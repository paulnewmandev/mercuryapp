/**
 * @fileoverview Inicializa la capa frontend compartida para MercuryApp,
 * incluyendo la configuración de PWA y la carga de dependencias base.
 */

import './Bootstrap';
import { registerSW } from 'virtual:pwa-register';

/**
 * Registra el service worker de la aplicación para habilitar
 * funcionalidades PWA con actualizaciones automáticas.
 *
 * @returns {void}
 */
const registerServiceWorker = () => {
    registerSW({
        immediate: true,
    });
};

registerServiceWorker();

const tx = (message, fallback = null) => {
    try {
        if (typeof window !== 'undefined' && typeof window.gettext === 'function') {
            return window.gettext(message);
        }
    } catch (error) {
        console.warn('[App] translate error', error, message);
    }
    return fallback ?? message;
};

if (typeof window !== 'undefined') {
    window.tx = tx;
    window.__aviTranslate = tx;
}

const ensureSweetAlert = () => {
    if (window.Swal) {
        return Promise.resolve(window.Swal);
    }

    if (!window.__aviSwalLoaderPromise) {
        window.__aviSwalLoaderPromise = new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
            script.async = true;
            script.onload = () => resolve(window.Swal);
            script.onerror = () => {
                window.__aviSwalLoaderPromise = null;
                reject(new Error('No se pudo cargar SweetAlert2.'));
            };
            document.head.appendChild(script);
        });
    }

    return window.__aviSwalLoaderPromise;
};

const getThemedSwal = () =>
    ensureSweetAlert().then((Swal) =>
        Swal.mixin({
            buttonsStyling: false,
            customClass: {
                popup: 'rounded-3xl border border-gray-200 bg-white px-6 py-8 shadow-2xl shadow-slate-900/10 dark:border-slate-700 dark:bg-slate-900',
                title: 'text-xl font-semibold text-gray-900 dark:text-white',
                htmlContainer: 'text-sm text-gray-600 dark:text-gray-300',
                actions: 'mt-6 flex items-center justify-center gap-3',
                confirmButton:
                    'inline-flex items-center justify-center rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-strong focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary',
                cancelButton:
                    'inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 shadow-sm transition hover:bg-gray-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary dark:border-slate-600 dark:bg-slate-800 dark:text-gray-200 dark:hover:bg-slate-700',
            },
        })
    );

const showAlert = ({ title, text, icon, confirmText }) => {
    const defaults = {
        success: {
            title: 'Datos actualizados',
            text: 'La operación se completó correctamente.',
        },
        error: {
            title: 'Error',
            text: 'Ocurrió un problema durante la operación.',
        },
        warning: {
            title: 'Atención',
            text: '',
        },
        info: {
            title: 'Información',
            text: '',
        },
    };

    const variant = icon && defaults[icon] ? defaults[icon] : defaults.info;

    console.log('[App] showAlert invoked', { title, text, icon });

    return getThemedSwal()
        .then((Swal) => {
            return Swal.fire({
                title: title ?? variant.title,
                html: text ?? variant.text,
                icon: icon ?? 'info',
                confirmButtonText: confirmText ?? tx('Aceptar'),
            });
        })
        .catch((error) => {
            console.error('[App] Error loading SweetAlert, creating fallback modal', error);
            // Fallback: crear un modal personalizado usando DOM en lugar de alert nativo
            return createFallbackAlert(title ?? variant.title, text ?? variant.text, icon ?? 'info', confirmText ?? tx('Aceptar'));
        });
};

// Fallback alert usando DOM cuando SweetAlert no está disponible
const createFallbackAlert = (title, text, icon, confirmText) => {
    return new Promise((resolve) => {
        // Remover modal anterior si existe
        const existingModal = document.getElementById('fallback-alert-modal');
        if (existingModal) {
            existingModal.remove();
        }

        // Crear overlay
        const overlay = document.createElement('div');
        overlay.id = 'fallback-alert-modal';
        overlay.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm';
        overlay.style.cssText = 'animation: fadeIn 0.2s ease-out;';

        // Colores según icono
        const iconConfig = {
            success: { bg: 'bg-green-100', text: 'text-green-600', icon: 'fa-circle-check' },
            error: { bg: 'bg-rose-100', text: 'text-rose-600', icon: 'fa-circle-xmark' },
            warning: { bg: 'bg-amber-100', text: 'text-amber-600', icon: 'fa-triangle-exclamation' },
            info: { bg: 'bg-blue-100', text: 'text-blue-600', icon: 'fa-circle-info' },
        };
        const config = iconConfig[icon] || iconConfig.info;

        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'mx-4 w-full max-w-md rounded-2xl border border-gray-200 bg-white p-6 shadow-2xl dark:border-gray-700 dark:bg-slate-900';
        modal.style.cssText = 'animation: scaleIn 0.2s ease-out;';

        modal.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full ${config.bg}">
                    <i class="fa-solid ${config.icon} text-xl ${config.text}"></i>
                </div>
                <div class="flex-1">
                    <h3 class="mb-2 text-lg font-semibold text-gray-900 dark:text-white">${title}</h3>
                    <p class="mb-4 text-sm text-gray-600 dark:text-gray-300">${text}</p>
                    <div class="flex justify-end">
                        <button
                            type="button"
                            class="inline-flex items-center justify-center rounded-xl bg-primary px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-primary-strong focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                            data-fallback-alert-close
                        >
                            ${confirmText}
                        </button>
                    </div>
                </div>
            </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Cerrar al hacer clic en el botón
        const closeBtn = modal.querySelector('[data-fallback-alert-close]');
        const closeModal = () => {
            overlay.style.animation = 'fadeOut 0.2s ease-out';
            modal.style.animation = 'scaleOut 0.2s ease-out';
            setTimeout(() => {
                overlay.remove();
                resolve({ isConfirmed: true, isDismissed: false });
            }, 200);
        };

        closeBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeModal();
            }
        });

        // Cerrar con Escape
        const handleEscape = (e) => {
            if (e.key === 'Escape' && document.getElementById('fallback-alert-modal')) {
                closeModal();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    });
};

// Agregar estilos para las animaciones si no existen
if (!document.getElementById('fallback-alert-styles')) {
    const style = document.createElement('style');
    style.id = 'fallback-alert-styles';
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes scaleOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0.95); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

const initFlashAlerts = () => {
    const flashContainer = document.querySelector('[data-flash-container="true"]');
    if (!flashContainer) {
        return;
    }

    const status = flashContainer.dataset.flashStatus ?? '';
    const message = flashContainer.dataset.flashMessage ?? '';
    const title = flashContainer.dataset.flashTitle ?? '';

    if (!status && !message) {
        return;
    }

    const statusToIcon = {
        success: 'success',
        error: 'error',
        warning: 'warning',
        info: 'info',
    };

    const resolvedIcon = statusToIcon[status] ?? 'info';

    showAlert({
        title: title || undefined,
        text: message || undefined,
        icon: resolvedIcon,
    });
};

const initPasswordToggles = () => {
    const toggles = document.querySelectorAll('[data-toggle-password]');
    toggles.forEach((toggle, index) => {
        const inputId = toggle.getAttribute('data-toggle-password');
        const input = document.getElementById(inputId);

        if (!input) {
            return;
        }

        const showIcon = toggle.querySelector('[data-icon="show"]');
        const hideIcon = toggle.querySelector('[data-icon="hide"]');

        const syncState = () => {
            const isVisible = input.type === 'text';
            toggle.setAttribute('aria-pressed', String(isVisible));
            if (showIcon && hideIcon) {
                showIcon.style.display = isVisible ? 'none' : '';
                hideIcon.style.display = isVisible ? '' : 'none';
            }
        };

        syncState();

        toggle.addEventListener('click', (event) => {
            event.preventDefault();
            input.type = input.type === 'password' ? 'text' : 'password';
            syncState();
        });
    });
};

const initOtpForm = () => {
    const form = document.getElementById('otp-form');
    if (!form) {
        return;
    }

    const inputs = Array.from(form.querySelectorAll('#otp-inputs input'));
    const hiddenInput = document.getElementById('code');
    const resendButton = document.getElementById('resend-button');
    const feedbackSpan = document.getElementById('resend-feedback');

    if (!hiddenInput || !resendButton) {
        return;
    }

    let countdown = 30;
    let timerId;

    const updateHiddenInput = () => {
        hiddenInput.value = inputs.map((input) => input.value).join('');
    };

    inputs.forEach((input, index) => {
        input.addEventListener('keydown', (event) => {
            if (event.key === 'Backspace' && !input.value && index > 0) {
                inputs[index - 1].focus();
            }
        });

        input.addEventListener('input', () => {
            input.value = input.value.replace(/\D/g, '').slice(0, 1);
            if (input.value && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            updateHiddenInput();
        });

        input.addEventListener('paste', (event) => {
            event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text') ?? '';
            const digits = pasteData.replace(/\D/g, '');
            if (!digits) {
                return;
            }

            let currentIndex = index;
            for (const digit of digits) {
                if (currentIndex >= inputs.length) {
                    break;
                }
                inputs[currentIndex].value = digit;
                currentIndex += 1;
            }

            const nextIndex = Math.min(currentIndex, inputs.length - 1);
            inputs[nextIndex].focus();
            updateHiddenInput();
        });
    });

    form.addEventListener('submit', () => {
        updateHiddenInput();
    });

    const formatTime = (seconds) => {
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${mins}:${secs}`;
    };

    const renderCountdownLabel = () => {
        resendButton.innerHTML = `No he recibido el código (<span id="resend-countdown">${formatTime(countdown)}</span>)`;
    };

    const updateCountdownDisplay = () => {
        const span = document.getElementById('resend-countdown');
        if (span) {
            span.textContent = formatTime(countdown);
        }
    };

    const renderReadyLabel = () => {
        resendButton.textContent = 'Enviar un nuevo código';
    };

    const startCountdown = () => {
        resendButton.disabled = true;
        countdown = 30;
        renderCountdownLabel();
        if (feedbackSpan) {
            feedbackSpan.textContent = '';
            feedbackSpan.classList.remove('text-red-500');
        }

        timerId = setInterval(() => {
            countdown -= 1;
            if (countdown <= 0) {
                clearInterval(timerId);
                resendButton.disabled = false;
                renderReadyLabel();
            } else {
                updateCountdownDisplay();
            }
        }, 1000);
    };

    startCountdown();

    resendButton.addEventListener('click', () => {
        if (resendButton.disabled) {
            return;
        }

        fetch(resendButton.dataset.resendUrl ?? '', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': resendButton.dataset.csrf ?? '',
            },
            body: JSON.stringify({ email: resendButton.dataset.email }),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}`);
                }
                countdown = 30;
                startCountdown();
                if (feedbackSpan) {
                    feedbackSpan.textContent = 'Acabamos de enviarte un nuevo código.';
                    feedbackSpan.classList.remove('text-red-500');
                }
            })
            .catch((error) => {
                resendButton.disabled = false;
                if (feedbackSpan) {
                    feedbackSpan.textContent = 'No se pudo reenviar el código. Intenta nuevamente.';
                    feedbackSpan.classList.add('text-red-500');
                }
            });
    });

    updateHiddenInput();
};

const initThemeToggles = () => {
    const toggles = document.querySelectorAll('[data-theme-toggle]');
    if (toggles.length === 0) {
        return;
    }

    const applyTheme = (mode) => {
        const isDark = mode === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
        document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
        localStorage.setItem('theme', mode);
    };

    const getCurrentTheme = () => (document.documentElement.classList.contains('dark') ? 'dark' : 'light');

    const updateToggles = () => {
        const isDark = getCurrentTheme() === 'dark';
        toggles.forEach((toggle) => {
            toggle.setAttribute('aria-pressed', String(isDark));
            const lightIcon = toggle.querySelector('[data-theme-icon="light"]');
            const darkIcon = toggle.querySelector('[data-theme-icon="dark"]');
            if (lightIcon) {
                lightIcon.style.display = isDark ? 'none' : 'inline';
            }
            if (darkIcon) {
                darkIcon.style.display = isDark ? 'inline' : 'none';
            }
        });
    };

    const storedTheme = localStorage.getItem('theme');
    if (storedTheme) {
        applyTheme(storedTheme);
    } else {
        document.documentElement.style.colorScheme = getCurrentTheme() === 'dark' ? 'dark' : 'light';
    }

    updateToggles();

    toggles.forEach((toggle) => {
        toggle.addEventListener('click', (event) => {
            event.preventDefault();
            const nextTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
            applyTheme(nextTheme);
            updateToggles();
        });
    });
};

const initDropdowns = () => {
    const dropdowns = Array.from(document.querySelectorAll('[data-dropdown]'));
    if (dropdowns.length === 0) {
        return;
    }

    const closeDropdown = (dropdown) => {
        const panel = dropdown.querySelector('[data-dropdown-panel]');
        const trigger = dropdown.querySelector('[data-dropdown-trigger]');
        if (panel && !panel.hasAttribute('hidden')) {
            panel.setAttribute('hidden', '');
            panel.classList.add('hidden');
        }
        if (trigger) {
            trigger.setAttribute('aria-expanded', 'false');
        }
    };

    const closeAll = (exception = null) => {
        dropdowns.forEach((dropdown) => {
            if (dropdown !== exception) {
                closeDropdown(dropdown);
            }
        });
    };

    dropdowns.forEach((dropdown) => {
        const trigger = dropdown.querySelector('[data-dropdown-trigger]');
        const panel = dropdown.querySelector('[data-dropdown-panel]');

        if (!trigger || !panel) {
            return;
        }

        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const isOpen = !panel.hasAttribute('hidden');
            if (isOpen) {
                closeDropdown(dropdown);
            } else {
                closeAll(dropdown);
                panel.removeAttribute('hidden');
                panel.classList.remove('hidden');
                trigger.setAttribute('aria-expanded', 'true');
            }
        });

        panel.addEventListener('click', (event) => {
            event.stopPropagation();
        });
    });

    document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
            return;
        }

        const clickedInside = dropdowns.some((dropdown) => dropdown.contains(target));
        if (!clickedInside) {
            closeAll();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeAll();
        }
    });
};

const initSidebarToggle = () => {
    const sidebar = document.querySelector('[data-sidebar]');
    if (!sidebar) {
        return;
    }

    const overlay = document.querySelector('[data-sidebar-overlay]');
    const openButton = document.querySelector('[data-sidebar-open]');
    const closeButton = document.querySelector('[data-sidebar-close]');
    const contentArea = document.querySelector('[data-content-area]');

    let isSidebarOpen = window.innerWidth >= 1024; // Default open on desktop
    let isMobile = window.innerWidth < 1024;
    const sidebarWidth = 288; // Default sidebar width in px
    const sidebarCompactWidth = 88; // Compact sidebar width in px
    let baseSidebarState = !isMobile && !isSidebarOpen ? 'compact' : 'expanded';

    const updateDocumentState = () => {
        const state = sidebar.getAttribute('data-sidebar-state') ?? 'expanded';
        const hover = sidebar.getAttribute('data-sidebar-hover') ?? 'false';
        document.body.setAttribute('data-sidebar-state', state);
        document.body.setAttribute('data-sidebar-hover', hover);
    };

    const isSidebarFixed = () => window.getComputedStyle(sidebar).position === 'fixed';

    const updateContentOffset = () => {
        if (!contentArea) {
            return;
        }
        if (isMobile || !isSidebarFixed()) {
            contentArea.style.marginLeft = '0px';
            return;
        }
        const width = Math.round(sidebar.getBoundingClientRect().width);
        contentArea.style.marginLeft = `${width}px`;
    };

    const applyBaseLayout = () => {
        if (isMobile) {
            sidebar.setAttribute('data-sidebar-state', 'expanded');
            sidebar.setAttribute('data-sidebar-hover', 'false');
        } else {
            baseSidebarState = isSidebarOpen ? 'expanded' : 'compact';
            sidebar.setAttribute('data-sidebar-state', baseSidebarState);
            sidebar.setAttribute('data-sidebar-hover', 'false');
        }
        requestAnimationFrame(() => {
            updateContentOffset();
            updateDocumentState();
        });
    };

    const setSidebarState = (state) => {
        isSidebarOpen = state === 'expanded';
        applyBaseLayout();
    };

    const applyHoverState = (hovering) => {
        if (isMobile || baseSidebarState === 'expanded') {
            return;
        }
        sidebar.setAttribute('data-sidebar-hover', hovering ? 'true' : 'false');
        requestAnimationFrame(() => {
            updateContentOffset();
            updateDocumentState();
        });
    };

    const applyState = () => {
        if (isMobile) {
            // Mobile: overlay behavior
            if (isSidebarOpen) {
                sidebar.style.transform = `translateX(0px)`;
                sidebar.setAttribute('data-sidebar-hover', 'false');
                sidebar.setAttribute('data-sidebar-state', 'expanded');
                if (overlay) overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                sidebar.style.transform = `translateX(-${sidebarWidth}px)`;
                sidebar.setAttribute('data-sidebar-hover', 'false');
                sidebar.setAttribute('data-sidebar-state', 'expanded');
                if (overlay) overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
            requestAnimationFrame(() => {
                updateContentOffset();
                updateDocumentState();
            });
        } else {
            // Desktop: toggle compact/expanded
            if (isSidebarOpen) {
                sidebar.style.transform = `translateX(0px)`;
                sidebar.setAttribute('data-sidebar-hover', 'false');
                setSidebarState('expanded');
            } else {
                sidebar.style.transform = `translateX(0px)`; // Always visible, just compact
                sidebar.setAttribute('data-sidebar-hover', 'false');
                setSidebarState('compact');
            }
            if (overlay) overlay.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
    };

    if (openButton) {
        openButton.addEventListener('click', (event) => {
            event.preventDefault();
            isSidebarOpen = !isSidebarOpen;
            applyState();
        });
    }

    if (closeButton) {
        closeButton.addEventListener('click', (event) => {
            event.preventDefault();
            isSidebarOpen = false;
            applyState();
        });
    }

    if (overlay) {
        overlay.addEventListener('click', (event) => {
            event.preventDefault();
            isSidebarOpen = false;
            applyState();
        });
    }

    sidebar.addEventListener('mouseenter', () => {
        applyHoverState(true);
    });

    sidebar.addEventListener('mouseleave', () => {
        applyHoverState(false);
    });

    const handleResize = () => {
        const wasMobile = isMobile;
        isMobile = window.innerWidth < 1024;

        if (isMobile !== wasMobile) {
            // If switching between mobile/desktop viewports
            if (!isMobile) {
                // Switched to desktop, ensure sidebar is open
                isSidebarOpen = true;
            } else {
                // Switched to mobile, ensure sidebar is closed
                isSidebarOpen = false;
            }
        }
        applyState();
        if (!isMobile) {
            applyBaseLayout();
        }
    };

    applyState();
    if (!isMobile) {
        applyBaseLayout();
    }
    window.addEventListener('resize', handleResize);
};

const initSidebarAccordions = () => {
    const sidebar = document.querySelector('[data-sidebar]');
    if (!sidebar) {
        return;
    }

    const triggers = sidebar.querySelectorAll('[data-sidebar-collapse-trigger]');
    const panels = sidebar.querySelectorAll('[data-sidebar-collapse-panel]');
    const escapeSelector = (value) => {
        if (typeof CSS !== 'undefined' && typeof CSS.escape === 'function') {
            return CSS.escape(value);
        }
        return value.replace(/[\s#.;?+*~'":!^$\[\]()=>|/@]/g, '\\$&');
    };

    // Función para cerrar todos los paneles excepto el especificado
    const closeAllPanels = (exceptTrigger = null) => {
        triggers.forEach((t) => {
            if (t === exceptTrigger) {
                return; // No cerrar el panel que se está abriendo
            }
            const targetId = t.getAttribute('data-target');
        if (!targetId) {
            return;
        }
            const panel = sidebar.querySelector(`#${escapeSelector(targetId)}`);
            const icon = t.querySelector('[data-sidebar-collapse-icon]');
            
            t.setAttribute('aria-expanded', 'false');
            if (panel) {
                panel.classList.add('hidden');
            }
            if (icon) {
                icon.style.transform = 'rotate(-90deg)';
            }
        });
    };

    // Función para establecer el estado de un panel específico
    const setState = (trigger, expanded) => {
        const targetId = trigger.getAttribute('data-target');
        if (!targetId) {
            return;
        }
        const panel = sidebar.querySelector(`#${escapeSelector(targetId)}`);
        const icon = trigger.querySelector('[data-sidebar-collapse-icon]');

            trigger.setAttribute('aria-expanded', String(expanded));
            if (panel) {
                panel.classList.toggle('hidden', !expanded);
            }
            if (icon) {
                icon.style.transform = expanded ? 'rotate(0deg)' : 'rotate(-90deg)';
            }
        };

    // Inicializar estado inicial: cerrar todos primero, luego abrir solo el primero que esté activo
    // Primero, cerrar todos los paneles
    triggers.forEach((trigger) => {
        setState(trigger, false);
    });
    
    // Luego, encontrar el primer trigger que debería estar abierto (si hay alguno)
    let firstActiveTrigger = null;
    triggers.forEach((trigger) => {
        const shouldBeOpen = trigger.getAttribute('aria-expanded') === 'true';
        if (shouldBeOpen && !firstActiveTrigger) {
            firstActiveTrigger = trigger;
        }
    });
    
    // Si hay un trigger activo, abrirlo (y esto automáticamente cerrará los demás)
    if (firstActiveTrigger) {
        closeAllPanels(firstActiveTrigger);
        setState(firstActiveTrigger, true);
    }

    // Agregar listeners a los triggers
    triggers.forEach((trigger) => {
        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                // Si está expandido, solo cerrarlo
                setState(trigger, false);
            } else {
                // Si está cerrado, cerrar todos los demás y abrir este
                closeAllPanels(trigger);
                setState(trigger, true);
            }
        });
    });

    // Cerrar todos los paneles cuando se hace clic en un enlace hijo
    const childLinks = sidebar.querySelectorAll('.sidebar-nav-item-child');
    childLinks.forEach((link) => {
        link.addEventListener('click', () => {
            // Cerrar todos los paneles cuando se navega a una página
            closeAllPanels();
        });
    });

    // Cerrar todos los paneles cuando se hace clic en un enlace principal (sin hijos)
    // Los enlaces principales son <a> con clase sidebar-nav-item que NO están dentro de un trigger
    const mainLinks = sidebar.querySelectorAll('a.sidebar-nav-item');
    mainLinks.forEach((link) => {
        // Verificar que no sea un trigger (los triggers son botones, no enlaces)
        if (link.tagName === 'A' && !link.hasAttribute('data-sidebar-collapse-trigger')) {
            link.addEventListener('click', () => {
                // Cerrar todos los paneles cuando se navega a una página
                closeAllPanels();
            });
        }
    });
};

const initCompanyProfile = () => {
    const container = document.querySelector('[data-company-profile]');
    if (!container) {
        return;
    }

    const preview = container.querySelector('[data-company-preview]');
    const form = container.querySelector('[data-company-edit]');
    const hiddenField = form ? form.querySelector('input[name="_editing"]') : null;

    const showEdit = () => {
        if (preview) {
            preview.classList.add('hidden');
        }
        if (form) {
            form.classList.remove('hidden');
        }
        if (hiddenField) {
            hiddenField.value = '1';
        }
    };

    const showPreview = () => {
        if (preview) {
            preview.classList.remove('hidden');
        }
        if (form) {
            form.classList.add('hidden');
        }
        if (hiddenField) {
            hiddenField.value = '0';
        }
    };

    const editButtons = container.querySelectorAll('[data-company-edit-toggle]');
    editButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
            event.preventDefault();
            showEdit();
        });
    });

    const cancelButtons = container.querySelectorAll('[data-company-edit-cancel]');
    cancelButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
            event.preventDefault();
            showPreview();
        });
    });

    const initialState = container.dataset.initialState === 'editing';
    if (initialState) {
        showEdit();
    } else {
        showPreview();
    }
};
const initDropzones = () => {
    const zones = document.querySelectorAll('[data-dropzone]');
    if (zones.length === 0) {
        return;
    }

    const parseAccepts = (value) => {
        if (!value) {
            return [];
        }
        return value
            .split(',')
            .map((item) => item.trim())
            .filter(Boolean);
    };

    const isAcceptedType = (file, accepted) => {
        if (accepted.length === 0) {
            return true;
        }

        const fileType = file.type ?? '';
        const fileName = file.name?.toLowerCase() ?? '';

        return accepted.some((accept) => {
            if (accept === '*/*') {
                return true;
            }
            if (accept.endsWith('/*')) {
                const category = accept.slice(0, -2);
                return fileType.startsWith(`${category}/`);
            }
            if (accept.startsWith('.')) {
                return fileName.endsWith(accept.toLowerCase());
            }
            return fileType === accept;
        });
    };

    zones.forEach((zone) => {
        const input = zone.querySelector('input[type="file"]');
        if (!input) {
            return;
        }

        const acceptedTypes = parseAccepts(zone.dataset.accept ?? '');
        const maxSizeMb = Number(zone.dataset.maxSize ?? '10');
        const maxSizeBytes = Number.isFinite(maxSizeMb) ? maxSizeMb * 1024 * 1024 : 10 * 1024 * 1024;

        const preview = zone.querySelector('[data-dropzone-preview]');
        const icon = zone.querySelector('[data-dropzone-icon]');
        const filenameLabel = zone.querySelector('[data-dropzone-filename]');
        const feedbackLabel = zone.querySelector('[data-dropzone-feedback]');
        const defaultFilename = filenameLabel?.dataset.default ?? filenameLabel?.textContent ?? '';
        const initialPreviewSrc = preview?.getAttribute('data-dropzone-initial') ?? '';
        const initialPreviewVisible = preview ? !preview.classList.contains('hidden') : false;

        const updateVisualState = (hasPreview) => {
            if (preview) {
                preview.classList.toggle('hidden', !hasPreview);
            }
            if (icon) {
                if (preview) {
                    icon.classList.toggle('hidden', hasPreview);
                } else {
                    icon.classList.remove('hidden');
                }
            }
        };

        updateVisualState(initialPreviewVisible);

        const clearFeedback = () => {
            if (feedbackLabel) {
                feedbackLabel.textContent = '';
                feedbackLabel.classList.add('hidden');
            }
            zone.classList.remove('has-error');
        };

        const showError = (message) => {
            if (feedbackLabel) {
                feedbackLabel.textContent = message;
                feedbackLabel.classList.remove('hidden');
            }
            if (filenameLabel) {
                filenameLabel.textContent = defaultFilename || '—';
            }
            if (preview && initialPreviewSrc) {
                preview.setAttribute('src', initialPreviewSrc);
            }
            updateVisualState(initialPreviewVisible);
            zone.classList.add('has-error');
            input.value = '';
        };

        const updatePreview = (file) => {
            if (!preview) {
                updateVisualState(true);
                return;
            }

            if (file.type && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.addEventListener('load', () => {
                    preview.setAttribute('src', String(reader.result));
                });
                reader.readAsDataURL(file);
            } else if (initialPreviewSrc) {
                preview.setAttribute('src', initialPreviewSrc);
            }
            updateVisualState(true);
        };

        const applyFile = (file) => {
            if (file.size > maxSizeBytes) {
                showError(`El archivo supera el máximo permitido (${maxSizeMb} MB).`);
                return;
            }

            if (!isAcceptedType(file, acceptedTypes)) {
                const message =
                    acceptedTypes.length > 0
                        ? `Formato no permitido. Tipos válidos: ${acceptedTypes.join(', ')}.`
                        : 'Formato de archivo no permitido.';
                showError(message);
                return;
            }

            clearFeedback();
            if (filenameLabel) {
                filenameLabel.textContent = file.name;
            }
            updatePreview(file);
        };

        const handleFiles = (fileList) => {
            if (!fileList || fileList.length === 0) {
                return;
            }
            const [file] = fileList;
            applyFile(file);
        };

        zone.addEventListener('click', (event) => {
            const target = event.target;
            if (target instanceof HTMLButtonElement || target instanceof HTMLAnchorElement) {
                return;
            }
            input.click();
        });

        zone.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                input.click();
            }
        });

        zone.addEventListener('dragover', (event) => {
            event.preventDefault();
            zone.classList.add('is-dragging');
        });

        zone.addEventListener('dragleave', (event) => {
            const related = event.relatedTarget;
            if (!related || !zone.contains(related)) {
                zone.classList.remove('is-dragging');
            }
        });

        zone.addEventListener('drop', (event) => {
            event.preventDefault();
            zone.classList.remove('is-dragging');
            const files = event.dataTransfer?.files;
            if (files && files.length > 0) {
                input.files = files;
                handleFiles(files);
            }
        });

        zone.querySelectorAll('[data-dropzone-trigger]').forEach((trigger) => {
            trigger.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                input.click();
            });
        });

        input.addEventListener('change', () => {
            clearFeedback();
            zone.classList.remove('is-dragging');
            handleFiles(input.files ?? undefined);
        });
    });
};


const initNotificationsDropdown = () => {

    const dropdown = document.querySelector('[data-dropdown="notifications"]');
    if (!dropdown) {
        return;
    }

    const list = dropdown.querySelector('[data-notification-list]');
    if (!list) {
        return;
    }

    const filterButtons = dropdown.querySelectorAll('[data-notification-filter]');
    const indicator = dropdown.querySelector('.notification-indicator');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    let activeFilter = 'all';

    const getItems = () => Array.from(list.querySelectorAll('.notification-item'));

    const updateCounts = () => {
        const items = getItems();
        const unread = items.filter((item) => item.dataset.isRead === 'false').length;
        const total = items.length;

        const allBadge = dropdown.querySelector('[data-notification-count="all"]');
        const unreadBadge = dropdown.querySelector('[data-notification-count="unread"]');
        if (allBadge) {
            allBadge.textContent = String(total);
        }
        if (unreadBadge) {
            unreadBadge.textContent = String(unread);
        }

        if (indicator) {
            indicator.classList.toggle('hidden', unread === 0);
        }
    };

    const ensureEmptyState = () => {
        let empty = list.querySelector('.notification-empty');
        const visible = getItems().filter((item) => !item.classList.contains('hidden'));

        if (visible.length === 0) {
            if (!empty) {
                empty = document.createElement('li');
                empty.className = 'notification-empty px-4 py-6 text-center text-xs text-secondary';
                list.append(empty);
            }

            empty.textContent = activeFilter === 'unread'
                ? 'No tienes notificaciones sin leer.'
                : 'No tienes notificaciones registradas.';
            empty.classList.remove('hidden');
        } else if (empty) {
            empty.remove();
        }
    };

    const applyFilter = () => {
        const showUnread = activeFilter === 'unread';
        getItems().forEach((item) => {
            const shouldHide = showUnread && item.dataset.isRead === 'true';
            item.classList.toggle('hidden', shouldHide);
        });

        updateCounts();
        ensureEmptyState();
    };

    const setActiveFilter = (filter) => {
        if (activeFilter === filter) {
            return;
        }

        activeFilter = filter;
        filterButtons.forEach((button) => {
            const isActive = button.dataset.notificationFilter === filter;
            button.classList.toggle('is-active', isActive);
        });

        applyFilter();
    };

    filterButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
            event.preventDefault();
            setActiveFilter(button.dataset.notificationFilter ?? 'all');
        });
    });

    const markAsRead = (item) => {
        if (!item || item.dataset.isRead === 'true') {
            return;
        }

        const url = item.dataset.readUrl;

        item.dataset.isRead = 'true';
        item.classList.remove('is-unread');
        item.classList.add('is-read');
        item.classList.add('cursor-default');
        item.classList.remove('cursor-pointer');
        const title = item.querySelector('[data-notification-title]');
        if (title) {
            title.classList.remove('font-semibold');
            title.classList.add('font-medium');
        }
        const description = item.querySelector('[data-notification-description]');
        if (description) {
            description.classList.remove('text-heading', 'font-medium');
            description.classList.add('text-secondary');
        }
        updateCounts();
        ensureEmptyState();

        if (!url) {
            return;
        }

        fetch(url, {
            method: 'PATCH',
            headers: {
                'X-CSRF-TOKEN': csrfToken,
                Accept: 'application/json',
            },
        }).catch((error) => {
            console.error('[Notifications] Error marcando como leída:', error);
        });
    };

    const removeNotification = (item) => {
        if (!item) {
            return;
        }

        const url = item.dataset.deleteUrl;
        item.remove();
        applyFilter();

        if (!url) {
            return;
        }

        fetch(url, {
            method: 'DELETE',
            headers: {
                'X-CSRF-TOKEN': csrfToken,
                Accept: 'application/json',
            },
        }).catch((error) => {
            console.error('[Notifications] Error eliminando notificación:', error);
        });
    };

    list.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
            return;
        }

        const deleteButton = target.closest('.notification-delete');
        if (deleteButton) {
            event.preventDefault();
            event.stopPropagation();
            const item = deleteButton.closest('.notification-item');
            removeNotification(item);
            return;
        }

        const item = target.closest('.notification-item');
        if (item) {
            markAsRead(item);
        }
    });

    list.addEventListener('keydown', (event) => {
        if (!['Enter', ' '].includes(event.key)) {
            return;
        }

        const item = event.target instanceof Element ? event.target.closest('.notification-item') : null;
        if (item) {
            event.preventDefault();
            markAsRead(item);
        }
    });

    applyFilter();
};

const initNotificationPageList = () => {
    const lists = document.querySelectorAll('[data-notification-list-page]');
    if (lists.length === 0) {
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    lists.forEach((list) => {
        const getItems = () => Array.from(list.querySelectorAll('.notification-list-item'));

        const updateEmptyState = () => {
            if (getItems().length === 0) {
                let empty = list.querySelector('.notification-empty');
                if (!empty) {
                    empty = document.createElement('li');
                    empty.className = 'notification-empty rounded-2xl border border-dashed border-surface px-6 py-16 text-center text-sm text-secondary';
                    empty.textContent = 'Aún no tienes notificaciones registradas.';
                    list.append(empty);
                }
            }
        };

        const markAsRead = (item) => {
            if (!item || item.dataset.isRead === 'true') {
                return;
            }

            item.dataset.isRead = 'true';
            item.classList.remove('is-unread', 'opacity-80', 'cursor-pointer');
            item.classList.add('is-read', 'cursor-default');

            const dot = item.querySelector('.notification-dot');
            if (dot) {
                dot.classList.remove('bg-primary');
                dot.classList.add('bg-surface-muted');
            }
            const title = item.querySelector('[data-notification-title]');
            if (title) {
                title.classList.remove('font-semibold');
                title.classList.add('font-medium');
            }
            const description = item.querySelector('[data-notification-description]');
            if (description) {
                description.classList.remove('text-heading', 'font-medium');
                description.classList.add('text-secondary');
            }

            const url = item.dataset.readUrl;
            if (!url) {
                return;
            }

            fetch(url, {
                method: 'PATCH',
                headers: {
                    'X-CSRF-TOKEN': csrfToken,
                    Accept: 'application/json',
                },
            }).catch((error) => {
                console.error('[Notifications] Error marcando como leída (listado):', error);
            });
        };

        const deleteItem = (item) => {
            if (!item) {
                return;
            }

            item.remove();
            updateEmptyState();

            const url = item.dataset.deleteUrl;
            if (!url) {
                return;
            }

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': csrfToken,
                    Accept: 'application/json',
                },
            }).catch((error) => {
                console.error('[Notifications] Error eliminando notificación (listado):', error);
            });
        };

        list.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Element)) {
                return;
            }

            const deleteButton = target.closest('.notification-list-delete');
            if (deleteButton) {
                event.preventDefault();
                event.stopPropagation();
                const item = deleteButton.closest('.notification-list-item');
                deleteItem(item);
                return;
            }

            const item = target.closest('.notification-list-item');
            if (item) {
                markAsRead(item);
            }
        });

        list.addEventListener('keydown', (event) => {
            if (!['Enter', ' '].includes(event.key)) {
                return;
            }
            const item = event.target instanceof Element ? event.target.closest('.notification-list-item') : null;
            if (item) {
                event.preventDefault();
                markAsRead(item);
            }
        });
    });
};

const initCustomSelects = () => {
    const selects = document.querySelectorAll('[data-select]:not([data-select-manual])');
    if (selects.length === 0) {
        return;
    }

    const closeSelect = (select) => {
        const trigger = select.querySelector('[data-select-trigger]');
        const dropdown = select.querySelector('[data-select-dropdown]');
        const icon = select.querySelector('[data-select-icon]');
        if (!trigger || !dropdown) {
            return;
        }

        dropdown.hidden = true;
        dropdown.dataset.open = 'false';
        select.dataset.open = 'false';
        trigger.setAttribute('aria-expanded', 'false');
        icon?.classList.remove('rotate-180');
    };

    const closeAll = (except) => {
        selects.forEach((select) => {
            if (select !== except) {
                closeSelect(select);
            }
        });
    };

    selects.forEach((select) => {
        const trigger = select.querySelector('[data-select-trigger]');
        const dropdown = select.querySelector('[data-select-dropdown]');
        const hiddenInput = select.querySelector('input[type="hidden"]');
        const valueLabel = select.querySelector('[data-select-value]');
        const icon = select.querySelector('[data-select-icon]');
        const options = Array.from(select.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';

        if (!trigger || !dropdown || !hiddenInput || !valueLabel) {
            return;
        }

        dropdown.dataset.open = 'false';
        select.dataset.open = 'false';

        const markSelected = (value) => {
            options.forEach((option) => {
                const isSelected = option.dataset.value === value;
                option.dataset.selected = isSelected ? 'true' : 'false';
            });
        };

        const updateTriggerState = () => {
            const hasValue = Boolean(hiddenInput.value);
            trigger.classList.toggle('is-empty', !hasValue);
        };

        const setValue = (value, label) => {
            hiddenInput.value = value;
            valueLabel.textContent = label || value || placeholder;
            markSelected(value);
            updateTriggerState();
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        };

        const initialOption = options.find((option) => option.dataset.value === hiddenInput.value);
        if (initialOption) {
            setValue(initialOption.dataset.value ?? '', initialOption.dataset.label ?? initialOption.textContent.trim());
        } else if (!hiddenInput.value) {
            valueLabel.textContent = placeholder;
            updateTriggerState();
        }

        const openSelect = () => {
            closeAll(select);
            dropdown.hidden = false;
            dropdown.dataset.open = 'true';
            select.dataset.open = 'true';
            trigger.setAttribute('aria-expanded', 'true');
            icon?.classList.add('rotate-180');
            requestAnimationFrame(() => {
                dropdown.style.minWidth = `${trigger.getBoundingClientRect().width}px`;
            });
        };

        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            const isOpen = select.dataset.open === 'true';
            if (isOpen) {
                closeSelect(select);
            } else {
                openSelect();
            }
        });

        options.forEach((option) => {
            option.addEventListener('click', (event) => {
                event.preventDefault();
                const value = option.dataset.value ?? option.textContent.trim();
                const label = option.dataset.label ?? option.textContent.trim();
                setValue(value, label);
                closeSelect(select);
                trigger.focus({ preventScroll: true });
            });
        });

        select.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeSelect(select);
                trigger.focus({ preventScroll: true });
            }
        });
    });

    document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Node)) {
            return;
        }
        if (!(target.closest('[data-select]'))) {
            closeAll();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeAll();
        }
    });
};

const decodePayload = (encoded) => {
    try {
        const decoded = window.atob(encoded);
        return JSON.parse(decodeURIComponent(escape(decoded)));
    } catch (error) {
        console.error('[Decode] Error decodificando payload', error);
        return null;
    }
};
const initBranchesModule = () => {
    const root = document.querySelector('[data-branches-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.branchesTableId ?? '';
    const baseUrl = root.dataset.branchesBaseUrl ?? '';
    const storeUrl = root.dataset.branchesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-branch-modal="form"]'),
        view: root.querySelector('[data-branch-modal="view"]'),
        delete: root.querySelector('[data-branch-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-branch-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-branch-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-branch-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-branch-modal-title]') ?? null;
    const modalSubtitle = modals.form?.querySelector('[data-branch-modal-subtitle]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-branch-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-branch-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-branch-delete-confirm]') ?? null;
    const mapContainer = modals.form?.querySelector('[data-branch-map]') ?? null;
    const mapSearchInput = modals.form?.querySelector('[data-branch-map-search]') ?? null;
    const mapFeedback = modals.form?.querySelector('[data-branch-map-feedback]') ?? null;
    const viewMapImg = modals.view?.querySelector('[data-branch-view-map]') ?? null;

    const mapsKey = root.dataset.branchesMapsKey ?? '';
    const defaultLatLng = { lat: -1.831239, lng: -78.183406 };

    let mapInstance = null;
    let markerInstance = null;
    let autocompleteInstance = null;
    let geocoderInstance = null;

    let mapFeedbackTimeoutId = null;

    const setMapFeedbackMessage = (message, type = 'info') => {
        if (!mapFeedback) {
            return;
        }
        mapFeedback.textContent = message ?? '';
        mapFeedback.classList.remove('text-rose-500', 'text-emerald-500');
        if (type === 'error') {
            mapFeedback.classList.add('text-rose-500');
        } else if (type === 'success') {
            mapFeedback.classList.add('text-emerald-500');
        }
    };

    const loadMaps = () => {
        if (window.google?.maps) {
            return Promise.resolve(window.google.maps);
        }

        if (!mapsKey) {
            return Promise.reject(new Error('Google Maps API key is not configured.'));
        }

        if (!window.__aviMapsLoaderPromise) {
            window.__aviMapsLoaderPromise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${mapsKey}&libraries=places`;
                script.async = true;
                script.onload = () => resolve(window.google.maps);
                script.onerror = () => {
                    window.__aviMapsLoaderPromise = null;
                    reject(new Error('No se pudo cargar Google Maps.'));
                };
                document.head.appendChild(script);
            });
        }

        return window.__aviMapsLoaderPromise;
    };

    const normalizeLatLng = (value) => {
        if (!value) {
            return null;
        }
        if (typeof value.lat === 'function') {
            return { lat: value.lat(), lng: value.lng() };
        }
        const lat = Number(value.lat ?? value.latitude ?? null);
        const lng = Number(value.lng ?? value.longitude ?? null);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
            return null;
        }
        return { lat, lng };
    };

    const setLatLngInputs = (coords) => {
        if (!coords) {
            return;
        }
        setFieldValue('latitude', coords.lat.toFixed(6));
        setFieldValue('longitude', coords.lng.toFixed(6));
    };

    const moveMarkerTo = (coords, options = {}) => {
        const normalized = normalizeLatLng(coords);
        if (!normalized || !mapInstance || !markerInstance) {
            return;
        }
        markerInstance.setPosition(normalized);
        if (options.pan !== false) {
            mapInstance.panTo(normalized);
        }
        if (typeof options.zoom === 'number') {
            mapInstance.setZoom(options.zoom);
        }
        setLatLngInputs(normalized);
        setMapFeedbackMessage('');

        if (options.geocode && geocoderInstance) {
            setMapFeedbackMessage('Buscando dirección...');
            geocoderInstance.geocode({ location: normalized }, (results, status) => {
                if (status === 'OK' && Array.isArray(results) && results.length > 0) {
                    const formatted = results[0].formatted_address ?? '';
                    setFieldValue('address', formatted);
                    if (mapSearchInput) {
                        mapSearchInput.value = formatted;
                    }
                    setMapFeedbackMessage('Ubicación actualizada.', 'success');
                } else {
                    setMapFeedbackMessage('No se pudo obtener la dirección para esta ubicación.', 'error');
                }
            });
        }
    };

    const ensureMapReady = async () => {
        if (!mapContainer) {
            return null;
        }

        if (mapInstance) {
            return mapInstance;
        }

        try {
            await loadMaps();
        } catch (error) {
            console.error('[Branches] Google Maps load error', error);
            setMapFeedbackMessage('No se pudo cargar el mapa de Google.', 'error');
            return null;
        }

        mapInstance = new window.google.maps.Map(mapContainer, {
            center: defaultLatLng,
            zoom: 6,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: true,
            zoomControlOptions: {
                position: window.google.maps.ControlPosition.RIGHT_BOTTOM,
            },
        });

        markerInstance = new window.google.maps.Marker({
            map: mapInstance,
            position: defaultLatLng,
            draggable: true,
        });

        geocoderInstance = new window.google.maps.Geocoder();

        markerInstance.addListener('dragend', (event) => {
            moveMarkerTo(event.latLng, { pan: false, geocode: true });
        });

        mapInstance.addListener('click', (event) => {
            moveMarkerTo(event.latLng, { zoom: mapInstance.getZoom(), geocode: true });
        });

        if (mapSearchInput) {
            autocompleteInstance = new window.google.maps.places.Autocomplete(mapSearchInput, {
                componentRestrictions: { country: 'ec' },
            });

            autocompleteInstance.addListener('place_changed', () => {
                const place = autocompleteInstance.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    setMapFeedbackMessage('No se pudo reconocer la ubicación seleccionada.', 'error');
                    return;
                }

                moveMarkerTo(place.geometry.location, { zoom: 15 });

                if (place.formatted_address) {
                    setFieldValue('address', place.formatted_address);
                }
                setMapFeedbackMessage('Ubicación actualizada.', 'success');
            });
        }

        setMapFeedbackMessage('');

        return mapInstance;
    };

    const updateFormMapPosition = (lat, lng, { searchValue } = {}) => {
        ensureMapReady().then(() => {
            const hasValidCoords = Number.isFinite(lat) && Number.isFinite(lng);
            const target = hasValidCoords ? { lat, lng } : defaultLatLng;
            moveMarkerTo(target, { zoom: hasValidCoords ? 15 : 6, pan: false });
            if (!hasValidCoords) {
                setLatLngInputs(defaultLatLng);
            }

            if (mapSearchInput) {
                mapSearchInput.value = searchValue ?? '';
            }

            setMapFeedbackMessage('');

            window.setTimeout(() => {
                if (window.google?.maps && mapInstance) {
                    window.google.maps.event.trigger(mapInstance, 'resize');
                    mapInstance.panTo(markerInstance.getPosition());
                }
            }, 150);
        }).catch((error) => {
            console.error('[Branches] Map update error', error);
            setMapFeedbackMessage('No se pudo actualizar el mapa.', 'error');
        });
    };

    const updateViewMap = (lat, lng) => {
        if (!viewMapImg) {
            return;
        }

        const hasValidCoords = Number.isFinite(lat) && Number.isFinite(lng);
        if (!mapsKey) {
            viewMapImg.removeAttribute('src');
            viewMapImg.alt = 'Mapa no disponible';
            return;
        }

        if (hasValidCoords) {
            viewMapImg.src = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=640x360&maptype=roadmap&markers=color:red%7C${lat},${lng}&key=${mapsKey}`;
            viewMapImg.alt = 'Mapa de la ubicación seleccionada';
        } else {
            viewMapImg.src = `https://maps.googleapis.com/maps/api/staticmap?center=${defaultLatLng.lat},${defaultLatLng.lng}&zoom=5&size=640x360&maptype=roadmap&key=${mapsKey}`;
            viewMapImg.alt = 'Mapa general de Ecuador';
        }
    };

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-branch-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
        if (modal === modals.form) {
            const lat = parseNullableNumber(getFieldValue('latitude')) ?? defaultLatLng.lat;
            const lng = parseNullableNumber(getFieldValue('longitude')) ?? defaultLatLng.lng;
            updateFormMapPosition(lat, lng, { searchValue: mapSearchInput?.value ?? '' });
        }
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-branch-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    const closeAllModals = () => {
        Object.values(modals).forEach((modal) => {
            if (modal) {
                modal.classList.add('hidden');
            }
        });
        document.body.classList.remove(bodyOverflowClass);
    };

    root.querySelectorAll('[data-branch-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-branch-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-branch-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-branch-error="${field}"]`);
            const inputEl = form.querySelector(`[data-branch-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-branch-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-branch-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const parseNullableNumber = (value) => {
        if (value === '' || value === null || value === undefined) {
            return null;
        }
        const numeric = Number(value);
        return Number.isFinite(numeric) ? numeric : null;
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);
        setMapFeedbackMessage('');

        form.dataset.mode = mode;
        form.dataset.branchId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nuevo registro';
            }
            if (modalSubtitle) {
                modalSubtitle.textContent = 'Completa la información para registrar un nuevo elemento.';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar registro';
            }
            if (modalSubtitle) {
                modalSubtitle.textContent = 'Actualiza la información y guarda los cambios.';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('code', data.code ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('address', data.address ?? '');
            setFieldValue('website', data.website ?? '');
            setFieldValue('email', data.email ?? '');
            setFieldValue('phone_number', data.phone_number ?? '');
            setFieldValue('latitude', data.latitude ?? '');
            setFieldValue('longitude', data.longitude ?? '');
            setFieldValue('status', data.status ?? 'A');
        }

        const latitude = parseNullableNumber(getFieldValue('latitude'));
        const longitude = parseNullableNumber(getFieldValue('longitude'));
        const searchValue = mode === 'edit' ? (data?.address ?? '') : '';

        if (mapSearchInput) {
            mapSearchInput.value = searchValue;
        }

        updateFormMapPosition(latitude, longitude, { searchValue });
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-branch-view-field]').forEach((element) => {
            const field = element.getAttribute('data-branch-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            if ((field === 'latitude' || field === 'longitude') && value !== null && value !== undefined && value !== '') {
                const numeric = Number(value);
                element.textContent = Number.isFinite(numeric) ? numeric.toFixed(6) : String(value);
                return;
            }
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });

        const latitude = parseNullableNumber(data.latitude);
        const longitude = parseNullableNumber(data.longitude);
        updateViewMap(latitude, longitude);
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const branchId = form.dataset.branchId ?? '';

        const payload = {
            code: getFieldValue('code'),
            name: getFieldValue('name'),
            address: getFieldValue('address') || null,
            website: getFieldValue('website') || null,
            email: getFieldValue('email') || null,
            phone_number: getFieldValue('phone_number') || null,
            latitude: parseNullableNumber(getFieldValue('latitude')),
            longitude: parseNullableNumber(getFieldValue('longitude')),
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        
        // Validar campos requeridos
        if (!payload.code || payload.code.trim() === '') {
            validationErrors.code = tx('El código es obligatorio.');
        }
        
        if (!payload.name || payload.name.trim() === '') {
            validationErrors.name = tx('El nombre es obligatorio.');
        }
        
        const phoneValue = payload.phone_number ?? '';
        const emailValue = payload.email ?? '';
        const websiteValue = payload.website ?? '';

        if (phoneValue !== '' && !/^[0-9()+\-\s]{4,}$/.test(phoneValue)) {
            validationErrors.phone_number = tx('El teléfono solo puede contener números y símbolos válidos.');
        }

        if (emailValue !== '' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
            validationErrors.email = tx('Ingresa un correo electrónico válido.');
        }

        try {
            if (websiteValue !== '') {
                const url = new URL(websiteValue.startsWith('http') ? websiteValue : `https://${websiteValue}`);
                payload.website = url.href;
            }
        } catch (error) {
            validationErrors.website = tx('Ingresa un sitio web válido.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        console.log('[Branches] submit payload', payload);

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${branchId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else if (response.status === 403) {
                    showAlert({ title: tx('Error de autorización'), text: tx('No tienes permisos para realizar esta acción.'), icon: 'error' });
                } else {
                    const errorMessage = json?.message ?? tx('No fue posible guardar la información.');
                    showAlert({ title: tx('Error'), text: errorMessage, icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Éxito'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Branches] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const branchId = modals.delete.dataset.branchId || deleteConfirmButton.dataset.branchId || '';
        if (!branchId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${branchId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Éxito'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Branches] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const branchId = input.dataset.id ?? '';
        if (!branchId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${branchId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Branches] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-branch-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute('data-branch-action')) {
            const action = actionEl.dataset.branchAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        if (!rowId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch branch data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    populateViewModal(json.data.item);
                    openModal(modals.view);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[Branches] Error loading view data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'edit') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch branch data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    setFormMode('edit', json.data.item);
                    openModal(modals.form);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[Branches] Error loading edit data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'delete') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch branch data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    const branchName = json.data.item.name ?? json.data.item.code ?? '';
                    if (modals.delete) {
                        modals.delete.dataset.branchId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = branchName;
                    }
                    if (deleteConfirmButton) {
                        deleteConfirmButton.dataset.branchId = rowId;
                    }
                    openModal(modals.delete);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[Branches] Error loading delete data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
            }
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) {
            return;
        }
        if (target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });

    form?.addEventListener('submit', (event) => {
        event.preventDefault();
        handleSubmit();
    });

    deleteConfirmButton?.addEventListener('click', () => {
        handleDelete();
    });
};
const initPaymentCardsModule = () => {
    const root = document.querySelector('[data-cards-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.cardsTableId ?? '';
    const baseUrl = root.dataset.cardsBaseUrl ?? '';
    const storeUrl = root.dataset.cardsStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-card-modal="form"]'),
        view: root.querySelector('[data-card-modal="view"]'),
        delete: root.querySelector('[data-card-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-card-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-card-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-card-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-card-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-card-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-card-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-card-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-card-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-card-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-card-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-card-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-card-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-card-error="${field}"]`);
            const inputEl = form.querySelector(`[data-card-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-card-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-card-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.cardId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nueva tarjeta';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar tarjeta';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-card-view-field]').forEach((element) => {
            const field = element.getAttribute('data-card-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const cardId = form.dataset.cardId ?? '';

        const categoryValue = categoryHiddenInput?.value?.trim() ?? '';

        const payload = {
            category_id: categoryValue !== '' ? categoryValue : null,
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!categoryValue) {
            validationErrors.category_id = tx('Selecciona una categoría.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${cardId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Cards] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const cardId = modals.delete.dataset.cardId;
        if (!cardId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${cardId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Cards] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const cardId = input.dataset.id ?? '';
        if (!cardId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${cardId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Cards] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-card-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-card-action')) {
            const action = actionEl.dataset.cardAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;

        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';

        if (rowAction === 'edit') {
            const payload = actionEl.dataset.rowPayload;
            let data = payload ? decodePayload(payload) : null;
            // If no payload, create data from button attributes
            if (!data && rowId) {
                data = {
                    id: rowId,
                    name: rowName || null,
                };
            }
            if (!data || !data.id) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                return;
            }
            setFormMode('edit', data);
            openModal(modals.form);
            return;
        }

        if (rowAction === 'view') {
            const payload = actionEl.dataset.rowPayload;
            let data = payload ? decodePayload(payload) : null;
            // If no payload, create data from button attributes
            if (!data && rowId) {
                data = {
                    id: rowId,
                    name: rowName || null,
                };
            }
            if (!data || !data.id) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para mostrar.'), icon: 'error' });
                return;
            }
            populateViewModal(data);
            openModal(modals.view);
            return;
        }

        if (rowAction === 'delete') {
            if (!rowId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                return;
            }
            if (modals.delete) {
                modals.delete.dataset.cardId = rowId;
            }
            if (deleteName) {
                deleteName.textContent = rowName || rowId;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) {
            return;
        }
        if (target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initBankAccountsModule = () => {
    const root = document.querySelector('[data-bank-accounts-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.bankAccountsTableId ?? '';
    const baseUrl = root.dataset.bankAccountsBaseUrl ?? '';
    const storeUrl = root.dataset.bankAccountsStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const typeLabels = (() => {
        try {
            return JSON.parse(root.dataset.bankAccountsTypeLabels ?? '{}');
        } catch (error) {
            console.error('[BankAccounts] Error parsing type labels', error);
            return {};
        }
    })();

    const modals = {
        form: root.querySelector('[data-bank-account-modal="form"]'),
        view: root.querySelector('[data-bank-account-modal="view"]'),
        delete: root.querySelector('[data-bank-account-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-bank-account-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-bank-account-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-bank-account-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-bank-account-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-bank-account-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-bank-account-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-bank-account-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-bank-account-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-bank-account-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-bank-account-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-bank-account-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-bank-account-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            const selectRoot = input.closest('[data-select]');
            if (selectRoot) {
                selectRoot.dataset.selectInvalid = 'false';
                const trigger = selectRoot.querySelector('[data-select-trigger]');
                trigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-bank-account-error="${field}"]`);
            const inputEl = form.querySelector(`[data-bank-account-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                const selectRoot = inputEl.closest('[data-select]');
                if (selectRoot) {
                    selectRoot.dataset.selectInvalid = 'true';
                    const trigger = selectRoot.querySelector('[data-select-trigger]');
                    trigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-bank-account-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        } else if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
        syncCustomSelectDisplay(input);
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-bank-account-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLSelectElement) {
            return input.value;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const syncCustomSelectDisplay = (input) => {
        if (!(input instanceof HTMLInputElement)) {
            return;
        }
        const selectRoot = input.closest('[data-select]');
        if (!selectRoot) {
            return;
        }
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const options = Array.from(selectRoot.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';

        let label = placeholder;
        options.forEach((option) => {
            const isSelected = option.dataset.value === input.value && input.value !== '';
            option.dataset.selected = isSelected ? 'true' : 'false';
            if (isSelected) {
                label = option.dataset.label ?? option.textContent.trim();
            }
        });

        if (valueLabel) {
            valueLabel.textContent = input.value ? label : placeholder;
        }
        trigger?.classList.toggle('is-empty', !input.value);
    };

    const closeSelect = (selectRoot) => {
        if (!selectRoot) {
            return;
        }
        const dropdown = selectRoot.querySelector('[data-select-dropdown]');
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const icon = selectRoot.querySelector('[data-select-icon]');
        if (dropdown && !dropdown.hasAttribute('hidden')) {
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
            selectRoot.dataset.open = 'false';
        }
        trigger?.setAttribute('aria-expanded', 'false');
        icon?.classList.remove('rotate-180');
    };

    const renderCategoryOptions = (options = categoryOptions) => {
        if (!categoryOptionsContainer || !(categoryInput instanceof HTMLInputElement)) {
            return;
        }

        categoryOptionsContainer.innerHTML = '';
        if (!Array.isArray(options) || options.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'px-4 py-2 text-sm text-gray-500 dark:text-gray-300';
            emptyState.textContent = tx('No hay categorías disponibles.');
            categoryOptionsContainer.appendChild(emptyState);
            categoryInput.value = '';
            syncCustomSelectDisplay(categoryInput);
            return;
        }

        const selectRoot = categoryInput.closest('[data-select]');

        options.forEach((option) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = option.id ?? '';
            button.dataset.label = option.name ?? '';
            button.dataset.selected = categoryInput.value === (option.id ?? '') ? 'true' : 'false';
            button.innerHTML = `<span class="truncate">${option.name ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setFieldValue('category_id', option.id ?? '');
                closeSelect(selectRoot);
                selectRoot?.querySelector('[data-select-trigger]')?.focus({ preventScroll: true });
            });
            categoryOptionsContainer.appendChild(button);
        });

        syncCustomSelectDisplay(categoryInput);
    };

    const loadCategoryOptions = async () => {
        if (!categoryOptionsUrl) {
            renderCategoryOptions(categoryOptions);
            return categoryOptions;
        }

        try {
            const response = await fetch(categoryOptionsUrl, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json().catch(() => null);
            if (!response.ok || !json?.data?.items) {
                throw new Error('Invalid response');
            }
            categoryOptions = json.data.items ?? [];
        } catch (error) {
            console.error('[Customers] Error loading categories options', error);
        } finally {
            renderCategoryOptions(categoryOptions);
        }

        return categoryOptions;
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const translateAccountType = (value) => typeLabels?.[value] ?? value ?? '-';

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.bankAccountId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            const accountTypeInput = form.querySelector('[data-bank-account-input="account_type"]');
            if (accountTypeInput instanceof HTMLInputElement || accountTypeInput instanceof HTMLSelectElement) {
                accountTypeInput.value = '';
                syncCustomSelectDisplay(accountTypeInput);
            }
            if (modalTitle) {
                modalTitle.textContent = 'Nueva cuenta de banco';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar cuenta de banco';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('bank_name', data.bank_name ?? '');
            setFieldValue('account_number', data.account_number ?? '');
            setFieldValue('account_type', data.account_type ?? '');
            setFieldValue('account_holder_name', data.account_holder_name ?? '');
            setFieldValue('alias', data.alias ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-bank-account-view-field]').forEach((element) => {
            const field = element.getAttribute('data-bank-account-view-field');
            if (!field) {
                return;
            }
            let value = data[field];
            if (field === 'account_type_label') {
                value = translateAccountType(data.account_type ?? '') ?? data.account_type_label ?? '-';
            }
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const accountId = form.dataset.bankAccountId ?? '';

        const payload = {
            bank_name: getFieldValue('bank_name'),
            account_number: getFieldValue('account_number'),
            account_type: getFieldValue('account_type'),
            account_holder_name: getFieldValue('account_holder_name'),
            alias: getFieldValue('alias') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.bank_name) {
            validationErrors.bank_name = tx('El nombre del banco es obligatorio.');
        }
        if (!payload.account_number) {
            validationErrors.account_number = tx('El número de cuenta es obligatorio.');
        } else if (!/^[A-Za-z0-9\-\s]{4,}$/.test(payload.account_number)) {
            validationErrors.account_number = tx('El número de cuenta debe tener al menos 4 caracteres válidos.');
        }
        if (!payload.account_type) {
            validationErrors.account_type = tx('Selecciona un tipo de cuenta.');
        }
        if (!payload.account_holder_name) {
            validationErrors.account_holder_name = tx('El titular es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${accountId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[BankAccounts] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const accountId = modals.delete.dataset.bankAccountId;
        if (!accountId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${accountId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[BankAccounts] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const accountId = input.dataset.id ?? '';
        if (!accountId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${accountId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[BankAccounts] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-bank-account-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute('data-bank-account-action')) {
            const action = actionEl.dataset.bankAccountAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        // If no payload, create data from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                bank_name: rowName || null,
            };
        }

        if (!rowAction || !data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[BankAccounts] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                populateViewModal(data);
                openModal(modals.view);
            }
            return;
        }

        if (rowAction === 'edit') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[BankAccounts] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                setFormMode('edit', data);
                openModal(modals.form);
            }
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.bankAccountId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.bank_name || data.alias || data.account_number || data.id;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initIncomeTypesModule = () => {
    const root = document.querySelector('[data-income-types-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.incomeTypesTableId ?? '';
    const baseUrl = root.dataset.incomeTypesBaseUrl ?? '';
    const storeUrl = root.dataset.incomeTypesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-income-type-modal="form"]'),
        view: root.querySelector('[data-income-type-modal="view"]'),
        delete: root.querySelector('[data-income-type-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-income-type-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-income-type-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-income-type-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-income-type-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-income-type-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-income-type-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-income-type-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-income-type-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-income-type-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-income-type-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-income-type-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-income-type-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-income-type-error="${field}"]`);
            const inputEl = form.querySelector(`[data-income-type-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-income-type-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-income-type-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.incomeTypeId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nuevo tipo de ingreso';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar tipo de ingreso';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('code', data.code ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-income-type-view-field]').forEach((element) => {
            const field = element.getAttribute('data-income-type-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const incomeTypeId = form.dataset.incomeTypeId ?? '';

        const payload = {
            code: getFieldValue('code'),
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.code) {
            validationErrors.code = tx('El código es obligatorio.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${incomeTypeId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[IncomeTypes] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const incomeTypeId = modals.delete.dataset.incomeTypeId;
        if (!incomeTypeId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${incomeTypeId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[IncomeTypes] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const incomeTypeId = input.dataset.id ?? '';
        if (!incomeTypeId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${incomeTypeId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[IncomeTypes] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-income-type-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute('data-income-type-action')) {
            const action = actionEl.dataset.incomeTypeAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        if (!rowId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch income type data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    populateViewModal(json.data.item);
                    openModal(modals.view);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[IncomeTypes] Error loading view data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'edit') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch income type data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    setFormMode('edit', json.data.item);
                    openModal(modals.form);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[IncomeTypes] Error loading edit data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'delete') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch income type data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    const incomeTypeName = json.data.item.name ?? json.data.item.code ?? '';
                    if (modals.delete) {
                        modals.delete.dataset.incomeTypeId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = incomeTypeName;
                    }
                    openModal(modals.delete);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[IncomeTypes] Error loading delete data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
            }
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initExpenseTypesModule = () => {
    const root = document.querySelector('[data-expense-types-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.expenseTypesTableId ?? '';
    const baseUrl = root.dataset.expenseTypesBaseUrl ?? '';
    const storeUrl = root.dataset.expenseTypesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-expense-type-modal="form"]'),
        view: root.querySelector('[data-expense-type-modal="view"]'),
        delete: root.querySelector('[data-expense-type-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-expense-type-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-expense-type-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-expense-type-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-expense-type-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-expense-type-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-expense-type-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-expense-type-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-expense-type-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-expense-type-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-expense-type-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-expense-type-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-expense-type-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-expense-type-error="${field}"]`);
            const inputEl = form.querySelector(`[data-expense-type-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-expense-type-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-expense-type-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.expenseTypeId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nuevo tipo de egreso';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar tipo de egreso';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('code', data.code ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-expense-type-view-field]').forEach((element) => {
            const field = element.getAttribute('data-expense-type-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const expenseTypeId = form.dataset.expenseTypeId ?? '';

        const payload = {
            code: getFieldValue('code'),
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.code) {
            validationErrors.code = tx('El código es obligatorio.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${expenseTypeId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[ExpenseTypes] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const expenseTypeId = modals.delete.dataset.expenseTypeId;
        if (!expenseTypeId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${expenseTypeId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[ExpenseTypes] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const expenseTypeId = input.dataset.id ?? '';
        if (!expenseTypeId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${expenseTypeId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[ExpenseTypes] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-expense-type-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute('data-expense-type-action')) {
            const action = actionEl.dataset.expenseTypeAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        if (!rowId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch expense type data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    populateViewModal(json.data.item);
                    openModal(modals.view);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[ExpenseTypes] Error loading view data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'edit') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch expense type data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    setFormMode('edit', json.data.item);
                    openModal(modals.form);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[ExpenseTypes] Error loading edit data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'delete') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch expense type data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    const expenseTypeName = json.data.item.name ?? json.data.item.code ?? '';
                    if (modals.delete) {
                        modals.delete.dataset.expenseTypeId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = expenseTypeName;
                    }
                    openModal(modals.delete);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[ExpenseTypes] Error loading delete data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
            }
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initReceivableCategoriesModule = () => {
    console.log('🔵 [ReceivableCategories] Module initialization started');
    const roots = document.querySelectorAll('[data-receivable-categories-root]');
    console.log('🔵 [ReceivableCategories] Found roots', { count: roots.length, roots: Array.from(roots) });
    
    document.querySelectorAll('[data-receivable-categories-root]').forEach((root, index) => {
        console.log(`🔵 [ReceivableCategories] Initializing root ${index + 1}`, { root, attributes: Array.from(root.attributes).map(attr => ({ name: attr.name, value: attr.value })) });

    const tableId = root.dataset.receivableCategoriesTableId ?? '';
    const baseUrl = root.dataset.receivableCategoriesBaseUrl ?? '';
    const storeUrl = root.dataset.receivableCategoriesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
        
        console.log('🔵 [ReceivableCategories] init - Configuration', { 
            tableId, 
            baseUrl, 
            storeUrl,
            csrfToken: csrfToken ? 'present' : 'missing',
            rootElement: root,
            allDataAttributes: Object.keys(root.dataset),
        });

    const modals = {
        form: root.querySelector('[data-receivable-category-modal="form"]'),
        view: root.querySelector('[data-receivable-category-modal="view"]'),
        delete: root.querySelector('[data-receivable-category-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-receivable-category-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-receivable-category-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-receivable-category-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-receivable-category-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-receivable-category-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-receivable-category-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-receivable-category-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-receivable-category-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-receivable-category-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-receivable-category-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-receivable-category-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-receivable-category-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-receivable-category-error="${field}"]`);
            const inputEl = form.querySelector(`[data-receivable-category-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-receivable-category-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-receivable-category-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.receivableCategoryId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = tx('Nueva categoría');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar categoría');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            setFieldValue('code', data.code ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-receivable-category-view-field]').forEach((element) => {
            const field = element.getAttribute('data-receivable-category-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const categoryId = form.dataset.receivableCategoryId ?? '';

        const payload = {
            code: getFieldValue('code'),
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.code) {
            validationErrors.code = tx('El código es obligatorio.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${categoryId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[ReceivableCategories] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const categoryId = modals.delete.dataset.receivableCategoryId;
        if (!categoryId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${categoryId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[ReceivableCategories] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const categoryId = input.dataset.id ?? '';
        if (!categoryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${categoryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[ReceivableCategories] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        console.log('🔵 [ReceivableCategories] Click detected', {
            target: event.target,
            targetTagName: event.target?.tagName,
            targetClasses: event.target?.className,
            targetId: event.target?.id,
            targetDataset: event.target?.dataset,
        });

        // Find the action element, checking both the target and its parent
        let actionEl = null;
        if (event.target instanceof Element) {
            actionEl = event.target.closest('[data-receivable-category-action], [data-action], [data-row-action]');
            console.log('🔵 [ReceivableCategories] First closest search', { 
                found: !!actionEl,
                element: actionEl,
                tagName: actionEl?.tagName,
                classes: actionEl?.className,
            });
            
            // If not found and target is an icon, try the parent button
            if (!actionEl && (event.target.tagName === 'I' || event.target.classList.contains('fa'))) {
                actionEl = event.target.closest('button[data-action], button[data-row-action]');
                console.log('🔵 [ReceivableCategories] Second closest search (icon)', { 
                    found: !!actionEl,
                    element: actionEl,
                    tagName: actionEl?.tagName,
                });
            }
        }
        
        if (!actionEl || !root.contains(actionEl)) {
            console.log('🔵 [ReceivableCategories] No actionEl found or not in root, returning');
            return;
        }
        
        console.log('🔵 [ReceivableCategories] Final actionEl', {
            found: !!actionEl,
            element: actionEl,
            allAttributes: actionEl ? Array.from(actionEl.attributes).map(attr => ({ name: attr.name, value: attr.value })) : null,
            dataset: actionEl?.dataset,
        });

        if (actionEl.hasAttribute('data-receivable-category-action')) {
            const action = actionEl.dataset.receivableCategoryAction;
            console.log('🔵 [ReceivableCategories] Receivable category action', { action });
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        console.log('🔵 [ReceivableCategories] Row action extracted', {
            rowAction,
            dataAction: actionEl.dataset.action,
            dataRowAction: actionEl.dataset.rowAction,
        });
        
        if (!rowAction) {
            console.log('🔵 [ReceivableCategories] No rowAction found, returning');
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId || '').trim();
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        console.log('🔵 [ReceivableCategories] Action clicked - FULL DATA', {
            rowAction,
            rowId,
            rowName,
            hasPayload: !!payload,
            payload,
            data,
            baseUrl,
            csrfToken: csrfToken ? 'present' : 'missing',
            allDatasetKeys: Object.keys(actionEl.dataset),
            datasetId: actionEl.dataset.id,
            datasetRowId: actionEl.dataset.rowId,
        });

        if (!rowId) {
            console.error('🔴 [ReceivableCategories] Missing rowId', { 
                actionEl, 
                rowAction,
                allDatasetKeys: actionEl ? Object.keys(actionEl.dataset) : null,
                dataset: actionEl?.dataset,
            });
            showAlert({ title: tx('Error'), text: tx('No se pudo identificar el registro seleccionado.'), icon: 'error' });
            return;
        }

        // If no payload, fetch data from server using rowId
        if (!data && rowId) {
            console.log('🟡 [ReceivableCategories] No payload, will fetch from server', { rowId, rowAction, hasData: !!data });
            
            if (rowAction === 'view' || rowAction === 'edit') {
                if (!baseUrl) {
                    console.error('🔴 [ReceivableCategories] Missing baseUrl');
                    showAlert({ title: tx('Error'), text: tx('Error de configuración. Por favor, recarga la página.'), icon: 'error' });
            return;
        }
                const fetchUrl = `${baseUrl}/${rowId}`;
                console.log('🟢 [ReceivableCategories] Starting fetch', { 
                    fetchUrl, 
                    rowAction, 
                    rowId,
                    baseUrl,
                    method: 'GET',
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-TOKEN': csrfToken ? 'present' : 'missing',
                    },
                });
                
                fetch(fetchUrl, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                })
                    .then(async (response) => {
                        console.log('🟢 [ReceivableCategories] Response received (raw)', {
                            ok: response.ok,
                            status: response.status,
                            statusText: response.statusText,
                            headers: Object.fromEntries(response.headers.entries()),
                            url: response.url,
                        });
                        
                        const json = await response.json().catch((parseError) => {
                            console.error('🔴 [ReceivableCategories] JSON parse error', { parseError });
                            return null;
                        });
                        
                        console.log('🟢 [ReceivableCategories] Response JSON parsed', { json });
                        
                        if (!response.ok) {
                            console.error('🔴 [ReceivableCategories] Fetch failed - Response not OK', { 
                                status: response.status, 
                                statusText: response.statusText,
                                url: fetchUrl,
                                json,
                                responseHeaders: Object.fromEntries(response.headers.entries()),
                            });
                            const errorMessage = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                            showAlert({ title: tx('Error'), text: errorMessage, icon: 'error' });
                            return null;
                        }
                        return json;
                    })
                    .then((json) => {
                        console.log('🟢 [ReceivableCategories] Processing response', { 
                            hasJson: !!json,
                            json,
                            status: json?.status,
                            hasData: !!json?.data,
                            hasItem: !!json?.data?.item,
                            item: json?.data?.item,
                        });
                        
                        if (!json) {
                            console.log('🟡 [ReceivableCategories] No JSON to process');
                            return;
                        }
                        
                        if (json?.status === 'success' && json?.data?.item) {
                            console.log('✅ [ReceivableCategories] Success! Opening modal', { rowAction, data: json.data.item });
                            data = json.data.item;
                            if (rowAction === 'view') {
                                populateViewModal(data);
                            openModal(modals.view);
                            } else if (rowAction === 'edit') {
                                setFormMode('edit', data);
                                openModal(modals.form);
                            }
                        } else {
                            const errorMsg = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                            console.error('🔴 [ReceivableCategories] Invalid response format', { 
                                json, 
                                expected: 'status: success, data.item',
                                actualStatus: json?.status,
                                hasData: !!json?.data,
                                hasItem: !!json?.data?.item,
                            });
                            showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('🔴 [ReceivableCategories] Fetch error (catch)', { 
                            error, 
                            errorName: error.name,
                            errorMessage: error.message, 
                            errorStack: error.stack,
                            fetchUrl,
                        });
                        const errorMsg = error.message?.includes('Failed to fetch') 
                            ? tx('Error de conexión. Verifica tu conexión a internet.')
                            : tx('No se pudieron obtener los datos del registro.');
                        showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                    });
                return;
            } else if (rowAction === 'delete') {
                console.log('🟡 [ReceivableCategories] Delete action', { rowId, rowName });
                if (modals.delete) {
                    modals.delete.dataset.receivableCategoryId = rowId;
                }
                if (deleteName) {
                    deleteName.textContent = rowName || rowId;
                }
                openModal(modals.delete);
                return;
            }
        }

        // If we have data from payload, use it directly
        if (data && data.id) {
            if (rowAction === 'view') {
                populateViewModal(data);
                openModal(modals.view);
            return;
        }

        if (rowAction === 'edit') {
                setFormMode('edit', data);
                openModal(modals.form);
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.receivableCategoryId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.name || data.code || data.id;
            }
            openModal(modals.delete);
                return;
            }
        }

        // Fallback error
        if (rowAction !== 'delete') {
            console.error('🔴 [ReceivableCategories] No data available', { rowAction, rowId, hasData: !!data });
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
        });
    });
};
const initPayableCategoriesModule = () => {
    console.log('🟢 [PayableCategories] Module initialization started');
    const root = document.querySelector('[data-payable-categories-root]');
    if (!root) {
        console.log('🟢 [PayableCategories] Root element not found');
        return;
    }

    const tableId = root.dataset.payableCategoriesTableId ?? '';
    const baseUrl = root.dataset.payableCategoriesBaseUrl ?? '';
    const storeUrl = root.dataset.payableCategoriesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    
    console.log('🟢 [PayableCategories] init - Configuration', { 
        tableId, 
        baseUrl, 
        storeUrl,
        csrfToken: csrfToken ? 'present' : 'missing',
        rootElement: root,
        allDataAttributes: Object.keys(root.dataset),
    });

    const modals = {
        form: root.querySelector('[data-payable-category-modal="form"]'),
        view: root.querySelector('[data-payable-category-modal="view"]'),
        delete: root.querySelector('[data-payable-category-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-payable-category-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-payable-category-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-payable-category-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-payable-category-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-payable-category-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-payable-category-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-payable-category-delete-confirm]') ?? null;
    
    console.log('🟢 [PayableCategories] Elements initialized', {
        hasForm: !!form,
        hasSubmitButton: !!submitButton,
        hasSubmitLabel: !!submitLabel,
        hasModalTitle: !!modalTitle,
        hasViewContainer: !!viewContainer,
        hasDeleteName: !!deleteName,
        hasDeleteConfirmButton: !!deleteConfirmButton,
        modals: {
            form: !!modals.form,
            view: !!modals.view,
            delete: !!modals.delete,
        },
        viewContainerSelector: '[data-payable-category-view]',
        viewContainerElement: viewContainer,
    });

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-payable-category-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-payable-category-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-payable-category-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-payable-category-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-payable-category-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-payable-category-error="${field}"]`);
            const inputEl = form.querySelector(`[data-payable-category-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            console.error('🟢 [PayableCategories] setFieldValue - No form', { field, value });
            return;
        }
        const input = form.querySelector(`[data-payable-category-input="${field}"]`);
        if (!input) {
            console.error('🟢 [PayableCategories] setFieldValue - Input not found', { field, value, selector: `[data-payable-category-input="${field}"]` });
            return;
        }
        console.log('🟢 [PayableCategories] setFieldValue', { field, value, input, inputType: input.constructor.name });
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
            console.log('🟢 [PayableCategories] setFieldValue - Value set', { field, value, inputValue: input.value });
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-payable-category-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        console.log('🟢 [PayableCategories] setFormMode called', { mode, data, hasForm: !!form, hasSubmitButton: !!submitButton, hasSubmitLabel: !!submitLabel });
        
        if (!form || !submitButton || !submitLabel) {
            console.error('🟢 [PayableCategories] setFormMode - Missing required elements', { form, submitButton, submitLabel });
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.payableCategoryId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = tx('Nueva categoría');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar categoría');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            console.log('🟢 [PayableCategories] setFormMode - Populating form with data', { 
                data, 
                code: data.code, 
                name: data.name, 
                description: data.description, 
                status: data.status 
            });
            setFieldValue('code', data.code ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            console.log('🟢 [PayableCategories] setFormMode - No data provided');
        }
    };

    const populateViewModal = (data) => {
        console.log('🟢 [PayableCategories] populateViewModal called', { data, viewContainer, hasViewContainer: !!viewContainer });
        if (!viewContainer || !data) {
            console.error('🟢 [PayableCategories] populateViewModal - Missing viewContainer or data', { viewContainer, data });
            return;
        }
        
        const fields = viewContainer.querySelectorAll('[data-payable-category-view-field]');
        console.log('🟢 [PayableCategories] populateViewModal - Found fields', { count: fields.length, fields: Array.from(fields).map(el => ({
            field: el.getAttribute('data-payable-category-view-field'),
            element: el
        })) });
        
        fields.forEach((element) => {
            const field = element.getAttribute('data-payable-category-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            console.log('🟢 [PayableCategories] populateViewModal - Setting field', { field, value, dataField: data[field] });
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const categoryId = form.dataset.payableCategoryId ?? '';

        const payload = {
            code: getFieldValue('code'),
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.code) {
            validationErrors.code = tx('El código es obligatorio.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${categoryId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';
        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[PayableCategories] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const categoryId = modals.delete.dataset.payableCategoryId;
        if (!categoryId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${categoryId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[PayableCategories] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const categoryId = input.dataset.id ?? '';
        if (!categoryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${categoryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[PayableCategories] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        console.log('🟢 [PayableCategories] Click detected', { target: event.target, tagName: event.target?.tagName });
        
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-payable-category-action], [data-action], [data-row-action]')
            : null;
        
        console.log('🟢 [PayableCategories] Action element found', { 
            actionEl, 
            hasAction: !!actionEl,
            isInRoot: actionEl ? root.contains(actionEl) : false,
            attributes: actionEl ? Array.from(actionEl.attributes).map(attr => ({ name: attr.name, value: attr.value })) : []
        });
        
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute('data-payable-category-action')) {
            const action = actionEl.dataset.payableCategoryAction;
            console.log('🟢 [PayableCategories] Category action detected', { action });
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        console.log('🟢 [PayableCategories] Row action data', { 
            rowAction, 
            rowId, 
            rowName, 
            hasPayload: !!payload,
            decodedData: data,
            allDataset: Object.keys(actionEl.dataset).reduce((acc, key) => {
                acc[key] = actionEl.dataset[key];
                return acc;
            }, {})
        });

        // If no payload, create data from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                name: rowName || null,
                code: actionEl.dataset.rowCode ?? null,
            };
            console.log('🟢 [PayableCategories] Created data from attributes', { data });
        }

        if (!rowAction || !data || !data.id) {
            console.error('🟢 [PayableCategories] Missing required data', { rowAction, rowId, hasData: !!data, dataId: data?.id });
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            console.log('🟢 [PayableCategories] View action', { data, dataKeys: Object.keys(data || {}), dataLength: Object.keys(data || {}).length });
            
            // Always fetch full data from server to ensure we have all fields
            const fetchUrl = `${baseUrl}/${data.id}`;
            console.log('🟢 [PayableCategories] Fetching view data', { url: fetchUrl, dataId: data.id });
            
            fetch(fetchUrl, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then((response) => {
                    console.log('🟢 [PayableCategories] View fetch response', { 
                        ok: response.ok, 
                        status: response.status, 
                        statusText: response.statusText 
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                    .then((json) => {
                    console.log('🟢 [PayableCategories] View fetch JSON', { json, hasItem: !!json?.data?.item, item: json?.data?.item });
                    if (json?.status === 'success' && json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                        console.error('🟢 [PayableCategories] Invalid response structure', { json });
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                    console.error('🟢 [PayableCategories] View fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            return;
        }

        if (rowAction === 'edit') {
            console.log('🟢 [PayableCategories] Edit action', { data, dataKeys: Object.keys(data || {}), dataLength: Object.keys(data || {}).length });
            
            // Always fetch full data from server to ensure we have all fields
            const fetchUrl = `${baseUrl}/${data.id}`;
            console.log('🟢 [PayableCategories] Fetching edit data', { url: fetchUrl, dataId: data.id });
            
            fetch(fetchUrl, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then((response) => {
                    console.log('🟢 [PayableCategories] Edit fetch response', { 
                        ok: response.ok, 
                        status: response.status, 
                        statusText: response.statusText 
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                    .then((json) => {
                    console.log('🟢 [PayableCategories] Edit fetch JSON', { json, hasItem: !!json?.data?.item, item: json?.data?.item });
                    if (json?.status === 'success' && json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                        console.error('🟢 [PayableCategories] Invalid response structure', { json });
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                    console.error('🟢 [PayableCategories] Edit fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            return;
        }

        if (rowAction === 'delete') {
            console.log('🟢 [PayableCategories] Delete action', { dataId: data.id, rowName });
            if (modals.delete) {
                modals.delete.dataset.payableCategoryId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.name || data.code || data.id;
            }
            openModal(modals.delete);
            return;
        }

        // Fallback error
        if (rowAction !== 'delete') {
            console.error('🟢 [PayableCategories] No data available', { rowAction, rowId, hasData: !!data });
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initFinanceModule = (entity, config = {}) => {
    const pluralMap = {
        income: 'incomes',
        expense: 'expenses',
        receivable: 'receivables',
        payable: 'payables',
    };

    const plural = config.plural ?? pluralMap[entity] ?? `${entity}s`;
    const root = document.querySelector(`[data-${plural}-root]`);
    if (!root) {
        return;
    }

    const tableId = root.dataset[`${plural}TableId`] ?? '';
    const baseUrl = root.dataset[`${plural}BaseUrl`] ?? '';
    const storeUrl = root.dataset[`${plural}StoreUrl`] ?? baseUrl;
    const optionsUrl = root.dataset[`${plural}OptionsUrl`] ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    let typeOptions = [];
    try {
        typeOptions = JSON.parse(root.dataset[`${plural}Types`] ?? '[]') ?? [];
    } catch (error) {
        console.warn(`[${entity}] Invalid type options JSON`, error);
        typeOptions = [];
    }

    const defaultConfigByEntity = {
        income: {
            typeField: 'income_type_id',
            typeNameField: 'income_type_name',
            statusField: 'status',
            settlementField: 'status',
            settlementEndpoint: (id) => `${baseUrl}/${id}/status`,
            settlementPayload: (value) => ({ status: value ? 'A' : 'I' }),
            settlementMessages: {
                true: tx('El ingreso se activó correctamente.'),
                false: tx('El ingreso se desactivó correctamente.'),
            },
            entityTitle: tx('ingreso'),
            createTitle: tx('Nuevo ingreso'),
            editTitle: tx('Editar ingreso'),
            messages: {
                created: tx('El ingreso se registró correctamente.'),
                updated: tx('El ingreso se actualizó correctamente.'),
                deleted: tx('El ingreso se eliminó correctamente.'),
                toggled: tx('El estado se modificó correctamente.'),
            },
            typeSelectionMessage: tx('Selecciona una categoría de ingreso.'),
            defaultStatusValue: 'A',
            currencyCode: 'USD',
        },
        expense: {
            typeField: 'expense_type_id',
            typeNameField: 'expense_type_name',
            statusField: 'status',
            settlementField: 'status',
            settlementEndpoint: (id) => `${baseUrl}/${id}/status`,
            settlementPayload: (value) => ({ status: value ? 'A' : 'I' }),
            settlementMessages: {
                true: tx('El egreso se activó correctamente.'),
                false: tx('El egreso se desactivó correctamente.'),
            },
            entityTitle: tx('egreso'),
            createTitle: tx('Nuevo egreso'),
            editTitle: tx('Editar egreso'),
            messages: {
                created: tx('El egreso se registró correctamente.'),
                updated: tx('El egreso se actualizó correctamente.'),
                deleted: tx('El egreso se eliminó correctamente.'),
                toggled: tx('El estado se modificó correctamente.'),
            },
            typeSelectionMessage: tx('Selecciona una categoría de egreso.'),
            defaultStatusValue: 'A',
            currencyCode: 'USD',
        },
        receivable: {
            typeField: 'receivable_category_id',
            typeNameField: 'receivable_category_name',
            statusField: null,
            settlementField: 'is_collected',
            settlementEndpoint: (id) => `${baseUrl}/${id}/settlement`,
            settlementPayload: (value) => ({ is_collected: value }),
            settlementMessages: {
                true: tx('La cuenta por cobrar fue marcada como cobrada.'),
                false: tx('La cuenta por cobrar fue marcada como pendiente.'),
            },
            entityTitle: tx('cuenta por cobrar'),
            createTitle: tx('Nueva cuenta por cobrar'),
            editTitle: tx('Editar cuenta por cobrar'),
            messages: {
                created: tx('La cuenta por cobrar se registró correctamente.'),
                updated: tx('La cuenta por cobrar se actualizó correctamente.'),
                deleted: tx('La cuenta por cobrar se eliminó correctamente.'),
                toggled: tx('El estado se modificó correctamente.'),
            },
            typeSelectionMessage: tx('Selecciona una categoría de cobro.'),
            defaultStatusValue: null,
            currencyCode: 'USD',
        },
        payable: {
            typeField: 'payable_category_id',
            typeNameField: 'payable_category_name',
            statusField: null,
            settlementField: 'is_paid',
            settlementEndpoint: (id) => `${baseUrl}/${id}/settlement`,
            settlementPayload: (value) => ({ is_paid: value }),
            settlementMessages: {
                true: tx('La cuenta por pagar fue marcada como pagada.'),
                false: tx('La cuenta por pagar fue marcada como pendiente.'),
            },
            entityTitle: tx('cuenta por pagar'),
            createTitle: tx('Nueva cuenta por pagar'),
            editTitle: tx('Editar cuenta por pagar'),
            messages: {
                created: tx('La cuenta por pagar se registró correctamente.'),
                updated: tx('La cuenta por pagar se actualizó correctamente.'),
                deleted: tx('La cuenta por pagar se eliminó correctamente.'),
                toggled: tx('El estado se modificó correctamente.'),
            },
            typeSelectionMessage: tx('Selecciona una categoría de pago.'),
            defaultStatusValue: null,
            currencyCode: 'USD',
        },
    };

    const entityDefaults = defaultConfigByEntity[entity] ?? {};

    const typeField = config.typeField ?? entityDefaults.typeField ?? `${entity}_type_id`;
    const typeNameField = config.typeNameField ?? entityDefaults.typeNameField ?? `${entity}_type_name`;
    const statusField = config.statusField ?? entityDefaults.statusField ?? null;
    const settlementField = config.settlementField ?? entityDefaults.settlementField ?? statusField;
    const defaultStatusValue = config.defaultStatusValue ?? entityDefaults.defaultStatusValue ?? 'A';
    const currencyCode = config.currencyCode ?? entityDefaults.currencyCode ?? 'USD';
    const entityTitle = config.entityTitle ?? entityDefaults.entityTitle ?? entity;
    const typeSelectionMessage = config.typeSelectionMessage ?? entityDefaults.typeSelectionMessage ?? tx('Selecciona una categoría.');

    const settlementEndpointBuilder = config.settlementEndpoint
        ?? entityDefaults.settlementEndpoint
        ?? ((id) => `${baseUrl}/${id}/status`);

    const settlementPayloadBuilder = config.settlementPayload
        ?? entityDefaults.settlementPayload
        ?? ((value) => ({ status: value ? 'A' : 'I' }));

    const baseMessages = entityDefaults.messages ?? {};
    const successMessages = {
        created: config.messages?.created ?? baseMessages.created ?? tx('El registro se creó correctamente.'),
        updated: config.messages?.updated ?? baseMessages.updated ?? tx('El registro se actualizó correctamente.'),
        deleted: config.messages?.deleted ?? baseMessages.deleted ?? tx('El registro se eliminó correctamente.'),
        toggled: config.messages?.toggled ?? baseMessages.toggled ?? tx('El estado se modificó correctamente.'),
    };

    const settlementMessages = {
        true: config.settlementMessages?.true ?? entityDefaults.settlementMessages?.true ?? successMessages.toggled,
        false: config.settlementMessages?.false ?? entityDefaults.settlementMessages?.false ?? successMessages.toggled,
    };

    const modals = {
        form: root.querySelector(`[data-${entity}-modal="form"]`),
        view: root.querySelector(`[data-${entity}-modal="view"]`),
        delete: root.querySelector(`[data-${entity}-modal="delete"]`),
    };

    const form = modals.form?.querySelector(`[data-${entity}-form]`) ?? null;
    const submitButton = modals.form?.querySelector(`[data-${entity}-submit]`) ?? null;
    const submitLabel = submitButton?.querySelector(`[data-${entity}-submit-label]`) ?? null;
    const modalTitle = modals.form?.querySelector(`[data-${entity}-modal-title]`) ?? null;
    const viewContainer = modals.view?.querySelector(`[data-${entity}-view]`) ?? modals.view;
    const deleteConcept = modals.delete?.querySelector(`[data-${entity}-delete-concept]`) ?? null;
    const deleteConfirmButton = modals.delete?.querySelector(`[data-${entity}-delete-confirm]`) ?? null;
    const amountCurrencyBadge = form?.querySelector(`[data-${entity}-amount-currency]`) ?? null;
    const typeSelectRoot = form?.querySelector(`[data-select-name="${typeField}"]`) ?? null;
    const typeHiddenInput = form?.querySelector(`[data-${entity}-input="${typeField}"]`) ?? null;
    const typeOptionsContainer = typeSelectRoot?.querySelector(`[data-${entity}-type-options]`) ?? null;
    const typeTrigger = typeSelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const typeValueLabel = typeSelectRoot?.querySelector('[data-select-value]') ?? null;
    const typeDropdown = typeSelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const typeIcon = typeSelectRoot?.querySelector('[data-select-icon]') ?? null;
    const typePlaceholder = typeTrigger?.dataset.selectPlaceholder ?? '';

    const bodyOverflowClass = 'overflow-hidden';
    const modalTitles = {
        create: config.createTitle ?? entityDefaults.createTitle ?? (entity === 'income' ? tx('Nuevo ingreso') : entity === 'expense' ? tx('Nuevo egreso') : tx('Nuevo registro')),
        edit: config.editTitle ?? entityDefaults.editTitle ?? (entity === 'income' ? tx('Editar ingreso') : entity === 'expense' ? tx('Editar egreso') : tx('Editar registro')),
    };

    const getEventTargetModal = (target) => target.closest(`[data-${entity}-modal]`);

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector(`[data-${entity}-modal]:not(.hidden)`)) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll(`[data-${entity}-modal-close]`).forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const getFieldElements = (field) => {
        const input = form?.querySelector(`[data-${entity}-input="${field}"]`) ?? null;
        const errorEl = form?.querySelector(`[data-${entity}-error="${field}"]`) ?? null;
        const selectRoot = input instanceof HTMLInputElement ? input.closest('[data-select]') : null;
        const trigger = selectRoot?.querySelector('[data-select-trigger]') ?? null;

        return { input, errorEl, selectRoot, trigger };
    };

    const clearFieldError = (field) => {
        const { input, errorEl, selectRoot, trigger } = getFieldElements(field);
        if (errorEl) {
            errorEl.textContent = '';
        }
        if (input instanceof HTMLInputElement && input.type !== 'hidden') {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        if (input instanceof HTMLSelectElement || input instanceof HTMLTextAreaElement) {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        if (selectRoot) {
            selectRoot.dataset.selectInvalid = 'false';
            trigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const { input, errorEl, selectRoot, trigger } = getFieldElements(field);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (input instanceof HTMLInputElement && input.type !== 'hidden') {
                input.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
            if (input instanceof HTMLSelectElement || input instanceof HTMLTextAreaElement) {
                input.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
            if (selectRoot) {
                selectRoot.dataset.selectInvalid = 'true';
                trigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll(`[data-${entity}-error]`).forEach((el) => {
            el.textContent = '';
        });
        form.querySelectorAll(`[data-${entity}-input]`).forEach((input) => {
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
        form.querySelectorAll('[data-select]').forEach((selectRoot) => {
            selectRoot.dataset.selectInvalid = 'false';
            selectRoot.querySelector('[data-select-trigger]')?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const syncCustomSelectDisplay = (input) => {
        if (!(input instanceof HTMLInputElement)) {
            return;
        }
        const selectRoot = input.closest('[data-select]');
        if (!selectRoot) {
            return;
        }

        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const options = Array.from(selectRoot.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';

        let label = placeholder;
        options.forEach((option) => {
            const isSelected = option.dataset.value === input.value && input.value !== '';
            option.dataset.selected = isSelected ? 'true' : 'false';
            if (isSelected) {
                label = option.dataset.label ?? option.textContent.trim();
            }
        });

        if (valueLabel) {
            valueLabel.textContent = input.value ? label : placeholder;
        }
        trigger?.classList.toggle('is-empty', !input.value);
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-${entity}-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
        if (input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
        if (input instanceof HTMLInputElement && input.type === 'hidden') {
            syncCustomSelectDisplay(input);
        }
    };

    const setBooleanField = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-${entity}-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement && input.type === 'checkbox') {
            input.checked = Boolean(value);
        } else if (input instanceof HTMLInputElement) {
            input.value = value ? '1' : '0';
            if (input.type === 'hidden') {
                syncCustomSelectDisplay(input);
            }
        } else if (input instanceof HTMLSelectElement) {
            input.value = value ? '1' : '0';
        }
    };

    const getBooleanField = (field) => {
        if (!form) {
            return false;
        }
        const input = form.querySelector(`[data-${entity}-input="${field}"]`);
        if (!input) {
            return false;
        }
        if (input instanceof HTMLInputElement && input.type === 'checkbox') {
            return input.checked;
        }
        if (input instanceof HTMLInputElement) {
            return input.value === '1' || input.value === 'true';
        }
        if (input instanceof HTMLSelectElement) {
            return input.value === '1' || input.value === 'true';
        }
        return false;
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-${entity}-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const closeTypeDropdown = () => {
        if (!typeSelectRoot || !typeDropdown) {
            return;
        }
        typeDropdown.hidden = true;
        typeDropdown.dataset.open = 'false';
        typeSelectRoot.dataset.open = 'false';
        typeTrigger?.setAttribute('aria-expanded', 'false');
        typeIcon?.classList.remove('rotate-180');
    };

    const renderTypeOptions = (options) => {
        if (!typeOptionsContainer) {
            return;
        }
        typeOptionsContainer.innerHTML = '';
        options.forEach((option) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-800 transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.setAttribute('role', 'option');
            button.dataset.selectOption = '';
            button.dataset.value = option.id ?? '';
            button.dataset.label = option.label ?? '';
            button.dataset.selected = 'false';
            button.innerHTML = `<span class="truncate">${option.label ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                if (typeHiddenInput instanceof HTMLInputElement) {
                    typeHiddenInput.value = option.id ?? '';
                    syncCustomSelectDisplay(typeHiddenInput);
                    typeHiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
                typeSelectRoot?.setAttribute('data-select-invalid', 'false');
                typeTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                closeTypeDropdown();
                typeTrigger?.focus({ preventScroll: true });
            });
            typeOptionsContainer.appendChild(button);
        });

        const typeHiddenInput = form?.querySelector(`[data-${entity}-input="${typeField}"]`);
        if (typeHiddenInput instanceof HTMLInputElement) {
            syncCustomSelectDisplay(typeHiddenInput);
        }
    };

    const fetchTypeOptions = async () => {
        if (!optionsUrl) {
            renderTypeOptions(typeOptions);
            return;
        }

        try {
            const response = await fetch(optionsUrl, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json().catch(() => null);

            if (!response.ok || !json?.data?.items) {
                throw new Error('Invalid response');
            }

            typeOptions = json.data.items;
            renderTypeOptions(typeOptions);
        } catch (error) {
            console.error(`[${entity}] Error loading type options`, error);
            renderTypeOptions(typeOptions);
        }
    };

    renderTypeOptions(typeOptions);

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll(`[data-${entity}-view-field]`).forEach((element) => {
            const field = element.getAttribute(`data-${entity}-view-field`);
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.entryId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            if (statusField) {
                setFieldValue(statusField, defaultStatusValue ?? 'A');
            }
            if (settlementField && (!statusField || settlementField !== statusField)) {
                setBooleanField(settlementField, false);
            }
            setFieldValue(typeField, '');
            if (modalTitle) {
                modalTitle.textContent = modalTitles.create;
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');

            const today = new Date().toISOString().slice(0, 10);
            setFieldValue('movement_date', today);
            setFieldValue('amount', '');
            if (amountCurrencyBadge) {
                amountCurrencyBadge.textContent = currencyCode;
            }
            
            // Inicializar campo de estado en modo creación (pendiente por defecto para receivables y payables)
            if (settlementField && (!statusField || settlementField !== statusField)) {
                setBooleanField(settlementField, false);
                // Actualizar el select de estado para mostrar "Pendiente"
                const statusSelectRoot = form?.querySelector(`[data-select-name="${settlementField}"]`);
                if (statusSelectRoot) {
                    const statusHiddenInput = statusSelectRoot?.querySelector('input[type="hidden"]');
                    if (statusHiddenInput) {
                        statusHiddenInput.value = '0';
                        syncCustomSelectDisplay(statusHiddenInput);
                    }
                }
            }
            
            fetchTypeOptions();
        } else {
            if (modalTitle) {
                modalTitle.textContent = modalTitles.edit;
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            if (data[typeField] && !typeOptions.some((option) => option.id === data[typeField])) {
                typeOptions = [
                    ...typeOptions,
                    {
                        id: data[typeField],
                        label: data[typeNameField] ?? data.type_name ?? data.concept ?? data.reference ?? data[typeField],
                    },
                ];
                renderTypeOptions(typeOptions);
            }

            setFieldValue(typeField, data[typeField] ?? '');
            setFieldValue('movement_date', data.movement_date ?? '');
            setFieldValue('concept', data.concept ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('reference', data.reference ?? '');
            const amountDecimal = typeof data.amount_cents === 'number' ? (data.amount_cents / 100).toFixed(2) : '';
            setFieldValue('amount', amountDecimal);
            if (statusField) {
                setFieldValue(statusField, data[statusField] ?? defaultStatusValue ?? 'A');
            }
            if (settlementField && (!statusField || settlementField !== statusField) && Object.prototype.hasOwnProperty.call(data, settlementField)) {
                setBooleanField(settlementField, data[settlementField]);
                // Actualizar el select de estado para mostrar el valor correcto
                const statusSelectRoot = form?.querySelector(`[data-select-name="${settlementField}"]`);
                if (statusSelectRoot) {
                    const statusHiddenInput = statusSelectRoot?.querySelector('input[type="hidden"]');
                    if (statusHiddenInput) {
                        statusHiddenInput.value = data[settlementField] ? '1' : '0';
                        syncCustomSelectDisplay(statusHiddenInput);
                    }
                }
            }
            if (amountCurrencyBadge) {
                amountCurrencyBadge.textContent = data.currency_code ?? currencyCode;
            }
            syncCustomSelectDisplay(form.querySelector(`[data-${entity}-input="${typeField}"]`));
            fetchTypeOptions();
        } else {
            syncCustomSelectDisplay(form.querySelector(`[data-${entity}-input="${typeField}"]`));
        }
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const entryId = form.dataset.entryId ?? '';

        const payload = {
            [typeField]: getFieldValue(typeField),
            movement_date: getFieldValue('movement_date'),
            concept: getFieldValue('concept'),
            description: getFieldValue('description') || null,
            reference: getFieldValue('reference') || null,
            amount: getFieldValue('amount'),
            currency_code: currencyCode,
        };

        if (statusField) {
            const selectedStatus = getFieldValue(statusField);
            payload[statusField] = (selectedStatus === undefined || selectedStatus === null || selectedStatus === '')
                ? (defaultStatusValue ?? 'A')
                : selectedStatus;
        }

        if (settlementField && (!statusField || settlementField !== statusField)) {
            payload[settlementField] = getBooleanField(settlementField);
        }

        clearFormErrors();

        const validationErrors = {};

        if (!payload[typeField]) {
            validationErrors[typeField] = typeSelectionMessage;
        }
        if (!payload.movement_date) {
            validationErrors.movement_date = tx('Selecciona la fecha del movimiento.');
        }
        if (!payload.concept) {
            validationErrors.concept = tx('Ingresa el concepto.');
        }
        const amountValue = parseFloat(payload.amount ?? '');
        if (Number.isNaN(amountValue) || amountValue <= 0) {
            validationErrors.amount = tx('Ingresa un monto válido mayor a cero.');
        } else {
            payload.amount = amountValue.toFixed(2);
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${entryId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages[mode === 'create' ? 'created' : 'updated'], icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error(`[${entity}] Submit error`, error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const entryId = modals.delete.dataset.entryId;
        if (!entryId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${entryId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.deleted, icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error(`[${entity}] Delete error`, error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const entryId = input.dataset.id ?? '';
        if (!entryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newValue = input.checked;

        input.disabled = true;

        try {
            const response = await fetch(settlementEndpointBuilder(entryId), {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(settlementPayloadBuilder(newValue)),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            const settlementMessageKey = newValue ? 'true' : 'false';
            const feedbackMessage = settlementMessages[settlementMessageKey] ?? successMessages.toggled;
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? feedbackMessage, icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error(`[${entity}] Status toggle error`, error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }
    // Listen for global table action events (from initGlobalDataTableActions)
    root.addEventListener('global-table-action:view', (event) => {
        event.preventDefault();
        if (event.detail?.data) {
            populateViewModal(event.detail.data);
            openModal(modals.view);
        }
    });

    root.addEventListener('global-table-action:edit', (event) => {
        event.preventDefault();
        if (event.detail?.data) {
            setFormMode('edit', event.detail.data);
            openModal(modals.form);
        }
    });

    root.addEventListener('global-table-action:delete', (event) => {
        event.preventDefault();
        if (event.detail?.data && event.detail?.rowId) {
            const entryConcept = event.detail.data.concept ?? event.detail.data.reference ?? '';
            if (modals.delete) {
                modals.delete.dataset.entryId = event.detail.rowId;
            }
            if (deleteConcept) {
                deleteConcept.textContent = entryConcept || String(event.detail.rowId);
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest(`[data-${entity}-action], [data-action], [data-row-action]`)
            : null;
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute(`data-${entity}-action`)) {
            const action = actionEl.dataset[`${entity}Action`];
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        if (!rowId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch entry data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    populateViewModal(json.data.item);
                    openModal(modals.view);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
            } catch (error) {
                console.error(`[${entity}] Error loading view data`, error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'edit') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch entry data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    setFormMode('edit', json.data.item);
                    openModal(modals.form);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                }
            } catch (error) {
                console.error(`[${entity}] Error loading edit data`, error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'delete') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch entry data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    const entryConcept = json.data.item.concept ?? json.data.item.reference ?? '';
                    if (modals.delete) {
                        modals.delete.dataset.entryId = rowId;
                    }
                    if (deleteConcept) {
                        deleteConcept.textContent = entryConcept || String(rowId);
                    }
                    openModal(modals.delete);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                }
            } catch (error) {
                console.error(`[${entity}] Error loading delete data`, error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
            }
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initUsersModule = () => {
    const root = document.querySelector('[data-users-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.usersTableId ?? '';
    const baseUrl = root.dataset.usersBaseUrl ?? '';
    const storeUrl = root.dataset.usersStoreUrl ?? baseUrl;
    const roleOptionsUrl = root.dataset.usersRoleOptionsUrl ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-user-modal="form"]'),
        view: root.querySelector('[data-user-modal="view"]'),
        delete: root.querySelector('[data-user-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-user-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-user-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-user-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-user-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-user-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-user-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-user-delete-confirm]') ?? null;
    const roleOptionsContainer = modals.form?.querySelector('[data-user-role-options]') ?? null;
    const firstNameInput = modals.form?.querySelector('[data-user-input="first_name"]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';
    let roleOptionsCache = [];
    let roleOptionsLoaded = false;

    const getModalFromElement = (element) => element.closest('[data-user-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
        modal.focus?.();
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-user-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-user-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getModalFromElement(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-user-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-user-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            const selectRoot = input.closest?.('[data-select]');
            if (selectRoot) {
                selectRoot.dataset.selectInvalid = 'false';
                const trigger = selectRoot.querySelector('[data-select-trigger]');
                trigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-user-error="${field}"]`);
            const inputEl = form.querySelector(`[data-user-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                const selectRoot = inputEl.closest('[data-select]');
                if (selectRoot) {
                    selectRoot.dataset.selectInvalid = 'true';
                    const trigger = selectRoot.querySelector('[data-select-trigger]');
                    trigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (!submitButton.dataset.originalLabel) {
            submitButton.dataset.originalLabel = submitLabel.textContent ?? '';
        }
        submitLabel.textContent = isLoading ? tx('Procesando...') : submitButton.dataset.originalLabel ?? tx('Guardar');
        submitButton.disabled = isLoading;
    };

    const syncCustomSelect = (selectRoot, value) => {
        if (!selectRoot) {
            return;
        }
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const options = Array.from(selectRoot.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';
        let label = placeholder;

        options.forEach((option) => {
            const isSelected = option.dataset.value === value && value !== '';
            option.dataset.selected = isSelected ? 'true' : 'false';
            if (isSelected) {
                label = option.dataset.label ?? option.textContent.trim();
            }
        });

        if (valueLabel) {
            valueLabel.textContent = value ? label : placeholder;
        }
        trigger?.classList.toggle('is-empty', !value);
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-user-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
        if (input instanceof HTMLInputElement) {
            const selectRoot = input.closest('[data-select]');
            if (selectRoot) {
                syncCustomSelect(selectRoot, input.value);
            }
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-user-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const renderRoleOptions = (options) => {
        if (!roleOptionsContainer) {
            return;
        }
        roleOptionsContainer.innerHTML = '';
        options.forEach((option) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = option.id;
            button.dataset.label = option.label;
            button.innerHTML = `
                <span class="truncate">${option.label}</span>
                <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
            `;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setFieldValue('role_id', option.id);
                closeCustomSelect(button.closest('[data-select]'));
            });
            roleOptionsContainer.appendChild(button);
        });
    };

    const loadRoleOptions = async () => {
        if (roleOptionsLoaded || !roleOptionsUrl) {
            return roleOptionsCache;
        }
        try {
            const response = await fetch(roleOptionsUrl, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json().catch(() => null);
            if (!response.ok || !json?.data?.items) {
                throw new Error('Invalid response');
            }
            roleOptionsCache = json.data.items;
            roleOptionsLoaded = true;
            renderRoleOptions(roleOptionsCache);
        } catch (error) {
            console.error('[Users] Role options error', error);
            showAlert({ title: tx('Error'), text: tx('No se pudieron cargar los roles disponibles.'), icon: 'error' });
        }
        return roleOptionsCache;
    };

    const closeCustomSelect = (selectRoot) => {
        if (!selectRoot) {
            return;
        }
        const dropdown = selectRoot.querySelector('[data-select-dropdown]');
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        if (dropdown && !dropdown.hasAttribute('hidden')) {
            dropdown.setAttribute('hidden', '');
            dropdown.classList.remove('visible');
        }
        trigger?.setAttribute('aria-expanded', 'false');
    };

    const setFormMode = async (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;

        await loadRoleOptions();
        renderRoleOptions(roleOptionsCache);

        if (mode === 'create') {
            form.reset();
            setFieldValue('id', '');
            setFieldValue('status', 'A');
            setFieldValue('role_id', '');
            if (modalTitle) {
                modalTitle.textContent = tx('Nuevo usuario');
            }
            submitButton.dataset.originalLabel = tx('Guardar');
            submitLabel.textContent = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar usuario');
            }
            submitButton.dataset.originalLabel = tx('Actualizar');
            submitLabel.textContent = tx('Actualizar');
        }

        if (data) {
            setFieldValue('id', data.id ?? '');
            setFieldValue('first_name', data.first_name ?? '');
            setFieldValue('last_name', data.last_name ?? '');
            setFieldValue('email', data.email ?? '');
            setFieldValue('role_id', data.role_id ?? '');
            setFieldValue('document_number', data.document_number ?? '');
            setFieldValue('phone_number', data.phone_number ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            setFieldValue('first_name', '');
            setFieldValue('last_name', '');
            setFieldValue('email', '');
            setFieldValue('document_number', '');
            setFieldValue('phone_number', '');
        }

        setFieldValue('password', '');
        setFieldValue('password_confirmation', '');

        syncCustomSelect(form?.querySelector('[data-select-name="role_id"]'), getFieldValue('role_id'));
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-user-view-field]').forEach((element) => {
            const field = element.getAttribute('data-user-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== undefined && value !== null && value !== '' ? String(value) : '—';
        });
    };

    const successMessages = {
        created: tx('El usuario se creó correctamente.'),
        updated: tx('El usuario se actualizó correctamente.'),
        deleted: tx('El usuario se eliminó correctamente.'),
        toggled: tx('El estado se actualizó correctamente.'),
    };

    const handleSubmit = async () => {
        if (!form) {
            return;
        }

        const mode = form.dataset.mode === 'edit' ? 'edit' : 'create';
        const userId = getFieldValue('id');

        const payload = {
            first_name: getFieldValue('first_name'),
            last_name: getFieldValue('last_name'),
            email: getFieldValue('email'),
            role_id: getFieldValue('role_id'),
            document_number: getFieldValue('document_number') || null,
            phone_number: getFieldValue('phone_number') || null,
            status: getFieldValue('status') || 'A',
        };

        const password = getFieldValue('password');
        const passwordConfirmation = getFieldValue('password_confirmation');
        if (password || passwordConfirmation) {
            payload.password = password;
            payload.password_confirmation = passwordConfirmation;
        }

        const url = mode === 'edit' && userId ? `${baseUrl}/${userId}` : storeUrl;
        const method = mode === 'edit' ? 'PATCH' : 'POST';

        clearFormErrors();
        setSubmitLoading(true);

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422) {
                    applyFormErrors(json?.errors ?? {});
                }
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo guardar el usuario.'), icon: 'error' });
                return;
            }

            showAlert({
                title: tx('Datos actualizados'),
                text: json?.message ?? (mode === 'edit' ? successMessages.updated : successMessages.created),
                icon: 'success',
            });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Users] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar el usuario.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete) {
            return;
        }
        const userId = modals.delete.dataset.userId ?? '';
        if (!userId) {
            showAlert({ title: tx('Error'), text: tx('No se pudo determinar el usuario a eliminar.'), icon: 'error' });
            return;
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.disabled = true;
            deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');
        }

        try {
            const response = await fetch(`${baseUrl}/${userId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el usuario.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.deleted, icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Users] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar el usuario.'), icon: 'error' });
        } finally {
            if (deleteConfirmButton) {
                deleteConfirmButton.disabled = false;
                deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
            }
        }
    };

    const handleStatusToggle = async (input) => {
        const entryId = input.dataset.id ?? '';
        if (!entryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${entryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado del usuario.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.toggled, icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Users] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-user-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-user-action')) {
            const action = actionEl.dataset.userAction;
            if (action === 'create') {
                setFormMode('create').then(() => {
                    openModal(modals.form);
                    window.setTimeout(() => {
                        firstNameInput?.focus();
                    }, 100);
                });
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        // If no payload, fetch data from server using rowId
        if (!data && rowId) {
            if (rowAction === 'view' || rowAction === 'edit') {
                fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            data = json.data.item;
                            if (rowAction === 'view') {
                                populateViewModal(data);
                                openModal(modals.view);
                            } else if (rowAction === 'edit') {
                                setFormMode('edit', data).then(() => {
                                    openModal(modals.form);
                                    window.setTimeout(() => {
                                        firstNameInput?.focus();
                                    }, 100);
                                });
                            }
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[Users] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
                return;
            } else if (rowAction === 'delete') {
                // For delete, we can use just the ID and name
                if (modals.delete) {
                    modals.delete.dataset.userId = rowId;
                }
                if (deleteName) {
                    deleteName.textContent = rowName || rowId;
                }
                openModal(modals.delete);
                return;
            }
        }

        if (!data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            populateViewModal(data);
            openModal(modals.view);
            return;
        }

        if (rowAction === 'edit') {
            setFormMode('edit', data).then(() => {
                openModal(modals.form);
                window.setTimeout(() => {
                    firstNameInput?.focus();
                }, 100);
            });
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.userId = data.id ?? '';
            }
            if (deleteName) {
                deleteName.textContent = data.display_name ?? data.email ?? data.id ?? '';
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });

    root.addEventListener('input', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) {
            return;
        }
        if (target.matches('[data-user-input="phone_number"]')) {
            const digits = target.value.replace(/\D+/g, '');
            if (target.value !== digits) {
                target.value = digits;
            }
        }
    });
};
const initRolesModule = () => {
    const root = document.querySelector('[data-roles-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.rolesTableId ?? '';
    const baseUrl = root.dataset.rolesBaseUrl ?? '';
    const storeUrl = root.dataset.rolesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-role-modal="form"]'),
        view: root.querySelector('[data-role-modal="view"]'),
        delete: root.querySelector('[data-role-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-role-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-role-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-role-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-role-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-role-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-role-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-role-delete-confirm]') ?? null;

    const displayNameInput = form?.querySelector('[data-role-input="display_name"]') ?? null;
    const slugInput = form?.querySelector('[data-role-input="name"]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getModalFromElement = (element) => element.closest('[data-role-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
        modal.focus?.();
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-role-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-role-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getModalFromElement(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-role-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-role-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-role-error="${field}"]`);
            const inputEl = form.querySelector(`[data-role-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (!submitButton.dataset.originalLabel) {
            submitButton.dataset.originalLabel = submitLabel.textContent ?? '';
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else {
            submitLabel.textContent = submitButton.dataset.originalLabel ?? tx('Guardar');
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-role-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-role-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const slugify = (value) => {
        if (!value) {
            return '';
        }
        return value
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '')
            .slice(0, 120);
    };

    const updateSlugPreview = () => {
        if (!form) {
            return;
        }
        const slug = slugify(getFieldValue('display_name'));
        setFieldValue('name', slug);
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;

        if (mode === 'create') {
            form.reset();
            setFieldValue('id', '');
            setFieldValue('status', 'A');
            setFieldValue('name', '');
            if (modalTitle) {
                modalTitle.textContent = tx('Nuevo rol');
            }
            submitButton.dataset.originalLabel = tx('Guardar');
            submitLabel.textContent = tx('Guardar');
            updateSlugPreview();
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar rol');
            }
            submitButton.dataset.originalLabel = tx('Actualizar');
            submitLabel.textContent = tx('Actualizar');
        }

        if (data) {
            setFieldValue('id', data.id ?? '');
            setFieldValue('display_name', data.display_name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            setFieldValue('display_name', '');
            setFieldValue('description', '');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-role-view-field]').forEach((element) => {
            const field = element.getAttribute('data-role-view-field');
            if (!field) {
                return;
            }
            let value = data[field];
            if (field === 'users_count') {
                value = typeof value === 'number' ? value : Number(value ?? 0);
            }
            if (field === 'description') {
                element.textContent = value ? String(value) : '—';
                return;
            }
            element.textContent = value !== undefined && value !== null && value !== '' ? String(value) : '—';
        });
    };

    const successMessages = {
        created: tx('El rol se creó correctamente.'),
        updated: tx('El rol se actualizó correctamente.'),
        deleted: tx('El rol se eliminó correctamente.'),
        toggled: tx('El estado se actualizó correctamente.'),
    };

    const handleSubmit = async () => {
        if (!form) {
            return;
        }
        const mode = form.dataset.mode === 'edit' ? 'edit' : 'create';
        const roleId = getFieldValue('id');

        const payload = {
            display_name: getFieldValue('display_name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        const url = mode === 'edit' && roleId ? `${baseUrl}/${roleId}` : storeUrl;
        const method = mode === 'edit' ? 'PATCH' : 'POST';

        clearFormErrors();
        setSubmitLoading(true);

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422) {
                    applyFormErrors(json?.errors ?? {});
                }
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo guardar el rol.'), icon: 'error' });
                return;
            }

            showAlert({
                title: tx('Datos actualizados'),
                text: json?.message ?? (mode === 'edit' ? successMessages.updated : successMessages.created),
                icon: 'success',
            });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Roles] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar el rol.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete) {
            return;
        }
        const roleId = modals.delete.dataset.roleId ?? '';
        if (!roleId) {
            showAlert({ title: tx('Error'), text: tx('No se pudo determinar el rol a eliminar.'), icon: 'error' });
            return;
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.disabled = true;
            deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');
        }

        try {
            const response = await fetch(`${baseUrl}/${roleId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el rol.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.deleted, icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Roles] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar el rol.'), icon: 'error' });
        } finally {
            if (deleteConfirmButton) {
                deleteConfirmButton.disabled = false;
                deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
            }
        }
    };

    const handleStatusToggle = async (input) => {
        const entryId = input.dataset.id ?? '';
        if (!entryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${entryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado del rol.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.toggled, icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Roles] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    if (displayNameInput) {
        displayNameInput.addEventListener('input', updateSlugPreview);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-role-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-role-action')) {
            const action = actionEl.dataset.roleAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
                window.setTimeout(() => {
                    displayNameInput?.focus();
                }, 100);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        // If no payload, fetch data from server using rowId
        if (!data && rowId) {
            if (rowAction === 'view' || rowAction === 'edit') {
                fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            data = json.data.item;
                            if (rowAction === 'view') {
                                populateViewModal(data);
                                openModal(modals.view);
                            } else if (rowAction === 'edit') {
                                setFormMode('edit', data);
                                openModal(modals.form);
                                window.setTimeout(() => {
                                    displayNameInput?.focus();
                                }, 100);
                            }
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[Roles] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
                return;
            } else if (rowAction === 'delete') {
                // For delete, we can use just the ID and name
                if (modals.delete) {
                    modals.delete.dataset.roleId = rowId;
                }
                if (deleteName) {
                    deleteName.textContent = rowName || rowId;
                }
                openModal(modals.delete);
                return;
            }
        }

        if (!data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            populateViewModal(data);
            openModal(modals.view);
            return;
        }

        if (rowAction === 'edit') {
            setFormMode('edit', data);
            openModal(modals.form);
            window.setTimeout(() => {
                displayNameInput?.focus();
            }, 100);
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.roleId = data.id ?? '';
            }
            if (deleteName) {
                deleteName.textContent = data.display_name ?? data.name ?? data.id ?? '';
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initPermissionsModule = () => {
    const root = document.querySelector('[data-permissions-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.permissionsTableId ?? '';
    const baseUrl = root.dataset.permissionsBaseUrl ?? '';
    const storeUrl = root.dataset.permissionsStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-permission-modal="form"]'),
        view: root.querySelector('[data-permission-modal="view"]'),
        delete: root.querySelector('[data-permission-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-permission-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-permission-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-permission-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-permission-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-permission-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-permission-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-permission-delete-confirm]') ?? null;

    const displayNameInput = form?.querySelector('[data-permission-input="display_name"]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getModalFromElement = (element) => element.closest('[data-permission-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
        modal.focus?.();
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-permission-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-permission-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getModalFromElement(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-permission-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-permission-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-permission-error="${field}"]`);
            const inputEl = form.querySelector(`[data-permission-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (!submitButton.dataset.originalLabel) {
            submitButton.dataset.originalLabel = submitLabel.textContent ?? '';
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else {
            submitLabel.textContent = submitButton.dataset.originalLabel ?? tx('Guardar');
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-permission-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-permission-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const updateSlugPreview = () => {
        if (!form) {
            return;
        }
        const slug = getFieldValue('display_name')
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '')
            .slice(0, 120);
        setFieldValue('name', slug);
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;

        if (mode === 'create') {
            form.reset();
            setFieldValue('id', '');
            setFieldValue('status', 'A');
            setFieldValue('name', '');
            if (modalTitle) {
                modalTitle.textContent = tx('Nuevo permiso');
            }
            submitButton.dataset.originalLabel = tx('Guardar');
            submitLabel.textContent = tx('Guardar');
            updateSlugPreview();
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar permiso');
            }
            submitButton.dataset.originalLabel = tx('Actualizar');
            submitLabel.textContent = tx('Actualizar');
        }

        if (data) {
            setFieldValue('id', data.id ?? '');
            setFieldValue('display_name', data.display_name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('name', data.name ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            setFieldValue('display_name', '');
            setFieldValue('description', '');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-permission-view-field]').forEach((element) => {
            const field = element.getAttribute('data-permission-view-field');
            if (!field) {
                return;
            }
            let value = data[field];
            if (field === 'roles_count') {
                value = typeof value === 'number' ? value : Number(value ?? 0);
            }
            if (field === 'description') {
                element.textContent = value ? String(value) : '—';
                return;
            }
            element.textContent = value !== undefined && value !== null && value !== '' ? String(value) : '—';
        });
    };

    const successMessages = {
        created: tx('El permiso se creó correctamente.'),
        updated: tx('El permiso se actualizó correctamente.'),
        deleted: tx('El permiso se eliminó correctamente.'),
        toggled: tx('El estado se actualizó correctamente.'),
    };

    const handleSubmit = async () => {
        if (!form) {
            return;
        }

        const mode = form.dataset.mode === 'edit' ? 'edit' : 'create';
        const permissionId = getFieldValue('id');

        const payload = {
            display_name: getFieldValue('display_name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        const url = mode === 'edit' && permissionId ? `${baseUrl}/${permissionId}` : storeUrl;
        const method = mode === 'edit' ? 'PATCH' : 'POST';

        clearFormErrors();
        setSubmitLoading(true);

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422) {
                    applyFormErrors(json?.errors ?? {});
                }
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo guardar el permiso.'), icon: 'error' });
                return;
            }

            showAlert({
                title: tx('Datos actualizados'),
                text: json?.message ?? (mode === 'edit' ? successMessages.updated : successMessages.created),
                icon: 'success',
            });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Permissions] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar el permiso.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete) {
            return;
        }
        const permissionId = modals.delete.dataset.permissionId ?? '';
        if (!permissionId) {
            showAlert({ title: tx('Error'), text: tx('No se pudo determinar el permiso a eliminar.'), icon: 'error' });
            return;
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.disabled = true;
            deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');
        }

        try {
            const response = await fetch(`${baseUrl}/${permissionId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el permiso.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.deleted, icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Permissions] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar el permiso.'), icon: 'error' });
        } finally {
            if (deleteConfirmButton) {
                deleteConfirmButton.disabled = false;
                deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
            }
        }
    };

    const handleStatusToggle = async (input) => {
        const entryId = input.dataset.id ?? '';
        if (!entryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${entryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado del permiso.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? successMessages.toggled, icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Permissions] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    if (displayNameInput) {
        displayNameInput.addEventListener('input', updateSlugPreview);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-permission-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-permission-action')) {
            const action = actionEl.dataset.permissionAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
                window.setTimeout(() => {
                    displayNameInput?.focus();
                }, 100);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        const payload = actionEl.dataset.rowPayload;
        const data = payload ? decodePayload(payload) : null;

        if (!rowAction || !data?.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            populateViewModal(data);
            openModal(modals.view);
            return;
        }

        if (rowAction === 'edit') {
            setFormMode('edit', data);
            openModal(modals.form);
            window.setTimeout(() => {
                displayNameInput?.focus();
            }, 100);
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.permissionId = data.id ?? '';
            }
            if (deleteName) {
                deleteName.textContent = data.display_name ?? data.name ?? data.id ?? '';
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};

const initIncomesModule = () => {
    initFinanceModule('income');
};

const initExpensesModule = () => {
    initFinanceModule('expense');
};

const initReceivablesModule = () => {
    initFinanceModule('receivable');
};

const initPayablesModule = () => {
    initFinanceModule('payable');
};

const initProductsIndexModule = () => {
    const root = document.querySelector('[data-products-index-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.productsTableId ?? '';
    const baseUrl = root.dataset.productsBaseUrl ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const deleteModal = root.querySelector('[data-product-modal="delete"]');
    const deleteName = deleteModal?.querySelector('[data-product-delete-name]');
    const deleteConfirmButton = deleteModal?.querySelector('[data-product-delete-confirm]');

    const refreshEvent = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    root.addEventListener('datatable-refresh-request', refreshEvent);

    const openDeleteModal = (productId, productName) => {
        if (!deleteModal || !deleteName || !deleteConfirmButton) {
            return;
        }
        deleteModal.dataset.productId = productId;
        deleteName.textContent = productName || 'este producto';
        deleteModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    };

    const closeDeleteModal = () => {
        if (!deleteModal) {
            return;
        }
        deleteModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (deleteModal.dataset.productId) {
            delete deleteModal.dataset.productId;
        }
    };

    const handleDelete = async () => {
        const productId = deleteModal?.dataset.productId;
        if (!productId || !deleteConfirmButton) {
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${productId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el producto.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Éxito'), text: json?.message ?? tx('Producto eliminado correctamente.'), icon: 'success' });
            closeDeleteModal();
            refreshEvent();
        } catch (error) {
            console.error('[ProductsIndex] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar el producto.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    // Handle action buttons
    root.addEventListener('click', (event) => {
        const actionEl = event.target.closest('[data-action], [data-row-action]');
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        const action = actionEl.dataset.action || actionEl.dataset.rowAction;
        const productId = actionEl.dataset.id || actionEl.dataset.rowId;
        const productName = actionEl.dataset.name || actionEl.dataset.rowName || '';

        if (!action || !productId) {
            return;
        }

        event.preventDefault();
        event.stopPropagation();

        if (action === 'view') {
            window.location.href = `${baseUrl}/${productId}`;
        } else if (action === 'edit') {
            window.location.href = `${baseUrl}/${productId}/edit`;
        } else if (action === 'delete') {
            openDeleteModal(productId, productName);
        }
    });

    // Handle delete modal close buttons
    root.querySelectorAll('[data-product-modal-close]').forEach((button) => {
        button.addEventListener('click', closeDeleteModal);
    });

    // Handle delete modal backdrop click
    if (deleteModal) {
        deleteModal.addEventListener('click', (event) => {
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        });
        deleteModal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeDeleteModal();
            }
        });
    }

    // Handle delete confirm button
    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    console.log('[ProductsIndex] module initialized', { tableId, baseUrl });
};
const initProductLinesModule = () => {
    console.log('🔵 [ProductLines] Module initialization started');
    const roots = document.querySelectorAll('[data-product-lines-root]');
    console.log('🔵 [ProductLines] Found roots', { count: roots.length, roots: Array.from(roots) });
    
    document.querySelectorAll('[data-product-lines-root]').forEach((root, index) => {
        console.log(`🔵 [ProductLines] Initializing root ${index + 1}`, { root, attributes: Array.from(root.attributes).map(attr => ({ name: attr.name, value: attr.value })) });
        
        const tableId = root.dataset.productLinesTableId ?? '';
        const baseUrl = root.dataset.productLinesBaseUrl ?? '';
        const storeUrl = root.dataset.productLinesStoreUrl ?? baseUrl;
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
        
        console.log('🔵 [ProductLines] init - Configuration', { 
            tableId, 
            baseUrl, 
            storeUrl,
            csrfToken: csrfToken ? 'present' : 'missing',
            rootElement: root,
            allDataAttributes: Object.keys(root.dataset),
        });

        const modals = {
            form: root.querySelector('[data-product-line-modal="form"]'),
            view: root.querySelector('[data-product-line-modal="view"]'),
            delete: root.querySelector('[data-product-line-modal="delete"]'),
        };

        const form = modals.form?.querySelector('[data-product-line-form]') ?? null;
        const submitButton = modals.form?.querySelector('[data-product-line-submit]') ?? null;
        const submitLabel = submitButton?.querySelector('[data-product-line-submit-label]') ?? null;
        const modalTitle = modals.form?.querySelector('[data-product-line-modal-title]') ?? null;
        const viewContainer = modals.view?.querySelector('[data-product-line-view]') ?? null;
        const deleteName = modals.delete?.querySelector('[data-product-line-delete-name]') ?? null;
        const deleteConfirmButton = modals.delete?.querySelector('[data-product-line-delete-confirm]') ?? null;

        const bodyOverflowClass = 'overflow-hidden';

        const getEventTargetModal = (target) => target.closest('[data-product-line-modal]');

        const openModal = (modal) => {
            if (!modal) {
                return;
            }
            modal.classList.remove('hidden');
            document.body.classList.add(bodyOverflowClass);
        };

        const closeModal = (modal) => {
            if (!modal) {
                return;
            }
            modal.classList.add('hidden');
            if (!root.querySelector('[data-product-line-modal]:not(.hidden)')) {
                document.body.classList.remove(bodyOverflowClass);
            }
        };

        root.querySelectorAll('[data-product-line-modal-close]').forEach((button) => {
            button.addEventListener('click', () => {
                const modal = getEventTargetModal(button);
                closeModal(modal);
            });
        });

        Object.values(modals).forEach((modal) => {
            if (!modal) {
                return;
            }
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal(modal);
                }
            });
            modal.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal(modal);
                }
            });
        });

        const clearFormErrors = () => {
            if (!form) {
                return;
            }
            form.querySelectorAll('[data-product-line-error]').forEach((errorEl) => {
                errorEl.textContent = '';
            });
            form.querySelectorAll('[data-product-line-input]').forEach((input) => {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            });
        };

        const applyFormErrors = (errors) => {
            if (!form || !errors) {
                return;
            }
            Object.entries(errors).forEach(([field, messages]) => {
                const message = Array.isArray(messages) ? messages[0] : messages;
                const errorEl = form.querySelector(`[data-product-line-error="${field}"]`);
                const inputEl = form.querySelector(`[data-product-line-input="${field}"]`);
                if (errorEl) {
                    errorEl.textContent = message ?? '';
                }
                if (inputEl) {
                    inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            });
        };

        const setSubmitLoading = (isLoading) => {
            if (!submitButton || !submitLabel) {
                return;
            }
            if (isLoading) {
                submitLabel.textContent = 'Procesando...';
            } else if (submitButton.dataset.originalLabel) {
                submitLabel.textContent = submitButton.dataset.originalLabel;
            }
            submitButton.disabled = isLoading;
        };

        const setFieldValue = (field, value) => {
            if (!form) {
                return;
            }
            const input = form.querySelector(`[data-product-line-input="${field}"]`);
            if (!input) {
                return;
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
                input.value = value ?? '';
            }
        };

        const getFieldValue = (field) => {
            if (!form) {
                return '';
            }
            const input = form.querySelector(`[data-product-line-input="${field}"]`);
            if (!input) {
                return '';
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
                return input.value.trim();
            }
            return '';
        };

        const refreshTable = () => {
            if (!tableId) {
                window.dispatchEvent(new CustomEvent('datatable-refresh'));
                return;
            }
            window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
        };

        const setFormMode = (mode, data = null) => {
            if (!form || !submitButton || !submitLabel) {
                return;
            }

            clearFormErrors();
            setSubmitLoading(false);

            form.dataset.mode = mode;
            form.dataset.productLineId = data?.id ?? '';

            if (mode === 'create') {
                form.reset();
                setFieldValue('status', 'A');
                if (modalTitle) {
                    modalTitle.textContent = 'Nueva línea';
                }
                submitLabel.textContent = 'Guardar';
                submitButton.dataset.originalLabel = 'Guardar';
            } else {
                if (modalTitle) {
                    modalTitle.textContent = 'Editar línea';
                }
                submitLabel.textContent = 'Actualizar';
                submitButton.dataset.originalLabel = 'Actualizar';
            }

            if (data) {
                setFieldValue('name', data.name ?? '');
                setFieldValue('description', data.description ?? '');
                setFieldValue('status', data.status ?? 'A');
            }
        };

        const populateViewModal = (data) => {
            if (!viewContainer || !data) {
                return;
            }
            viewContainer.querySelectorAll('[data-product-line-view-field]').forEach((element) => {
                const field = element.getAttribute('data-product-line-view-field');
                if (!field) {
                    return;
                }
                const value = data[field];
                element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
            });
        };

        const handleSubmit = async () => {
            if (!form || !submitButton || !submitLabel) {
                return;
            }

            const mode = form.dataset.mode ?? 'create';
            const productLineId = form.dataset.productLineId ?? '';

            const payload = {
                name: getFieldValue('name'),
                description: getFieldValue('description') || null,
                status: getFieldValue('status') || 'A',
            };

            clearFormErrors();

            const validationErrors = {};
            if (!payload.name) {
                validationErrors.name = tx('El nombre es obligatorio.');
            }

            if (Object.keys(validationErrors).length > 0) {
                applyFormErrors(validationErrors);
                showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
                return;
            }

            setSubmitLoading(true);

            const url = mode === 'create' ? storeUrl : `${baseUrl}/${productLineId}`;
            const method = mode === 'create' ? 'POST' : 'PATCH';

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    if (response.status === 422 && json?.errors) {
                        applyFormErrors(json.errors);
                        showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                    } else {
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                    }
                    return;
                }

                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
                closeModal(modals.form);
                refreshTable();
            } catch (error) {
                console.error('[ProductLines] Submit error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
            } finally {
                setSubmitLoading(false);
            }
        };

        const handleDelete = async () => {
            if (!modals.delete || !deleteConfirmButton) {
                return;
            }
            const productLineId = modals.delete.dataset.productLineId;
            if (!productLineId) {
                closeModal(modals.delete);
                return;
            }

            deleteConfirmButton.disabled = true;
            deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

            try {
                const response = await fetch(`${baseUrl}/${productLineId}`, {
                    method: 'DELETE',
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                    return;
                }

                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
                closeModal(modals.delete);
                refreshTable();
            } catch (error) {
                console.error('[ProductLines] Delete error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
            } finally {
                deleteConfirmButton.disabled = false;
                deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
            }
        };

        const handleStatusToggle = async (input) => {
            const productLineId = input.dataset.id ?? '';
            if (!productLineId || input.disabled) {
                return;
            }

            const previousChecked = !input.checked;
            const newStatus = input.checked ? 'A' : 'I';

            input.disabled = true;

            try {
                const response = await fetch(`${baseUrl}/${productLineId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify({ status: newStatus }),
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    input.checked = previousChecked;
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                    return;
                }

                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
                refreshTable();
            } catch (error) {
                console.error('[ProductLines] Status toggle error', error);
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
            } finally {
                input.disabled = false;
            }
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                handleSubmit();
            });
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.addEventListener('click', handleDelete);
        }

        root.addEventListener('click', (event) => {
            console.log('🔵 [ProductLines] Click detected', {
                target: event.target,
                targetTagName: event.target?.tagName,
                targetClasses: event.target?.className,
                targetId: event.target?.id,
                targetDataset: event.target?.dataset,
            });

            // Find the action element, checking both the target and its parent
            let actionEl = null;
            if (event.target instanceof Element) {
                actionEl = event.target.closest('[data-product-line-action], [data-action], [data-row-action]');
                console.log('🔵 [ProductLines] First closest search', { 
                    found: !!actionEl,
                    element: actionEl,
                    tagName: actionEl?.tagName,
                    classes: actionEl?.className,
                });
                
                // If not found and target is an icon, try the parent button
                if (!actionEl && (event.target.tagName === 'I' || event.target.classList.contains('fa'))) {
                    actionEl = event.target.closest('button[data-action], button[data-row-action]');
                    console.log('🔵 [ProductLines] Second closest search (icon)', { 
                        found: !!actionEl,
                        element: actionEl,
                        tagName: actionEl?.tagName,
                    });
                }
            }
            
            console.log('🔵 [ProductLines] Final actionEl', {
                found: !!actionEl,
                element: actionEl,
                allAttributes: actionEl ? Array.from(actionEl.attributes).map(attr => ({ name: attr.name, value: attr.value })) : null,
                dataset: actionEl?.dataset,
            });

            if (!actionEl) {
                console.log('🔵 [ProductLines] No actionEl found, returning');
                return;
            }

            if (actionEl.hasAttribute('data-product-line-action')) {
                const action = actionEl.dataset.productLineAction;
                console.log('🔵 [ProductLines] Product line action', { action });
                if (action === 'create') {
                    setFormMode('create');
                    openModal(modals.form);
                }
                return;
            }

            const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
            console.log('🔵 [ProductLines] Row action extracted', {
                rowAction,
                dataAction: actionEl.dataset.action,
                dataRowAction: actionEl.dataset.rowAction,
            });
            
            if (!rowAction) {
                console.log('🔵 [ProductLines] No rowAction found, returning');
                return;
            }

            const rowId = (actionEl.dataset.id || actionEl.dataset.rowId || '').trim();
            const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
                const payload = actionEl.dataset.rowPayload;
                let data = payload ? decodePayload(payload) : null;

            console.log('🔵 [ProductLines] Action clicked - FULL DATA', {
                rowAction,
                rowId,
                rowName,
                hasPayload: !!payload,
                payload,
                data,
                baseUrl,
                csrfToken: csrfToken ? 'present' : 'missing',
                allDatasetKeys: Object.keys(actionEl.dataset),
                datasetId: actionEl.dataset.id,
                datasetRowId: actionEl.dataset.rowId,
            });

            if (!rowId) {
                console.error('🔴 [ProductLines] Missing rowId', { 
                    actionEl, 
                    rowAction,
                    allDatasetKeys: actionEl ? Object.keys(actionEl.dataset) : null,
                    dataset: actionEl?.dataset,
                });
                showAlert({ title: tx('Error'), text: tx('No se pudo identificar el registro seleccionado.'), icon: 'error' });
                return;
            }

            // If no payload, fetch data from server using rowId
            if (!data && rowId) {
                console.log('🟡 [ProductLines] No payload, will fetch from server', { rowId, rowAction, hasData: !!data });
                
                if (rowAction === 'view' || rowAction === 'edit') {
                    if (!baseUrl) {
                        console.error('🔴 [ProductLines] Missing baseUrl');
                        showAlert({ title: tx('Error'), text: tx('Error de configuración. Por favor, recarga la página.'), icon: 'error' });
                    return;
                }
                    const fetchUrl = `${baseUrl}/${rowId}`;
                    console.log('🟢 [ProductLines] Starting fetch', { 
                        fetchUrl, 
                        rowAction, 
                        rowId,
                        baseUrl,
                        method: 'GET',
                        headers: {
                            Accept: 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken ? 'present' : 'missing',
                        },
                    });
                    
                    fetch(fetchUrl, {
                        headers: {
                            Accept: 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken,
                        },
                    })
                        .then(async (response) => {
                            console.log('🟢 [ProductLines] Response received (raw)', {
                                ok: response.ok,
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                url: response.url,
                            });
                            
                            const json = await response.json().catch((parseError) => {
                                console.error('🔴 [ProductLines] JSON parse error', { parseError });
                                return null;
                            });
                            
                            console.log('🟢 [ProductLines] Response JSON parsed', { json });
                            
                            if (!response.ok) {
                                console.error('🔴 [ProductLines] Fetch failed - Response not OK', { 
                                    status: response.status, 
                                    statusText: response.statusText,
                                    url: fetchUrl,
                                    json,
                                    responseHeaders: Object.fromEntries(response.headers.entries()),
                                });
                                const errorMessage = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                                showAlert({ title: tx('Error'), text: errorMessage, icon: 'error' });
                                return null;
                            }
                            return json;
                        })
                        .then((json) => {
                            console.log('🟢 [ProductLines] Processing response', { 
                                hasJson: !!json,
                                json,
                                status: json?.status,
                                hasData: !!json?.data,
                                hasItem: !!json?.data?.item,
                                item: json?.data?.item,
                            });
                            
                            if (!json) {
                                console.log('🟡 [ProductLines] No JSON to process');
                return;
            }

                            if (json?.status === 'success' && json?.data?.item) {
                                console.log('✅ [ProductLines] Success! Opening modal', { rowAction, data: json.data.item });
                                data = json.data.item;
            if (rowAction === 'view') {
                                    populateViewModal(data);
                                    openModal(modals.view);
                                } else if (rowAction === 'edit') {
                                    setFormMode('edit', data);
                                    openModal(modals.form);
                                }
                            } else {
                                const errorMsg = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                                console.error('🔴 [ProductLines] Invalid response format', { 
                                    json, 
                                    expected: 'status: success, data.item',
                                    actualStatus: json?.status,
                                    hasData: !!json?.data,
                                    hasItem: !!json?.data?.item,
                                });
                                showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                            }
                        })
                        .catch((error) => {
                            console.error('🔴 [ProductLines] Fetch error (catch)', { 
                                error, 
                                errorName: error.name,
                                errorMessage: error.message, 
                                errorStack: error.stack,
                                fetchUrl,
                            });
                            const errorMsg = error.message?.includes('Failed to fetch') 
                                ? tx('Error de conexión. Verifica tu conexión a internet.')
                                : tx('No se pudieron obtener los datos del registro.');
                            showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                        });
                    return;
                } else if (rowAction === 'delete') {
                    console.log('🟡 [ProductLines] Delete action', { rowId, rowName });
                    if (modals.delete) {
                        modals.delete.dataset.productLineId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = rowName || rowId;
                    }
                    openModal(modals.delete);
                    return;
                }
            }

            // If we have data from payload, use it directly
            if (data) {
                if (rowAction === 'view') {
                populateViewModal(data);
                openModal(modals.view);
                return;
            }

                if (rowAction === 'edit') {
                    setFormMode('edit', data);
                    openModal(modals.form);
                    return;
                }

                if (rowAction === 'delete') {
                if (modals.delete) {
                        modals.delete.dataset.productLineId = data.id ?? '';
                }
                if (deleteName) {
                        deleteName.textContent = (data.name || data.id) ?? '';
                }
                openModal(modals.delete);
                    return;
                }
            }

            // Fallback error
            if (rowAction !== 'delete') {
                console.error('🔴 [ProductLines] No data available', { rowAction, rowId, hasData: !!data });
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            }
        });

        root.addEventListener('change', (event) => {
            const target = event.target;
            if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
                handleStatusToggle(target);
            }
        });
    });
};
const initProductCategoriesModule = () => {
    console.log('🔵 [ProductCategories] Module initialization started');
    const roots = document.querySelectorAll('[data-product-categories-root]');
    console.log('🔵 [ProductCategories] Found roots', { count: roots.length, roots: Array.from(roots) });
    
    document.querySelectorAll('[data-product-categories-root]').forEach((root, index) => {
        console.log(`🔵 [ProductCategories] Initializing root ${index + 1}`, { root, attributes: Array.from(root.attributes).map(attr => ({ name: attr.name, value: attr.value })) });
        
        const tableId = root.dataset.productCategoriesTableId ?? '';
        const baseUrl = root.dataset.productCategoriesBaseUrl ?? '';
        const storeUrl = root.dataset.productCategoriesStoreUrl ?? baseUrl;
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
        const optionsUrl = root.dataset.productCategoriesOptionsUrl ?? '';
        
        console.log('🔵 [ProductCategories] init - Configuration', { 
            tableId, 
            baseUrl, 
            storeUrl,
            optionsUrl,
            csrfToken: csrfToken ? 'present' : 'missing',
            rootElement: root,
            allDataAttributes: Object.keys(root.dataset),
        });
        const lines = (() => {
            try {
                return JSON.parse(root.dataset.productCategoriesLines ?? '[]');
            } catch (error) {
                console.error('[ProductCategories] Error parsing lines', error);
                return [];
            }
        })();

        let config = {};
        try {
            config = JSON.parse(root.dataset.productCategoriesConfig ?? '{}');
        } catch (error) {
            console.error('[ProductCategories] Error parsing config', error);
        }

        const requiresParent = Boolean(config.requires_parent);

        const modals = {
            form: root.querySelector('[data-product-category-modal="form"]'),
            view: root.querySelector('[data-product-category-modal="view"]'),
            delete: root.querySelector('[data-product-category-modal="delete"]'),
        };

        const form = modals.form?.querySelector('[data-product-category-form]') ?? null;
        const submitButton = modals.form?.querySelector('[data-product-category-submit]') ?? null;
        const submitLabel = submitButton?.querySelector('[data-product-category-submit-label]') ?? null;
        const modalTitle = modals.form?.querySelector('[data-product-category-modal-title]') ?? null;
        const parentWrapper = form?.querySelector('[data-product-category-parent-wrapper]') ?? null;
        const parentSelect = parentWrapper?.querySelector('[data-product-category-input="parent_id"]') ?? null;
        const lineSelect = form?.querySelector('[data-product-category-input="product_line_id"]') ?? null;
        const viewContainer = modals.view?.querySelector('[data-product-category-view]') ?? null;
        const deleteName = modals.delete?.querySelector('[data-product-category-delete-name]') ?? null;
        const deleteConfirmButton = modals.delete?.querySelector('[data-product-category-delete-confirm]') ?? null;

        const bodyOverflowClass = 'overflow-hidden';
        let parentOptionsCache = new Map();

        const createCustomSelectHelper = (hiddenInput, optionsSelector, { placeholder = '' } = {}) => {
            if (!(hiddenInput instanceof HTMLInputElement)) {
                return null;
            }

            const selectRoot = hiddenInput.closest('[data-select]');
            if (!selectRoot) {
                return null;
            }

            const trigger = selectRoot.querySelector('[data-select-trigger]');
            const dropdown = selectRoot.querySelector('[data-select-dropdown]');
            const valueLabel = selectRoot.querySelector('[data-select-value]');
            const icon = selectRoot.querySelector('[data-select-icon]');
            const optionsContainer = optionsSelector
                ? selectRoot.querySelector(optionsSelector)
                : dropdown?.querySelector('.max-h-60');
            const placeholderLabel = trigger?.dataset.selectPlaceholder ?? placeholder ?? '';

            const close = () => {
                if (!dropdown) {
                    return;
                }
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
                selectRoot.dataset.open = 'false';
                trigger?.setAttribute('aria-expanded', 'false');
                icon?.classList.remove('rotate-180');
            };

            const markSelected = () => {
                if (!optionsContainer) {
                    return;
                }
                optionsContainer.querySelectorAll('[data-select-option]').forEach((option) => {
                    option.dataset.selected = option.dataset.value === hiddenInput.value ? 'true' : 'false';
                });
            };

            const updateDisplay = (overrideLabel = null) => {
                const options = optionsContainer?.querySelectorAll('[data-select-option]') ?? [];
                let label = overrideLabel;
                if (!label && optionsContainer) {
                    const selectedOption = optionsContainer.querySelector(`[data-select-option][data-value="${hiddenInput.value ?? ''}"]`);
                    label = selectedOption?.dataset.label ?? null;
                }
                if (!label) {
                    label = hiddenInput.value ? hiddenInput.value : placeholderLabel;
                }
                if (valueLabel) {
                    valueLabel.textContent = label;
                }
                trigger?.classList.toggle('is-empty', !hiddenInput.value);
                markSelected();
            };

            const setValue = (value, label = null) => {
                hiddenInput.value = value ?? '';
                updateDisplay(label);
                hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            };

            const buildOptionButton = (value, label) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                button.dataset.selectOption = '';
                button.dataset.value = value ?? '';
                button.dataset.label = label ?? '';
                button.dataset.selected = hiddenInput.value === (value ?? '') ? 'true' : 'false';
                button.innerHTML = `<span class="truncate">${label ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    setValue(value ?? '', label ?? '');
                    close();
                    trigger?.focus({ preventScroll: true });
                });
                return button;
            };

            const renderOptions = (options = []) => {
                if (!optionsContainer) {
                    return;
                }
                optionsContainer.innerHTML = '';
                options.forEach((option) => {
                    const button = buildOptionButton(option.value ?? '', option.label ?? '');
                    optionsContainer.appendChild(button);
                });
                updateDisplay();
            };

            updateDisplay();

            return {
                renderOptions,
                setValue,
                updateDisplay,
                close,
                selectRoot,
                placeholder: placeholderLabel,
            };
        };

        const lineSelectHelper = createCustomSelectHelper(lineSelect, '[data-product-category-line-options]', {
            placeholder: tx('Selecciona una línea'),
        });
        const parentSelectHelper = createCustomSelectHelper(parentSelect, '[data-product-category-parent-options]', {
            placeholder: tx('Selecciona una categoría padre'),
        });

        const getEventTargetModal = (target) => target.closest('[data-product-category-modal]');

        const openModal = (modal) => {
            if (!modal) {
                return;
            }
            modal.classList.remove('hidden');
            document.body.classList.add(bodyOverflowClass);
        };

        const closeModal = (modal) => {
            if (!modal) {
                return;
            }
            modal.classList.add('hidden');
            if (!root.querySelector('[data-product-category-modal]:not(.hidden)')) {
                document.body.classList.remove(bodyOverflowClass);
            }
        };

        const toggleParentFieldVisibility = () => {
            if (!parentWrapper) {
                return;
            }
            if (requiresParent) {
                parentWrapper.classList.remove('hidden');
            } else {
                parentWrapper.classList.add('hidden');
            }
        };

        toggleParentFieldVisibility();

        const populateLineOptions = () => {
            if (!lineSelectHelper) {
                return;
            }
            const options = lines.map((line) => ({
                value: line.id,
                label: line.name,
            }));
            lineSelectHelper.renderOptions(options);
            if (!lineSelect?.value) {
                lineSelectHelper.updateDisplay();
            }
        };

        populateLineOptions();

        const loadParentOptions = async (lineId) => {
            if (!requiresParent || !parentSelectHelper || !optionsUrl || !lineId) {
                if (parentSelectHelper) {
                    parentSelectHelper.renderOptions([]);
                    parentSelectHelper.setValue('');
                }
                return;
            }

            if (parentOptionsCache.has(lineId)) {
                const cached = parentOptionsCache.get(lineId);
                parentSelectHelper.renderOptions(cached);
                parentSelectHelper.updateDisplay();
                return;
            }

            try {
                const url = `${optionsUrl}${optionsUrl.includes('?') ? '&' : '?'}per_page=200&product_line_id=${encodeURIComponent(lineId)}`;
                const response = await fetch(url, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                const json = await response.json().catch(() => null);

                if (!response.ok || !json?.data?.items) {
                    throw new Error('Invalid response');
                }

                const options = json.data.items.map((item) => ({
                    value: item.id,
                    label: item.name,
                }));

                parentOptionsCache.set(lineId, options);
                parentSelectHelper.renderOptions(options);
                parentSelectHelper.updateDisplay();
            } catch (error) {
                console.error('[ProductCategories] Error loading parent options', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron cargar las categorías padre.'), icon: 'error' });
            }
        };

        root.querySelectorAll('[data-product-category-modal-close]').forEach((button) => {
            button.addEventListener('click', () => {
                const modal = getEventTargetModal(button);
                closeModal(modal);
            });
        });

        Object.values(modals).forEach((modal) => {
            if (!modal) {
                return;
            }
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal(modal);
                }
            });
            modal.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal(modal);
                }
            });
        });

        const clearFormErrors = () => {
            if (!form) {
                return;
            }
            form.querySelectorAll('[data-product-category-error]').forEach((errorEl) => {
                errorEl.textContent = '';
            });
            form.querySelectorAll('[data-product-category-input]').forEach((input) => {
                if (input instanceof HTMLInputElement && input.type === 'hidden') {
                    const selectRoot = input.closest('[data-select]');
                    if (selectRoot) {
                        selectRoot.dataset.selectInvalid = 'false';
                        selectRoot.querySelector('[data-select-trigger]')?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                    }
                } else if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                    input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            });
        };

        const applyFormErrors = (errors) => {
            if (!form || !errors) {
                return;
            }
            Object.entries(errors).forEach(([field, messages]) => {
                const message = Array.isArray(messages) ? messages[0] : messages;
                const errorEl = form.querySelector(`[data-product-category-error="${field}"]`);
                const inputEl = form.querySelector(`[data-product-category-input="${field}"]`);
                if (errorEl) {
                    errorEl.textContent = message ?? '';
                }
                if (inputEl instanceof HTMLInputElement && inputEl.type === 'hidden') {
                    const selectRoot = inputEl.closest('[data-select]');
                    if (selectRoot) {
                        selectRoot.dataset.selectInvalid = 'true';
                        selectRoot.querySelector('[data-select-trigger]')?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                    }
                } else if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement || inputEl instanceof HTMLSelectElement) {
                    inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            });
        };

        const setSubmitLoading = (isLoading) => {
            if (!submitButton || !submitLabel) {
                return;
            }
            if (isLoading) {
                submitLabel.textContent = 'Procesando...';
            } else if (submitButton.dataset.originalLabel) {
                submitLabel.textContent = submitButton.dataset.originalLabel;
            }
            submitButton.disabled = isLoading;
        };

        const setFieldValue = (field, value) => {
            if (!form) {
                return;
            }
            if (field === 'product_line_id' && lineSelectHelper) {
                lineSelectHelper.setValue(value ?? '');
                return;
            }
            if (field === 'parent_id' && parentSelectHelper) {
                // Si se pasa un objeto con id y name, usar ambos; si solo es un string, buscar el label en las opciones
                if (typeof value === 'object' && value !== null && value.id) {
                    parentSelectHelper.setValue(value.id, value.name || value.label);
                } else {
                parentSelectHelper.setValue(value ?? '');
                }
                return;
            }
            const input = form.querySelector(`[data-product-category-input="${field}"]`);
            if (!input) {
                return;
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                input.value = value ?? '';
            }
        };

        const getFieldValue = (field) => {
            if (!form) {
                return '';
            }
            const input = form.querySelector(`[data-product-category-input="${field}"]`);
            if (!input) {
                return '';
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                return input.value.trim();
            }
            return '';
        };

        const refreshTable = () => {
            if (!tableId) {
                window.dispatchEvent(new CustomEvent('datatable-refresh'));
                return;
            }
            window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
        };

        const setFormMode = (mode, data = null) => {
            if (!form || !submitButton || !submitLabel) {
                return;
            }

            clearFormErrors();
            setSubmitLoading(false);

            form.dataset.mode = mode;
            form.dataset.productCategoryId = data?.id ?? '';

            if (mode === 'create') {
                form.reset();
                setFieldValue('status', 'A');
                if (modalTitle) {
                    modalTitle.textContent = requiresParent ? 'Nueva subcategoría' : 'Nueva categoría';
                }
                submitLabel.textContent = 'Guardar';
                submitButton.dataset.originalLabel = 'Guardar';
                lineSelectHelper?.setValue('');
                parentSelectHelper?.renderOptions([]);
                parentSelectHelper?.setValue('');
            } else {
                if (modalTitle) {
                    modalTitle.textContent = requiresParent ? 'Editar subcategoría' : 'Editar categoría';
                }
                submitLabel.textContent = 'Actualizar';
                submitButton.dataset.originalLabel = 'Actualizar';
            }

            if (data) {
                setFieldValue('name', data.name ?? '');
                setFieldValue('status', data.status ?? 'A');
                setFieldValue('product_line_id', data.product_line_id ?? '');
                if (requiresParent && data.product_line_id) {
                    loadParentOptions(data.product_line_id).then(() => {
                        // Pasar el ID y el nombre para que se muestre correctamente
                        if (data.parent_id && data.parent_name) {
                            setFieldValue('parent_id', { id: data.parent_id, name: data.parent_name });
                        } else {
                        setFieldValue('parent_id', data.parent_id ?? '');
                        }
                    });
                }
                if (!requiresParent) {
                    if (data.parent_id && data.parent_name) {
                        setFieldValue('parent_id', { id: data.parent_id, name: data.parent_name });
                    } else {
                    setFieldValue('parent_id', data.parent_id ?? '');
                    }
                }
            } else {
                setFieldValue('name', '');
                setFieldValue('product_line_id', '');
                setFieldValue('parent_id', '');
            }
        };

        const populateViewModal = (data) => {
            if (!viewContainer || !data) {
                return;
            }
            viewContainer.querySelectorAll('[data-product-category-view-field]').forEach((element) => {
                const field = element.getAttribute('data-product-category-view-field');
                if (!field) {
                    return;
                }
                const value = data[field];
                element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
            });
            const lineField = viewContainer.querySelector('[data-product-category-view-field="product_line_name"]');
            if (lineField) {
                lineField.textContent = data.product_line_name ?? '-';
            }
        };

        const handleSubmit = async () => {
            if (!form || !submitButton || !submitLabel) {
                return;
            }

            const mode = form.dataset.mode ?? 'create';
            const productCategoryId = form.dataset.productCategoryId ?? '';

            const payload = {
                name: getFieldValue('name'),
                product_line_id: getFieldValue('product_line_id') || null,
                parent_id: getFieldValue('parent_id') || null,
                status: getFieldValue('status') || 'A',
            };

            clearFormErrors();

            const validationErrors = {};
            if (!payload.name) {
                validationErrors.name = tx('El nombre es obligatorio.');
            }
            if (!requiresParent && !payload.product_line_id) {
                validationErrors.product_line_id = tx('Selecciona una línea de producto.');
            }
            if (requiresParent) {
                if (!payload.product_line_id) {
                    validationErrors.product_line_id = tx('Selecciona una línea de producto.');
                }
                if (requiresParent && !payload.parent_id) {
                    validationErrors.parent_id = tx('Selecciona una categoría padre.');
                }
            }

            if (Object.keys(validationErrors).length > 0) {
                applyFormErrors(validationErrors);
                showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
                return;
            }

            setSubmitLoading(true);

            const url = mode === 'create' ? storeUrl : `${baseUrl}/${productCategoryId}`;
            const method = mode === 'create' ? 'POST' : 'PATCH';

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    if (response.status === 422 && json?.errors) {
                        applyFormErrors(json.errors);
                        showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                    } else {
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                    }
                    return;
                }

                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
                closeModal(modals.form);
                refreshTable();
            } catch (error) {
                console.error('[ProductCategories] Submit error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
            } finally {
                setSubmitLoading(false);
            }
        };

        const handleDelete = async () => {
            if (!modals.delete || !deleteConfirmButton) {
                return;
            }
            const productCategoryId = modals.delete.dataset.productCategoryId;
            if (!productCategoryId) {
                closeModal(modals.delete);
                return;
            }

            deleteConfirmButton.disabled = true;
            deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

            try {
                const response = await fetch(`${baseUrl}/${productCategoryId}`, {
                    method: 'DELETE',
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                    return;
                }

                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
                closeModal(modals.delete);
                refreshTable();
            } catch (error) {
                console.error('[ProductCategories] Delete error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
            } finally {
                deleteConfirmButton.disabled = false;
                deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
            }
        };

        const handleStatusToggle = async (input) => {
            const productCategoryId = input.dataset.id ?? '';
            if (!productCategoryId || input.disabled) {
                return;
            }

            const previousChecked = !input.checked;
            const newStatus = input.checked ? 'A' : 'I';

            input.disabled = true;

            try {
                const response = await fetch(`${baseUrl}/${productCategoryId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify({ status: newStatus }),
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    input.checked = previousChecked;
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                    return;
                }

                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
                refreshTable();
            } catch (error) {
                console.error('[ProductCategories] Status toggle error', error);
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
            } finally {
                input.disabled = false;
            }
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                handleSubmit();
            });
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.addEventListener('click', handleDelete);
        }

        root.addEventListener('click', (event) => {
            console.log('🔵 [ProductCategories] Click detected', {
                target: event.target,
                targetTagName: event.target?.tagName,
                targetClasses: event.target?.className,
                targetId: event.target?.id,
                targetDataset: event.target?.dataset,
            });

            // Find the action element, checking both the target and its parent
            let actionEl = null;
            if (event.target instanceof Element) {
                actionEl = event.target.closest('[data-product-category-action], [data-action], [data-row-action]');
                console.log('🔵 [ProductCategories] First closest search', { 
                    found: !!actionEl,
                    element: actionEl,
                    tagName: actionEl?.tagName,
                    classes: actionEl?.className,
                });
                
                // If not found and target is an icon, try the parent button
                if (!actionEl && (event.target.tagName === 'I' || event.target.classList.contains('fa'))) {
                    actionEl = event.target.closest('button[data-action], button[data-row-action]');
                    console.log('🔵 [ProductCategories] Second closest search (icon)', { 
                        found: !!actionEl,
                        element: actionEl,
                        tagName: actionEl?.tagName,
                    });
                }
            }
            
            console.log('🔵 [ProductCategories] Final actionEl', {
                found: !!actionEl,
                element: actionEl,
                allAttributes: actionEl ? Array.from(actionEl.attributes).map(attr => ({ name: attr.name, value: attr.value })) : null,
                dataset: actionEl?.dataset,
            });

            if (!actionEl) {
                console.log('🔵 [ProductCategories] No actionEl found, returning');
                return;
            }

            if (actionEl.hasAttribute('data-product-category-action')) {
                const action = actionEl.dataset.productCategoryAction;
                console.log('🔵 [ProductCategories] Product category action', { action });
                if (action === 'create') {
                    if (requiresParent) {
                        parentOptionsCache.clear();
                        parentSelectHelper?.renderOptions([]);
                        parentSelectHelper?.setValue('');
                    }
                    setFormMode('create');
                    openModal(modals.form);
                }
                return;
            }

            const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
            console.log('🔵 [ProductCategories] Row action extracted', {
                rowAction,
                dataAction: actionEl.dataset.action,
                dataRowAction: actionEl.dataset.rowAction,
            });
            
            if (!rowAction) {
                console.log('🔵 [ProductCategories] No rowAction found, returning');
                return;
            }

            const rowId = (actionEl.dataset.id || actionEl.dataset.rowId || '').trim();
            const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
            const payload = actionEl.dataset.rowPayload;
            let data = payload ? decodePayload(payload) : null;

            console.log('🔵 [ProductCategories] Action clicked - FULL DATA', {
                rowAction,
                rowId,
                rowName,
                hasPayload: !!payload,
                payload,
                data,
                baseUrl,
                csrfToken: csrfToken ? 'present' : 'missing',
                allDatasetKeys: Object.keys(actionEl.dataset),
                datasetId: actionEl.dataset.id,
                datasetRowId: actionEl.dataset.rowId,
            });

            if (!rowId) {
                console.error('🔴 [ProductCategories] Missing rowId', { 
                    actionEl, 
                    rowAction,
                    allDatasetKeys: actionEl ? Object.keys(actionEl.dataset) : null,
                    dataset: actionEl?.dataset,
                });
                showAlert({ title: tx('Error'), text: tx('No se pudo identificar el registro seleccionado.'), icon: 'error' });
                return;
            }

            // If no payload, fetch data from server using rowId
            if (!data && rowId) {
                console.log('🟡 [ProductCategories] No payload, will fetch from server', { rowId, rowAction, hasData: !!data });
                
                if (rowAction === 'view' || rowAction === 'edit') {
                    if (!baseUrl) {
                        console.error('🔴 [ProductCategories] Missing baseUrl');
                        showAlert({ title: tx('Error'), text: tx('Error de configuración. Por favor, recarga la página.'), icon: 'error' });
                        return;
                    }
                    const fetchUrl = `${baseUrl}/${rowId}`;
                    console.log('🟢 [ProductCategories] Starting fetch', { 
                        fetchUrl, 
                        rowAction, 
                        rowId,
                        baseUrl,
                        method: 'GET',
                        headers: {
                            Accept: 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken ? 'present' : 'missing',
                        },
                    });
                    
                    fetch(fetchUrl, {
                        headers: {
                            Accept: 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken,
                        },
                    })
                        .then(async (response) => {
                            console.log('🟢 [ProductCategories] Response received (raw)', {
                                ok: response.ok,
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                url: response.url,
                            });
                            
                            const json = await response.json().catch((parseError) => {
                                console.error('🔴 [ProductCategories] JSON parse error', { parseError });
                                return null;
                            });
                            
                            console.log('🟢 [ProductCategories] Response JSON parsed', { json });
                            
                            if (!response.ok) {
                                console.error('🔴 [ProductCategories] Fetch failed - Response not OK', { 
                                    status: response.status, 
                                    statusText: response.statusText,
                                    url: fetchUrl,
                                    json,
                                    responseHeaders: Object.fromEntries(response.headers.entries()),
                                });
                                const errorMessage = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                                showAlert({ title: tx('Error'), text: errorMessage, icon: 'error' });
                                return null;
                            }
                            return json;
                        })
                        .then((json) => {
                            console.log('🟢 [ProductCategories] Processing response', { 
                                hasJson: !!json,
                                json,
                                status: json?.status,
                                hasData: !!json?.data,
                                hasItem: !!json?.data?.item,
                                item: json?.data?.item,
                            });
                            
                            if (!json) {
                                console.log('🟡 [ProductCategories] No JSON to process');
                                return;
                            }
                            
                            if (json?.status === 'success' && json?.data?.item) {
                                console.log('✅ [ProductCategories] Success! Opening modal', { rowAction, data: json.data.item });
                                data = json.data.item;
                                if (rowAction === 'view') {
                                    populateViewModal(data);
                                    openModal(modals.view);
                                } else if (rowAction === 'edit') {
                                    setFormMode('edit', data);
                                    openModal(modals.form);
                                }
                            } else {
                                const errorMsg = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                                console.error('🔴 [ProductCategories] Invalid response format', { 
                                    json, 
                                    expected: 'status: success, data.item',
                                    actualStatus: json?.status,
                                    hasData: !!json?.data,
                                    hasItem: !!json?.data?.item,
                                });
                                showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                            }
                        })
                        .catch((error) => {
                            console.error('🔴 [ProductCategories] Fetch error (catch)', { 
                                error, 
                                errorName: error.name,
                                errorMessage: error.message, 
                                errorStack: error.stack,
                                fetchUrl,
                            });
                            const errorMsg = error.message?.includes('Failed to fetch') 
                                ? tx('Error de conexión. Verifica tu conexión a internet.')
                                : tx('No se pudieron obtener los datos del registro.');
                            showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                        });
                    return;
                } else if (rowAction === 'delete') {
                    // For delete, we can use just the ID and name
                    if (modals.delete) {
                        modals.delete.dataset.productCategoryId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = rowName || rowId;
                    }
                    openModal(modals.delete);
                    return;
                }
            }

            if (!data || !data.id) {
                if (rowAction === 'delete') {
                    const productCategoryId = rowId || '';
                    const productCategoryName = rowName || '';
                    if (!productCategoryId) {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                        return;
                    }
                    if (modals.delete) {
                        modals.delete.dataset.productCategoryId = productCategoryId;
                    }
                    if (deleteName) {
                        deleteName.textContent = productCategoryName || productCategoryId;
                    }
                    openModal(modals.delete);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
                return;
            }

            if (rowAction === 'view') {
                populateViewModal(data);
                openModal(modals.view);
                return;
            }

            if (rowAction === 'edit') {
                setFormMode('edit', data);
                openModal(modals.form);
                return;
            }

            if (rowAction === 'delete') {
                if (modals.delete) {
                    modals.delete.dataset.productCategoryId = data.id ?? '';
                }
                if (deleteName) {
                    deleteName.textContent = (data.name || data.id) ?? '';
                }
                openModal(modals.delete);
            }
        });

        root.addEventListener('change', (event) => {
            const target = event.target;
            if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
                handleStatusToggle(target);
            }
            if (target instanceof HTMLInputElement && target.matches('[data-product-category-input="product_line_id"]')) {
                if (requiresParent) {
                    parentSelectHelper?.renderOptions([]);
                    parentSelectHelper?.setValue('');
                    loadParentOptions(target.value);
                }
            }
        });
    });
};
const initWorkshopCategoriesModule = () => {
    const root = document.querySelector('[data-workshop-categories-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.workshopCategoriesTableId ?? '';
    const baseUrl = root.dataset.workshopCategoriesBaseUrl ?? '';
    const storeUrl = root.dataset.workshopCategoriesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-workshop-category-modal="form"]'),
        view: root.querySelector('[data-workshop-category-modal="view"]'),
        delete: root.querySelector('[data-workshop-category-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-workshop-category-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-category-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-category-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-category-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-workshop-category-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-category-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-category-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-workshop-category-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-category-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-workshop-category-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-workshop-category-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-category-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-category-error="${field}"]`);
            const inputEl = form.querySelector(`[data-workshop-category-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-workshop-category-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-workshop-category-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.workshopCategoryId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = tx('Nueva categoría');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar categoría');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            setFieldValue('description', '');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-workshop-category-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-category-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const categoryId = form.dataset.workshopCategoryId ?? '';

        const payload = {
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${categoryId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopCategories] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const categoryId = modals.delete.dataset.workshopCategoryId;
        if (!categoryId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${categoryId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopCategories] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const categoryId = input.dataset.id ?? '';
        if (!categoryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${categoryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[WorkshopCategories] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-workshop-category-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-workshop-category-action')) {
            const action = actionEl.dataset.workshopCategoryAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        // If no payload, create data from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                name: rowName || null,
            };
        }

        if (!rowAction || !data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopCategories] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                populateViewModal(data);
                openModal(modals.view);
            }
            return;
        }

        if (rowAction === 'edit') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopCategories] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                setFormMode('edit', data);
                openModal(modals.form);
            }
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.workshopCategoryId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.name || data.id;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initWorkshopBrandsModule = () => {
    const root = document.querySelector('[data-workshop-brands-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.workshopBrandsTableId ?? '';
    const baseUrl = root.dataset.workshopBrandsBaseUrl ?? '';
    const storeUrl = root.dataset.workshopBrandsStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-workshop-brand-modal="form"]'),
        view: root.querySelector('[data-workshop-brand-modal="view"]'),
        delete: root.querySelector('[data-workshop-brand-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-workshop-brand-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-brand-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-brand-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-brand-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-workshop-brand-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-brand-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-brand-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-workshop-brand-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-brand-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-workshop-brand-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-workshop-brand-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-brand-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-brand-error="${field}"]`);
            const inputEl = form.querySelector(`[data-workshop-brand-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-workshop-brand-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-workshop-brand-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.workshopBrandId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = tx('Nueva marca');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar marca');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            setFieldValue('description', '');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-workshop-brand-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-brand-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const brandId = form.dataset.workshopBrandId ?? '';

        const payload = {
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${brandId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopBrands] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const brandId = modals.delete.dataset.workshopBrandId;
        if (!brandId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${brandId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopBrands] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const brandId = input.dataset.id ?? '';
        if (!brandId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${brandId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[WorkshopBrands] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-workshop-brand-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-workshop-brand-action')) {
            const action = actionEl.dataset.workshopBrandAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        // If no payload, create data from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                name: rowName || null,
            };
        }

        if (!rowAction || !data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopBrands] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                populateViewModal(data);
                openModal(modals.view);
            }
            return;
        }

        if (rowAction === 'edit') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopBrands] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                setFormMode('edit', data);
                openModal(modals.form);
            }
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.workshopBrandId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.name || data.id;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initWorkshopEquipmentsModule = () => {
    const root = document.querySelector('[data-workshop-equipments-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.workshopEquipmentsTableId ?? '';
    const baseUrl = root.dataset.workshopEquipmentsBaseUrl ?? '';
    const storeUrl = root.dataset.workshopEquipmentsStoreUrl ?? baseUrl;
    const modelsUrl = root.dataset.workshopEquipmentsModelOptionsUrl ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-workshop-equipment-modal="form"]'),
        view: root.querySelector('[data-workshop-equipment-modal="view"]'),
        delete: root.querySelector('[data-workshop-equipment-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-workshop-equipment-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-equipment-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-equipment-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-equipment-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-workshop-equipment-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-equipment-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-equipment-delete-confirm]') ?? null;

    const brandSelectRoot = form?.querySelector('[data-select-name="brand_id"]') ?? null;
    const brandOptionsContainer = brandSelectRoot?.querySelector('[data-workshop-equipment-brand-options]') ?? null;
    const brandTrigger = brandSelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const brandDropdown = brandSelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const brandValueLabel = brandSelectRoot?.querySelector('[data-select-value]') ?? null;
    const brandHiddenInput = form?.querySelector('[data-workshop-equipment-input="brand_id"]') ?? null;
    const brandIcon = brandSelectRoot?.querySelector('[data-select-icon]') ?? null;
    const brandPlaceholder = brandTrigger?.dataset.selectPlaceholder ?? '';

    const modelSelectRoot = form?.querySelector('[data-select-name="model_id"]') ?? null;
    const modelOptionsContainer = modelSelectRoot?.querySelector('[data-workshop-equipment-model-options]') ?? null;
    const modelTrigger = modelSelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const modelDropdown = modelSelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const modelValueLabel = modelSelectRoot?.querySelector('[data-select-value]') ?? null;
    const modelHiddenInput = form?.querySelector('[data-workshop-equipment-input="model_id"]') ?? null;
    const modelIcon = modelSelectRoot?.querySelector('[data-select-icon]') ?? null;
    const modelSearchInput = modelSelectRoot?.querySelector('[data-workshop-equipment-model-search]') ?? null;
    const modelPlaceholder = modelTrigger?.dataset.selectPlaceholder ?? '';

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-workshop-equipment-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-equipment-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
        closeBrandSelect();
        closeModelSelect();
    };

    root.querySelectorAll('[data-workshop-equipment-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-workshop-equipment-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-equipment-input]').forEach((input) => {
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
        if (brandSelectRoot) {
            brandSelectRoot.dataset.selectInvalid = 'false';
        }
        if (modelSelectRoot) {
            modelSelectRoot.dataset.selectInvalid = 'false';
        }
        brandTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        modelTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-equipment-error="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (field === 'brand_id') {
                if (brandSelectRoot) {
                    brandSelectRoot.dataset.selectInvalid = 'true';
                }
                brandTrigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                return;
            }
            if (field === 'model_id') {
                if (modelSelectRoot) {
                    modelSelectRoot.dataset.selectInvalid = 'true';
                }
                modelTrigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                return;
            }
            const inputEl = form.querySelector(`[data-workshop-equipment-input="${field}"]`);
            if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-workshop-equipment-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-workshop-equipment-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-workshop-equipment-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-equipment-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const setMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }
        clearFormErrors();
        setSubmitLoading(false);
        form.dataset.mode = mode;
        form.dataset.workshopEquipmentId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setBrandValue('');
            setModelValue('');
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = tx('Nuevo equipo');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar equipo');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            setBrandValue(data.brand_id ?? '');
            setModelValue(data.model_id ?? '', data.model_name ?? '');
            setFieldValue('identifier', data.identifier ?? '');
            setFieldValue('note', data.note ?? '');
            setFieldValue('status', data.status ?? 'A');
        } else {
            setFieldValue('identifier', '');
            setFieldValue('note', '');
        }
    };

    const setBrandValue = (value) => {
        if (!brandHiddenInput) {
            return;
        }
        const normalized = value ? String(value) : '';
        brandHiddenInput.value = normalized;
        if (brandValueLabel) {
            const option = brandOptionsContainer?.querySelector(`[data-select-option][data-value="${normalized}"]`);
            const label = option?.dataset.label ?? brandPlaceholder;
            brandValueLabel.textContent = normalized ? label : brandPlaceholder;
        }
        brandOptionsContainer?.querySelectorAll('[data-select-option]').forEach((option) => {
            option.dataset.selected = option.dataset.value === normalized ? 'true' : 'false';
        });
        if (brandSelectRoot) {
            brandSelectRoot.dataset.selectInvalid = 'false';
        }
        brandTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        closeBrandSelect();
        if (!normalized) {
            setModelValue('');
            disableModelSelect();
        } else {
            enableModelSelect();
            loadModelOptions(normalized, modelSearchInput?.value ?? '');
        }
    };

    const setModelValue = (value, label) => {
        if (!modelHiddenInput) {
            return;
        }
        const normalized = value ? String(value) : '';
        modelHiddenInput.value = normalized;
        if (modelValueLabel) {
            modelValueLabel.textContent = normalized ? (label ?? findModelLabel(normalized)) : modelPlaceholder;
        }
        modelOptionsContainer?.querySelectorAll('[data-select-option]').forEach((option) => {
            option.dataset.selected = option.dataset.value === normalized ? 'true' : 'false';
        });
        if (modelSelectRoot) {
            modelSelectRoot.dataset.selectInvalid = 'false';
        }
        modelTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        closeModelSelect();
    };

    const findModelLabel = (value) => {
        const option = modelOptionsContainer?.querySelector(`[data-select-option][data-value="${value}"]`);
        return option?.dataset.label ?? modelPlaceholder;
    };

    const disableModelSelect = () => {
        modelTrigger?.classList.add('pointer-events-none', 'opacity-60');
        setModelValue('');
    };

    const enableModelSelect = () => {
        modelTrigger?.classList.remove('pointer-events-none', 'opacity-60');
    };

    const closeBrandSelect = () => {
        if (!brandSelectRoot || !brandDropdown) {
            return;
        }
        brandDropdown.hidden = true;
        brandDropdown.dataset.open = 'false';
        brandSelectRoot.dataset.open = 'false';
        brandTrigger?.setAttribute('aria-expanded', 'false');
        brandIcon?.classList.remove('rotate-180');
    };

    const openBrandSelect = () => {
        if (!brandSelectRoot || !brandDropdown) {
            return;
        }
        brandDropdown.hidden = false;
        brandDropdown.dataset.open = 'true';
        brandSelectRoot.dataset.open = 'true';
        brandTrigger?.setAttribute('aria-expanded', 'true');
        brandIcon?.classList.add('rotate-180');
    };

    const toggleBrandSelect = () => {
        if (!brandDropdown) {
            return;
        }
        if (brandDropdown.dataset.open === 'true') {
            closeBrandSelect();
            return;
        }
        openBrandSelect();
    };

    const closeModelSelect = () => {
        if (!modelSelectRoot || !modelDropdown) {
            return;
        }
        modelDropdown.hidden = true;
        modelDropdown.dataset.open = 'false';
        modelSelectRoot.dataset.open = 'false';
        modelTrigger?.setAttribute('aria-expanded', 'false');
        modelIcon?.classList.remove('rotate-180');
    };

    const openModelSelect = () => {
        if (!modelSelectRoot || !modelDropdown) {
            return;
        }
        modelDropdown.hidden = false;
        modelDropdown.dataset.open = 'true';
        modelSelectRoot.dataset.open = 'true';
        modelTrigger?.setAttribute('aria-expanded', 'true');
        modelIcon?.classList.add('rotate-180');
    };

    const toggleModelSelect = () => {
        if (!modelDropdown) {
            return;
        }
        if (modelDropdown.dataset.open === 'true') {
            closeModelSelect();
            return;
        }
        openModelSelect();
        if (brandHiddenInput?.value) {
            loadModelOptions(brandHiddenInput.value, modelSearchInput?.value ?? '');
        }
    };

    let modelFetchTimeout;

    const renderModelOptions = (items) => {
        if (!modelOptionsContainer) {
            return;
        }
        modelOptionsContainer.innerHTML = '';
        if (!items.length) {
            const empty = document.createElement('p');
            empty.className = 'px-4 py-2 text-sm text-gray-500 dark:text-gray-400';
            empty.textContent = tx('No hay modelos disponibles.');
            modelOptionsContainer.appendChild(empty);
            return;
        }
        items.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = item.id ?? '';
            button.dataset.label = item.name ?? '';
            button.dataset.selected = modelHiddenInput?.value === String(item.id) ? 'true' : 'false';
            button.innerHTML = `<span class="truncate">${item.name ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setModelValue(item.id ?? '', item.name ?? '');
                modelTrigger?.focus({ preventScroll: true });
            });
            modelOptionsContainer.appendChild(button);
        });
    };

    const loadModelOptions = async (brandId, search = '') => {
        if (!modelsUrl || !brandId) {
            renderModelOptions([]);
            return;
        }
        if (modelOptionsContainer) {
            modelOptionsContainer.innerHTML = `<p class="px-4 py-2 text-sm text-gray-500 dark:text-gray-400">${tx('Cargando...')}</p>`;
        }
        try {
            const url = new URL(modelsUrl, window.location.origin);
            url.searchParams.set('brand_id', brandId);
            url.searchParams.set('per_page', '200');
            if (search) {
                url.searchParams.set('search', search);
            }
            const response = await fetch(url.toString(), {
                headers: {
                    Accept: 'application/json',
                },
            });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data?.items) {
                renderModelOptions(json.data.items);
            } else {
                console.error('[WorkshopEquipments] models fetch error', json);
                renderModelOptions([]);
            }
        } catch (error) {
            console.error('[WorkshopEquipments] models fetch error', error);
            renderModelOptions([]);
        }
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const equipmentId = form.dataset.workshopEquipmentId ?? '';

        const payload = {
            brand_id: brandHiddenInput?.value ?? '',
            model_id: modelHiddenInput?.value ?? '',
            identifier: getFieldValue('identifier'),
            note: getFieldValue('note') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.brand_id) {
            validationErrors.brand_id = tx('Debes seleccionar una marca.');
        }
        if (!payload.model_id) {
            validationErrors.model_id = tx('Debes seleccionar un modelo.');
        }
        if (!payload.identifier) {
            validationErrors.identifier = tx('El identificador es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${equipmentId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopEquipments] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const equipmentId = modals.delete.dataset.workshopEquipmentId;
        if (!equipmentId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${equipmentId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopEquipments] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const equipmentId = input.dataset.id ?? '';
        if (!equipmentId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${equipmentId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[WorkshopEquipments] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    const openBarcodePdf = async (url) => {
        console.log('[WorkshopEquipments] openBarcodePdf start', { url });
        const popup = window.open(url, '_blank', 'noopener,noreferrer');
        if (popup && !popup.closed) {
            popup.focus();
            console.log('[WorkshopEquipments] barcode opened via direct popup');
            return;
        }

        console.warn('[WorkshopEquipments] popup blocked, attempting fetch fallback', { url });

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    Accept: 'application/pdf',
                },
            });

            if (!response.ok) {
                throw new Error(`Unexpected response status ${response.status}`);
            }

            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            console.log('[WorkshopEquipments] blob fallback generated', { blobUrl });

            const blobWindow = window.open(blobUrl, '_blank', 'noopener,noreferrer');
            if (blobWindow && !blobWindow.closed) {
                blobWindow.focus();
                console.log('[WorkshopEquipments] barcode opened from blob fallback');
            } else {
                console.warn('[WorkshopEquipments] blob popup blocked, redirecting current tab', { blobUrl });
                window.location.href = blobUrl;
            }

            setTimeout(() => {
                URL.revokeObjectURL(blobUrl);
                console.log('[WorkshopEquipments] blob URL revoked');
            }, 10_000);
        } catch (error) {
            console.error('[WorkshopEquipments] barcode fallback error', error);
            window.location.href = url;
        }
    };

    const enhanceBarcodeButtons = () => {
        const candidates = root.querySelectorAll('[data-row-url]:not([data-row-action])');
        candidates.forEach((button) => {
            if (!(button instanceof HTMLElement)) {
                return;
            }
            const hasBarcodeIcon = button.querySelector('i.fa-barcode, i.fa-solid.fa-barcode');
            if (!hasBarcodeIcon) {
                return;
            }
            button.dataset.rowAction = 'barcode';
            console.log('[WorkshopEquipments] enhanced barcode button', { button });
        });
    };

    const barcodeObserver = new MutationObserver(() => {
        enhanceBarcodeButtons();
    });

    barcodeObserver.observe(root, {
        childList: true,
        subtree: true,
    });

    enhanceBarcodeButtons();

    root.addEventListener('click', (event) => {
        if (!(event.target instanceof Element)) {
            return;
        }

        console.log('[WorkshopEquipments] click detected', { target: event.target, tagName: event.target.tagName });

        let actionEl = event.target.closest('[data-workshop-equipment-action], [data-action], [data-row-action], [data-barcode-url], [data-url], [data-row-url], [data-row-payload]');
        if (!actionEl) {
            console.log('[WorkshopEquipments] no actionable element detected');
            return;
        }
        
        // If we clicked on an icon or other child element inside a button, use the button as actionEl
        if (actionEl.tagName !== 'BUTTON') {
            const buttonParent = actionEl.closest('button[data-action], button[data-url]');
            if (buttonParent) {
                console.log('[WorkshopEquipments] using button parent instead of child element', { 
                    original: actionEl.tagName, 
                    button: buttonParent,
                    buttonAttributes: Array.from(buttonParent.attributes).map(attr => `${attr.name}="${attr.value}"`).join(', ')
                });
                actionEl = buttonParent;
            }
        }

        const payloadSource = actionEl.dataset.rowPayload
            ? actionEl
            : actionEl.closest('[data-row-payload]');

        let data = null;
        const payloadValue = payloadSource?.dataset?.rowPayload ?? actionEl.dataset.rowPayload ?? null;
        if (payloadValue) {
            try {
                data = decodePayload(payloadValue);
            } catch (error) {
                console.error('[WorkshopEquipments] payload decode error', error, { payloadValue });
            }
        }

        const dataset = actionEl.dataset ?? {};
        let rowAction = dataset.workshopEquipmentAction ?? dataset.action ?? dataset.rowAction ?? null;
        // Try both dataset and getAttribute for data-url (dataset.url might not work in all cases)
        let barcodeUrlAttr = dataset.barcodeUrl
            ?? (actionEl.getAttribute('data-url') || dataset.url)
            ?? dataset.rowUrl
            ?? '';
        
        // Also check payloadSource
        if (!barcodeUrlAttr) {
            barcodeUrlAttr = payloadSource?.dataset?.barcodeUrl
                ?? (payloadSource?.getAttribute?.('data-url') || payloadSource?.dataset?.url)
                ?? payloadSource?.dataset?.rowUrl
                ?? '';
        }
        
        console.log('[WorkshopEquipments] URL extraction', {
            barcodeUrlAttr,
            datasetUrl: dataset.url,
            getAttributeUrl: actionEl.getAttribute('data-url'),
            actionElTagName: actionEl.tagName,
            actionElHasDataUrl: actionEl.hasAttribute('data-url'),
        });

        if (!rowAction && barcodeUrlAttr) {
            rowAction = 'barcode';
        }

        if (!rowAction && data?.barcode_label_url) {
            rowAction = 'barcode';
            }

        console.log('[WorkshopEquipments] resolved action', {
            rowAction,
            dataset,
            barcodeUrlAttr,
            data,
            payloadSource,
            actionEl,
            actionElTagName: actionEl?.tagName,
            actionElAttributes: actionEl ? Array.from(actionEl.attributes).map(attr => `${attr.name}="${attr.value}"`).join(', ') : null,
        });

        if (rowAction === 'create') {
            setMode('create');
            openModal(modals.form);
            return;
        }

        if (!rowAction) {
            console.log('[WorkshopEquipments] rowAction unresolved, skipping');
            return;
        }

        // Get row ID and name from button attributes if data is not available
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        
        // If no data from payload, create from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                identifier: rowName || null,
            };
        }

        if (rowAction === 'view') {
            // Always fetch full data from server to ensure we have all fields
            const equipmentId = data?.id ?? rowId ?? '';
            if (!equipmentId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            console.log('[WorkshopEquipments] Fetching equipment', { equipmentId, url: `${baseUrl}/${equipmentId}`, data, rowId });
            fetch(`${baseUrl}/${equipmentId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => {
                    console.log('[WorkshopEquipments] Response received', { status: response.status, ok: response.ok, url: response.url });
                    return response.json().then((json) => ({ response, json }));
                })
                .then(({ response, json }) => {
                    if (response.ok && json?.data?.item) {
                        populateViewModal(json.data.item);
                        openModal(modals.view);
                    } else {
                        console.error('[WorkshopEquipments] Error response', { response: { status: response.status, ok: response.ok }, json });
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopEquipments] Fetch error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'edit') {
            // Always fetch full data from server to ensure we have all fields
            const equipmentId = data?.id ?? rowId ?? '';
            if (!equipmentId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            fetch(`${baseUrl}/${equipmentId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        setMode('edit', json.data.item);
                        openModal(modals.form);
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopEquipments] Fetch error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'delete') {
            const deleteId = data?.id ?? rowId ?? '';
            if (!deleteId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            // Always fetch full data from server to get equipment identifier
            fetch(`${baseUrl}/${deleteId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        data = json.data.item;
                        if (modals.delete) {
                            modals.delete.dataset.workshopEquipmentId = deleteId;
                        }
                        if (deleteName) {
                            deleteName.textContent = data?.identifier ?? data?.display_name ?? deleteId;
                        }
                        openModal(modals.delete);
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopEquipments] Fetch error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'barcode') {
            const url = barcodeUrlAttr || data?.barcode_label_url || '';
            const hasIdentifier = data?.identifier || actionEl.dataset.identifier || '';
            if (!url) {
                if (!hasIdentifier) {
                    showAlert({ title: tx('Error'), text: tx('El equipo no tiene identificador configurado. Debes agregar un identificador para generar el código de barras.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudo generar el código de barras del equipo.'), icon: 'error' });
                }
                return;
            }
            console.log('[WorkshopEquipments] barcode action', { url, data, dataset });
            openBarcodePdf(url);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
    brandOptionsContainer?.querySelectorAll('[data-select-option]').forEach((option) => {
        option.addEventListener('click', (event) => {
            event.preventDefault();
            setBrandValue(option.dataset.value ?? '');
            brandTrigger?.focus({ preventScroll: true });
        });
    });

    brandTrigger?.addEventListener('click', (event) => {
        event.preventDefault();
        toggleBrandSelect();
    });

    brandTrigger?.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeBrandSelect();
        }
        if (['Enter', ' '].includes(event.key)) {
            event.preventDefault();
            toggleBrandSelect();
        }
    });

    document.addEventListener('click', (event) => {
        if (!brandSelectRoot || !event.target) {
            return;
        }
        if (!brandSelectRoot.contains(event.target)) {
            closeBrandSelect();
        }
    });
    modelTrigger?.addEventListener('click', (event) => {
        event.preventDefault();
        if (!brandHiddenInput?.value) {
            showAlert({ title: tx('Información'), text: tx('Selecciona una marca primero.'), icon: 'info' });
            return;
        }
        toggleModelSelect();
        loadModelOptions(brandHiddenInput.value, modelSearchInput?.value ?? '');
    });

    modelTrigger?.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeModelSelect();
        }
        if (['Enter', ' '].includes(event.key)) {
            event.preventDefault();
            if (!brandHiddenInput?.value) {
                return;
            }
            toggleModelSelect();
            loadModelOptions(brandHiddenInput.value, modelSearchInput?.value ?? '');
        }
    });

    if (modelSearchInput) {
        modelSearchInput.addEventListener('input', () => {
            if (!brandHiddenInput?.value) {
                return;
            }
            clearTimeout(modelFetchTimeout);
            modelFetchTimeout = setTimeout(() => {
                loadModelOptions(brandHiddenInput.value, modelSearchInput.value.trim());
            }, 250);
        });
    }

    document.addEventListener('click', (event) => {
        if (!modelSelectRoot || !event.target) {
            return;
        }
        if (!modelSelectRoot.contains(event.target)) {
            closeModelSelect();
        }
    });

    if (!brandHiddenInput?.value) {
        disableModelSelect();
    } else {
        enableModelSelect();
    }

};


const initWorkshopModelsModule = () => {
    const root = document.querySelector('[data-workshop-models-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.workshopModelsTableId ?? '';
    const baseUrl = root.dataset.workshopModelsBaseUrl ?? '';
    const storeUrl = root.dataset.workshopModelsStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const brandsUrl = root.dataset.workshopModelsBrandOptionsUrl ?? '';

    const modals = {
        form: root.querySelector('[data-workshop-model-modal="form"]'),
        view: root.querySelector('[data-workshop-model-modal="view"]'),
        delete: root.querySelector('[data-workshop-model-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-workshop-model-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-model-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-model-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-model-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-workshop-model-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-model-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-model-delete-confirm]') ?? null;
    const brandSelectRoot = form?.querySelector('[data-select-name="brand_id"]') ?? null;
    const brandHiddenInput = form?.querySelector('[data-workshop-model-input="brand_id"]') ?? null;
    const brandOptionsContainer = brandSelectRoot?.querySelector('[data-workshop-model-brand-options]') ?? null;
    const brandTrigger = brandSelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const brandValueLabel = brandSelectRoot?.querySelector('[data-select-value]') ?? null;
    const brandDropdown = brandSelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const brandIcon = brandSelectRoot?.querySelector('[data-select-icon]') ?? null;
    const brandPlaceholder = brandTrigger?.dataset.selectPlaceholder ?? '';

    if (brandSelectRoot) {
        brandSelectRoot.dataset.selectManual = 'true';
    }

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-workshop-model-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-model-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
        closeBrandSelect();
        selectedBrandId = '';
        if (brandHiddenInput) {
            brandHiddenInput.value = '';
        }
        if (brandValueLabel) {
            brandValueLabel.textContent = brandPlaceholder;
        }
    };

    root.querySelectorAll('[data-workshop-model-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-workshop-model-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-model-input]').forEach((input) => {
            if (input instanceof HTMLInputElement && input.type === 'hidden') {
                return;
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
        if (brandSelectRoot) {
            brandSelectRoot.dataset.selectInvalid = 'false';
        }
        brandTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-model-error="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }

            if (field === 'brand_id') {
                if (brandSelectRoot) {
                    brandSelectRoot.dataset.selectInvalid = 'true';
                }
                brandTrigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                return;
            }

            const inputEl = form.querySelector(`[data-workshop-model-input="${field}"]`);
            if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    let cachedBrands = [];
    let isLoadingBrands = false;
    let selectedBrandId = '';

    const markBrandSelected = (value) => {
        if (!brandOptionsContainer) {
            return;
        }
        brandOptionsContainer.querySelectorAll('[data-select-option]').forEach((option) => {
            option.dataset.selected = option.dataset.value === value ? 'true' : 'false';
        });
    };

    const setBrandValue = (value) => {
        if (!brandHiddenInput) {
            return;
        }
        const normalizedValue = value ? String(value) : '';
        const optionFromCache = cachedBrands.find((item) => String(item.id) === normalizedValue);
        const optionFromDom = brandOptionsContainer
            ? Array.from(brandOptionsContainer.querySelectorAll('[data-select-option]')).find((option) => option.dataset.value === normalizedValue)
            : null;
        const label = optionFromCache?.name ?? optionFromDom?.dataset.label ?? brandPlaceholder;

        selectedBrandId = normalizedValue;
        brandHiddenInput.value = normalizedValue;
        if (brandValueLabel) {
            brandValueLabel.textContent = normalizedValue ? label : brandPlaceholder;
        }
        markBrandSelected(normalizedValue);
        if (brandSelectRoot) {
            brandSelectRoot.dataset.selectInvalid = 'false';
        }
        brandTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        brandTrigger?.classList.toggle('is-empty', !normalizedValue);
        brandHiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        form?.dispatchEvent(new CustomEvent('workshop-model-brand-change', {
            bubbles: true,
            detail: { brandId: normalizedValue },
        }));
    };

    const clearBrandValue = () => {
        selectedBrandId = '';
        if (brandHiddenInput) {
            brandHiddenInput.value = '';
        }
        if (brandValueLabel) {
            brandValueLabel.textContent = brandPlaceholder;
        }
        markBrandSelected('');
        brandTrigger?.classList.add('is-empty');
    };

    const renderBrandOptions = (items) => {
        if (!brandOptionsContainer) {
            return;
        }
        brandOptionsContainer.innerHTML = '';
        items.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = item.id ?? '';
            button.dataset.label = item.name ?? '';
            button.dataset.selected = brandHiddenInput?.value === String(item.id) ? 'true' : 'false';
            button.innerHTML = `<span class="truncate">${item.name ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setBrandValue(item.id ?? '');
                closeBrandSelect();
                brandTrigger?.focus({ preventScroll: true });
            });
            brandOptionsContainer.appendChild(button);
        });
        markBrandSelected(String(brandHiddenInput?.value ?? ''));
    };

    const closeBrandSelect = () => {
        if (!brandSelectRoot || !brandDropdown) {
            return;
        }
        brandDropdown.hidden = true;
        brandDropdown.dataset.open = 'false';
        brandSelectRoot.dataset.open = 'false';
        brandTrigger?.setAttribute('aria-expanded', 'false');
        brandIcon?.classList.remove('rotate-180');
    };

    const openBrandSelect = () => {
        if (!brandSelectRoot || !brandDropdown) {
            return;
        }
        brandDropdown.hidden = false;
        brandDropdown.dataset.open = 'true';
        brandSelectRoot.dataset.open = 'true';
        brandTrigger?.setAttribute('aria-expanded', 'true');
        brandIcon?.classList.add('rotate-180');
    };

    const ensureBrandOptions = async (selectedValue = '') => {
        renderBrandOptions(cachedBrands);
        const valueToApply = selectedValue ?? selectedBrandId ?? brandHiddenInput?.value ?? '';
        setBrandValue(valueToApply);

        if (!brandsUrl || isLoadingBrands || cachedBrands.length > 0) {
            return cachedBrands;
        }

        isLoadingBrands = true;
        try {
            const url = `${brandsUrl}${brandsUrl.includes('?') ? '&' : '?'}per_page=200`;
            const response = await fetch(url, {
                headers: {
                    Accept: 'application/json',
                },
            });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data?.items) {
                cachedBrands = json.data.items;
        renderBrandOptions(cachedBrands);
        const valueToApply = selectedValue ?? selectedBrandId ?? brandHiddenInput?.value ?? '';
        setBrandValue(valueToApply);
            } else {
                console.error('[WorkshopModels] brands fetch error', json);
            }
        } catch (error) {
            console.error('[WorkshopModels] brands fetch error', error);
        } finally {
            isLoadingBrands = false;
        }

        return cachedBrands;
    };

    const toggleBrandSelect = () => {
        if (!brandDropdown) {
            return;
        }
        if (brandDropdown.dataset.open === 'true') {
            closeBrandSelect();
            return;
        }
        openBrandSelect();
        ensureBrandOptions(brandHiddenInput?.value ?? '');
    };

    const handleTriggerKeydown = (event) => {
        if (event.key === 'Escape') {
            closeBrandSelect();
            return;
        }
        if (['Enter', ' '].includes(event.key)) {
            event.preventDefault();
            toggleBrandSelect();
        }
    };

    const handleDocumentClick = (event) => {
        if (!brandSelectRoot || !event.target) {
            return;
        }
        if (brandSelectRoot.contains(event.target)) {
            return;
        }
        closeBrandSelect();
    };

    const handleDocumentKeydown = (event) => {
        if (event.key === 'Escape') {
            closeBrandSelect();
        }
    };

    if (brandTrigger) {
        brandTrigger.addEventListener('click', (event) => {
            event.preventDefault();
            toggleBrandSelect();
        });
        brandTrigger.addEventListener('keydown', handleTriggerKeydown);
    }

    brandDropdown?.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeBrandSelect();
            brandTrigger?.focus({ preventScroll: true });
        }
    });

    if (brandSelectRoot) {
        document.addEventListener('click', handleDocumentClick);
        document.addEventListener('keydown', handleDocumentKeydown);
    }

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        if (field === 'brand_id') {
            setBrandValue(value ?? '');
            return;
        }
        const input = form.querySelector(`[data-workshop-model-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        if (field === 'brand_id') {
            return brandHiddenInput?.value?.trim() ?? '';
        }
        const input = form.querySelector(`[data-workshop-model-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);
        closeBrandSelect();

        form.dataset.mode = mode;
        form.dataset.workshopModelId = data?.id ?? '';

        ensureBrandOptions().finally(() => {
            if (mode === 'create') {
                form.reset();
                setFieldValue('status', 'A');
                clearBrandValue();
                if (modalTitle) {
                    modalTitle.textContent = tx('Nuevo modelo');
                }
                submitLabel.textContent = tx('Guardar');
                submitButton.dataset.originalLabel = tx('Guardar');
            } else {
                if (modalTitle) {
                    modalTitle.textContent = tx('Editar modelo');
                }
                submitLabel.textContent = tx('Actualizar');
                submitButton.dataset.originalLabel = tx('Actualizar');
            }

            clearBrandValue();
            setFieldValue('name', data?.name ?? '');
            setFieldValue('description', data?.description ?? '');
            setFieldValue('status', data?.status ?? 'A');

            if (data?.brand_id) {
                setBrandValue(data.brand_id);
            }
        });
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-workshop-model-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-model-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const modelId = form.dataset.workshopModelId ?? '';
        const brandValue = brandHiddenInput?.value?.trim() ?? '';

        const payload = {
            brand_id: brandValue !== '' ? brandValue : null,
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.brand_id) {
            validationErrors.brand_id = tx('Selecciona una marca.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        console.log('[WorkshopModels] submit payload', payload);

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${modelId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopModels] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const modelId = modals.delete.dataset.workshopModelId;
        if (!modelId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${modelId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopModels] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const modelId = input.dataset.id ?? '';
        if (!modelId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${modelId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el modelo.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El modelo se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[WorkshopModels] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el modelo.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (brandSelectRoot) {
        ensureBrandOptions(selectedBrandId);
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-workshop-model-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-workshop-model-action')) {
            const action = actionEl.dataset.workshopModelAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;
        console.log('[WorkshopModels] action resolved', { action: rowAction, data, actionEl });

        // If no payload, create data from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                name: rowName || null,
            };
        }

        if (!rowAction || !data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopModels] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                populateViewModal(data);
                openModal(modals.view);
            }
            return;
        }

        if (rowAction === 'edit') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopModels] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                setFormMode('edit', data);
                openModal(modals.form);
            }
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.workshopModelId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.name || data.id;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initWorkshopStatesModule = () => {
    const root = document.querySelector('[data-workshop-states-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.workshopStatesTableId ?? '';
    const baseUrl = root.dataset.workshopStatesBaseUrl ?? '';
    const storeUrl = root.dataset.workshopStatesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const categoriesUrl = root.dataset.workshopStatesCategoryOptionsUrl ?? '';

    const modals = {
        form: root.querySelector('[data-workshop-state-modal="form"]'),
        view: root.querySelector('[data-workshop-state-modal="view"]'),
        delete: root.querySelector('[data-workshop-state-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-workshop-state-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-state-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-state-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-state-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-workshop-state-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-state-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-state-delete-confirm]') ?? null;
    const categorySelectRoot = form?.querySelector('[data-select-name="category_id"]') ?? null;
    const categoryHiddenInput = form?.querySelector('[data-workshop-state-input="category_id"]') ?? null;
    const categoryOptionsContainer = categorySelectRoot?.querySelector('[data-workshop-state-category-options]') ?? null;
    const categoryTrigger = categorySelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const categoryValueLabel = categorySelectRoot?.querySelector('[data-select-value]') ?? null;
    const categoryDropdown = categorySelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const categoryIcon = categorySelectRoot?.querySelector('[data-select-icon]') ?? null;
    const categoryPlaceholder = categoryTrigger?.dataset.selectPlaceholder ?? '';

    if (categorySelectRoot) {
        categorySelectRoot.dataset.selectManual = 'true';
    }

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-workshop-state-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-state-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
        closeCategorySelect();
        selectedCategoryId = '';
        if (categoryHiddenInput) {
            categoryHiddenInput.value = '';
        }
        if (categoryValueLabel) {
            categoryValueLabel.textContent = categoryPlaceholder;
        }
    };

    root.querySelectorAll('[data-workshop-state-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-workshop-state-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-state-input]').forEach((input) => {
            if (input instanceof HTMLInputElement && input.type === 'hidden') {
                return;
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
        if (categorySelectRoot) {
            categorySelectRoot.dataset.selectInvalid = 'false';
        }
        categoryTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-state-error="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }

            if (field === 'category_id') {
                if (categorySelectRoot) {
                    categorySelectRoot.dataset.selectInvalid = 'true';
                }
                categoryTrigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                return;
            }

            const inputEl = form.querySelector(`[data-workshop-state-input="${field}"]`);
            if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    let cachedCategories = [];
    let isLoadingCategories = false;
    let selectedCategoryId = '';

    const markCategorySelected = (value) => {
        if (!categoryOptionsContainer) {
            return;
        }
        categoryOptionsContainer.querySelectorAll('[data-select-option]').forEach((option) => {
            option.dataset.selected = option.dataset.value === value ? 'true' : 'false';
        });
    };

    const setCategoryValue = (value) => {
        if (!categoryHiddenInput) {
            return;
        }
        const normalizedValue = value ? String(value) : '';
        const optionFromCache = cachedCategories.find((item) => String(item.id) === normalizedValue);
        const optionFromDom = categoryOptionsContainer
            ? Array.from(categoryOptionsContainer.querySelectorAll('[data-select-option]')).find((option) => option.dataset.value === normalizedValue)
            : null;
        const label = optionFromCache?.name ?? optionFromDom?.dataset.label ?? categoryPlaceholder;

        selectedCategoryId = normalizedValue;
        categoryHiddenInput.value = normalizedValue;
        if (categoryValueLabel) {
            categoryValueLabel.textContent = normalizedValue ? label : categoryPlaceholder;
        }
        markCategorySelected(normalizedValue);
        if (categorySelectRoot) {
            categorySelectRoot.dataset.selectInvalid = 'false';
        }
        categoryTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        categoryTrigger?.classList.toggle('is-empty', !normalizedValue);
        categoryHiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        form?.dispatchEvent(new CustomEvent('workshop-state-category-change', {
            bubbles: true,
            detail: { categoryId: normalizedValue },
        }));
        console.log('[WorkshopStates] category selected', { categoryId: normalizedValue, label, hiddenValue: categoryHiddenInput.value });
    };

    const clearCategoryValue = () => {
        selectedCategoryId = '';
        if (categoryHiddenInput) {
            categoryHiddenInput.value = '';
        }
        if (categoryValueLabel) {
            categoryValueLabel.textContent = categoryPlaceholder;
        }
        markCategorySelected('');
        categoryTrigger?.classList.add('is-empty');
    };

    const renderCategoryOptions = (items) => {
        if (!categoryOptionsContainer) {
            return;
        }
        categoryOptionsContainer.innerHTML = '';
        items.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = item.id ?? '';
            button.dataset.label = item.name ?? '';
            button.dataset.selected = categoryHiddenInput?.value === String(item.id) ? 'true' : 'false';
            button.innerHTML = `<span class="truncate">${item.name ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setCategoryValue(item.id ?? '');
                closeCategorySelect();
                categoryTrigger?.focus({ preventScroll: true });
            });
            categoryOptionsContainer.appendChild(button);
        });
        markCategorySelected(String(categoryHiddenInput?.value ?? ''));
    };

    const closeCategorySelect = () => {
        if (!categorySelectRoot || !categoryDropdown) {
            return;
        }
        categoryDropdown.hidden = true;
        categoryDropdown.dataset.open = 'false';
        categorySelectRoot.dataset.open = 'false';
        categoryTrigger?.setAttribute('aria-expanded', 'false');
        categoryIcon?.classList.remove('rotate-180');
    };

    const openCategorySelect = () => {
        if (!categorySelectRoot || !categoryDropdown) {
            return;
        }
        categoryDropdown.hidden = false;
        categoryDropdown.dataset.open = 'true';
        categorySelectRoot.dataset.open = 'true';
        categoryTrigger?.setAttribute('aria-expanded', 'true');
        categoryIcon?.classList.add('rotate-180');
    };

    const ensureCategoryOptions = async (selectedValue = '') => {
        renderCategoryOptions(cachedCategories);
        const valueToApply = selectedValue ?? selectedCategoryId ?? categoryHiddenInput?.value ?? '';
        setCategoryValue(valueToApply);

        if (!categoriesUrl || isLoadingCategories || cachedCategories.length > 0) {
            return cachedCategories;
        }

        isLoadingCategories = true;
        try {
            const url = `${categoriesUrl}${categoriesUrl.includes('?') ? '&' : '?'}per_page=200`;
            const response = await fetch(url, {
                headers: {
                    Accept: 'application/json',
                },
            });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data?.items) {
                cachedCategories = json.data.items;
        renderCategoryOptions(cachedCategories);
        const valueToApply = selectedValue ?? selectedCategoryId ?? categoryHiddenInput?.value ?? '';
        setCategoryValue(valueToApply);
            } else {
                console.error('[WorkshopStates] categories fetch error', json);
            }
        } catch (error) {
            console.error('[WorkshopStates] categories fetch error', error);
        } finally {
            isLoadingCategories = false;
        }

        return cachedCategories;
    };

    const toggleCategorySelect = () => {
        if (!categoryDropdown) {
            return;
        }
        if (categoryDropdown.dataset.open === 'true') {
            closeCategorySelect();
            return;
        }
        openCategorySelect();
        ensureCategoryOptions(categoryHiddenInput?.value ?? '');
    };

    const handleTriggerKeydown = (event) => {
        if (event.key === 'Escape') {
            closeCategorySelect();
            return;
        }
        if (['Enter', ' '].includes(event.key)) {
            event.preventDefault();
            toggleCategorySelect();
        }
    };

    const handleDocumentClick = (event) => {
        if (!categorySelectRoot || !event.target) {
            return;
        }
        if (categorySelectRoot.contains(event.target)) {
            return;
        }
        closeCategorySelect();
    };

    const handleDocumentKeydown = (event) => {
        if (event.key === 'Escape') {
            closeCategorySelect();
        }
    };

    if (categoryTrigger) {
        categoryTrigger.addEventListener('click', (event) => {
            event.preventDefault();
            toggleCategorySelect();
        });
        categoryTrigger.addEventListener('keydown', handleTriggerKeydown);
    }

    categoryDropdown?.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeCategorySelect();
            categoryTrigger?.focus({ preventScroll: true });
        }
    });

    if (categorySelectRoot) {
        document.addEventListener('click', handleDocumentClick);
        document.addEventListener('keydown', handleDocumentKeydown);
    }

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        if (field === 'category_id') {
            setCategoryValue(value ?? '');
            return;
        }
        const input = form.querySelector(`[data-workshop-state-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        if (field === 'category_id') {
            return categoryHiddenInput?.value?.trim() ?? '';
        }
        const input = form.querySelector(`[data-workshop-state-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);
        closeCategorySelect();

        form.dataset.mode = mode;
        form.dataset.workshopStateId = data?.id ?? '';

        ensureCategoryOptions().finally(() => {
            if (mode === 'create') {
                form.reset();
                setFieldValue('status', 'A');
                clearCategoryValue();
                if (modalTitle) {
                    modalTitle.textContent = tx('Nuevo estado');
                }
                submitLabel.textContent = tx('Guardar');
                submitButton.dataset.originalLabel = tx('Guardar');
            } else {
                if (modalTitle) {
                    modalTitle.textContent = tx('Editar estado');
                }
                submitLabel.textContent = tx('Actualizar');
                submitButton.dataset.originalLabel = tx('Actualizar');
            }

            clearCategoryValue();
            setFieldValue('name', data?.name ?? '');
            setFieldValue('description', data?.description ?? '');
            setFieldValue('status', data?.status ?? 'A');

            if (data?.category_id) {
                setCategoryValue(data.category_id);
            }
        });
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-workshop-state-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-state-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const stateId = form.dataset.workshopStateId ?? '';
        const categoryValue = categoryHiddenInput?.value?.trim() ?? '';

        const payload = {
            category_id: categoryValue !== '' ? categoryValue : null,
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.category_id) {
            validationErrors.category_id = tx('Selecciona una categoría.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        console.log('[WorkshopStates] submit payload', payload);

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${stateId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopStates] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const stateId = modals.delete.dataset.workshopStateId;
        if (!stateId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${stateId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopStates] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const stateId = input.dataset.id ?? '';
        if (!stateId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${stateId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[WorkshopStates] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (categorySelectRoot) {
        ensureCategoryOptions(selectedCategoryId);
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-workshop-state-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-workshop-state-action')) {
            const action = actionEl.dataset.workshopStateAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        // Get row ID and name from button attributes
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;

        // If no payload, create data from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                name: rowName || null,
            };
        }

        if (!rowAction || !data || !data.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopStates] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                populateViewModal(data);
                openModal(modals.view);
            }
            return;
        }

        if (rowAction === 'edit') {
            // If we only have ID, fetch full data from server
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${data.id}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopStates] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                setFormMode('edit', data);
                openModal(modals.form);
            }
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.workshopStateId = data.id;
            }
            if (deleteName) {
                deleteName.textContent = rowName || data.name || data.id;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initServiceCategoriesModule = () => {
    const root = document.querySelector('[data-service-categories-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.serviceCategoriesTableId ?? '';
    const baseUrl = root.dataset.serviceCategoriesBaseUrl ?? '';
    const storeUrl = root.dataset.serviceCategoriesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-service-category-modal="form"]'),
        view: root.querySelector('[data-service-category-modal="view"]'),
        delete: root.querySelector('[data-service-category-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-service-category-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-service-category-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-service-category-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-service-category-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-service-category-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-service-category-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-service-category-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-service-category-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-service-category-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-service-category-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-service-category-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-service-category-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-service-category-error="${field}"]`);
            const inputEl = form.querySelector(`[data-service-category-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-service-category-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-service-category-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.serviceCategoryId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nueva categoría';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar categoría';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('name', data.name ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-service-category-view-field]').forEach((element) => {
            const field = element.getAttribute('data-service-category-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const categoryId = form.dataset.serviceCategoryId ?? '';

        const payload = {
            name: getFieldValue('name'),
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${categoryId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[ServiceCategories] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const categoryId = modals.delete.dataset.serviceCategoryId;
        if (!categoryId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${categoryId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[ServiceCategories] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const categoryId = input.dataset.id ?? '';
        if (!categoryId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${categoryId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[ServiceCategories] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target.closest('[data-service-category-action], [data-action], [data-row-action]');
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        // Verificar si es el botón de crear PRIMERO, antes de preventDefault
        if (actionEl.hasAttribute('data-service-category-action')) {
            const action = actionEl.dataset.serviceCategoryAction;
            if (action === 'create') {
                event.preventDefault();
                event.stopPropagation();
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        event.preventDefault();
        event.stopPropagation();

        const action = actionEl.dataset.action || actionEl.dataset.rowAction;
        
        if (!action) {
            return;
        }

        // Obtener ID directamente de los atributos del botón
        const serviceCategoryId = actionEl.dataset.id || actionEl.dataset.rowId;
        const serviceCategoryName = actionEl.dataset.name || actionEl.dataset.rowName || '';

        if (!serviceCategoryId) {
            console.error('[ServiceCategories] No se pudo obtener el ID de la categoría', { action, actionEl });
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (action === 'view') {
            // Fetch service category data
            fetch(`${baseUrl}/${serviceCategoryId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.status === 'success' && json?.data?.item) {
                        populateViewModal(json.data.item);
                        openModal(modals.view);
                    } else {
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[ServiceCategories] Error fetching service category', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                });
            return;
        }

        if (action === 'edit') {
            // Fetch service category data
            fetch(`${baseUrl}/${serviceCategoryId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.status === 'success' && json?.data?.item) {
                        setFormMode('edit', json.data.item);
                        openModal(modals.form);
                    } else {
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[ServiceCategories] Error fetching service category', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                });
            return;
        }

        if (action === 'delete') {
            const deleteId = serviceCategoryId;
            const name = serviceCategoryName || deleteId;
            if (modals.delete) {
                modals.delete.dataset.serviceCategoryId = deleteId;
            }
            if (deleteName) {
                deleteName.textContent = name;
            }
            openModal(modals.delete);
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initCustomerCategoriesModule = () => {
    console.log('🔵 [CustomerCategories] Module initialization started');
    const roots = document.querySelectorAll('[data-customer-categories-root]');
    console.log('🔵 [CustomerCategories] Found roots', { count: roots.length, roots: Array.from(roots) });
    
    document.querySelectorAll('[data-customer-categories-root]').forEach((root, index) => {
        console.log(`🔵 [CustomerCategories] Initializing root ${index + 1}`, { root, attributes: Array.from(root.attributes).map(attr => ({ name: attr.name, value: attr.value })) });
        
        const tableId = root.dataset.customerCategoriesTableId ?? '';
        const baseUrl = root.dataset.customerCategoriesBaseUrl ?? '';
        const storeUrl = root.dataset.customerCategoriesStoreUrl ?? baseUrl;
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

        console.log('🔵 [CustomerCategories] init - Configuration', { 
            tableId, 
            baseUrl, 
            storeUrl,
            csrfToken: csrfToken ? 'present' : 'missing',
            rootElement: root,
            allDataAttributes: Object.keys(root.dataset),
        });

        const modals = {
            form: root.querySelector('[data-customer-category-modal="form"]'),
            view: root.querySelector('[data-customer-category-modal="view"]'),
            delete: root.querySelector('[data-customer-category-modal="delete"]'),
        };

        const form = modals.form?.querySelector('[data-customer-category-form]') ?? null;
        const submitButton = modals.form?.querySelector('[data-customer-category-submit]') ?? null;
        const submitLabel = submitButton?.querySelector('[data-customer-category-submit-label]') ?? null;
        const modalTitle = modals.form?.querySelector('[data-customer-category-modal-title]') ?? null;
        const viewContainer = modals.view?.querySelector('[data-customer-category-view]') ?? null;
        const deleteName = modals.delete?.querySelector('[data-customer-category-delete-name]') ?? null;
        const deleteConfirmButton = modals.delete?.querySelector('[data-customer-category-delete-confirm]') ?? null;

        const bodyOverflowClass = 'overflow-hidden';

        const getEventTargetModal = (target) => target.closest('[data-customer-category-modal]');

        const openModal = (modal) => {
            if (!modal) {
                return;
            }
            modal.classList.remove('hidden');
            document.body.classList.add(bodyOverflowClass);
        };

        const closeModal = (modal) => {
            if (!modal) {
                return;
            }
            modal.classList.add('hidden');
            if (!root.querySelector('[data-customer-category-modal]:not(.hidden)')) {
                document.body.classList.remove(bodyOverflowClass);
            }
        };

        root.querySelectorAll('[data-customer-category-modal-close]').forEach((button) => {
            button.addEventListener('click', () => {
                const modal = getEventTargetModal(button);
                closeModal(modal);
            });
        });

        Object.values(modals).forEach((modal) => {
            if (!modal) {
                return;
            }
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal(modal);
                }
            });
            modal.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal(modal);
                }
            });
        });

        const clearFormErrors = () => {
            if (!form) {
                return;
            }
            form.querySelectorAll('[data-customer-category-error]').forEach((errorEl) => {
                errorEl.textContent = '';
            });
            form.querySelectorAll('[data-customer-category-input]').forEach((input) => {
                if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
                    input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            });
        };

        const applyFormErrors = (errors) => {
            if (!form || !errors) {
                return;
            }
            Object.entries(errors).forEach(([field, messages]) => {
                const message = Array.isArray(messages) ? messages[0] : messages;
                const errorEl = form.querySelector(`[data-customer-category-error="${field}"]`);
                const inputEl = form.querySelector(`[data-customer-category-input="${field}"]`);
                if (errorEl) {
                    errorEl.textContent = message ?? '';
                }
                if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement) {
                    inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            });
        };

        const setSubmitLoading = (isLoading) => {
            if (!submitButton || !submitLabel) {
                return;
            }
            if (isLoading) {
                submitLabel.textContent = tx('Procesando...');
            } else if (submitButton.dataset.originalLabel) {
                submitLabel.textContent = submitButton.dataset.originalLabel;
            }
            submitButton.disabled = isLoading;
        };

        const setFieldValue = (field, value) => {
            if (!form) {
                return;
            }
            const input = form.querySelector(`[data-customer-category-input="${field}"]`);
            if (!input) {
                return;
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                input.value = value ?? '';
            }
        };

        const getFieldValue = (field) => {
            if (!form) {
                return '';
            }
            const input = form.querySelector(`[data-customer-category-input="${field}"]`);
            if (!input) {
                return '';
            }
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                return input.value.trim();
            }
            return '';
        };

        const refreshTable = () => {
            if (!tableId) {
                console.warn('[CustomerCategories] refresh without tableId');
                window.dispatchEvent(new CustomEvent('datatable-refresh'));
                return;
            }
            console.info('[CustomerCategories] refresh', { tableId });
            window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
        };

        const setFormMode = (mode, data = null) => {
            if (!form || !submitButton || !submitLabel) {
                return;
            }

            clearFormErrors();
            setSubmitLoading(false);

            form.dataset.mode = mode;
            form.dataset.customerCategoryId = data?.id ?? '';

            if (mode === 'create') {
                form.reset();
                setFieldValue('status', 'A');
                if (modalTitle) {
                    modalTitle.textContent = tx('Nueva categoría');
                }
                submitLabel.textContent = tx('Guardar');
                submitButton.dataset.originalLabel = tx('Guardar');
            } else {
                if (modalTitle) {
                    modalTitle.textContent = tx('Editar categoría');
                }
                submitLabel.textContent = tx('Actualizar');
                submitButton.dataset.originalLabel = tx('Actualizar');
            }

            if (data) {
                setFieldValue('name', data.name ?? '');
                setFieldValue('description', data.description ?? '');
                setFieldValue('status', data.status ?? 'A');
            } else {
                setFieldValue('name', '');
                setFieldValue('description', '');
            }
        };

        const populateViewModal = (data) => {
            if (!viewContainer || !data) {
                return;
            }
            viewContainer.querySelectorAll('[data-customer-category-view-field]').forEach((element) => {
                const field = element.getAttribute('data-customer-category-view-field');
                if (!field) {
                    return;
                }
                const value = data[field];
                element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
            });
        };

        const handleSubmit = async () => {
            if (!form || !submitButton || !submitLabel) {
                return;
            }

            const mode = form.dataset.mode ?? 'create';
            const categoryId = form.dataset.customerCategoryId ?? '';

            const payload = {
                name: getFieldValue('name'),
                description: getFieldValue('description') || null,
                status: getFieldValue('status') || 'A',
            };

            console.info('[CustomerCategories] submit', { mode, categoryId, payload });

            clearFormErrors();

            const validationErrors = {};
            if (!payload.name) {
                validationErrors.name = tx('El nombre es obligatorio.');
            }

            if (Object.keys(validationErrors).length > 0) {
                applyFormErrors(validationErrors);
                showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
                return;
            }

            setSubmitLoading(true);

            const url = mode === 'create' ? storeUrl : `${baseUrl}/${categoryId}`;
            const method = mode === 'create' ? 'POST' : 'PATCH';

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify(payload),
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    console.error('[CustomerCategories] submit failed', { response, json });
                    if (response.status === 422 && json?.errors) {
                        applyFormErrors(json.errors);
                        showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                    } else {
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                    }
                    return;
                }

                console.info('[CustomerCategories] submit success');
                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
                closeModal(modals.form);
                refreshTable();
            } catch (error) {
                console.error('[CustomerCategories] Submit error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
            } finally {
                setSubmitLoading(false);
            }
        };

        const handleDelete = async () => {
            if (!modals.delete || !deleteConfirmButton) {
                return;
            }
            const categoryId = modals.delete.dataset.customerCategoryId;
            if (!categoryId) {
                closeModal(modals.delete);
                return;
            }

            deleteConfirmButton.disabled = true;
            deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

            try {
                console.info('[CustomerCategories] delete', { categoryId });
                const response = await fetch(`${baseUrl}/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    console.error('[CustomerCategories] delete failed', { response, json });
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                    return;
                }

                console.info('[CustomerCategories] delete success');
                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
                closeModal(modals.delete);
                refreshTable();
            } catch (error) {
                console.error('[CustomerCategories] Delete error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
            } finally {
                deleteConfirmButton.disabled = false;
                deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
            }
        };

        const handleStatusToggle = async (input) => {
            const categoryId = input.dataset.id ?? '';
            if (!categoryId || input.disabled) {
                return;
            }

            const previousChecked = !input.checked;
            const newStatus = input.checked ? 'A' : 'I';

            input.disabled = true;

            try {
                console.info('[CustomerCategories] toggle status', { categoryId, newStatus });
                const response = await fetch(`${baseUrl}/${categoryId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify({ status: newStatus }),
                });

                const json = await response.json().catch(() => null);

                if (!response.ok) {
                    console.error('[CustomerCategories] toggle failed', { response, json });
                    input.checked = previousChecked;
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                    return;
                }

                console.info('[CustomerCategories] toggle success');
                showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
                refreshTable();
            } catch (error) {
                console.error('[CustomerCategories] Status toggle error', error);
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
            } finally {
                input.disabled = false;
            }
        };

        if (form) {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                handleSubmit();
            });
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.addEventListener('click', handleDelete);
        }

        root.addEventListener('click', (event) => {
            console.log('🔵 [CustomerCategories] Click detected', {
                target: event.target,
                targetTagName: event.target?.tagName,
                targetClasses: event.target?.className,
                targetId: event.target?.id,
                targetDataset: event.target?.dataset,
            });

            // Find the action element, checking both the target and its parent
            let actionEl = null;
            if (event.target instanceof Element) {
                actionEl = event.target.closest('[data-customer-category-action], [data-action], [data-row-action]');
                console.log('🔵 [CustomerCategories] First closest search', { 
                    found: !!actionEl,
                    element: actionEl,
                    tagName: actionEl?.tagName,
                    classes: actionEl?.className,
                });
                
                // If not found and target is an icon, try the parent button
                if (!actionEl && (event.target.tagName === 'I' || event.target.classList.contains('fa'))) {
                    actionEl = event.target.closest('button[data-action], button[data-row-action]');
                    console.log('🔵 [CustomerCategories] Second closest search (icon)', { 
                        found: !!actionEl,
                        element: actionEl,
                        tagName: actionEl?.tagName,
                    });
                }
            }
            
            console.log('🔵 [CustomerCategories] Final actionEl', {
                found: !!actionEl,
                element: actionEl,
                allAttributes: actionEl ? Array.from(actionEl.attributes).map(attr => ({ name: attr.name, value: attr.value })) : null,
                dataset: actionEl?.dataset,
            });

            if (!actionEl) {
                console.log('🔵 [CustomerCategories] No actionEl found, returning');
                return;
            }

            if (actionEl.hasAttribute('data-customer-category-action')) {
                const action = actionEl.dataset.customerCategoryAction;
                console.log('🔵 [CustomerCategories] Customer category action', { action });
                if (action === 'create') {
                    setFormMode('create');
                    openModal(modals.form);
                }
                return;
            }

            const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
            console.log('🔵 [CustomerCategories] Row action extracted', {
                rowAction,
                dataAction: actionEl.dataset.action,
                dataRowAction: actionEl.dataset.rowAction,
            });
            
            if (!rowAction) {
                console.log('🔵 [CustomerCategories] No rowAction found, returning');
                return;
            }

            const rowId = (actionEl.dataset.id || actionEl.dataset.rowId || '').trim();
            const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
            const payload = actionEl.dataset.rowPayload;
            let data = payload ? decodePayload(payload) : null;

            console.log('🔵 [CustomerCategories] Action clicked - FULL DATA', {
                rowAction,
                rowId,
                rowName,
                hasPayload: !!payload,
                payload,
                data,
                baseUrl,
                csrfToken: csrfToken ? 'present' : 'missing',
                allDatasetKeys: Object.keys(actionEl.dataset),
                datasetId: actionEl.dataset.id,
                datasetRowId: actionEl.dataset.rowId,
            });

            if (!rowId) {
                console.error('🔴 [CustomerCategories] Missing rowId', { 
                    actionEl, 
                    rowAction,
                    allDatasetKeys: actionEl ? Object.keys(actionEl.dataset) : null,
                    dataset: actionEl?.dataset,
                });
                showAlert({ title: tx('Error'), text: tx('No se pudo identificar el registro seleccionado.'), icon: 'error' });
                return;
            }

            // If no payload, fetch data from server using rowId
            if (!data && rowId) {
                console.log('🟡 [CustomerCategories] No payload, will fetch from server', { rowId, rowAction, hasData: !!data });
                
                if (rowAction === 'view' || rowAction === 'edit') {
                    if (!baseUrl) {
                        console.error('🔴 [CustomerCategories] Missing baseUrl');
                        showAlert({ title: tx('Error'), text: tx('Error de configuración. Por favor, recarga la página.'), icon: 'error' });
                        return;
                    }
                    const fetchUrl = `${baseUrl}/${rowId}`;
                    console.log('🟢 [CustomerCategories] Starting fetch', { 
                        fetchUrl, 
                        rowAction, 
                        rowId,
                        baseUrl,
                        method: 'GET',
                        headers: {
                            Accept: 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken ? 'present' : 'missing',
                        },
                    });
                    
                    fetch(fetchUrl, {
                        headers: {
                            Accept: 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': csrfToken,
                        },
                    })
                        .then(async (response) => {
                            console.log('🟢 [CustomerCategories] Response received (raw)', {
                                ok: response.ok,
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                url: response.url,
                            });
                            
                            const json = await response.json().catch((parseError) => {
                                console.error('🔴 [CustomerCategories] JSON parse error', { parseError });
                                return null;
                            });
                            
                            console.log('🟢 [CustomerCategories] Response JSON parsed', { json });
                            
                            if (!response.ok) {
                                console.error('🔴 [CustomerCategories] Fetch failed - Response not OK', { 
                                    status: response.status, 
                                    statusText: response.statusText,
                                    url: fetchUrl,
                                    json,
                                    responseHeaders: Object.fromEntries(response.headers.entries()),
                                });
                                const errorMessage = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                                showAlert({ title: tx('Error'), text: errorMessage, icon: 'error' });
                                return null;
                            }
                            return json;
                        })
                        .then((json) => {
                            console.log('🟢 [CustomerCategories] Processing response', { 
                                hasJson: !!json,
                                json,
                                status: json?.status,
                                hasData: !!json?.data,
                                hasItem: !!json?.data?.item,
                                item: json?.data?.item,
                            });
                            
                            if (!json) {
                                console.log('🟡 [CustomerCategories] No JSON to process');
                                return;
                            }
                            
                            if (json?.status === 'success' && json?.data?.item) {
                                console.log('✅ [CustomerCategories] Success! Opening modal', { rowAction, data: json.data.item });
                                data = json.data.item;
                                if (rowAction === 'view') {
                                    populateViewModal(data);
                                    openModal(modals.view);
                                } else if (rowAction === 'edit') {
                                    setFormMode('edit', data);
                                    openModal(modals.form);
                                }
                            } else {
                                const errorMsg = json?.message ?? tx('No se pudieron obtener los datos del registro.');
                                console.error('🔴 [CustomerCategories] Invalid response format', { 
                                    json, 
                                    expected: 'status: success, data.item',
                                    actualStatus: json?.status,
                                    hasData: !!json?.data,
                                    hasItem: !!json?.data?.item,
                                });
                                showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                            }
                        })
                        .catch((error) => {
                            console.error('🔴 [CustomerCategories] Fetch error (catch)', { 
                                error, 
                                errorName: error.name,
                                errorMessage: error.message, 
                                errorStack: error.stack,
                                fetchUrl,
                            });
                            const errorMsg = error.message?.includes('Failed to fetch') 
                                ? tx('Error de conexión. Verifica tu conexión a internet.')
                                : tx('No se pudieron obtener los datos del registro.');
                            showAlert({ title: tx('Error'), text: errorMsg, icon: 'error' });
                        });
                    return;
                } else if (rowAction === 'delete') {
                    // For delete, we can use just the ID and name
                    if (modals.delete) {
                        modals.delete.dataset.customerCategoryId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = rowName || rowId;
                    }
                    openModal(modals.delete);
                    return;
                }
            }

            if (!data || !data.id) {
                if (rowAction !== 'delete') {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
                return;
            }

            if (rowAction === 'view') {
                populateViewModal(data);
                openModal(modals.view);
                return;
            }

            if (rowAction === 'edit') {
                setFormMode('edit', data);
                openModal(modals.form);
                return;
            }

            if (rowAction === 'delete') {
                if (modals.delete) {
                    modals.delete.dataset.customerCategoryId = data.id ?? '';
                }
                if (deleteName) {
                    deleteName.textContent = data.name ?? '';
                }
                openModal(modals.delete);
            }
        });

        root.addEventListener('change', (event) => {
            const target = event.target;
            if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
                handleStatusToggle(target);
            }
        });
    });
};
const initServicesModule = () => {
    const root = document.querySelector('[data-services-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.servicesTableId ?? '';
    const baseUrl = root.dataset.servicesBaseUrl ?? '';
    const storeUrl = root.dataset.servicesStoreUrl ?? baseUrl;
    const categoryOptionsUrl = root.dataset.servicesCategoryOptionsUrl ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const initialCategories = (() => {
        try {
            return JSON.parse(root.dataset.servicesCategories ?? '[]');
        } catch (error) {
            console.error('[Services] Error parsing categories', error);
            return [];
        }
    })();

    const modals = {
        form: root.querySelector('[data-service-modal="form"]'),
        view: root.querySelector('[data-service-modal="view"]'),
        delete: root.querySelector('[data-service-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-service-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-service-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-service-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-service-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-service-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-service-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-service-delete-confirm]') ?? null;
    const categorySelectRoot = form?.querySelector('[data-select-name="category_id"]') ?? null;
    const categoryHiddenInput = form?.querySelector('[data-service-input="category_id"]') ?? null;
    const categoryOptionsContainer = categorySelectRoot?.querySelector('[data-service-category-options]') ?? null;
    const categoryTrigger = categorySelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const categoryValueLabel = categorySelectRoot?.querySelector('[data-select-value]') ?? null;
    const categoryDropdown = categorySelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const categoryIcon = categorySelectRoot?.querySelector('[data-select-icon]') ?? null;
    const categoryPlaceholder = categoryTrigger?.dataset.selectPlaceholder ?? '';

    const bodyOverflowClass = 'overflow-hidden';
    let categoryOptions = initialCategories;

    const getEventTargetModal = (target) => target.closest('[data-service-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-service-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-service-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-service-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-service-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
        if (categorySelectRoot) {
            categorySelectRoot.dataset.selectInvalid = 'false';
            categoryTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-service-error="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (field === 'category_id') {
                if (categorySelectRoot) {
                    categorySelectRoot.dataset.selectInvalid = 'true';
                }
                categoryTrigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            } else {
                const inputEl = form.querySelector(`[data-service-input="${field}"]`);
                if (inputEl) {
                    inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
                }
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        if (field === 'category_id') {
            setCategoryValue(value ?? '');
            return;
        }
        const input = form.querySelector(`[data-service-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-service-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const closeCategorySelect = () => {
        if (!categorySelectRoot || !categoryDropdown) {
            return;
        }
        categoryDropdown.hidden = true;
        categoryDropdown.dataset.open = 'false';
        categorySelectRoot.dataset.open = 'false';
        categoryTrigger?.setAttribute('aria-expanded', 'false');
        categoryIcon?.classList.remove('rotate-180');
    };

    const markCategorySelected = (value) => {
        if (!categoryOptionsContainer) {
            return;
        }
        categoryOptionsContainer.querySelectorAll('[data-select-option]').forEach((option) => {
            option.dataset.selected = option.dataset.value === value ? 'true' : 'false';
        });
    };

    const setCategoryValue = (value) => {
        if (!categoryHiddenInput) {
            return;
        }
        const normalizedValue = value ?? '';
        const option = categoryOptions.find((item) => String(item.id) === String(normalizedValue));
        const label = option?.name ?? categoryPlaceholder;
        categoryHiddenInput.value = normalizedValue;
        if (categoryValueLabel) {
            categoryValueLabel.textContent = normalizedValue ? label : categoryPlaceholder;
        }
        markCategorySelected(String(normalizedValue));
        categoryTrigger?.classList.toggle('is-empty', !normalizedValue);
        categoryHiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
    };

    const renderCategoryOptions = (items) => {
        if (!categoryOptionsContainer) {
            return;
        }
        categoryOptionsContainer.innerHTML = '';
        items.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = item.id;
            button.dataset.label = item.name;
            button.innerHTML = `<span class="truncate">${item.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setCategoryValue(item.id);
                closeCategorySelect();
                categoryTrigger?.focus({ preventScroll: true });
            });
            categoryOptionsContainer.appendChild(button);
        });
        markCategorySelected(String(categoryHiddenInput?.value ?? ''));
    };

    const ensureCategoryOptions = async (selectedValue = '') => {
        renderCategoryOptions(categoryOptions);
        setCategoryValue(selectedValue ?? '');

        if (!categoryOptionsUrl) {
            return;
        }

        try {
            const url = `${categoryOptionsUrl}${categoryOptionsUrl.includes('?') ? '&' : '?'}per_page=200`;
            const response = await fetch(url, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok || !json?.data?.items) {
                throw new Error('Invalid response');
            }

            categoryOptions = json.data.items;
            renderCategoryOptions(categoryOptions);
            setCategoryValue(selectedValue ?? '');
        } catch (error) {
            console.error('[Services] Error loading category options', error);
            showAlert({ title: tx('Error'), text: tx('No se pudieron cargar las categorías de servicio.'), icon: 'error' });
        }
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.serviceId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            setFieldValue('price', '0');
            if (modalTitle) {
                modalTitle.textContent = 'Nuevo servicio';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar servicio';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        renderCategoryOptions(categoryOptions);
        setCategoryValue(data?.category_id ?? '');

        if (data) {
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('price', data.price ?? '0');
            setFieldValue('status', data.status ?? 'A');
        }

        ensureCategoryOptions(data?.category_id ?? '');
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-service-view-field]').forEach((element) => {
            const field = element.getAttribute('data-service-view-field');
            if (!field) {
                return;
            }
            let value = data[field];
            
            // Para el precio, formatear sin moneda
            if (field === 'price') {
                const price = parseFloat(value) || 0;
                value = price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                value = value !== null && value !== undefined && value !== '' ? String(value) : '-';
            }
            
            element.textContent = value;
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const serviceId = form.dataset.serviceId ?? '';

        const descriptionValue = getFieldValue('description');
        const durationValueRaw = getFieldValue('duration_minutes');
        const durationValue = durationValueRaw ? Number.parseInt(durationValueRaw, 10) : null;

        const priceValueRaw = getFieldValue('price');
        const priceValue = priceValueRaw ? parseFloat(priceValueRaw) : 0;

        const payload = {
            category_id: getFieldValue('category_id') || null,
            name: getFieldValue('name'),
            description: descriptionValue || null,
            price: priceValue,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.category_id) {
            validationErrors.category_id = tx('Selecciona una categoría.');
        }
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        console.log('[WorkshopStates] submit payload', payload);

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${serviceId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Services] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const serviceId = modals.delete.dataset.serviceId;
        if (!serviceId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${serviceId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Services] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const serviceId = input.dataset.id ?? '';
        if (!serviceId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${serviceId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Services] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target.closest('[data-service-action], [data-action], [data-row-action]');
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        // Verificar si es el botón de crear PRIMERO, antes de verificar serviceId
        if (actionEl.hasAttribute('data-service-action')) {
            const action = actionEl.dataset.serviceAction;
            if (action === 'create') {
                event.preventDefault();
                event.stopPropagation();
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        event.preventDefault();
        event.stopPropagation();

        const action = actionEl.dataset.action || actionEl.dataset.rowAction;
        const serviceId = actionEl.dataset.id || actionEl.dataset.rowId;
        const serviceName = actionEl.dataset.name || actionEl.dataset.rowName || '';
        const rowPayload = actionEl.dataset.rowPayload;

        if (!action || !serviceId) {
            return;
        }

        let data = null;
        if (rowPayload) {
            try {
                data = decodePayload(rowPayload);
            } catch (error) {
                console.error('[Services] Error decoding payload', error);
            }
        }

        if (action === 'view') {
            if (!data) {
                // Fetch service data
                fetch(`${baseUrl}/${serviceId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.status === 'success' && json?.data?.item) {
                            populateViewModal(json.data.item);
                            openModal(modals.view);
                        } else {
                            showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[Services] Error fetching service', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                    });
            } else {
                populateViewModal(data);
                openModal(modals.view);
            }
            return;
        }

        if (action === 'edit') {
            if (!data) {
                // Fetch service data
                fetch(`${baseUrl}/${serviceId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.status === 'success' && json?.data?.item) {
                            setFormMode('edit', json.data.item);
                            openModal(modals.form);
                        } else {
                            showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[Services] Error fetching service', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                    });
            } else {
                setFormMode('edit', data);
                openModal(modals.form);
            }
            return;
        }

        if (action === 'delete') {
            const deleteId = data?.id || serviceId;
            const name = data?.name || serviceName || deleteId;
            if (modals.delete) {
                modals.delete.dataset.serviceId = deleteId;
            }
            if (deleteName) {
                deleteName.textContent = name;
            }
            openModal(modals.delete);
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initWarehousesModule = () => {
    const root = document.querySelector('[data-warehouses-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.warehousesTableId ?? '';
    const baseUrl = root.dataset.warehousesBaseUrl ?? '';
    const storeUrl = root.dataset.warehousesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-warehouse-modal="form"]'),
        view: root.querySelector('[data-warehouse-modal="view"]'),
        delete: root.querySelector('[data-warehouse-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-warehouse-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-warehouse-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-warehouse-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-warehouse-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-warehouse-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-warehouse-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-warehouse-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-warehouse-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-warehouse-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-warehouse-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-warehouse-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-warehouse-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-warehouse-error="${field}"]`);
            const inputEl = form.querySelector(`[data-warehouse-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-warehouse-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-warehouse-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.warehouseId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nueva bodega';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar bodega';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            setFieldValue('name', data.name ?? '');
            setFieldValue('address', data.address ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-warehouse-view-field]').forEach((element) => {
            const field = element.getAttribute('data-warehouse-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const warehouseId = form.dataset.warehouseId ?? '';

        const payload = {
            name: getFieldValue('name'),
            address: getFieldValue('address') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${warehouseId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Warehouses] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const warehouseId = modals.delete.dataset.warehouseId;
        if (!warehouseId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${warehouseId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Warehouses] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const warehouseId = input.dataset.id ?? '';
        if (!warehouseId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${warehouseId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Warehouses] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-warehouse-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-warehouse-action')) {
            const action = actionEl.dataset.warehouseAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        const warehouseId = actionEl.dataset.id || actionEl.dataset.rowId;
        const warehouseName = actionEl.dataset.name || actionEl.dataset.rowName || '';

        if (!rowAction || !warehouseId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            fetch(`${baseUrl}/${warehouseId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        populateViewModal(json.data.item);
                        openModal(modals.view);
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para ver.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[Warehouses] Fetch view error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para ver.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'edit') {
            fetch(`${baseUrl}/${warehouseId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        setFormMode('edit', json.data.item);
                        openModal(modals.form);
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[Warehouses] Fetch edit error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'delete') {
            const name = warehouseName || warehouseId;
            if (modals.delete) {
                modals.delete.dataset.warehouseId = warehouseId;
            }
            if (deleteName) {
                deleteName.textContent = name || warehouseId;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initDocumentSequencesModule = () => {
    const root = document.querySelector('[data-document-sequences-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.documentSequencesTableId ?? '';
    const baseUrl = root.dataset.documentSequencesBaseUrl ?? '';
    const storeUrl = root.dataset.documentSequencesStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const parseJson = (value, fallback = []) => {
        try {
            const parsed = JSON.parse(value ?? '[]');
            return Array.isArray(parsed) ? parsed : fallback;
        } catch (error) {
            console.warn('[DocumentSequences] Invalid JSON dataset', error);
            return fallback;
        }
    };

    const documentTypes = parseJson(root.dataset.documentSequencesTypes, []);

    const modals = {
        form: root.querySelector('[data-document-sequence-modal="form"]'),
        view: root.querySelector('[data-document-sequence-modal="view"]'),
        delete: root.querySelector('[data-document-sequence-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-document-sequence-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-document-sequence-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-document-sequence-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-document-sequence-modal-title]') ?? null;

    const viewContainer = modals.view?.querySelector('[data-document-sequence-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-document-sequence-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-document-sequence-delete-confirm]') ?? null;

    const previewLabel = form?.querySelector('[data-document-sequence-preview]') ?? null;

    const documentTypeSelectRoot = form?.querySelector('[data-document-sequence-select="document_type"]') ?? null;

    const documentTypeSelectTrigger = documentTypeSelectRoot?.querySelector('[data-custom-select-trigger]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const selectControllers = new Set();

    const closeAllSelects = (except = null) => {
        selectControllers.forEach((controller) => {
            if (controller !== except) {
                controller.close();
            }
        });
    };

    const createSelectController = (selectRoot, options = [], { placeholder = tx('Selecciona...') } = {}) => {
        if (!selectRoot) {
            return null;
        }

        const trigger = selectRoot.querySelector('[data-custom-select-trigger]');
        const label = selectRoot.querySelector('[data-custom-select-label]');
        const dropdown = selectRoot.querySelector('[data-custom-select-options]');
        const hiddenInput = selectRoot.querySelector('input[type="hidden"]');

        if (!trigger || !label || !dropdown || !hiddenInput) {
            return null;
        }

        let currentOptions = Array.isArray(options) ? options : [];

        const renderOptions = (list = []) => {
            currentOptions = Array.isArray(list) ? list : [];
            dropdown.innerHTML = '';

            if (currentOptions.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'px-4 py-2 text-sm text-gray-500 dark:text-gray-300';
                emptyItem.textContent = tx('No hay opciones disponibles');
                dropdown.appendChild(emptyItem);
                updateDisplay();
                return;
            }

            currentOptions.forEach((option) => {
                const value = option.value ?? option.id ?? '';
                const optionLabel = option.label ?? option.name ?? value;
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-primary-soft/20 data-[selected=true]:font-semibold data-[selected=true]:text-primary dark:text-gray-200';
                button.dataset.selectOption = 'true';
                button.dataset.value = value;
                button.dataset.label = optionLabel;
                button.dataset.selected = hiddenInput.value === value ? 'true' : 'false';
                button.innerHTML = `<span class="truncate">${optionLabel}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100"></i>`;
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    setValue(value);
                    close();
                    trigger.focus({ preventScroll: true });
                });
                dropdown.appendChild(button);
            });

            updateDisplay();
        };

        const updateDisplay = () => {
            const selected = dropdown.querySelector(`[data-select-option][data-value="${hiddenInput.value ?? ''}"]`);
            label.textContent = hiddenInput.value ? (selected?.dataset.label ?? placeholder ?? '') : (placeholder ?? tx('Selecciona...'));
            dropdown.querySelectorAll('[data-select-option]').forEach((option) => {
                option.dataset.selected = option.dataset.value === hiddenInput.value ? 'true' : 'false';
            });
            trigger.classList.toggle('text-gray-400', !hiddenInput.value);
        };

        const close = () => {
            dropdown.classList.add('hidden');
            selectRoot.dataset.open = 'false';
            trigger.setAttribute('aria-expanded', 'false');
            trigger.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
        };

        const open = () => {
            closeAllSelects(controller);
            dropdown.classList.remove('hidden');
            selectRoot.dataset.open = 'true';
            trigger.setAttribute('aria-expanded', 'true');
            trigger.querySelector('.fa-chevron-down')?.classList.add('rotate-180');
        };

        const setValue = (value) => {
            hiddenInput.value = value ?? '';
            updateDisplay();
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        };

        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            if (selectRoot.dataset.open === 'true') {
                close();
            } else {
                open();
            }
        });

        selectRoot.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                close();
                trigger.focus({ preventScroll: true });
            }
        });

        const controller = {
            renderOptions,
            setValue,
            close,
            get value() {
                return hiddenInput.value;
            },
        };

        selectControllers.add(controller);
        renderOptions(currentOptions);

        return controller;
    };

    document.addEventListener('click', (event) => {
        const target = event.target;
        const select = target instanceof Element ? target.closest('[data-custom-select]') : null;
        if (!select) {
            closeAllSelects();
        }
    });

    const documentTypeSelectController = createSelectController(
        documentTypeSelectRoot,
        documentTypes,
        { placeholder: tx('Selecciona un tipo') },
    );

    const getEventTargetModal = (target) => target.closest('[data-document-sequence-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-document-sequence-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-document-sequence-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-document-sequence-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-document-sequence-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
        documentTypeSelectTrigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-document-sequence-error="${field}"]`);
            const inputEl = form.querySelector(`[data-document-sequence-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }

            if (field === 'document_type') {
                documentTypeSelectTrigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            } else if (inputEl instanceof HTMLInputElement) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }

        if (field === 'document_type') {
            documentTypeSelectController?.setValue(value ?? '');
            return;
        }

        const input = form?.querySelector(`[data-document-sequence-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        if (field === 'document_type') {
            return documentTypeSelectController?.value ?? '';
        }
        const input = form.querySelector(`[data-document-sequence-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const updatePreview = () => {
        if (!previewLabel) {
            return;
        }
        const establishment = getFieldValue('establishment_code').toUpperCase();
        const emission = getFieldValue('emission_point_code').toUpperCase();
        const sequenceValue = getFieldValue('current_sequence');
        const sequenceNumber = sequenceValue ? parseInt(sequenceValue, 10) : NaN;

        if (!establishment || !emission || Number.isNaN(sequenceNumber) || sequenceNumber <= 0) {
            previewLabel.textContent = '---';
            return;
        }

        const formatted = `${establishment}-${emission}-${String(sequenceNumber).padStart(3, '0')}`;
        previewLabel.textContent = formatted;
    };

    const normalizeCodeInput = (input) => {
        if (!input) {
            return;
        }
        input.addEventListener('input', () => {
            input.value = input.value.replaceAll(/\s+/g, '').toUpperCase().slice(0, 5).replace(/[^A-Z0-9]/g, '');
            updatePreview();
        });
        input.addEventListener('blur', () => {
            input.value = input.value.replaceAll(/\s+/g, '').toUpperCase().slice(0, 5).replace(/[^A-Z0-9]/g, '');
            updatePreview();
        });
    };

    normalizeCodeInput(form?.querySelector('[data-document-sequence-input="establishment_code"]'));
    normalizeCodeInput(form?.querySelector('[data-document-sequence-input="emission_point_code"]'));

    const currentSequenceInput = form?.querySelector('[data-document-sequence-input="current_sequence"]') ?? null;
    currentSequenceInput?.addEventListener('input', () => {
        if (!currentSequenceInput) {
            return;
        }
        const numeric = parseInt(currentSequenceInput.value, 10);
        if (Number.isNaN(numeric) || numeric < 1) {
            currentSequenceInput.value = numeric <= 0 ? '1' : '';
        }
        updatePreview();
    });

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.documentSequenceId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            branchSelectController?.setValue('');
            documentTypeSelectController?.setValue('');
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = tx('Nuevo secuencial');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
            updatePreview();
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar secuencial');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            setFieldValue('document_type', data.document_type ?? '');
            setFieldValue('establishment_code', data.establishment_code ?? '');
            setFieldValue('emission_point_code', data.emission_point_code ?? '');
            setFieldValue('current_sequence', data.current_sequence ?? '');
            setFieldValue('status', data.status ?? 'A');
            updatePreview();
        }
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-document-sequence-view-field]').forEach((element) => {
            const field = element.getAttribute('data-document-sequence-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '—';
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const sequenceId = form.dataset.documentSequenceId ?? '';

        const payload = {
            document_type: getFieldValue('document_type'),
            establishment_code: getFieldValue('establishment_code').toUpperCase(),
            emission_point_code: getFieldValue('emission_point_code').toUpperCase(),
            current_sequence: (() => {
                const value = parseInt(getFieldValue('current_sequence'), 10);
                return Number.isNaN(value) ? null : value;
            })(),
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.document_type) {
            validationErrors.document_type = tx('El tipo de documento es obligatorio.');
        }
        if (!payload.establishment_code) {
            validationErrors.establishment_code = tx('El código de establecimiento es obligatorio.');
        }
        if (!payload.emission_point_code) {
            validationErrors.emission_point_code = tx('El punto de emisión es obligatorio.');
        }
        if (!payload.current_sequence || payload.current_sequence < 1) {
            validationErrors.current_sequence = tx('El secuencial debe ser mayor o igual a 1.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${sequenceId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[DocumentSequences] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }

        const sequenceId = modals.delete.dataset.documentSequenceId ?? '';
        if (!sequenceId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${sequenceId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[DocumentSequences] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const sequenceId = input.dataset.id ?? '';
        if (!sequenceId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${sequenceId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[DocumentSequences] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-document-sequence-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl || !root.contains(actionEl)) {
            return;
        }

        if (actionEl.hasAttribute('data-document-sequence-action')) {
            const action = actionEl.dataset.documentSequenceAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        if (!rowAction) {
            return;
        }

        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        if (!rowId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch document sequence data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    populateViewModal(json.data.item);
                    openModal(modals.view);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[DocumentSequences] Error loading view data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'edit') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch document sequence data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    setFormMode('edit', json.data.item);
                    openModal(modals.form);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[DocumentSequences] Error loading edit data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
            }
            return;
        }

        if (rowAction === 'delete') {
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch document sequence data');
                }

                const json = await response.json();
                if (json?.data?.item) {
                    const displayName = json.data.item.display_name ?? json.data.item.document_type_label ?? '';
                    if (modals.delete) {
                        modals.delete.dataset.documentSequenceId = rowId;
                    }
                    if (deleteName) {
                        deleteName.textContent = displayName;
                    }
                    openModal(modals.delete);
                } else {
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
                }
            } catch (error) {
                console.error('[DocumentSequences] Error loading delete data', error);
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para eliminar.'), icon: 'error' });
            }
            return;
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initPriceListsModule = () => {
    const root = document.querySelector('[data-price-lists-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.priceListsTableId ?? '';
    const baseUrl = root.dataset.priceListsBaseUrl ?? '';
    const storeUrl = root.dataset.priceListsStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-price-list-modal="form"]'),
        view: root.querySelector('[data-price-list-modal="view"]'),
        delete: root.querySelector('[data-price-list-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-price-list-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-price-list-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-price-list-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-price-list-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-price-list-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-price-list-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-price-list-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-price-list-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-price-list-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-price-list-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-price-list-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-price-list-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-price-list-error="${field}"]`);
            const inputEl = form.querySelector(`[data-price-list-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-price-list-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-price-list-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        console.log('🟡 [PriceLists] setFormMode called', { mode, hasData: !!data, data });
        
        if (!form || !submitButton || !submitLabel) {
            console.warn('🟡 [PriceLists] Missing form elements', { form: !!form, submitButton: !!submitButton, submitLabel: !!submitLabel });
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.priceListId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            if (modalTitle) {
                modalTitle.textContent = 'Nueva lista de precios';
            }
            submitLabel.textContent = 'Guardar';
            submitButton.dataset.originalLabel = 'Guardar';
        } else {
            if (modalTitle) {
                modalTitle.textContent = 'Editar lista de precios';
            }
            submitLabel.textContent = 'Actualizar';
            submitButton.dataset.originalLabel = 'Actualizar';
        }

        if (data) {
            console.log('🟡 [PriceLists] Setting form values', {
                name: data.name,
                description: data.description,
                status: data.status,
            });
            setFieldValue('name', data.name ?? '');
            setFieldValue('description', data.description ?? '');
            setFieldValue('status', data.status ?? 'A');
        }
    };

    const populateViewModal = (data) => {
        console.log('🟡 [PriceLists] populateViewModal called', { 
            hasViewContainer: !!viewContainer, 
            hasData: !!data,
            data,
        });
        
        if (!viewContainer || !data) {
            console.warn('🟡 [PriceLists] Missing viewContainer or data', { viewContainer, data });
            return;
        }
        
        viewContainer.querySelectorAll('[data-price-list-view-field]').forEach((element) => {
            const field = element.getAttribute('data-price-list-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            const displayValue = value !== null && value !== undefined && value !== '' ? String(value) : '-';
            element.textContent = displayValue;
            console.log('🟡 [PriceLists] Set view field', { field, value, displayValue });
        });
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const priceListId = form.dataset.priceListId ?? '';

        const payload = {
            name: getFieldValue('name'),
            description: getFieldValue('description') || null,
            status: getFieldValue('status') || 'A',
        };

        clearFormErrors();

        const validationErrors = {};
        if (!payload.name) {
            validationErrors.name = tx('El nombre es obligatorio.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${priceListId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[PriceLists] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const priceListId = modals.delete.dataset.priceListId;
        if (!priceListId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${priceListId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[PriceLists] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const priceListId = input.dataset.id ?? '';
        if (!priceListId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${priceListId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[PriceLists] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-price-list-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        console.log('🟡 [PriceLists] Click detected', {
            target: event.target,
            actionEl,
            hasPriceListAction: actionEl.hasAttribute('data-price-list-action'),
            action: actionEl.dataset.priceListAction,
            dataAction: actionEl.dataset.action,
            rowAction: actionEl.dataset.rowAction,
        });

        if (actionEl.hasAttribute('data-price-list-action')) {
            const action = actionEl.dataset.priceListAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        const payload = actionEl.dataset.rowPayload;
        let data = payload ? decodePayload(payload) : null;
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? null;
        
        console.log('🟡 [PriceLists] Action clicked', {
            rowAction,
            hasPayload: !!payload,
            hasData: !!data,
            rowId,
            actionEl: actionEl,
        });
        
        if (!rowAction || !rowId) {
            console.error('🟡 [PriceLists] Missing rowAction or rowId', { rowAction, rowId });
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        // If data is not available and we need it for view/edit, fetch it
        if ((rowAction === 'view' || rowAction === 'edit') && !data) {
            console.log('🟡 [PriceLists] Fetching data for', { rowAction, rowId });
            try {
                const response = await fetch(`${baseUrl}/${rowId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                console.log('🟡 [PriceLists] Fetch response', {
                    status: response.status,
                    ok: response.ok,
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error('🟡 [PriceLists] Fetch failed', {
                        status: response.status,
                        text: text.substring(0, 200),
                    });
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                    return;
                }

                const json = await response.json().catch(() => null);
                console.log('🟡 [PriceLists] Fetch JSON', {
                    status: json?.status,
                    hasData: !!json?.data,
                    hasItem: !!json?.data?.item,
                });

                if (json?.status === 'success' && json?.data?.item) {
                    data = json.data.item;
                    console.log('🟡 [PriceLists] Data fetched successfully', { data });
                } else {
                    console.error('🟡 [PriceLists] Invalid response format', { json });
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                    return;
                }
            } catch (error) {
                console.error('🟡 [PriceLists] Fetch error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al obtener los datos.'), icon: 'error' });
                return;
            }
        }

        if (!data && rowAction === 'delete') {
            data = {
                id: rowId,
                name: (actionEl.dataset.name || actionEl.dataset.rowName) ?? null,
            };
        }

        if ((rowAction === 'view' || rowAction === 'edit') && !data?.id) {
            console.error('🟡 [PriceLists] Missing data.id after fetch', { data, rowAction });
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            console.log('🟡 [PriceLists] Populating view modal', { data });
            populateViewModal(data);
            openModal(modals.view);
            return;
        }

        if (rowAction === 'edit') {
            console.log('🟡 [PriceLists] Setting form mode to edit', { data });
            setFormMode('edit', data);
            openModal(modals.form);
            return;
        }

        if (rowAction === 'delete') {
            if (modals.delete) {
                modals.delete.dataset.priceListId = data.id ?? '';
            }
            if (deleteName) {
                deleteName.textContent = data.name ?? '';
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};
const initProductsFormModule = () => {
    const root = document.querySelector('[data-product-form-root]');
    if (!root) {
        return;
    }

    console.log('[ProductsForm] Inicializando módulo de productos', {
        mode: root.dataset.productFormMode,
    });

    const form = root.querySelector('[data-product-form]');
    const descriptionInput = form?.querySelector('[data-product-description-input]');
    const descriptionEditorContainer = form?.querySelector('[data-product-description-editor]');
    const featuredInput = form?.querySelector('[data-product-featured-input]');
    const featuredPreview = form?.querySelector('[data-product-featured-preview]');
    const featuredWrapper = form?.querySelector('[data-product-featured-wrapper]');
    const featuredRemoveButton = form?.querySelector('[data-product-featured-remove]');
    const featuredRemoveInput = form?.querySelector('[data-product-featured-remove-input]');
    const galleryInput = form?.querySelector('[data-product-gallery-input]');
    const galleryUpload = form?.querySelector('[data-product-gallery-upload]');
    const galleryContainer = form?.querySelector('[data-product-gallery-container]');
    let removedGalleryContainer = form?.querySelector('[data-product-gallery-removed]');
    const lineSelectRoot = form?.querySelector('[data-product-line-select]');
    const categorySelectRoot = form?.querySelector('[data-product-category-select]');
    const subcategorySelectRoot = form?.querySelector('[data-product-subcategory-select]');
    const lineSelectInput = lineSelectRoot?.querySelector('input[type="hidden"]') ?? null;
    const categorySelectInput = categorySelectRoot?.querySelector('input[type="hidden"]') ?? null;
    const subcategorySelectInput = subcategorySelectRoot?.querySelector('input[type="hidden"]') ?? null;
    const categoryOptions = Array.from(categorySelectRoot?.querySelectorAll('[data-product-category-option]') ?? []);
    const subcategoryOptions = Array.from(subcategorySelectRoot?.querySelectorAll('[data-product-subcategory-option]') ?? []);
    const initialHasFeaturedImage = featuredWrapper?.dataset.productFeaturedInitial === 'true';
    const emptyFeaturedMarkup = '<i class="fa-solid fa-image text-2xl text-gray-400"></i>';

    const catalogData = (() => {
        try {
            return JSON.parse(root.dataset.productFormCatalog ?? '{}');
        } catch (error) {
            console.warn('[ProductsForm] Invalid catalog data', error);
            return {};
        }
    })();

    const initialData = (() => {
        try {
            return JSON.parse(root.dataset.productFormInitial ?? 'null');
        } catch (error) {
            console.warn('[ProductsForm] Invalid initial payload', error);
            return null;
        }
    })();

    let pendingGalleryFiles = [];

    const setCustomSelectValue = (selectRoot, value, { silent = false } = {}) => {
        if (!selectRoot) {
            return;
        }
        console.log('[ProductsForm] setCustomSelectValue', {
            name: selectRoot.dataset.selectName,
            value,
        });
        const hiddenInput = selectRoot.querySelector('input[type="hidden"]');
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const options = Array.from(selectRoot.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';

        if (!hiddenInput || !valueLabel) {
            return;
        }

        const normalizedValue = value ?? '';
        hiddenInput.value = normalizedValue;

        options.forEach((option) => {
            option.dataset.selected = option.dataset.value === normalizedValue ? 'true' : 'false';
        });

        if (normalizedValue) {
            const selectedOption = options.find((option) => option.dataset.value === normalizedValue);
            valueLabel.textContent = selectedOption?.dataset.label ?? selectedOption?.textContent.trim() ?? placeholder;
        } else {
            valueLabel.textContent = placeholder;
        }

        trigger?.classList.toggle('is-empty', !normalizedValue);

        if (!silent) {
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    };

    const setFeaturedRemoveVisibility = (visible) => {
        if (!featuredRemoveButton) {
            return;
        }
        featuredRemoveButton.dataset.visible = visible ? 'true' : 'false';
        console.log('[ProductsForm] featured remove visibility', { visible });
    };

    const renderFeaturedPlaceholder = () => {
        if (!featuredPreview) {
                return;
            }
        featuredPreview.innerHTML = emptyFeaturedMarkup;
    };

    const renderFeaturedFromFile = (file) => {
        if (!featuredPreview || !file) {
            renderFeaturedPlaceholder();
            return;
        }
        console.log('[ProductsForm] renderFeaturedFromFile', {
            name: file.name,
            size: file.size,
            type: file.type,
        });
        const reader = new FileReader();
        reader.onload = (event) => {
            featuredPreview.innerHTML = `<img src="${event.target?.result ?? ''}" alt="${file.name}" class="h-full w-full object-cover">`;
        };
        reader.readAsDataURL(file);
    };

    const filterCategories = () => {
        const selectedLine = lineSelectInput?.value ?? '';
        const selectedCategory = categorySelectInput?.value ?? '';
        console.log('[ProductsForm] filterCategories', {
            selectedLine,
            selectedCategory,
        });

        categoryOptions.forEach((option) => {
            const optionLine = option.dataset.line ?? '';
            const shouldHide = Boolean(selectedLine && optionLine && optionLine !== selectedLine);
            option.hidden = shouldHide;
        });

        if (selectedCategory) {
            const categoryVisible = categoryOptions.some((option) => !option.hidden && option.dataset.value === selectedCategory);
            if (!categoryVisible) {
                setCustomSelectValue(categorySelectRoot, '', { silent: true });
            }
        }

        const currentCategory = categorySelectInput?.value ?? '';
        const selectedSubcategory = subcategorySelectInput?.value ?? '';

        subcategoryOptions.forEach((option) => {
            const optionLine = option.dataset.line ?? '';
            const optionCategory = option.dataset.category ?? '';
            const hideByLine = Boolean(selectedLine && optionLine && optionLine !== selectedLine);
            const hideByCategory = Boolean(currentCategory && optionCategory && optionCategory !== currentCategory);
            option.hidden = hideByLine || hideByCategory;
        });

        if (selectedSubcategory) {
            const subcategoryVisible = subcategoryOptions.some((option) => !option.hidden && option.dataset.value === selectedSubcategory);
            if (!subcategoryVisible) {
                setCustomSelectValue(subcategorySelectRoot, '', { silent: true });
            }
        }
    };

    const initialiseCategoryFilters = () => {
        if (!categorySelectRoot || !subcategorySelectRoot) {
            return;
        }
        filterCategories();
        lineSelectInput?.addEventListener('change', filterCategories);
        categorySelectInput?.addEventListener('change', filterCategories);
    };

    const initialiseQuill = () => {
        if (!descriptionEditorContainer || !descriptionInput) {
            return;
        }

        const loadQuill = () => {
            if (window.Quill) {
                return Promise.resolve(window.Quill);
            }
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    if (window.Quill) {
                        clearInterval(interval);
                        resolve(window.Quill);
                    }
                }, 100);
                setTimeout(() => {
                    clearInterval(interval);
                    resolve(null);
                }, 3000);
            });
        };

        loadQuill().then((Quill) => {
            if (!Quill) {
                console.warn('[ProductsForm] Quill no disponible');
                return;
            }
            console.log('[ProductsForm] Quill cargado correctamente');
            const editor = new Quill(descriptionEditorContainer, {
                theme: 'snow',
                placeholder: tx('Describe tu producto con especificaciones, características y beneficios.'),
                modules: {
                    toolbar: [
                        [{ header: [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['link', 'blockquote', 'code-block'],
                        ['clean'],
                    ],
                },
            });

            if (descriptionInput.value) {
                editor.clipboard.dangerouslyPasteHTML(descriptionInput.value);
            }

            const quillToolbar = descriptionEditorContainer.previousElementSibling;
            const quillContainer = descriptionEditorContainer;

            quillToolbar?.classList.add(
                'rounded-t-3xl',
                'border',
                'border-gray-200',
                'border-b-0',
                'bg-white',
                'px-4',
                'py-2',
                'dark:border-gray-700',
                'dark:bg-slate-900'
            );
            quillContainer?.classList.add(
                'rounded-b-3xl',
                'border',
                'border-gray-200',
                'border-t',
                'bg-white',
                'dark:border-gray-700',
                'dark:bg-slate-900'
            );
            quillContainer?.classList.add('rounded-tl-none', 'rounded-tr-none');

            editor.on('text-change', () => {
                const html = editor.root.innerHTML;
                descriptionInput.value = html === '<p><br></p>' ? '' : html;
                console.log('[ProductsForm] description text-change', {
                    length: editor.getLength(),
                });
            });
        });
    };

    const initialiseFeaturedUpload = () => {
        if (!featuredInput) {
            return;
        }
        featuredInput.addEventListener('change', () => {
            const file = featuredInput.files?.[0] ?? null;
            console.log('[ProductsForm] featured_input change', {
                hasFile: Boolean(file),
            });
            if (file) {
                renderFeaturedFromFile(file);
                if (featuredRemoveInput) {
                    featuredRemoveInput.value = '0';
                }
                setFeaturedRemoveVisibility(true);
            return;
        }

            if (initialHasFeaturedImage && featuredRemoveInput?.value !== '1' && featuredPreview?.querySelector('img')) {
                setFeaturedRemoveVisibility(true);
                return;
            }

            renderFeaturedPlaceholder();
            setFeaturedRemoveVisibility(false);
        });
    };

    if (initialHasFeaturedImage) {
        setFeaturedRemoveVisibility(true);
    } else {
        setFeaturedRemoveVisibility(false);
    }

    featuredRemoveButton?.addEventListener('click', (event) => {
        event.preventDefault();
        if (featuredInput) {
            featuredInput.value = '';
        }
        renderFeaturedPlaceholder();
        if (featuredRemoveInput) {
            featuredRemoveInput.value = initialHasFeaturedImage ? '1' : '0';
        }
        setFeaturedRemoveVisibility(false);
        console.log('[ProductsForm] featured image cleared by user', {
            initialHadImage: initialHasFeaturedImage,
        });
    });

    const getExistingGalleryCards = () => Array.from(galleryContainer?.querySelectorAll('[data-product-gallery-card][data-gallery-type="existing"]') ?? []);

    const syncGalleryInputFiles = () => {
        if (!galleryInput) {
            return;
        }
        const dataTransfer = new DataTransfer();
        pendingGalleryFiles.forEach((file) => {
            dataTransfer.items.add(file);
        });
        galleryInput.files = dataTransfer.files;
    };

    const renderGalleryPreviews = () => {
        if (!galleryContainer || !galleryUpload) {
            return;
        }
        galleryContainer.querySelectorAll('[data-product-gallery-new]').forEach((element) => element.remove());

        pendingGalleryFiles.forEach((file, index) => {
            console.log('[ProductsForm] renderGalleryPreviews', { index, name: file.name, size: file.size });
            const reader = new FileReader();
                const wrapper = document.createElement('div');
            wrapper.className = 'group relative flex flex-col gap-2 rounded-2xl border border-dashed border-gray-300 bg-white/95 p-3 shadow-sm dark:border-gray-700 dark:bg-slate-900';
                wrapper.dataset.productGalleryNew = '';
            wrapper.dataset.productGalleryCard = '';
            wrapper.dataset.galleryType = 'new';
            wrapper.dataset.galleryIndex = String(index);
                wrapper.innerHTML = `
                    <button type="button" class="absolute right-2 top-2 inline-flex h-8 w-8 items-center justify-center rounded-full bg-slate-900/80 text-white transition hover:bg-slate-900 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary focus-visible:outline-white cursor-pointer z-10" data-product-gallery-remove aria-label="${tx('Eliminar imagen temporal')}">
                    <span class="sr-only">${tx('Eliminar imagen temporal')}</span>
                    <svg class="h-3.5 w-3.5" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <path d="M3.5 3.5L10.5 10.5M10.5 3.5L3.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
                <figure class="aspect-square overflow-hidden rounded-xl bg-gray-100 shadow-inner ring-1 ring-gray-200/70 dark:bg-slate-800 dark:ring-gray-700/60">
                    <img src="" alt="${file.name}" class="h-full w-full object-cover opacity-0 transition-opacity duration-200">
                    </figure>
                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${file.name}</p>
                `;
            const image = wrapper.querySelector('img');
                galleryContainer.insertBefore(wrapper, galleryUpload);
            reader.onload = (event) => {
                if (image) {
                    image.src = event.target?.result ?? '';
                    image.classList.remove('opacity-0');
                }
            };
            reader.readAsDataURL(file);
        });
    };

    const initialiseGalleryUpload = () => {
        if (!galleryInput || !galleryContainer || !galleryUpload) {
            return;
        }

        galleryInput.addEventListener('change', () => {
            const newFiles = Array.from(galleryInput.files ?? []);
            console.log('[ProductsForm] gallery_input change', {
                selectedFiles: newFiles.map((file) => ({ name: file.name, size: file.size })),
            });
            if (newFiles.length === 0) {
                return;
            }
            const existingCount = getExistingGalleryCards().length;
            const availableSlots = Math.max(0, 5 - existingCount - pendingGalleryFiles.length);

            if (availableSlots <= 0) {
                showAlert({ title: tx('Galería llena'), text: tx('Debes eliminar imágenes existentes antes de agregar nuevas.'), icon: 'warning' });
                galleryInput.value = '';
                return;
            }

            if (newFiles.length > availableSlots) {
                const message = tx('Solo puedes agregar :count imágenes adicionales.').replace(':count', availableSlots);
                showAlert({ title: tx('Límite excedido'), text: message, icon: 'warning' });
                galleryInput.value = '';
                return;
            }

            pendingGalleryFiles = pendingGalleryFiles.concat(newFiles);
            galleryInput.value = '';
            syncGalleryInputFiles();
            renderGalleryPreviews();
        });

        const getRemovedGalleryContainer = () => {
            if (removedGalleryContainer && removedGalleryContainer.isConnected) {
                return removedGalleryContainer;
            }
            if (!form) {
                return null;
            }
            removedGalleryContainer = form.querySelector('[data-product-gallery-removed]');
            if (!removedGalleryContainer) {
                removedGalleryContainer = document.createElement('div');
                removedGalleryContainer.dataset.productGalleryRemoved = '';
                removedGalleryContainer.hidden = true;
                form.appendChild(removedGalleryContainer);
            }
            return removedGalleryContainer;
        };

        const handleGalleryRemove = (event) => {
            const target = event.target instanceof Element ? event.target.closest('[data-product-gallery-remove]') : null;
            if (!target) {
                return;
            }
            event.preventDefault();
            const card = target.closest('[data-product-gallery-card]');
            if (!card) {
                return;
            }
            const galleryType = card.dataset.galleryType ?? '';
            if (galleryType === 'existing') {
                const galleryPath = card.dataset.galleryPath ?? '';
                const retainInput = card.querySelector('input[name="retain_gallery[]"]');
                if (retainInput) {
                    retainInput.remove();
                }
                const targetContainer = getRemovedGalleryContainer();
                if (galleryPath && targetContainer) {
                    console.log('[ProductsForm] removing existing gallery image', { galleryPath });
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'removed_gallery[]';
                    hiddenInput.value = galleryPath;
                    targetContainer.appendChild(hiddenInput);
                }
                card.remove();
            } else if (galleryType === 'new') {
                const index = Number(card.dataset.galleryIndex ?? '-1');
                if (!Number.isNaN(index) && index >= 0) {
                    console.log('[ProductsForm] removing new gallery image', { index });
                    pendingGalleryFiles.splice(index, 1);
                    syncGalleryInputFiles();
                    renderGalleryPreviews();
                }
            }
        };

        galleryContainer.addEventListener('click', handleGalleryRemove);
        form?.addEventListener('click', handleGalleryRemove);
    };

    const syncVisibilitySwitch = (input) => {
        if (!(input instanceof HTMLInputElement) || input.type !== 'checkbox') {
            return;
        }
        const container = input.parentElement;
        const track = container?.querySelector('[data-visibility-track]');
        const thumb = track?.querySelector('[data-visibility-thumb]');
        if (!track || !thumb) {
            return;
        }
        const isChecked = input.checked;
        track.classList.toggle('bg-primary', isChecked);
        track.classList.toggle('bg-gray-300', !isChecked);
        thumb.classList.toggle('translate-x-5', isChecked);
    };

    const initialiseVisibilitySwitches = () => {
        if (!form) {
            return;
        }
        const inputs = form.querySelectorAll('input[type="checkbox"][name="show_in_pos"], input[type="checkbox"][name="show_in_b2b"], input[type="checkbox"][name="show_in_b2c"]');
        inputs.forEach((input) => {
            syncVisibilitySwitch(input);
            input.addEventListener('change', () => syncVisibilitySwitch(input));
        });
    };

    const normalisePriceInputValue = (input) => {
        if (!(input instanceof HTMLInputElement)) {
            return;
        }
        const rawValue = input.value?.trim() ?? '';
        if (rawValue === '') {
            input.value = '0';
            return;
        }
        const sanitized = rawValue.replace(/,/g, '.');
        const numericValue = Number.parseFloat(sanitized);
        if (Number.isNaN(numericValue) || numericValue < 0) {
            input.value = '0';
            return;
        }
        input.value = (Math.round(numericValue * 100) / 100).toString();
    };

    const initialisePriceInputs = () => {
        if (!form) {
            return;
        }
        const priceInputs = form.querySelectorAll('[data-product-price-input]');
        if (priceInputs.length === 0) {
            return;
        }
        priceInputs.forEach((input) => {
            if (!(input instanceof HTMLInputElement)) {
                return;
            }
            normalisePriceInputValue(input);
            input.addEventListener('blur', () => {
                normalisePriceInputValue(input);
            });
        });
        form.addEventListener('submit', () => {
            priceInputs.forEach((input) => {
                if (input instanceof HTMLInputElement) {
                    normalisePriceInputValue(input);
                }
            });
        });
    };

    const initialiseSelects = () => {
        // Wait for custom selects to be initialized
        setTimeout(() => {
            console.log('[ProductsForm] initialising selects', { hasInitialData: !!initialData });

            // Initialize line select
            if (lineSelectRoot) {
                const value = initialData?.product_line_id ?? lineSelectInput?.value ?? '';
                if (value) {
                    setCustomSelectValue(lineSelectRoot, value, { silent: true });
                }
            }

            // Initialize category select
            if (categorySelectRoot) {
                const value = initialData?.category_id ?? categorySelectInput?.value ?? '';
                if (value) {
                    setCustomSelectValue(categorySelectRoot, value, { silent: true });
                }
            }

            // Initialize subcategory select
            if (subcategorySelectRoot) {
                const value = initialData?.subcategory_id ?? subcategorySelectInput?.value ?? '';
                if (value) {
                    setCustomSelectValue(subcategorySelectRoot, value, { silent: true });
                }
            }

            // Initialize price list selects
            const priceListPosSelect = form?.querySelector('[data-select-name="price_list_pos_id"]');
            if (priceListPosSelect) {
                const hiddenInput = priceListPosSelect.querySelector('input[type="hidden"]');
                const value = initialData?.price_list_pos_id ?? hiddenInput?.value ?? '';
                if (value) {
                    setCustomSelectValue(priceListPosSelect, value, { silent: true });
                }
            }

            const priceListB2cSelect = form?.querySelector('[data-select-name="price_list_b2c_id"]');
            if (priceListB2cSelect) {
                const hiddenInput = priceListB2cSelect.querySelector('input[type="hidden"]');
                const value = initialData?.price_list_b2c_id ?? hiddenInput?.value ?? '';
                if (value) {
                    setCustomSelectValue(priceListB2cSelect, value, { silent: true });
                }
            }

            const priceListB2bSelect = form?.querySelector('[data-select-name="price_list_b2b_id"]');
            if (priceListB2bSelect) {
                const hiddenInput = priceListB2bSelect.querySelector('input[type="hidden"]');
                const value = initialData?.price_list_b2b_id ?? hiddenInput?.value ?? '';
                if (value) {
                    setCustomSelectValue(priceListB2bSelect, value, { silent: true });
                }
            }

            // Filter categories after initializing selects
            filterCategories();
        }, 100);
    };

    const initialiseProductSelects = () => {
        console.log('🟡 [ProductsForm] initialiseProductSelects called', { hasForm: !!form, form });
        
        if (!form) {
            console.warn('🟡 [ProductsForm] Form not found for initialiseProductSelects');
            return;
        }

        const productSelects = form.querySelectorAll('[data-select-manual]');
        console.log('🟡 [ProductsForm] Initializing product selects', { 
            count: productSelects.length, 
            formFound: !!form,
            selects: Array.from(productSelects).map(s => ({
                name: s.dataset.selectName,
                hasManual: s.hasAttribute('data-select-manual'),
                initialized: s.dataset.productsFormInitialized === 'true',
            }))
        });

        productSelects.forEach((select, index) => {
            console.log(`🟡 [ProductsForm] Processing select ${index + 1}`, {
                name: select.dataset.selectName,
                alreadyInitialized: select.dataset.productsFormInitialized === 'true',
            });
            
            // Skip if already initialized
            if (select.dataset.productsFormInitialized === 'true') {
                console.log(`🟡 [ProductsForm] Select ${index + 1} already initialized, skipping`);
                return;
            }
            select.dataset.productsFormInitialized = 'true';

            const trigger = select.querySelector('[data-select-trigger]');
            const dropdown = select.querySelector('[data-select-dropdown]');
            const hiddenInput = select.querySelector('input[type="hidden"]');
            const valueLabel = select.querySelector('[data-select-value]');
            const icon = select.querySelector('[data-select-icon]');
            
            // Search for options within the dropdown, not the entire select
            const options = dropdown 
                ? Array.from(dropdown.querySelectorAll('[data-select-option]'))
                : Array.from(select.querySelectorAll('[data-select-option]'));

            // Log full dropdown HTML for debugging
            const dropdownHTML = dropdown ? dropdown.innerHTML : 'no dropdown';
            const dropdownHTMLPreview = dropdown ? dropdown.innerHTML.substring(0, 500) : 'no dropdown';
            
            console.log(`🟡 [ProductsForm] Select ${index + 1} elements`, {
                name: select.dataset.selectName,
                hasTrigger: !!trigger,
                hasDropdown: !!dropdown,
                hasHiddenInput: !!hiddenInput,
                hasValueLabel: !!valueLabel,
                hasIcon: !!icon,
                optionsCount: options.length,
                dropdownHidden: dropdown?.hidden,
                dropdownDatasetOpen: dropdown?.dataset.open,
                dropdownHTMLPreview: dropdownHTMLPreview,
                dropdownHTMLFull: dropdownHTML, // Full HTML for inspection
                optionsFound: options.map(opt => ({
                    value: opt.dataset.value,
                    label: opt.dataset.label,
                    textContent: opt.textContent.trim().substring(0, 50),
                })),
            });

            if (!trigger || !dropdown || !hiddenInput || !valueLabel) {
                console.error(`🟡 [ProductsForm] Select ${index + 1} missing required elements`, {
                    hasTrigger: !!trigger,
                    hasDropdown: !!dropdown,
                    hasHiddenInput: !!hiddenInput,
                    hasValueLabel: !!valueLabel,
                    selectName: select.dataset.selectName,
                });
                return;
            }

            console.log(`🟡 [ProductsForm] Initializing select ${index + 1}`, {
                name: select.dataset.selectName,
                optionsCount: options.length,
                initialValue: hiddenInput.value,
            });

            // Initialize dropdown state
            dropdown.setAttribute('hidden', '');
            dropdown.classList.add('hidden', 'invisible');
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
            select.dataset.open = 'false';
            
            console.log(`🟡 [ProductsForm] Select ${index + 1} initial state set`, {
                name: select.dataset.selectName,
                dropdownHidden: dropdown.hidden,
                hasHiddenClass: dropdown.classList.contains('hidden'),
                hasInvisibleClass: dropdown.classList.contains('invisible'),
                datasetOpen: dropdown.dataset.open,
            });

            const markSelected = (value) => {
                options.forEach((option) => {
                    const isSelected = option.dataset.value === value;
                    option.dataset.selected = isSelected ? 'true' : 'false';
                });
            };

            const updateTriggerState = () => {
                const hasValue = Boolean(hiddenInput.value);
                trigger.classList.toggle('is-empty', !hasValue);
            };

            const setValue = (value, label) => {
                hiddenInput.value = value;
                valueLabel.textContent = label || value || (trigger.dataset.selectPlaceholder ?? '');
                markSelected(value);
                updateTriggerState();
                hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            };

            // Set initial value if exists
            const initialOption = options.find((option) => option.dataset.value === hiddenInput.value);
            if (initialOption) {
                setValue(initialOption.dataset.value ?? '', initialOption.dataset.label ?? initialOption.textContent.trim());
            } else if (!hiddenInput.value) {
                valueLabel.textContent = trigger.dataset.selectPlaceholder ?? '';
                updateTriggerState();
            }

            const closeSelect = () => {
                console.log(`🟡 [ProductsForm] Closing select`, { name: select.dataset.selectName });
                dropdown.setAttribute('hidden', '');
                dropdown.classList.add('hidden');
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
                select.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                if (icon) {
                    icon.style.transform = '';
                }
                console.log(`🟡 [ProductsForm] Select closed`, { 
                    name: select.dataset.selectName,
                    dropdownHidden: dropdown.hidden,
                    hasHiddenClass: dropdown.classList.contains('hidden'),
                    datasetOpen: dropdown.dataset.open,
                });
            };

            const openSelect = () => {
                // Re-fetch options when opening in case they were dynamically added
                const currentOptions = dropdown 
                    ? Array.from(dropdown.querySelectorAll('[data-select-option]'))
                    : Array.from(select.querySelectorAll('[data-select-option]'));
                
                console.log(`🟡 [ProductsForm] Opening select`, { 
                    name: select.dataset.selectName,
                    optionsCount: options.length,
                    currentOptionsCount: currentOptions.length,
                    visibleOptions: currentOptions.filter(o => !o.hidden && !o.closest('[hidden]')).length,
                    dropdownHTML: dropdown ? dropdown.innerHTML.substring(0, 300) : 'no dropdown',
                    optionsDetails: currentOptions.map((opt, idx) => ({
                        index: idx,
                        value: opt.dataset.value,
                        label: opt.dataset.label,
                        textContent: opt.textContent.trim().substring(0, 50),
                        isHidden: opt.hidden,
                        parentHidden: opt.closest('[hidden]') !== null,
                        display: window.getComputedStyle(opt).display,
                        visibility: window.getComputedStyle(opt).visibility,
                    })),
                });
                
                // Close all other selects in the form
                productSelects.forEach((otherSelect) => {
                    if (otherSelect !== select && otherSelect.dataset.open === 'true') {
                        const otherDropdown = otherSelect.querySelector('[data-select-dropdown]');
                        const otherTrigger = otherSelect.querySelector('[data-select-trigger]');
                        const otherIcon = otherSelect.querySelector('[data-select-icon]');
                        if (otherDropdown && otherTrigger) {
                            otherDropdown.hidden = true;
                            otherDropdown.dataset.open = 'false';
                            otherSelect.dataset.open = 'false';
                            otherTrigger.setAttribute('aria-expanded', 'false');
                            if (otherIcon) {
                                otherIcon.style.transform = '';
                            }
                        }
                    }
                });

                // Set data-open first to trigger CSS classes
                dropdown.dataset.open = 'true';
                select.dataset.open = 'true';
                
                // Remove hidden attribute and class, ensure visible
                dropdown.removeAttribute('hidden');
                dropdown.classList.remove('hidden', 'invisible');
                dropdown.hidden = false;
                
                trigger.setAttribute('aria-expanded', 'true');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                }
                
                console.log(`🟡 [ProductsForm] Select opened (before RAF)`, { 
                    name: select.dataset.selectName,
                    dropdownHidden: dropdown.hidden,
                    hasHiddenClass: dropdown.classList.contains('hidden'),
                    hasInvisibleClass: dropdown.classList.contains('invisible'),
                    datasetOpen: dropdown.dataset.open,
                    ariaExpanded: trigger.getAttribute('aria-expanded'),
                    iconTransform: icon?.style.transform,
                });
                
                // Use requestAnimationFrame to ensure CSS transitions work
                requestAnimationFrame(() => {
                    // Force visibility with inline styles if needed
                    dropdown.style.display = '';
                    dropdown.style.visibility = '';
                    dropdown.style.opacity = '';
                    dropdown.style.minWidth = `${trigger.getBoundingClientRect().width}px`;
                    
                    console.log(`🟡 [ProductsForm] Select opened (after RAF)`, {
                        name: select.dataset.selectName,
                        dropdownHidden: dropdown.hidden,
                        hasHiddenClass: dropdown.classList.contains('hidden'),
                        hasInvisibleClass: dropdown.classList.contains('invisible'),
                        datasetOpen: dropdown.dataset.open,
                        dropdownDisplay: window.getComputedStyle(dropdown).display,
                        dropdownVisibility: window.getComputedStyle(dropdown).visibility,
                        dropdownOpacity: window.getComputedStyle(dropdown).opacity,
                        minWidth: dropdown.style.minWidth,
                        triggerWidth: trigger.getBoundingClientRect().width,
                        computedStyles: {
                            display: window.getComputedStyle(dropdown).display,
                            visibility: window.getComputedStyle(dropdown).visibility,
                            opacity: window.getComputedStyle(dropdown).opacity,
                            transform: window.getComputedStyle(dropdown).transform,
                        },
                    });
                });
            };

            // Add click handler to trigger
            trigger.addEventListener('click', (event) => {
                console.log(`🟡 [ProductsForm] Trigger clicked`, { 
                    name: select.dataset.selectName,
                    target: event.target,
                    currentTarget: event.currentTarget,
                });
                event.preventDefault();
                event.stopPropagation();
                const isOpen = select.dataset.open === 'true';
                console.log(`🟡 [ProductsForm] Select state before toggle`, { 
                    name: select.dataset.selectName,
                    isOpen,
                    dropdownHidden: dropdown.hidden,
                    datasetOpen: dropdown.dataset.open,
                });
                if (isOpen) {
                    closeSelect();
                } else {
                    openSelect();
                }
            });

            // Add click handlers to options - use event delegation for dynamically added options
            const handleOptionClick = (event) => {
                const option = event.target.closest('[data-select-option]');
                if (!option || !dropdown.contains(option)) {
                    return;
                }
                
                console.log(`🟡 [ProductsForm] Option clicked`, { 
                    selectName: select.dataset.selectName,
                    value: option.dataset.value,
                    label: option.dataset.label,
                    textContent: option.textContent.trim(),
                    isHidden: option.hidden,
                    parentHidden: option.closest('[hidden]') !== null,
                });
                    event.preventDefault();
                    event.stopPropagation();
                    const value = option.dataset.value ?? '';
                    const label = option.dataset.label ?? option.textContent.trim();
                console.log(`🟡 [ProductsForm] Setting value`, { 
                    selectName: select.dataset.selectName,
                    value,
                    label,
                });
                    setValue(value, label);
                    closeSelect();
                    trigger.focus({ preventScroll: true });
            };
            
            // Use event delegation on the dropdown container
            dropdown.addEventListener('click', handleOptionClick);
            
            // Also add directly to existing options for immediate feedback
            options.forEach((option, optIndex) => {
                option.addEventListener('click', handleOptionClick);
            });

            // Add keyboard handler
            select.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeSelect();
                    trigger.focus({ preventScroll: true });
                }
            });
        });

        // Close selects when clicking outside
        document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Node)) {
                return;
            }
            if (!target.closest('[data-select]')) {
                productSelects.forEach((select) => {
                    if (select.dataset.open === 'true') {
                        const dropdown = select.querySelector('[data-select-dropdown]');
                        const trigger = select.querySelector('[data-select-trigger]');
                        const icon = select.querySelector('[data-select-icon]');
                        if (dropdown && trigger) {
                            dropdown.hidden = true;
                            dropdown.dataset.open = 'false';
                            select.dataset.open = 'false';
                            trigger.setAttribute('aria-expanded', 'false');
                            icon?.classList.remove('rotate-180');
                        }
                    }
                });
            }
        });
    };

    const initialiseForm = () => {
        // Wait for DOM to be fully ready
        setTimeout(() => {
            console.log('[ProductsForm] Starting form initialization');
            
            // Initialize product selects first - this must happen before other initializations
            initialiseProductSelects();
            
            // Small delay to ensure selects are initialized before other functions
            setTimeout(() => {
                initialiseCategoryFilters();
                initialiseSelects();
                initialiseQuill();
                initialiseFeaturedUpload();
                initialiseGalleryUpload();
                initialisePriceInputs();
                initialiseVisibilitySwitches();
            }, 50);
        }, 300);
        
        form?.addEventListener('change', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLInputElement)) {
                return;
            }
            if (target.matches('[name="show_in_pos"], [name="show_in_b2b"], [name="show_in_b2c"]')) {
                console.log('[ProductsForm] visibility change', {
                    field: target.name,
                    checked: target.checked,
                });
                syncVisibilitySwitch(target);
            }
        });
    };

    initialiseForm();
};
const initProductTransfersModule = () => {
    const root = document.querySelector('[data-product-transfers-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.productTransfersTableId ?? '';
    const baseUrl = root.dataset.productTransfersBaseUrl ?? '';
    const storeUrl = root.dataset.productTransfersStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    let warehouses = [];
    let products = [];

    try {
        const warehousesData = root.dataset.productTransfersWarehouses ?? '[]';
        warehouses = JSON.parse(warehousesData) ?? [];
    } catch (error) {
        console.error('[ProductTransfers] Invalid warehouses JSON', {
            error,
            data: root.dataset.productTransfersWarehouses?.substring(0, 100),
            length: root.dataset.productTransfersWarehouses?.length,
        });
        warehouses = [];
    }

    try {
        const productsData = root.dataset.productTransfersProducts ?? '[]';
        products = JSON.parse(productsData) ?? [];
        console.log('[ProductTransfers] Products loaded', { count: products.length });
    } catch (error) {
        console.error('[ProductTransfers] Invalid products JSON', {
            error,
            data: root.dataset.productTransfersProducts?.substring(0, 200),
            length: root.dataset.productTransfersProducts?.length,
        });
        products = [];
    }

    const modals = {
        form: root.querySelector('[data-product-transfer-modal="form"]'),
        view: root.querySelector('[data-product-transfer-modal="view"]'),
        delete: root.querySelector('[data-product-transfer-modal="delete"]'),
    };

    // Buscar el formulario tanto en modal como directamente en root (para páginas Create/Edit)
    const form = modals.form?.querySelector('[data-product-transfer-form]') ?? root.querySelector('[data-product-transfer-form]') ?? null;
    const submitButton = form?.querySelector('[data-product-transfer-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-product-transfer-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-product-transfer-modal-title]') ?? null;

    const movementDateInput = form?.querySelector('[data-product-transfer-input="movement_date"]') ?? null;
    const referenceInput = form?.querySelector('[data-product-transfer-input="reference"]') ?? null;
    const notesInput = form?.querySelector('[data-product-transfer-input="notes"]') ?? null;

    const originSelectRoot = form?.querySelector('[data-product-transfer-select="origin"]') ?? null;
    const destinationSelectRoot = form?.querySelector('[data-product-transfer-select="destination"]') ?? null;

    const itemsContainer = form?.querySelector('[data-product-transfer-items]') ?? null;
    const addItemButton = form?.querySelector('[data-product-transfer-add-item]') ?? null;

    const movementDateError = form?.querySelector('[data-product-transfer-error="movement_date"]') ?? null;
    const originError = form?.querySelector('[data-product-transfer-error="origin_warehouse_id"]') ?? null;
    const destinationError = form?.querySelector('[data-product-transfer-error="destination_warehouse_id"]') ?? null;
    const itemsError = form?.querySelector('[data-product-transfer-error="items"]') ?? null;

    const viewContainer = modals.view?.querySelector('[data-product-transfer-view]') ?? null;
    const viewItemsBody = modals.view?.querySelector('[data-product-transfer-view-items]') ?? null;

    const deleteReference = modals.delete?.querySelector('[data-product-transfer-delete-reference]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-product-transfer-delete-confirm]') ?? null;

    const bodyOverflowClass = 'overflow-hidden';

    const selectControllers = new Set();

    const closeAllSelects = (except = null) => {
        selectControllers.forEach((controller) => {
            if (controller !== except) {
                controller.close();
            }
        });
    };

    const createSelectController = (selectRoot, options = [], { placeholder = '' } = {}) => {
        if (!selectRoot) {
            return null;
        }

        const hiddenInput = selectRoot.querySelector('input[type="hidden"]');
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const dropdown = selectRoot.querySelector('[data-select-dropdown]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const icon = selectRoot.querySelector('[data-select-icon]');
        const optionsContainer = selectRoot.querySelector('[data-product-transfer-origin-options], [data-product-transfer-destination-options], [data-product-transfer-item-options]');

        if (!hiddenInput || !trigger || !dropdown || !valueLabel || !optionsContainer) {
            return null;
        }

        let currentOptions = options;

        const markSelected = () => {
            optionsContainer.querySelectorAll('[data-select-option]').forEach((option) => {
                option.dataset.selected = option.dataset.value === hiddenInput.value ? 'true' : 'false';
            });
        };

        const updateDisplay = () => {
            const selectedOption = optionsContainer.querySelector(`[data-select-option][data-value="${hiddenInput.value ?? ''}"]`);
            const label = selectedOption?.dataset.label ?? placeholder ?? '';
            valueLabel.textContent = hiddenInput.value ? label : (placeholder ?? '');
            trigger.classList.toggle('is-empty', !hiddenInput.value);
            markSelected();
        };

        const close = () => {
            dropdown.setAttribute('hidden', '');
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
            selectRoot.dataset.open = 'false';
            trigger.setAttribute('aria-expanded', 'false');
            icon?.classList.remove('rotate-180');
            // Restaurar clases CSS
            dropdown.classList.remove('visible', 'opacity-100');
            dropdown.classList.add('invisible', 'opacity-0');
        };

        let controller = null; // Declarar controller antes de usarlo

        const open = () => {
            if (controller) {
                closeAllSelects(controller);
            }
            console.log('[ProductTransfers] Opening dropdown', { 
                dropdown, 
                optionsContainer, 
                currentOptionsCount: currentOptions.length,
                hidden: dropdown.hidden,
                hasOptions: optionsContainer.children.length
            });
            // Remover el atributo hidden y actualizar datos
            dropdown.removeAttribute('hidden');
            dropdown.hidden = false;
            dropdown.dataset.open = 'true';
            selectRoot.dataset.open = 'true';
            trigger.setAttribute('aria-expanded', 'true');
            icon?.classList.add('rotate-180');
            // Limpiar el input de búsqueda si existe
            const searchInputLocal = selectRoot.querySelector('[data-product-transfer-item-search]');
            if (searchInputLocal) {
                searchInputLocal.value = '';
            }
            requestAnimationFrame(() => {
                dropdown.style.minWidth = `${trigger.getBoundingClientRect().width}px`;
                // Asegurar que las clases CSS estén correctas
                dropdown.classList.remove('invisible', 'opacity-0');
                dropdown.classList.add('visible', 'opacity-100');
                // Enfocar el input de búsqueda si existe
                if (searchInputLocal) {
                    searchInputLocal.focus();
                }
                console.log('[ProductTransfers] Dropdown opened', { 
                    hidden: dropdown.hidden, 
                    hasAttributeHidden: dropdown.hasAttribute('hidden'),
                    datasetOpen: dropdown.dataset.open,
                    optionsCount: optionsContainer.children.length,
                    classes: dropdown.className
                });
            });
        };

        const setValue = (value) => {
            hiddenInput.value = value ?? '';
            updateDisplay();
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        };

        let searchFilter = '';
        const searchInput = selectRoot.querySelector('[data-product-transfer-item-search]');

        const renderOptions = (list = [], filterText = '') => {
            currentOptions = list;
            optionsContainer.innerHTML = '';
            
            // Filtrar opciones basándose en el texto de búsqueda
            const filteredOptions = filterText.trim()
                ? currentOptions.filter((option) => {
                    const label = (option.label ?? option.name ?? '').toLowerCase();
                    const searchLower = filterText.toLowerCase();
                    return label.includes(searchLower);
                })
                : currentOptions;
            
            if (filteredOptions.length === 0 && filterText.trim()) {
                const noResults = document.createElement('div');
                noResults.className = 'px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400';
                noResults.textContent = tx('No se encontraron productos');
                optionsContainer.appendChild(noResults);
            } else {
                filteredOptions.forEach((option) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    button.dataset.selectOption = '';
                    button.dataset.value = option.id ?? option.value ?? '';
                    button.dataset.label = option.label ?? option.name ?? '';
                    button.dataset.selected = hiddenInput.value === (option.id ?? option.value ?? '') ? 'true' : 'false';
                    button.innerHTML = `<span class="truncate">${option.label ?? option.name ?? ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        setValue(option.id ?? option.value ?? '');
                        close();
                        if (searchInput) {
                            searchInput.value = '';
                            searchFilter = '';
                        }
                        trigger.focus({ preventScroll: true });
                    });
                    optionsContainer.appendChild(button);
                });
            }
            updateDisplay();
        };

        // Agregar listener para el input de búsqueda
        if (searchInput) {
            searchInput.addEventListener('input', (event) => {
                searchFilter = event.target.value;
                renderOptions(currentOptions, searchFilter);
            });

            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    event.preventDefault();
                    searchInput.value = '';
                    searchFilter = '';
                    renderOptions(currentOptions, '');
                    trigger.focus({ preventScroll: true });
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    const firstOption = optionsContainer.querySelector('[data-select-option]');
                    if (firstOption) {
                        firstOption.focus();
                    }
                }
            });
        }

        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            const isOpen = selectRoot.dataset.open === 'true';
            console.log('[ProductTransfers] Select trigger clicked', { isOpen, selectRoot, trigger });
            if (isOpen) {
                close();
            } else {
                console.log('[ProductTransfers] Opening select', { dropdown, optionsContainer, currentOptionsCount: currentOptions.length });
                open();
            }
        });

        selectRoot.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                close();
                trigger.focus({ preventScroll: true });
            }
        });

        controller = {
            setValue,
            renderOptions,
            close,
            get value() {
                return hiddenInput.value;
            },
            destroy() {
                selectControllers.delete(controller);
            },
        };

        selectControllers.add(controller);
        renderOptions(currentOptions);

        return controller;
    };

    document.addEventListener('click', (event) => {
        const target = event.target;
        const select = target instanceof Element ? target.closest('[data-select]') : null;
        // No cerrar si el click fue dentro de un select de product transfers
        if (!select) {
            // Verificar si el click fue dentro de un select de product transfers
            const productTransferSelect = target instanceof Element ? target.closest('[data-product-transfers-root] [data-select]') : null;
            if (!productTransferSelect) {
                closeAllSelects();
            }
        }
    }, true); // Usar capture phase para que se ejecute primero

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-product-transfer-error]').forEach((el) => {
            el.textContent = '';
        });
        form.querySelectorAll('[data-product-transfer-input]').forEach((input) => {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        });
        originSelectRoot?.querySelector('[data-select-trigger]')?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        destinationSelectRoot?.querySelector('[data-select-trigger]')?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        if (itemsError) {
            itemsError.textContent = '';
        }
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }

        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;

            if (field.startsWith('items')) {
                if (itemsError) {
                    itemsError.textContent = message ?? '';
                }
                return;
            }

            if (field === 'origin_warehouse_id') {
                originSelectRoot?.querySelector('[data-select-trigger]')?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }

            if (field === 'destination_warehouse_id') {
                destinationSelectRoot?.querySelector('[data-select-trigger]')?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }

            const errorEl = form.querySelector(`[data-product-transfer-error="${field}"]`);
            const inputEl = form.querySelector(`[data-product-transfer-input="${field}"]`);
            if (errorEl) {
                errorEl.textContent = message ?? '';
            }
            if (inputEl) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };

    const populateItemsTable = (items = []) => {
        if (!viewItemsBody) {
            return;
        }
        viewItemsBody.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="3" class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-300">${tx('No hay productos registrados')}</td>`;
            viewItemsBody.appendChild(row);
            return;
        }
        items.forEach((item) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-200">${item.product_name ?? '—'}</td>
                <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300">${item.product_sku ?? '—'}</td>
                <td class="px-4 py-3 text-right text-sm font-semibold text-gray-900 dark:text-white">${item.quantity ?? 0}</td>
            `;
            viewItemsBody.appendChild(row);
        });
    };

    const originSelectController = createSelectController(
        originSelectRoot,
        warehouses,
        { placeholder: tx('Selecciona una bodega') },
    );

    const destinationSelectController = createSelectController(
        destinationSelectRoot,
        warehouses,
        { placeholder: tx('Selecciona una bodega') },
    );

    // Lógica para ocultar bodega seleccionada en origen solo en destino
    const updateWarehouseOptions = () => {
        if (!originSelectController || !destinationSelectController) {
            return;
        }

        const originValue = originSelectController.value;

        // Solo filtrar opciones para destino (excluir la seleccionada en origen)
        // El select de origen siempre muestra todas las bodegas para poder modificar
        const destinationOptions = originValue
            ? warehouses.filter((w) => w.id !== originValue)
            : warehouses;
        destinationSelectController.renderOptions(destinationOptions);
    };

    // Escuchar cambios solo en el select de origen
    if (originSelectController) {
        const originHiddenInput = originSelectRoot?.querySelector('input[type="hidden"]');
        originHiddenInput?.addEventListener('change', () => {
            updateWarehouseOptions();
        });
    }

    const itemSelectControllers = new Map();

    const destroyItemControllers = () => {
        itemSelectControllers.forEach((controller) => {
            controller?.destroy?.();
        });
        itemSelectControllers.clear();
    };

    const removeItemRow = (row) => {
        const controllerId = row.dataset.productTransferItemRow ?? null;
        if (controllerId && itemSelectControllers.has(controllerId)) {
            const controller = itemSelectControllers.get(controllerId);
            controller?.destroy?.();
            itemSelectControllers.delete(controllerId);
        }
        row.remove();
    };

    let itemCounter = 0;

    const createItemRow = (data = null) => {
        if (!itemsContainer) {
            return;
        }

        const rowId = `item-${itemCounter += 1}`;
        const row = document.createElement('div');
        row.className = 'rounded-xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-slate-900';
        row.dataset.productTransferItemRow = rowId;

        row.innerHTML = `
            <div class="grid gap-3 md:grid-cols-[minmax(0,2fr)_120px_1fr_40px] md:items-end">
                <div>
                    <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300">${tx('Producto')}</label>
                    <div class="relative" data-select data-select-name="product_id" data-select-manual="true">
                        <input type="hidden" data-product-transfer-item-input="product_id" value="">
                        <button
                            type="button"
                            class="flex w-full items-center justify-between rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-800 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                            data-select-trigger
                            data-select-placeholder="${tx('Selecciona un producto')}"
                            aria-haspopup="listbox"
                            aria-expanded="false"
                        >
                            <span data-select-value class="truncate">${tx('Selecciona un producto')}</span>
                            <i class="fa-solid fa-chevron-down text-xs text-secondary transition" data-select-icon></i>
                        </button>
                        <div
                            class="invisible absolute left-0 right-0 z-50 mt-2 w-full origin-top scale-95 transform rounded-xl border border-gray-200 bg-white shadow-xl opacity-0 transition will-change-transform data-[open='true']:visible data-[open='true']:scale-100 data-[open='true']:opacity-100 dark:border-gray-700 dark:bg-slate-900"
                            data-select-dropdown
                            role="listbox"
                            hidden
                        >
                            <div class="border-b border-gray-200 p-3 dark:border-gray-700">
                                <input
                                    type="text"
                                    class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 placeholder-gray-400 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-800 dark:text-white"
                                    placeholder="${tx('Buscar producto...')}"
                                    data-product-transfer-item-search
                                    autocomplete="off"
                                >
                            </div>
                            <div class="max-h-56 overflow-y-auto py-2" data-product-transfer-item-options></div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300">${tx('Cantidad')}</label>
                    <input
                        type="number"
                        min="1"
                        step="1"
                        data-product-transfer-item-input="quantity"
                        class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm text-gray-800 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                        value="1"
                        required
                    >
                </div>
                <div>
                    <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300">${tx('Notas')}</label>
                    <input
                        type="text"
                        data-product-transfer-item-input="notes"
                        class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm text-gray-800 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                        maxlength="500"
                    >
                </div>
                <div class="flex justify-end md:justify-center">
                    <button
                        type="button"
                        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-gray-300 text-gray-500 transition hover:border-rose-500 hover:text-rose-600 dark:border-gray-700 dark:text-gray-300"
                        data-product-transfer-item-remove
                        aria-label="${tx('Eliminar producto')}"
                    >
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
        `;

        itemsContainer.appendChild(row);

        const quantityInput = row.querySelector('[data-product-transfer-item-input="quantity"]');
        const notesInput = row.querySelector('[data-product-transfer-item-input="notes"]');

        // Establecer valores de cantidad y notas inmediatamente si hay datos
        if (data) {
            if (quantityInput && data.quantity) {
                quantityInput.value = data.quantity;
            }
            if (notesInput && data.notes) {
                notesInput.value = data.notes;
            }
        }

        // Esperar un momento para que el DOM se actualice
        requestAnimationFrame(() => {
            const productSelectRoot = row.querySelector('[data-select]');
            
            // Verificar que el select root existe
            if (!productSelectRoot) {
                console.error('[ProductTransfers] Product select root not found for row:', rowId);
                return;
            }

            // Verificar que hay productos disponibles
            if (!products || products.length === 0) {
                console.warn('[ProductTransfers] No products available for select', { products, count: products?.length });
                return;
            }

            const productController = createSelectController(
                productSelectRoot,
                products,
                { placeholder: tx('Selecciona un producto') },
            );

            if (productController) {
                itemSelectControllers.set(rowId, productController);
                // Asegurar que las opciones se rendericen inmediatamente
                productController.renderOptions(products);
                
                // Si hay datos, establecer el valor del producto después de crear el controller
                if (data && data.product_id) {
                    productController.setValue(data.product_id);
                }
                
                console.log('[ProductTransfers] Product select controller created successfully for row:', rowId, { productsCount: products.length, productId: data?.product_id });
            } else {
                console.error('[ProductTransfers] Failed to create product select controller for row:', rowId, {
                    productSelectRoot: !!productSelectRoot,
                    productsCount: products?.length,
                    optionsContainer: productSelectRoot?.querySelector('[data-product-transfer-item-options]'),
                });
            }
        });

        const removeButton = row.querySelector('[data-product-transfer-item-remove]');
        removeButton?.addEventListener('click', () => {
            removeItemRow(row);
            ensureAtLeastOneItem();
        });
    };

    const clearItems = () => {
        if (!itemsContainer) {
            return;
        }
        destroyItemControllers();
        itemsContainer.innerHTML = '';
    };

    const ensureAtLeastOneItem = () => {
        if (!itemsContainer) {
            return;
        }
        if (itemsContainer.querySelectorAll('[data-product-transfer-item-row]').length === 0) {
            createItemRow();
        }
    };

    addItemButton?.addEventListener('click', (event) => {
        event.preventDefault();
        createItemRow();
    });

    const getFormMode = () => form?.dataset.mode ?? 'create';

    const collectItems = () => {
        if (!itemsContainer) {
            return [];
        }
        const rows = Array.from(itemsContainer.querySelectorAll('[data-product-transfer-item-row]'));
        return rows.map((row) => {
            const productController = itemSelectControllers.get(row.dataset.productTransferItemRow ?? '');
            const productId = productController?.value ?? '';
            const quantityInput = row.querySelector('[data-product-transfer-item-input="quantity"]');
            const notesInput = row.querySelector('[data-product-transfer-item-input="notes"]');

            return {
                product_id: productId,
                quantity: quantityInput ? Number.parseInt(quantityInput.value || '0', 10) : 0,
                notes: notesInput?.value?.trim() ?? null,
            };
        });
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }

        viewContainer.querySelectorAll('[data-product-transfer-view-field]').forEach((element) => {
            const field = element.getAttribute('data-product-transfer-view-field');
            if (!field) {
                return;
            }
            element.textContent = data[field] ?? '—';
        });

        populateItemsTable(data.items ?? []);
    };

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-product-transfer-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-product-transfer-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = button.closest('[data-product-transfer-modal]');
            closeModal(modal);
        });
    });

    [modals.form, modals.view, modals.delete].forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        if (itemsError) {
            itemsError.textContent = '';
        }

        form.dataset.mode = mode;
        form.dataset.entryId = data?.id ?? '';

        submitButton.dataset.originalLabel = mode === 'create' ? tx('Guardar') : tx('Actualizar');
        submitLabel.textContent = submitButton.dataset.originalLabel;

        if (modalTitle) {
            modalTitle.textContent = mode === 'create'
                ? tx('Nuevo movimiento')
                : tx('Editar movimiento');
        }

        if (movementDateInput) {
            movementDateInput.value = data?.movement_date ?? new Date().toISOString().slice(0, 10);
        }

        if (referenceInput) {
            referenceInput.value = data?.reference ?? '';
        }

        if (notesInput) {
            notesInput.value = data?.notes ?? '';
        }

        if (originSelectController) {
            const originValue = data?.origin_warehouse_id ?? '';
            // El select de origen siempre muestra todas las bodegas
            originSelectController.renderOptions(warehouses);
            originSelectController.setValue(originValue);
        }

        if (destinationSelectController) {
            const originValue = data?.origin_warehouse_id ?? '';
            const destinationValue = data?.destination_warehouse_id ?? '';
            // Solo filtrar opciones para destino (excluir la seleccionada en origen)
            const destinationOptions = originValue
                ? warehouses.filter((w) => w.id !== originValue)
                : warehouses;
            destinationSelectController.renderOptions(destinationOptions);
            destinationSelectController.setValue(destinationValue);
        }

        clearItems();

        if (data?.items?.length) {
            data.items.forEach((item) => createItemRow(item));
        } else {
            createItemRow();
        }
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const items = collectItems().filter((item) => item.product_id);

        const payload = {
            movement_date: movementDateInput?.value ?? '',
            reference: referenceInput?.value?.trim() || null,
            origin_warehouse_id: originSelectController?.value ?? '',
            destination_warehouse_id: destinationSelectController?.value ?? '',
            notes: notesInput?.value?.trim() || null,
            items,
        };

        if (!items.length && itemsError) {
            itemsError.textContent = tx('Agrega al menos un producto al movimiento.');
            return;
        }

        const hasInvalid = items.some((item) => !item.product_id || !Number.isInteger(item.quantity) || item.quantity <= 0);
        if (hasInvalid) {
            if (itemsError) {
                itemsError.textContent = tx('Cada producto debe tener una cantidad válida mayor que cero.');
            }
            return;
        }

        clearFormErrors();

        setSubmitLoading(true);

        const mode = getFormMode();
        const entryId = form.dataset.entryId ?? '';
        const url = mode === 'create' ? storeUrl : `${baseUrl}/${entryId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json?.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            // Si estamos en una página (no modal), mostrar alert y redirigir después
            if (!modals.form) {
                showAlert({
                    title: tx('Datos actualizados'),
                    text: json?.message ?? (mode === 'create' ? tx('El movimiento se registró correctamente.') : tx('El movimiento se actualizó correctamente.')),
                    icon: 'success',
                }).then(() => {
                    window.location.href = `${baseUrl}/${json?.data?.item?.id ?? entryId}`;
                }).catch(() => {
                    // Si el usuario cierra el alert, redirigir de todas formas
                    window.location.href = `${baseUrl}/${json?.data?.item?.id ?? entryId}`;
                });
                return;
            }
            
            // Si estamos en modal, mostrar alert, cerrar modal y refrescar tabla
            showAlert({
                title: tx('Datos actualizados'),
                text: json?.message ?? (mode === 'create' ? tx('El movimiento se registró correctamente.') : tx('El movimiento se actualizó correctamente.')),
                icon: 'success',
            }).then(() => {
                closeModal(modals.form);
                refreshTable();
            }).catch(() => {
                // Si el usuario cierra el alert, cerrar modal y refrescar de todas formas
                closeModal(modals.form);
                refreshTable();
            });
        } catch (error) {
            console.error('[ProductTransfers] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }

        const entryId = modals.delete.dataset.productTransferId ?? '';
        if (!entryId) {
            showAlert({ title: tx('Error'), text: tx('No se pudo determinar el movimiento a eliminar.'), icon: 'error' });
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${entryId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el movimiento.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El movimiento se eliminó correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[ProductTransfers] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    // Si estamos en la página de creación, inicializar el formulario
    const createForm = root.querySelector('form[action*="/store"][data-product-transfer-form]');
    if (createForm) {
        setFormMode('create');
    }

    // Si estamos en la página de edición, inicializar el formulario con los datos
    const editForm = root.querySelector('form[method="POST"][data-product-transfer-form][data-entry-id]');
    if (editForm && editForm.dataset.entryId) {
        const transferId = editForm.dataset.entryId;
        fetch(`${baseUrl}/${transferId}`, {
            headers: {
                Accept: 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => response.json())
            .then((json) => {
                if (json?.data?.item) {
                    setFormMode('edit', json.data.item);
                }
            })
            .catch((error) => {
                console.error('[ProductTransfers] Error loading edit data', error);
            });
    }

    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-product-transfer-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-product-transfer-action')) {
            const action = actionEl.dataset.productTransferAction;
            if (action === 'create') {
                window.location.href = `${baseUrl}/create`;
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        const transferId = actionEl.dataset.id || actionEl.dataset.rowId;
        const reference = actionEl.dataset.name || actionEl.dataset.rowName || '';

        if (!rowAction || !transferId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            window.location.href = `${baseUrl}/${transferId}`;
            return;
        }

        if (rowAction === 'edit') {
            window.location.href = `${baseUrl}/${transferId}/edit`;
            return;
        }

        if (rowAction === 'delete') {
            const name = reference || transferId;
            if (modals.delete) {
                modals.delete.dataset.productTransferId = transferId;
            }
            if (deleteReference) {
                deleteReference.textContent = name || transferId;
            }
            openModal(modals.delete);
        }
    });
};
const initProvidersModule = () => {
    const root = document.querySelector('[data-providers-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.providersTableId ?? '';
    const baseUrl = root.dataset.providersBaseUrl ?? '';
    const storeUrl = root.dataset.providersStoreUrl ?? baseUrl;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    const modals = {
        form: root.querySelector('[data-provider-modal="form"]'),
        view: root.querySelector('[data-provider-modal="view"]'),
        delete: root.querySelector('[data-provider-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-provider-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-provider-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-provider-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-provider-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-provider-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-provider-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-provider-delete-confirm]') ?? null;

    const providerTypeInput = form?.querySelector('[data-provider-input="provider_type"]') ?? null;
    const identificationTypeInput = form?.querySelector('[data-provider-input="identification_type"]') ?? null;

    const individualSections = form ? Array.from(form.querySelectorAll('[data-provider-section="individual"]')) : [];
    const businessSections = form ? Array.from(form.querySelectorAll('[data-provider-section="business"]')) : [];

    const bodyOverflowClass = 'overflow-hidden';

    const getEventTargetModal = (target) => target.closest('[data-provider-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (!root.querySelector('[data-provider-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-provider-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const getFieldElements = (field) => {
        const input = form?.querySelector(`[data-provider-input="${field}"]`) ?? null;
        const errorEl = form?.querySelector(`[data-provider-error="${field}"]`) ?? null;
        const selectRoot = input instanceof HTMLInputElement ? input.closest('[data-select]') : null;
        const trigger = selectRoot?.querySelector('[data-select-trigger]') ?? null;

        return { input, errorEl, selectRoot, trigger };
    };

    const clearFieldError = (field) => {
        const { input, errorEl, selectRoot, trigger } = getFieldElements(field);
        if (errorEl) {
            errorEl.textContent = '';
        }
        if (input && input.type !== 'hidden') {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        if (selectRoot) {
            selectRoot.dataset.selectInvalid = 'false';
        }
        trigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
    };

    const setFieldError = (field, message) => {
        const { input, errorEl, selectRoot, trigger } = getFieldElements(field);
        if (errorEl) {
            errorEl.textContent = message ?? '';
        }
        if (input && input.type !== 'hidden') {
            input.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        if (selectRoot) {
            selectRoot.dataset.selectInvalid = 'true';
        }
        trigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
    };

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-provider-input]').forEach((input) => {
            const field = input.getAttribute('data-provider-input');
            if (field) {
                clearFieldError(field);
            }
        });
    };

    const applyFormErrors = (errors) => {
        if (!errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            setFieldError(field, message ?? '');
        });
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const syncCustomSelectDisplay = (input) => {
        if (!(input instanceof HTMLInputElement)) {
            return;
        }
        const selectRoot = input.closest('[data-select]');
        if (!selectRoot) {
            return;
        }
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const options = Array.from(selectRoot.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';

        let label = placeholder;
        options.forEach((option) => {
            const isSelected = option.dataset.value === input.value && input.value !== '';
            option.dataset.selected = isSelected ? 'true' : 'false';
            if (isSelected) {
                label = option.dataset.label ?? option.textContent.trim();
            }
        });

        if (valueLabel) {
            valueLabel.textContent = input.value ? label : placeholder;
        }
        trigger?.classList.toggle('is-empty', !input.value);
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-provider-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            input.value = value ?? '';
            syncCustomSelectDisplay(input);
        }
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-provider-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement) {
            return input.value.trim();
        }
        return '';
    };

    const sanitizeIdentificationNumber = (type, value) => {
        const normalized = (value ?? '').toUpperCase().replace(/\s+/g, '');
        if (type === 'CEDULA') {
            return normalized.replace(/\D+/g, '').slice(0, 10);
        }
        if (type === 'RUC') {
            return normalized.replace(/\D+/g, '').slice(0, 13);
        }
        return normalized.replace(/[^A-Z0-9]/g, '').slice(0, 20);
    };

    const sanitizePhoneValue = (value) => (value ?? '').replace(/[^0-9+\-()\s]/g, '');

    const toggleProviderSections = () => {
        if (!form) {
            return;
        }
        const type = getFieldValue('provider_type') || 'individual';
        const isBusiness = type === 'business';

        individualSections.forEach((section) => {
            section.classList.toggle('hidden', isBusiness);
            section.querySelectorAll('[data-provider-input]').forEach((inputEl) => {
                if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement) {
                    inputEl.disabled = isBusiness;
                    inputEl.required = !isBusiness;
                    if (isBusiness) {
                        inputEl.value = '';
                        const field = inputEl.getAttribute('data-provider-input');
                        if (field) {
                            clearFieldError(field);
                        }
                    }
                }
            });
        });

        businessSections.forEach((section) => {
            section.classList.toggle('hidden', !isBusiness);
            section.querySelectorAll('[data-provider-input]').forEach((inputEl) => {
                if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement) {
                    inputEl.disabled = !isBusiness;
                    inputEl.required = isBusiness;
                    if (!isBusiness) {
                        inputEl.value = '';
                        const field = inputEl.getAttribute('data-provider-input');
                        if (field) {
                            clearFieldError(field);
                        }
                    }
                }
            });
        });

        if (identificationTypeInput instanceof HTMLInputElement) {
            if (isBusiness && identificationTypeInput.value === 'CEDULA') {
                setFieldValue('identification_type', 'RUC');
            } else if (!isBusiness && identificationTypeInput.value === 'RUC') {
                setFieldValue('identification_type', 'CEDULA');
            } else {
                syncCustomSelectDisplay(identificationTypeInput);
            }
        }
    };

    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.providerId = data?.id ?? '';

        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            setFieldValue('provider_type', 'individual');
            setFieldValue('identification_type', 'CEDULA');
            setFieldValue('identification_number', '');
            setFieldValue('first_name', '');
            setFieldValue('last_name', '');
            setFieldValue('business_name', '');
            setFieldValue('email', '');
            setFieldValue('phone_number', '');
            if (modalTitle) {
                modalTitle.textContent = tx('Nuevo proveedor');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            if (modalTitle) {
                modalTitle.textContent = tx('Editar proveedor');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        if (data) {
            setFieldValue('provider_type', data.provider_type ?? 'individual');
            setFieldValue('identification_type', data.identification_type ?? 'CEDULA');
            setFieldValue('identification_number', data.identification_number ?? '');
            setFieldValue('first_name', data.first_name ?? '');
            setFieldValue('last_name', data.last_name ?? '');
            setFieldValue('business_name', data.business_name ?? '');
            setFieldValue('email', data.email ?? '');
            setFieldValue('phone_number', data.phone_number ?? '');
            setFieldValue('status', data.status ?? 'A');
        }

        toggleProviderSections();
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-provider-view-field]').forEach((element) => {
            const field = element.getAttribute('data-provider-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };

    const fetchProvider = async (providerId) => {
        if (!providerId) {
            return null;
        }
        try {
            const response = await fetch(`${baseUrl}/${providerId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json().catch(() => null);
            if (!response.ok || !json?.data?.item) {
                throw new Error(json?.message ?? 'Invalid response');
            }
            return json.data.item;
        } catch (error) {
            console.error('[Providers] Fetch error', error);
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return null;
        }
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const providerId = form.dataset.providerId ?? '';

        const providerType = getFieldValue('provider_type') || 'individual';
        const identificationType = getFieldValue('identification_type') || 'CEDULA';
        const identifier = sanitizeIdentificationNumber(identificationType, getFieldValue('identification_number'));
        const email = getFieldValue('email').toLowerCase();
        const phone = sanitizePhoneValue(getFieldValue('phone_number'));

        const payload = {
            provider_type: providerType,
            identification_type: identificationType,
            identification_number: identifier,
            first_name: getFieldValue('first_name'),
            last_name: getFieldValue('last_name'),
            business_name: getFieldValue('business_name'),
            email: email || null,
            phone_number: phone || null,
            status: getFieldValue('status') || 'A',
        };

        if (payload.provider_type === 'business') {
            payload.first_name = null;
            payload.last_name = null;
            payload.business_name = payload.business_name ? payload.business_name.toUpperCase() : null;
        } else {
            payload.first_name = payload.first_name ? payload.first_name.toUpperCase() : null;
            payload.last_name = payload.last_name ? payload.last_name.toUpperCase() : null;
            payload.business_name = null;
        }

        clearFormErrors();

        const validationErrors = {};

        if (!payload.identification_number) {
            validationErrors.identification_number = tx('El número de identificación es obligatorio.');
        } else {
            if (payload.identification_type === 'CEDULA' && !/^\d{10}$/.test(payload.identification_number)) {
                validationErrors.identification_number = tx('Ingresa un número de cédula válido (10 dígitos).');
            }
            if (payload.identification_type === 'RUC' && !/^\d{13}$/.test(payload.identification_number)) {
                validationErrors.identification_number = tx('Ingresa un número de RUC válido (13 dígitos).');
            }
            if (payload.identification_type === 'PASAPORTE' && !/^[A-Z0-9]{5,20}$/.test(payload.identification_number)) {
                validationErrors.identification_number = tx('Ingresa un número de pasaporte válido (5-20 caracteres alfanuméricos).');
            }
        }

        if (payload.provider_type === 'business') {
            if (!payload.business_name) {
                validationErrors.business_name = tx('La razón social es obligatoria.');
            }
        } else {
            if (!payload.first_name) {
                validationErrors.first_name = tx('El nombre es obligatorio.');
            }
            if (!payload.last_name) {
                validationErrors.last_name = tx('El apellido es obligatorio.');
            }
        }

        if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
            validationErrors.email = tx('Ingresa un correo electrónico válido.');
        }

        if (payload.phone_number && !/^[0-9+\-()\s]{6,}$/.test(payload.phone_number)) {
            validationErrors.phone_number = tx('Ingresa un teléfono válido.');
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${providerId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Providers] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const providerId = modals.delete.dataset.providerId;
        if (!providerId) {
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            const response = await fetch(`${baseUrl}/${providerId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Providers] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const providerId = input.dataset.id ?? '';
        if (!providerId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            const response = await fetch(`${baseUrl}/${providerId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Providers] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }

    if (providerTypeInput instanceof HTMLInputElement) {
        providerTypeInput.addEventListener('change', () => {
            toggleProviderSections();
        });
    }

    if (identificationTypeInput instanceof HTMLInputElement) {
        identificationTypeInput.addEventListener('change', () => {
            identificationTypeInput.value = identificationTypeInput.value.toUpperCase();
            syncCustomSelectDisplay(identificationTypeInput);
        });
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }

    root.addEventListener('click', async (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-provider-action], [data-action], [data-row-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-provider-action')) {
            const action = actionEl.dataset.providerAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        const rowAction = actionEl.dataset.action || actionEl.dataset.rowAction;
        const providerId = actionEl.dataset.id || actionEl.dataset.rowId;
        const providerName = actionEl.dataset.name || actionEl.dataset.rowName || '';

        if (!rowAction || !providerId) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'edit') {
            fetch(`${baseUrl}/${providerId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        setFormMode('edit', json.data.item);
                        openModal(modals.form);
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[Providers] Fetch edit error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para editar.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'view') {
            fetch(`${baseUrl}/${providerId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        populateViewModal(json.data.item);
                        openModal(modals.view);
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para ver.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[Providers] Fetch view error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos para ver.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'delete') {
            const name = providerName || providerId;
            if (modals.delete) {
                modals.delete.dataset.providerId = providerId;
            }
            if (deleteName) {
                deleteName.textContent = name || providerId;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });

    toggleProviderSections();
};
const initCustomersModule = () => {
    const root = document.querySelector('[data-customers-root]');
    if (!root) {
        return;
    }

    const tableId = root.dataset.customersTableId ?? '';
    const baseUrl = root.dataset.customersBaseUrl ?? '';
    const storeUrl = root.dataset.customersStoreUrl ?? baseUrl;
    const apiUrl = root.dataset.customersApiUrl ?? '';
    const presetCustomerType = (root.dataset.customersType ?? '').toLowerCase();
    const isBusinessModule = presetCustomerType === 'business';
    const validateDocumentUrl = root.dataset.customersValidateDocumentUrl ?? '';
    const validateEmailUrl = root.dataset.customersValidateEmailUrl ?? '';
    const categoryOptionsUrl = root.dataset.customersCategoriesOptionsUrl ?? '';
    let categoryOptions = [];
    try {
        categoryOptions = JSON.parse(root.dataset.customersCategoriesOptions ?? '[]') ?? [];
    } catch (error) {
        console.warn('[Customers] Invalid categories options payload', error);
    }
    if (!Array.isArray(categoryOptions)) {
        categoryOptions = [];
    }
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';

    console.info('[Customers] init', { tableId, baseUrl, apiUrl, presetCustomerType });

    const queryModal = (selector) => root.querySelector(selector) || document.querySelector(selector);

    const modals = {
        form: queryModal('[data-customer-modal="form"]'),
        view: queryModal('[data-customer-modal="view"]'),
        delete: queryModal('[data-customer-modal="delete"]'),
    };

    const form = modals.form?.querySelector('[data-customer-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-customer-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-customer-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-customer-modal-title]') ?? null;
    const viewContainer = modals.view?.querySelector('[data-customer-view]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-customer-delete-name]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-customer-delete-confirm]') ?? null;
    const deleteIdInput = modals.delete?.querySelector('[data-customer-delete-id]') ?? null;
    console.log('[Customers] delete references', { deleteModal: modals.delete, deleteConfirmButton, deleteIdInput });
    const customerTypeInput = form?.querySelector('[data-customer-input="customer_type"]') ?? null;
    const documentTypeInput = form?.querySelector('[data-customer-input="document_type"]') ?? null;
    const documentInput = form?.querySelector('[data-customer-input="document_number"]') ?? null;
    const emailInput = form?.querySelector('[data-customer-input="email"]') ?? null;
    const firstNameInput = form?.querySelector('[data-customer-input="first_name"]') ?? null;
    const lastNameInput = form?.querySelector('[data-customer-input="last_name"]') ?? null;
    const businessNameInput = form?.querySelector('[data-customer-input="business_name"]') ?? null;
    const phoneInput = form?.querySelector('[data-customer-input="phone_number"]') ?? null;
    const categoryInput = form?.querySelector('[data-customer-input="category_id"]') ?? null;
    const sexInput = form?.querySelector('[data-customer-input="sex"]') ?? null;
    const birthDateInput = form?.querySelector('[data-customer-input="birth_date"]') ?? null;
    const portalPasswordInput = form?.querySelector('[data-customer-input="portal_password"]') ?? null;
    const portalPasswordToggle = form?.querySelector('[data-customer-password-toggle]') ?? null;
    const b2bAccessInput = form?.querySelector('[data-customer-input="b2b_access"]') ?? null;
    const b2cAccessInput = form?.querySelector('[data-customer-input="b2c_access"]') ?? null;
    const b2bToggleButton = form?.querySelector('[data-customer-toggle="b2b_access"]') ?? null;
    const b2cToggleButton = form?.querySelector('[data-customer-toggle="b2c_access"]') ?? null;
    const b2bToggleLabel = form?.querySelector('[data-customer-toggle-label="b2b_access"]') ?? null;
    const b2cToggleLabel = form?.querySelector('[data-customer-toggle-label="b2c_access"]') ?? null;
    const categoryOptionsContainer = form?.querySelector('[data-customer-category-options]') ?? null;
    const categorySelectRoot = categoryInput?.closest('[data-select]') ?? null;
    const categoryTrigger = categorySelectRoot?.querySelector('[data-select-trigger]') ?? null;
    const categoryDropdown = categorySelectRoot?.querySelector('[data-select-dropdown]') ?? null;
    const categoryIcon = categorySelectRoot?.querySelector('[data-select-icon]') ?? null;
    const customerTypeWrapper = form?.querySelector('[data-customer-type-wrapper]') ?? null;
    const bodyOverflowClass = 'overflow-hidden';
    const validationControllers = {
        document_number: null,
        email: null,
    };
    let lastDocumentResult = { value: null, available: null, message: '' };
    let lastEmailResult = { value: null, available: null, message: '' };
    const sexLabels = {
        MASCULINO: tx('Masculino'),
        FEMENINO: tx('Femenino'),
        OTRO: tx('Otro'),
    };

    const accessToggleConfig = {
        b2b_access: {
            input: b2bAccessInput,
            button: b2bToggleButton,
            label: b2bToggleLabel,
        },
        b2c_access: {
            input: b2cAccessInput,
            button: b2cToggleButton,
            label: b2cToggleLabel,
        },
    };

    const setPortalPasswordVisibility = (visible) => {
        if (!(portalPasswordInput instanceof HTMLInputElement)) {
            return;
        }
        const isVisible = Boolean(visible);
        portalPasswordInput.type = isVisible ? 'text' : 'password';
        if (portalPasswordToggle instanceof HTMLElement) {
            portalPasswordToggle.dataset.state = isVisible ? 'visible' : 'hidden';
            portalPasswordToggle.setAttribute('aria-pressed', isVisible ? 'true' : 'false');
            portalPasswordToggle.innerHTML = isVisible
                ? '<i class="fa-solid fa-eye-slash"></i>'
                : '<i class="fa-solid fa-eye"></i>';
            portalPasswordToggle.setAttribute('aria-label', isVisible ? tx('Ocultar clave') : tx('Mostrar clave'));
        }
    };

    const setAccessToggleState = (field, enabled) => {
        const config = accessToggleConfig[field];
        if (!config?.input) {
            return;
        }
        const isEnabled = Boolean(enabled);
        config.input.value = isEnabled ? '1' : '0';
        if (config.button) {
            config.button.dataset.active = isEnabled ? 'true' : 'false';
            config.button.setAttribute('aria-pressed', isEnabled ? 'true' : 'false');
            config.button.classList.toggle('bg-primary', isEnabled);
            config.button.classList.toggle('border-primary', isEnabled);
            config.button.classList.toggle('shadow-lg', isEnabled);
            config.button.classList.toggle('bg-gray-200', !isEnabled);
            config.button.classList.toggle('border-gray-300', !isEnabled);
            config.button.classList.toggle('dark:bg-primary', isEnabled);
            config.button.classList.toggle('dark:border-primary', isEnabled);
            config.button.classList.toggle('dark:bg-slate-700', !isEnabled);
            config.button.classList.toggle('dark:border-gray-600', !isEnabled);
            const handle = config.button.querySelector('[data-customer-toggle-handle]');
            if (handle) {
                handle.dataset.active = isEnabled ? 'true' : 'false';
            }
        }
        if (config.label) {
            config.label.textContent = isEnabled ? tx('Activo') : tx('Inactivo');
        }
    };

    const getAccessToggleValue = (field) => {
        const config = accessToggleConfig[field];
        if (!config?.input) {
            return false;
        }
        const value = config.input.value;
        return value === '1' || value === 1 || value === true || value === 'true';
    };

    const toggleAccessField = (field) => {
        setAccessToggleState(field, !getAccessToggleValue(field));
    };

    const getEventTargetModal = (target) => target.closest('[data-customer-modal]');

    const openModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };

    const closeModal = (modal) => {
        if (!modal) {
            return;
        }
        modal.classList.add('hidden');
        if (modal === modals.delete) {
            modal.dataset.customerId = '';
            if (deleteIdInput) {
                deleteIdInput.value = '';
            }
            if (deleteConfirmButton) {
                deleteConfirmButton.dataset.customerId = '';
            }
        }
        if (!root.querySelector('[data-customer-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };

    root.querySelectorAll('[data-customer-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });

    Object.values(modals).forEach((modal) => {
        if (!modal) {
            return;
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeModal(modal);
            }
        });
    });

    const clearFormErrors = () => {
        if (!form) {
            return;
        }
        form.querySelectorAll('[data-customer-input]').forEach((input) => {
            const field = input.getAttribute('data-customer-input');
            if (field) {
                clearFieldError(field);
            }
        });
    };

    const applyFormErrors = (errors) => {
        if (!form || !errors) {
            return;
        }
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            setFieldError(field, message ?? '');
        });
    };

    const getFieldElements = (field) => {
        const input = form?.querySelector(`[data-customer-input="${field}"]`) ?? null;
        const errorEl = form?.querySelector(`[data-customer-error="${field}"]`) ?? null;
        const selectRoot = input instanceof HTMLInputElement ? input.closest('[data-select]') : null;
        const trigger = selectRoot?.querySelector('[data-select-trigger]') ?? null;
        const icon = form?.querySelector(`[data-customer-valid-icon="${field}"]`) ?? null;

        return { input, errorEl, selectRoot, trigger, icon };
    };

    const showValidIcon = (field, show) => {
        const { icon } = getFieldElements(field);
        if (!icon) {
            return;
        }
        icon.classList.toggle('opacity-0', !show);
    };

    const clearFieldError = (field) => {
        const { input, errorEl, selectRoot, trigger } = getFieldElements(field);
        if (errorEl) {
            errorEl.textContent = '';
        }
        if (input && input.type !== 'hidden') {
            input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        if (selectRoot) {
            selectRoot.dataset.selectInvalid = 'false';
            trigger?.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        showValidIcon(field, false);
    };

    const setFieldError = (field, message) => {
        const { input, errorEl, selectRoot, trigger } = getFieldElements(field);
        if (errorEl) {
            errorEl.textContent = message ?? '';
        }
        if (input && input.type !== 'hidden') {
            input.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        if (selectRoot) {
            selectRoot.dataset.selectInvalid = 'true';
            trigger?.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
        }
        showValidIcon(field, false);
    };

    const setFieldSuccess = (field) => {
        clearFieldError(field);
        showValidIcon(field, true);
    };

    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) {
            return;
        }
        if (isLoading) {
            submitLabel.textContent = 'Procesando...';
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };

    const setFieldValue = (field, value) => {
        if (!form) {
            return;
        }
        const input = form.querySelector(`[data-customer-input="${field}"]`);
        if (!input) {
            return;
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
        syncCustomSelectDisplay(input);
    };

    const getFieldValue = (field) => {
        if (!form) {
            return '';
        }
        const input = form.querySelector(`[data-customer-input="${field}"]`);
        if (!input) {
            return '';
        }
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };

    const syncCustomSelectDisplay = (input) => {
        if (!(input instanceof HTMLInputElement)) {
            return;
        }
        const selectRoot = input.closest('[data-select]');
        if (!selectRoot) {
            return;
        }
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const valueLabel = selectRoot.querySelector('[data-select-value]');
        const options = Array.from(selectRoot.querySelectorAll('[data-select-option]'));
        const placeholder = trigger?.dataset.selectPlaceholder ?? '';

        let label = placeholder;
        options.forEach((option) => {
            const isSelected = option.dataset.value === input.value && input.value !== '';
            option.dataset.selected = isSelected ? 'true' : 'false';
            if (isSelected) {
                label = option.dataset.label ?? option.textContent.trim();
            }
        });

        if (valueLabel) {
            valueLabel.textContent = input.value ? label : placeholder;
        }
        trigger?.classList.toggle('is-empty', !input.value);
    };

    const closeCustomerCategorySelect = () => {
        if (!categorySelectRoot || !categoryTrigger || !categoryDropdown) {
            return;
        }
        categoryDropdown.hidden = true;
        categoryDropdown.dataset.open = 'false';
        categorySelectRoot.dataset.open = 'false';
        categoryTrigger.setAttribute('aria-expanded', 'false');
        categoryIcon?.classList.remove('rotate-180');
    };

    const markCustomerCategorySelected = (value) => {
        if (!categoryOptionsContainer) {
            return;
        }
        categoryOptionsContainer.querySelectorAll('[data-select-option]').forEach((option) => {
            option.dataset.selected = option.dataset.value === value ? 'true' : 'false';
        });
    };

    const renderCustomerCategoryOptions = (items = []) => {
        if (!(categoryOptionsContainer instanceof HTMLElement) || !(categoryInput instanceof HTMLInputElement)) {
            return;
        }

        const options = Array.isArray(items) ? items : [];
        categoryOptionsContainer.innerHTML = '';

        if (options.length === 0) {
            const emptyState = document.createElement('p');
            emptyState.className = 'px-4 py-2 text-sm text-secondary';
            emptyState.textContent = tx('No hay categorías disponibles.');
            categoryOptionsContainer.appendChild(emptyState);
            categoryInput.value = '';
            syncCustomSelectDisplay(categoryInput);
            return;
        }

        options.forEach((item) => {
            const value = String(item?.id ?? '');
            const label = item?.name ?? '';
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            button.dataset.selectOption = '';
            button.dataset.value = value;
            button.dataset.label = label;
            button.dataset.selected = categoryInput.value === value ? 'true' : 'false';
            button.innerHTML = `<span class="truncate">${label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
            button.addEventListener('click', (event) => {
                event.preventDefault();
                setFieldValue('category_id', value);
                closeCustomerCategorySelect();
                categoryTrigger?.focus({ preventScroll: true });
            });
            categoryOptionsContainer.appendChild(button);
        });

        markCustomerCategorySelected(categoryInput.value);
        syncCustomSelectDisplay(categoryInput);
    };

    const loadCustomerCategoryOptions = async () => {
        if (!categoryOptionsUrl) {
            renderCustomerCategoryOptions(categoryOptions);
            return categoryOptions;
        }

        try {
            const url = `${categoryOptionsUrl}${categoryOptionsUrl.includes('?') ? '&' : '?'}per_page=200`;
            const response = await fetch(url, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json().catch(() => null);
            if (!response.ok || !json?.data?.items) {
                throw new Error('Invalid response');
            }
            categoryOptions = Array.isArray(json.data.items) ? json.data.items : [];
        } catch (error) {
            console.error('[Customers] Error loading categories options', error);
            showAlert({ title: tx('Error'), text: tx('No fue posible cargar las categorías.'), icon: 'error' });
        } finally {
            renderCustomerCategoryOptions(categoryOptions);
        }

        return categoryOptions;
    };

    const refreshTable = () => {
        if (!tableId) {
            console.warn('[Customers] refresh without tableId');
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        console.info('[Customers] refresh', { tableId });
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };

    const setFormMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        clearFormErrors();
        setSubmitLoading(false);

        form.dataset.mode = mode;
        form.dataset.customerId = data?.id ?? '';
        form.dataset.hasPortalPassword = data?.has_portal_password ? 'true' : 'false';

        setAccessToggleState('b2b_access', Boolean(data?.b2b_access));
        setAccessToggleState('b2c_access', Boolean(data?.b2c_access));

        if (portalPasswordInput instanceof HTMLInputElement) {
            portalPasswordInput.value = '';
        }
        setPortalPasswordVisibility(false);

        const assignCategoryValue = (value) => {
            if (!(categoryInput instanceof HTMLInputElement)) {
                return;
            }
            categoryInput.value = value ?? '';
            syncCustomSelectDisplay(categoryInput);
        };

        const initialiseCategorySelection = () => {
            if (mode === 'create') {
                if (categoryOptions.length > 0) {
                    assignCategoryValue(categoryOptions[0]?.id ?? '');
                } else {
                    assignCategoryValue('');
                }
            } else {
                assignCategoryValue(data?.category_id ?? '');
            }
        };

        const ensureCategories = () => {
            loadCustomerCategoryOptions()
                .then(() => {
                    initialiseCategorySelection();
                })
                .catch(() => {
                    initialiseCategorySelection();
                });
        };

        if (mode === 'create') {
            form.reset();
            const defaultType = presetCustomerType && ['individual', 'business'].includes(presetCustomerType)
                ? presetCustomerType
                : 'individual';
            setFieldValue('customer_type', defaultType);
            setFieldValue('document_type', defaultType === 'business' ? 'RUC' : 'CEDULA');
            setFieldValue('document_number', '');
            setFieldValue('first_name', '');
            setFieldValue('last_name', '');
            setFieldValue('business_name', '');
            setFieldValue('email', '');
            setFieldValue('phone_number', '');
            setFieldValue('address', '');
            setFieldValue('status', 'A');
            setFieldValue('category_id', '');
            setFieldValue('sex', '');
            setFieldValue('birth_date', '');
            if (modalTitle) {
                modalTitle.textContent = isBusinessModule ? tx('Nueva empresa') : tx('Nuevo cliente');
            }
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
        } else {
            setFieldValue('customer_type', data?.customer_type ?? 'individual');
            setFieldValue('document_type', data?.document_type ?? 'RUC');
            setFieldValue('document_number', data?.document_number ?? '');
            setFieldValue('first_name', data?.first_name ?? '');
            setFieldValue('last_name', data?.last_name ?? '');
            setFieldValue('business_name', data?.business_name ?? '');
            setFieldValue('email', data?.email ?? '');
            setFieldValue('phone_number', data?.phone_number ?? '');
            setFieldValue('address', data?.address ?? '');
            setFieldValue('status', data?.status ?? 'A');
            setFieldValue('category_id', data?.category_id ?? '');
            setFieldValue('sex', data?.sex ?? '');
            setFieldValue('birth_date', data?.birth_date ?? '');
            if (modalTitle) {
                modalTitle.textContent = isBusinessModule ? tx('Editar empresa') : tx('Editar cliente');
            }
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
        }

        ensureCategories();
        applyCustomerPresetType();

        ['customer_type', 'document_type'].forEach((field) => {
            const input = form.querySelector(`[data-customer-input="${field}"]`);
            if (input instanceof HTMLInputElement) {
                syncCustomSelectDisplay(input);
            }
        });
        if (sexInput instanceof HTMLInputElement) {
            syncCustomSelectDisplay(sexInput);
        }

        toggleFieldsVisibility();
    };

    const populateViewModal = (data) => {
        if (!viewContainer || !data) {
            return;
        }
        viewContainer.querySelectorAll('[data-customer-view-field]').forEach((element) => {
            const field = element.getAttribute('data-customer-view-field');
            if (!field) {
                return;
            }
            const value = data[field];
            let display = value !== null && value !== undefined && value !== '' ? String(value) : '-';

            if (field === 'category_name') {
                display = value ? String(value) : '-';
            }

            element.textContent = display;
        });
    };

    const getDocumentType = () => (getFieldValue('document_type') || '').toUpperCase();
    const getEffectiveCustomerType = () => {
        const documentType = getDocumentType();
        if (documentType === 'RUC') {
            return 'business';
        }
        return 'individual';
    };

    const toggleFieldsVisibility = () => {
        if (!form) {
            return;
        }
        const effectiveType = getEffectiveCustomerType();
        const documentType = getDocumentType();
        const showIndividual = effectiveType === 'individual';
        const showBusiness = effectiveType === 'business';

        form.querySelectorAll('[data-customer-section="individual"]').forEach((wrapper) => {
            const show = showIndividual;
            wrapper.classList.toggle('hidden', !show);
            wrapper.querySelectorAll('[data-customer-input]').forEach((inputEl) => {
                if (!(inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement || inputEl instanceof HTMLSelectElement)) {
                    return;
                }
                const field = inputEl.getAttribute('data-customer-input') ?? '';
                inputEl.disabled = !show;
                inputEl.required = show && ['first_name', 'last_name'].includes(field);
                if (!show) {
                    inputEl.value = '';
                    if (inputEl instanceof HTMLInputElement) {
                        syncCustomSelectDisplay(inputEl);
                    }
                    if (field) {
                        clearFieldError(field);
                    }
                }
            });
        });

        form.querySelectorAll('[data-customer-section="business"]').forEach((wrapper) => {
            const show = showBusiness;
            wrapper.classList.toggle('hidden', !show);
            wrapper.querySelectorAll('[data-customer-input]').forEach((inputEl) => {
                if (!(inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement || inputEl instanceof HTMLSelectElement)) {
                    return;
                }
                const field = inputEl.getAttribute('data-customer-input') ?? '';
                inputEl.disabled = !show;
                inputEl.required = show && field === 'business_name';
                if (!show) {
                    inputEl.value = '';
                    if (field) {
                        clearFieldError(field);
                    }
                }
            });
        });

        if (sexInput instanceof HTMLInputElement && documentType === 'RUC') {
            sexInput.value = '';
            syncCustomSelectDisplay(sexInput);
            clearFieldError('sex');
        }
        if (birthDateInput instanceof HTMLInputElement && documentType === 'RUC') {
            birthDateInput.value = '';
            clearFieldError('birth_date');
        }
    };

    const applyCustomerPresetType = () => {
        if (!(customerTypeInput instanceof HTMLInputElement)) {
            return;
        }
        if (!presetCustomerType || !['individual', 'business'].includes(presetCustomerType)) {
            customerTypeInput.disabled = false;
            customerTypeWrapper?.classList.remove('hidden');
            return;
        }
        customerTypeInput.value = presetCustomerType;
        syncCustomSelectDisplay(customerTypeInput);
        customerTypeInput.disabled = true;
        if (customerTypeWrapper) {
            customerTypeWrapper.classList.add('hidden');
        }
        toggleFieldsVisibility();
    };

    applyCustomerPresetType();
    renderCustomerCategoryOptions(categoryOptions);

    const sanitizeString = (value) => (typeof value === 'string' ? value : (value ?? '').toString());

    const sanitizeNameValue = (value = '') => sanitizeString(value)
        .replace(/[^A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();

    const sanitizeBusinessValue = (value = '') => sanitizeString(value).replace(/\s+/g, ' ').trim();

    const sanitizeEmailValue = (value = '') => sanitizeString(value).trim().toLowerCase();

    const sanitizePhoneValue = (value = '') => sanitizeString(value).replace(/\D+/g, '');

    const sanitizeDocumentValue = (value = '', type = 'RUC') => {
        const upper = sanitizeString(value).toUpperCase();

        if (type === 'CEDULA') {
            return upper.replace(/\D+/g, '').slice(0, 10);
        }

        if (type === 'RUC') {
            return upper.replace(/\D+/g, '').slice(0, 13);
        }

        return upper.replace(/[^A-Z0-9]/g, '').slice(0, 20);
    };

    const normalizeName = (value) => {
        const sanitized = sanitizeNameValue(value);
        return sanitized.length ? sanitized.toUpperCase() : null;
    };

    const normalizeBusinessName = (value) => {
        const sanitized = sanitizeBusinessValue(value);
        return sanitized.length ? sanitized.toUpperCase() : null;
    };

    const normalizeEmail = (value) => {
        const sanitized = sanitizeEmailValue(value ?? '');
        return sanitized.length ? sanitized : null;
    };

    const normalizePhone = (value) => {
        const sanitized = sanitizePhoneValue(value ?? '');
        return sanitized.length ? sanitized : null;
    };

    const normalizeDocumentNumber = (value, type = getFieldValue('document_type') || 'RUC') => {
        const sanitized = sanitizeDocumentValue(value ?? '', type);
        return sanitized.length ? sanitized : '';
    };

    const handleNameInput = (event) => {
        const normalized = sanitizeNameValue(event.target.value).toUpperCase();
        if (event.target.value !== normalized) {
            event.target.value = normalized;
        }
    };

    const handleBusinessInput = (event) => {
        const normalized = sanitizeBusinessValue(event.target.value).toUpperCase();
        if (event.target.value !== normalized) {
            event.target.value = normalized;
        }
    };

    const handlePhoneInput = (event) => {
        const sanitized = sanitizePhoneValue(event.target.value);
        if (event.target.value !== sanitized) {
            event.target.value = sanitized;
        }
    };

    const handleEmailInput = (event) => {
        const normalized = sanitizeEmailValue(event.target.value);
        if (event.target.value !== normalized) {
            event.target.value = normalized;
        }
    };

    const handleDocumentInput = () => {
        if (!documentInput) {
            return;
        }
        const docType = getFieldValue('document_type') || 'RUC';
        const sanitized = sanitizeDocumentValue(documentInput.value ?? '', docType);
        if (documentInput.value !== sanitized) {
            documentInput.value = sanitized;
        }
        clearFieldError('document_number');
        showValidIcon('document_number', false);
        lastDocumentResult = { value: null, available: null, message: '' };
    };

    const validateDocument = (type, value) => {
        if (!value) {
            return false;
        }
        if (type === 'CEDULA') {
            return /^\d{10}$/.test(value);
        }
        if (type === 'RUC') {
            return /^\d{13}$/.test(value);
        }
        if (type === 'PASAPORTE') {
            return /^[A-Z0-9]{5,20}$/.test(value);
        }
        return value.length > 0;
    };
    const validateField = (field) => {
        const customerType = getEffectiveCustomerType();
        const documentType = getDocumentType();
        const requiresPersonalDetails = documentType !== 'RUC';

        switch (field) {
            case 'customer_type': {
                const value = getFieldValue('customer_type');
                if (!value) {
                    setFieldError('customer_type', tx('Selecciona un tipo de cliente.'));
                    return false;
                }
                clearFieldError('customer_type');
                return true;
            }
            case 'category_id': {
                const value = getFieldValue('category_id');
                if (!value) {
                    setFieldError('category_id', tx('Selecciona una categoría.'));
                    return false;
                }
                clearFieldError('category_id');
                return true;
            }
            case 'first_name': {
                if (!requiresPersonalDetails) {
                    clearFieldError('first_name');
                    return true;
                }
                const value = getFieldValue('first_name');
                if (!value) {
                    setFieldError('first_name', tx('Ingresa los nombres del cliente.'));
                    return false;
                }
                if (!/^[A-ZÁÉÍÓÚÜÑ\s]+$/.test(value)) {
                    setFieldError('first_name', tx('Solo se permiten letras y espacios.'));
                    return false;
                }
                clearFieldError('first_name');
                return true;
            }
            case 'last_name': {
                if (!requiresPersonalDetails) {
                    clearFieldError('last_name');
                    return true;
                }
                const value = getFieldValue('last_name');
                if (!value) {
                    setFieldError('last_name', tx('Ingresa los apellidos del cliente.'));
                    return false;
                }
                if (!/^[A-ZÁÉÍÓÚÜÑ\s]+$/.test(value)) {
                    setFieldError('last_name', tx('Solo se permiten letras y espacios.'));
                    return false;
                }
                clearFieldError('last_name');
                return true;
            }
            case 'business_name': {
                if (documentType !== 'RUC') {
                    clearFieldError('business_name');
                    return true;
                }
                const value = getFieldValue('business_name');
                if (!value) {
                    setFieldError('business_name', tx('Ingresa la razón social.'));
                    return false;
                }
                clearFieldError('business_name');
                return true;
            }
            case 'email': {
                const value = getFieldValue('email');
                if (!value) {
                    clearFieldError('email');
                    showValidIcon('email', false);
                    return true;
                }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                    setFieldError('email', tx('Ingresa un correo electrónico válido.'));
                    return false;
                }
                clearFieldError('email');
                showValidIcon('email', false);
                return true;
            }
            case 'phone_number': {
                const value = getFieldValue('phone_number');
                if (!value) {
                    clearFieldError('phone_number');
                    return true;
                }
                if (!/^\d+$/.test(value)) {
                    setFieldError('phone_number', tx('Ingresa un número telefónico válido.'));
                    return false;
                }
                clearFieldError('phone_number');
                return true;
            }
            case 'sex': {
                if (!requiresPersonalDetails) {
                    clearFieldError('sex');
                    return true;
                }
                const value = getFieldValue('sex');
                if (!value) {
                    clearFieldError('sex');
                    return true;
                }
                if (!['MASCULINO', 'FEMENINO', 'OTRO'].includes(value)) {
                    setFieldError('sex', tx('Selecciona un sexo válido.'));
                    return false;
                }
                clearFieldError('sex');
                return true;
            }
            case 'birth_date': {
                if (!requiresPersonalDetails) {
                    clearFieldError('birth_date');
                    return true;
                }
                const value = getFieldValue('birth_date');
                if (!value) {
                    clearFieldError('birth_date');
                    return true;
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime()) || date > new Date()) {
                    setFieldError('birth_date', tx('Ingresa una fecha de nacimiento válida.'));
                    return false;
                }
                clearFieldError('birth_date');
                return true;
            }
            default:
                return true;
        }
    };
    const validateDocumentAsync = async () => {
        if (!documentInput || !validateDocumentUrl) {
            return;
        }

        const docType = getFieldValue('document_type') || 'RUC';
        const documentNumber = normalizeDocumentNumber(documentInput.value, docType);
        if (documentInput.value !== documentNumber) {
            documentInput.value = documentNumber;
        }

        if (!documentNumber) {
            clearFieldError('document_number');
            return;
        }

        if (lastDocumentResult.value === documentNumber && lastDocumentResult.available !== null) {
            if (lastDocumentResult.available) {
                setFieldSuccess('document_number');
            } else {
                setFieldError('document_number', lastDocumentResult.message || tx('El número de documento ya está registrado.'));
            }
            return;
        }

        if (validationControllers.document_number) {
            validationControllers.document_number.abort();
        }
        const controller = new AbortController();
        validationControllers.document_number = controller;

        try {
            console.info('[Customers] validate document', { docType, documentNumber });
            const response = await fetch(validateDocumentUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({
                    document_type: docType,
                    document_number: documentNumber,
                    customer_id: form?.dataset.customerId ?? null,
                }),
                signal: controller.signal,
            });

            const json = await response.json().catch(() => null);
            if (controller.signal.aborted) {
                return;
            }

            if (!response.ok || !json?.data) {
                console.error('[Customers] validate document failed', { response, json });
                throw new Error(json?.message ?? '');
            }

            const available = Boolean(json.data.available);
            lastDocumentResult = {
                value: documentNumber,
                available,
                message: json.message ?? '',
            };

            if (available) {
                setFieldSuccess('document_number');
            } else {
                setFieldError('document_number', json.message ?? tx('El número de documento ya está registrado.'));
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                return;
            }
            lastDocumentResult = {
                value: documentNumber,
                available: null,
                message: '',
            };
            setFieldError('document_number', tx('No fue posible validar el número de documento.'));
        } finally {
            if (!controller.signal.aborted) {
                validationControllers.document_number = null;
            }
        }
    };

    const validateEmailAsync = async () => {
        if (!emailInput || !validateEmailUrl) {
            return;
        }

        const emailValue = normalizeEmail(emailInput.value);
        if (emailInput.value !== (emailValue ?? '')) {
            emailInput.value = emailValue ?? '';
        }

        if (!emailValue) {
            clearFieldError('email');
            showValidIcon('email', false);
            return;
        }

        if (lastEmailResult.value === emailValue && lastEmailResult.available !== null) {
            if (lastEmailResult.available) {
                setFieldSuccess('email');
            } else {
                setFieldError('email', lastEmailResult.message || tx('El correo electrónico ya está registrado.'));
            }
            return;
        }

        if (validationControllers.email) {
            validationControllers.email.abort();
        }
        const controller = new AbortController();
        validationControllers.email = controller;

        try {
            console.info('[Customers] validate email', { emailValue });
            const response = await fetch(validateEmailUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({
                    email: emailValue,
                    customer_id: form?.dataset.customerId ?? null,
                }),
                signal: controller.signal,
            });

            const json = await response.json().catch(() => null);
            if (controller.signal.aborted) {
                return;
            }

            if (!response.ok || !json?.data) {
                console.error('[Customers] validate email failed', { response, json });
                throw new Error(json?.message ?? '');
            }

            const available = Boolean(json.data.available);
            lastEmailResult = {
                value: emailValue,
                available,
                message: json.message ?? '',
            };

            if (available) {
                setFieldSuccess('email');
            } else {
                setFieldError('email', json.message ?? tx('El correo electrónico ya está registrado.'));
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                return;
            }
            lastEmailResult = {
                value: emailValue,
                available: null,
                message: '',
            };
            setFieldError('email', tx('No fue posible validar el correo electrónico.'));
        } finally {
            if (!controller.signal.aborted) {
                validationControllers.email = null;
            }
        }
    };

    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) {
            return;
        }

        const mode = form.dataset.mode ?? 'create';
        const customerId = form.dataset.customerId ?? '';

        const payload = {
            category_id: getFieldValue('category_id') || null,
            customer_type: getFieldValue('customer_type') || 'individual',
            document_type: getFieldValue('document_type') || 'RUC',
            document_number: getFieldValue('document_number'),
            first_name: getFieldValue('first_name') || null,
            last_name: getFieldValue('last_name') || null,
            business_name: getFieldValue('business_name') || null,
            sex: getFieldValue('sex') || null,
            birth_date: getFieldValue('birth_date') || null,
            email: getFieldValue('email') || null,
            phone_number: getFieldValue('phone_number') || null,
            address: getFieldValue('address') || null,
            status: getFieldValue('status') || 'A',
            portal_password: getFieldValue('portal_password') || null,
            b2b_access: getAccessToggleValue('b2b_access') ? 1 : 0,
            b2c_access: getAccessToggleValue('b2c_access') ? 1 : 0,
        };

        const documentType = (payload.document_type || 'RUC').toUpperCase();
        payload.document_type = documentType;
        const effectiveType = documentType === 'RUC' ? 'business' : 'individual';
        payload.customer_type = effectiveType;

        payload.document_number = normalizeDocumentNumber(payload.document_number, payload.document_type);
        if (documentInput) {
            documentInput.value = payload.document_number ?? '';
        }

        payload.email = normalizeEmail(payload.email);
        if (emailInput) {
            emailInput.value = payload.email ?? '';
        }

        payload.phone_number = normalizePhone(payload.phone_number);
        if (phoneInput) {
            phoneInput.value = payload.phone_number ?? '';
        }

        payload.sex = effectiveType === 'individual' && payload.sex ? payload.sex.toString().toUpperCase() : null;
        if (sexInput instanceof HTMLInputElement) {
            sexInput.value = payload.sex ?? '';
            syncCustomSelectDisplay(sexInput);
        }

        payload.birth_date = effectiveType === 'individual' && payload.birth_date ? payload.birth_date : null;
        if (birthDateInput instanceof HTMLInputElement) {
            birthDateInput.value = payload.birth_date ?? '';
        }

        const debugPayload = { ...payload };
        if (Object.prototype.hasOwnProperty.call(debugPayload, 'portal_password')) {
            debugPayload.portal_password = debugPayload.portal_password ? '***' : debugPayload.portal_password;
        }
        console.info('[Customers] submit', { mode, customerId, payload: debugPayload });

        clearFormErrors();

        const validationErrors = {};
        const type = effectiveType;

        if (!payload.customer_type) {
            validationErrors.customer_type = tx('Selecciona un tipo de cliente.');
        }

        if (!payload.category_id) {
            validationErrors.category_id = tx('Selecciona una categoría.');
        }

        if (payload.sex && !['MASCULINO', 'FEMENINO', 'OTRO'].includes(payload.sex)) {
            validationErrors.sex = tx('Selecciona un sexo válido.');
        }

        const requiresPortalAccess = Boolean(payload.b2b_access) || Boolean(payload.b2c_access);
        const hasExistingPortal = form?.dataset.hasPortalPassword === 'true';

        if (requiresPortalAccess && !payload.email) {
            validationErrors.email = tx('Registra un correo electrónico para habilitar el acceso al portal.');
        }

        if (requiresPortalAccess) {
            if (mode === 'create' && !payload.portal_password) {
                validationErrors.portal_password = tx('Define una clave para el portal.');
            }
            if (mode === 'update' && !payload.portal_password && !hasExistingPortal) {
                validationErrors.portal_password = tx('Define una clave para el portal.');
            }
        }

        if (type === 'individual') {
            payload.first_name = normalizeName(payload.first_name);
            payload.last_name = normalizeName(payload.last_name);
            if (firstNameInput) {
                firstNameInput.value = payload.first_name ?? '';
            }
            if (lastNameInput) {
                lastNameInput.value = payload.last_name ?? '';
            }
            if (!payload.first_name) {
                validationErrors.first_name = tx('Ingresa los nombres del cliente.');
            }
            if (!payload.last_name) {
                validationErrors.last_name = tx('Ingresa los apellidos del cliente.');
            }
            payload.business_name = null;
        } else if (type === 'business') {
            payload.business_name = normalizeBusinessName(payload.business_name);
            if (businessNameInput) {
                businessNameInput.value = payload.business_name ?? '';
            }
            if (!payload.business_name) {
                validationErrors.business_name = tx('Ingresa la razón social.');
            }
            payload.first_name = null;
            payload.last_name = null;
        }

        if (!payload.document_number) {
            validationErrors.document_number = tx('Ingresa un número de documento válido.');
        } else if (!validateDocument(payload.document_type, payload.document_number)) {
            validationErrors.document_number = tx('Ingresa un número de documento válido.');
        }

        if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
            validationErrors.email = tx('Ingresa un correo electrónico válido.');
        }

        if (payload.phone_number && !/^\d+$/.test(payload.phone_number)) {
            validationErrors.phone_number = tx('Ingresa un número telefónico válido.');
        }

        if (payload.birth_date) {
            const birthDate = new Date(payload.birth_date);
            if (Number.isNaN(birthDate.getTime()) || birthDate > new Date()) {
                validationErrors.birth_date = tx('Ingresa una fecha de nacimiento válida.');
            }
        }

        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }

        if (!payload.portal_password) {
            delete payload.portal_password;
        }

        setSubmitLoading(true);

        const url = mode === 'create' ? storeUrl : `${baseUrl}/${customerId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';

        try {
            console.info('[Customers] submit request', { url, method });
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                console.error('[Customers] submit failed', { response, json });
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }

            console.info('[Customers] submit success');
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[Customers] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) {
            return;
        }
        const customerId = (deleteConfirmButton?.dataset.customerId ?? '').trim() || (deleteIdInput?.value ?? '').trim() || modals.delete.dataset.customerId || '';
        console.log('[Customers] handleDelete invoked', { customerId, datasetId: modals.delete?.dataset.customerId, inputValue: deleteIdInput?.value, buttonDataset: deleteConfirmButton?.dataset.customerId });
        if (!customerId) {
            console.warn('[Customers] handleDelete without customerId, aborting');
            closeModal(modals.delete);
            return;
        }

        deleteConfirmButton.disabled = true;
        console.log('[Customers] handleDelete request start');
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');

        try {
            console.info('[Customers] delete', { customerId });
            console.log('[Customers] delete request', `${baseUrl}/${customerId}`);
            const response = await fetch(`${baseUrl}/${customerId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                console.error('[Customers] delete failed', { response, json });
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }

            console.info('[Customers] delete success', { customerId });
            console.log('[Customers] delete response', json);
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[Customers] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    const handleStatusToggle = async (input) => {
        const customerId = input.dataset.id ?? '';
        if (!customerId || input.disabled) {
            return;
        }

        const previousChecked = !input.checked;
        const newStatus = input.checked ? 'A' : 'I';

        input.disabled = true;

        try {
            console.info('[Customers] toggle status', { customerId, newStatus });
            const response = await fetch(`${baseUrl}/${customerId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            });

            const json = await response.json().catch(() => null);

            if (!response.ok) {
                console.error('[Customers] toggle failed', { response, json });
                input.checked = previousChecked;
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                return;
            }

            console.info('[Customers] toggle success', { customerId, newStatus });
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
            refreshTable();
        } catch (error) {
            console.error('[Customers] Status toggle error', error);
            input.checked = previousChecked;
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
        } finally {
            input.disabled = false;
        }
    };

    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
        ['b2b_access', 'b2c_access'].forEach((field) => {
            const config = accessToggleConfig[field];
            config.button?.addEventListener('click', (event) => {
                event.preventDefault();
                toggleAccessField(field);
                clearFieldError(field);
            });
        });
        if (portalPasswordToggle instanceof HTMLElement) {
            portalPasswordToggle.addEventListener('click', (event) => {
                event.preventDefault();
                const isVisible = portalPasswordToggle.dataset.state === 'visible';
                setPortalPasswordVisibility(!isVisible);
            });
        }

        if (customerTypeInput instanceof HTMLInputElement) {
            customerTypeInput.addEventListener('change', () => {
                clearFieldError('customer_type');
                const selectedType = (customerTypeInput.value || '').toLowerCase();
                if (documentTypeInput instanceof HTMLInputElement) {
                    const currentDocType = getDocumentType();
                    if (selectedType === 'business' && currentDocType !== 'RUC') {
                        setFieldValue('document_type', 'RUC');
                        syncCustomSelectDisplay(documentTypeInput);
                        documentTypeInput.dispatchEvent(new Event('change', { bubbles: true }));
                    } else if (selectedType !== 'business' && currentDocType === 'RUC') {
                        setFieldValue('document_type', 'CEDULA');
                        syncCustomSelectDisplay(documentTypeInput);
                        documentTypeInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
                toggleFieldsVisibility();
                syncCustomSelectDisplay(customerTypeInput);
                validateField('customer_type');
                validateField('first_name');
                validateField('last_name');
                validateField('business_name');
            });
        }

        if (documentTypeInput instanceof HTMLInputElement) {
            documentTypeInput.addEventListener('change', () => {
                handleDocumentInput();
                syncCustomSelectDisplay(documentTypeInput);
                const docType = getDocumentType();
                if (customerTypeInput instanceof HTMLInputElement && !customerTypeInput.disabled) {
                    const nextType = docType === 'RUC' ? 'business' : 'individual';
                    if ((customerTypeInput.value || '').toLowerCase() !== nextType) {
                        setFieldValue('customer_type', nextType);
                        syncCustomSelectDisplay(customerTypeInput);
                    }
                }
                toggleFieldsVisibility();
                clearFieldError('customer_type');
                validateDocumentAsync();
                ['first_name', 'last_name', 'business_name', 'sex', 'birth_date'].forEach((field) => {
                    clearFieldError(field);
                    validateField(field);
                });
            });
        }

        if (documentInput instanceof HTMLInputElement) {
            documentInput.addEventListener('input', () => {
                handleDocumentInput();
            });
            documentInput.addEventListener('blur', () => {
                const value = normalizeDocumentNumber(documentInput.value);
                const docType = getFieldValue('document_type');
                if (!value) {
                    clearFieldError('document_number');
                    showValidIcon('document_number', false);
                    return;
                }
                documentInput.value = value;
                if (!validateDocument(docType, value)) {
                    setFieldError('document_number', tx('Ingresa un número de documento válido.'));
                    return;
                }
                validateDocumentAsync();
            });
        }

        if (categoryInput instanceof HTMLInputElement) {
            categoryInput.addEventListener('change', () => {
                clearFieldError('category_id');
                syncCustomSelectDisplay(categoryInput);
                validateField('category_id');
            });
        }

        if (sexInput instanceof HTMLInputElement) {
            sexInput.addEventListener('change', () => {
                const value = getFieldValue('sex');
                setFieldValue('sex', value ? value.toUpperCase() : '');
                clearFieldError('sex');
                validateField('sex');
            });
        }

        if (birthDateInput instanceof HTMLInputElement) {
            birthDateInput.addEventListener('change', () => {
                validateField('birth_date');
            });
        }

        if (portalPasswordInput instanceof HTMLInputElement) {
            portalPasswordInput.addEventListener('input', () => {
                clearFieldError('portal_password');
            });
        }

        if (emailInput instanceof HTMLInputElement) {
            emailInput.addEventListener('input', (event) => {
                handleEmailInput(event);
                clearFieldError('email');
                lastEmailResult = { value: null, available: null, message: '' };
            });
            emailInput.addEventListener('blur', () => {
                if (!validateField('email')) {
                    return;
                }
                validateEmailAsync();
            });
        }

        if (firstNameInput instanceof HTMLInputElement) {
            firstNameInput.addEventListener('input', (event) => {
                handleNameInput(event);
                clearFieldError('first_name');
            });
            firstNameInput.addEventListener('blur', () => {
                validateField('first_name');
            });
        }

        if (lastNameInput instanceof HTMLInputElement) {
            lastNameInput.addEventListener('input', (event) => {
                handleNameInput(event);
                clearFieldError('last_name');
            });
            lastNameInput.addEventListener('blur', () => {
                validateField('last_name');
            });
        }

        if (businessNameInput instanceof HTMLInputElement) {
            businessNameInput.addEventListener('input', (event) => {
                handleBusinessInput(event);
                clearFieldError('business_name');
            });
            businessNameInput.addEventListener('blur', () => {
                validateField('business_name');
            });
        }

        if (phoneInput instanceof HTMLInputElement) {
            phoneInput.addEventListener('input', (event) => {
                handlePhoneInput(event);
                clearFieldError('phone_number');
            });
            phoneInput.addEventListener('blur', () => {
                validateField('phone_number');
            });
        }

        toggleFieldsVisibility();
    }

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }
    root.addEventListener('click', (event) => {
        const actionEl = event.target instanceof Element
            ? event.target.closest('[data-customer-action], [data-row-action], [data-action]')
            : null;
        if (!actionEl) {
            return;
        }

        if (actionEl.hasAttribute('data-customer-action')) {
            const action = actionEl.dataset.customerAction;
            if (action === 'create') {
                setFormMode('create');
                openModal(modals.form);
            }
            return;
        }

        // Handle both data-action (new format) and data-row-action (old format)
        const rowAction = actionEl.dataset.action || actionEl.dataset.action || actionEl.dataset.rowAction;
        const payload = actionEl.dataset.rowPayload;
        const rowId = actionEl.dataset.id || actionEl.dataset.id || actionEl.dataset.rowId;
        const rowName = actionEl.dataset.name || actionEl.dataset.name || actionEl.dataset.rowName;
        
        let data = payload ? decodePayload(payload) : null;
        if (!data && rowId) {
            // Fetch customer data if we only have ID
            data = {
                id: rowId,
                display_name: rowName ?? null,
                name: rowName ?? null,
            };
        }
        
        if (!rowAction || !data?.id) {
            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
            return;
        }

        if (rowAction === 'view') {
            // Fetch full customer data for view
            fetch(`${baseUrl}/${data.id}`, {
                headers: {
                    Accept: 'application/json',
                },
            })
                .then(response => response.json())
                .then(responseData => {
                    const customerData = responseData?.data?.item ?? responseData?.data ?? responseData;
                    populateViewModal(customerData);
                    openModal(modals.view);
                })
                .catch(error => {
                    console.error('[Customers] Error fetching customer data', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudo cargar la información del cliente.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'edit') {
            // Fetch full customer data for edit
            fetch(`${baseUrl}/${data.id}`, {
                headers: {
                    Accept: 'application/json',
                },
            })
                .then(response => response.json())
                .then(responseData => {
                    const customerData = responseData?.data?.item ?? responseData?.data ?? responseData;
                    setFormMode('edit', customerData);
                    openModal(modals.form);
                })
                .catch(error => {
                    console.error('[Customers] Error fetching customer data', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudo cargar la información del cliente.'), icon: 'error' });
                });
            return;
        }

        if (rowAction === 'delete') {
            const idValue = data.id ?? '';
            const nameValue = data.display_name ?? data.name ?? rowName ?? '';
            console.log('[Customers] open delete modal', { idValue, nameValue, data });
            if (modals.delete) {
                modals.delete.dataset.customerId = idValue;
            }
            if (deleteIdInput) {
                deleteIdInput.value = idValue;
            }
            if (deleteConfirmButton) {
                deleteConfirmButton.dataset.customerId = idValue;
            }
            if (deleteName) {
                deleteName.textContent = nameValue;
            }
            openModal(modals.delete);
        }
    });

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            handleStatusToggle(target);
        }
    });
};

const initWorkshopOrdersModule = () => {
    const root = document.querySelector('[data-workshop-orders-root]');
    if (!root) return;
    const tableId = root.dataset.workshopOrdersTableId ?? '';
    const baseUrl = root.dataset.workshopOrdersBaseUrl ?? '';
    const storeUrl = root.dataset.workshopOrdersStoreUrl ?? baseUrl;
    const optionsUrl = root.dataset.workshopOrdersOptionsUrl ?? '';
    const customersUrl = root.dataset.workshopOrdersCustomersUrl ?? '';
    const equipmentsUrl = root.dataset.workshopOrdersEquipmentsUrl ?? '';
    const responsiblesUrl = root.dataset.workshopOrdersResponsiblesUrl ?? '';
    const accessoriesUrl = root.dataset.workshopOrdersAccessoriesUrl ?? '';
    const accessoriesCreateUrl = root.dataset.workshopOrdersAccessoriesCreateUrl ?? '';
    const categoriesUrl = root.dataset.workshopOrdersCategoriesUrl ?? '';
    const statesUrl = root.dataset.workshopOrdersStatesUrl ?? '';
    const customerCreateUrl = root.dataset.workshopOrdersCustomerCreateUrl ?? '';
    const equipmentCreateUrl = root.dataset.workshopOrdersEquipmentCreateUrl ?? '';
    const responsibleCreateUrl = root.dataset.workshopOrdersResponsibleCreateUrl ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const modals = {
        form: root.querySelector('[data-workshop-order-modal="form"]'),
        view: root.querySelector('[data-workshop-order-modal="view"]'),
        delete: root.querySelector('[data-workshop-order-modal="delete"]'),
        accessoryCreate: root.querySelector('[data-workshop-order-modal="accessory-create"]'),
    };
    const form = modals.form?.querySelector('[data-workshop-order-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-order-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-order-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-order-modal-title]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-order-delete-summary]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-order-delete-confirm]') ?? null;
    const bodyOverflowClass = 'overflow-hidden';
    const getEventTargetModal = (target) => target.closest('[data-workshop-order-modal]');
    const openModal = (modal) => {
        if (!modal) return;
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };
    const closeModal = (modal) => {
        if (!modal) return;
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-order-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };
    root.querySelectorAll('[data-workshop-order-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });
    Object.values(modals).forEach((modal) => {
        if (!modal) return;
        modal.addEventListener('click', (event) => {
            if (event.target === modal) closeModal(modal);
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeModal(modal);
        });
    });
    const clearFormErrors = () => {
        if (!form) return;
        form.querySelectorAll('[data-workshop-order-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-order-input]').forEach((input) => {
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };
    const applyFormErrors = (errors) => {
        if (!form || !errors) return;
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-order-error="${field}"]`);
            if (errorEl) errorEl.textContent = message ?? '';
            const inputEl = form.querySelector(`[data-workshop-order-input="${field}"]`);
            if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement || inputEl instanceof HTMLSelectElement) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };
    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) return;
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };
    const getFieldValue = (field) => {
        if (!form) return '';
        const input = form.querySelector(`[data-workshop-order-input="${field}"]`);
        if (!input) return '';
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };
    const setFieldValue = (field, value) => {
        if (!form) return;
        const input = form.querySelector(`[data-workshop-order-input="${field}"]`);
        if (!input) return;
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };
    
    let currentFilters = {};
    
    const refreshTable = (filters = null) => {
        // Si se pasan filtros, actualizar los filtros actuales
        if (filters !== null && typeof filters === 'object') {
            currentFilters = { ...filters };
        }
        // Si filters es null, limpiar los filtros
        if (filters === null) {
            currentFilters = {};
        }
        
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { filters: currentFilters } }));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId, filters: currentFilters } }));
    };
    const populateViewModal = (data) => {
        if (!modals.view || !data) return;
        modals.view.querySelectorAll('[data-workshop-order-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-order-view-field');
            if (!field) return;
            const value = data[field];
            if (field === 'accessories' && Array.isArray(value)) {
                element.innerHTML = value.length > 0
                    ? value.map((acc) => `<span class="inline-flex items-center rounded-full bg-primary-soft/30 px-3 py-1.5 text-xs font-semibold text-primary dark:bg-primary/15 dark:text-primary-100">${acc.name ?? ''}</span>`).join(' ')
                    : '<span>-</span>';
            } else {
                element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
            }
        });
    };
    const selectedAccessories = new Set();
    const setMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) return;
        clearFormErrors();
        setSubmitLoading(false);
        form.dataset.mode = mode;
        form.dataset.workshopOrderId = data?.id ?? '';
        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            setFieldValue('priority', 'Normal');
            setFieldValue('diagnosis', '0');
            setFieldValue('warranty', '0');
            setFieldValue('budget_currency', 'USD');
            setFieldValue('advance_currency', 'USD');
            if (modalTitle) modalTitle.textContent = tx('Nueva orden de trabajo');
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
            selectedAccessories.clear();
            const accessoriesSelected = form?.querySelector('[data-workshop-order-accessories-selected]');
            if (accessoriesSelected) accessoriesSelected.innerHTML = '';
            const customerSearch = form?.querySelector('[data-workshop-order-customer-search]');
            const equipmentSearch = form?.querySelector('[data-workshop-order-equipment-search]');
            const responsibleSearch = form?.querySelector('[data-workshop-order-responsible-search]');
            if (customerSearch instanceof HTMLInputElement) {
                customerSearch.value = '';
                customerSearch.readOnly = false;
            }
            if (equipmentSearch instanceof HTMLInputElement) {
                equipmentSearch.value = '';
                equipmentSearch.readOnly = false;
            }
            if (responsibleSearch instanceof HTMLInputElement) {
                responsibleSearch.value = '';
                responsibleSearch.readOnly = false;
            }
            setFieldValue('customer_id', '');
            setFieldValue('equipment_id', '');
            setFieldValue('responsible_user_id', '');
            const categorySelect = form?.querySelector('[data-select-name="category_id"]');
            if (categorySelect) {
                const hiddenInput = categorySelect.querySelector('[data-workshop-order-input="category_id"]');
                const trigger = categorySelect.querySelector('[data-select-trigger]');
                const valueLabel = categorySelect.querySelector('[data-select-value]');
                if (hiddenInput) hiddenInput.value = '';
                if (valueLabel && trigger) valueLabel.textContent = trigger.dataset.selectPlaceholder ?? tx('Selecciona una categoría');
            }
            const stateSelect = form?.querySelector('[data-select-name="state_id"]');
            if (stateSelect) {
                const hiddenInput = stateSelect.querySelector('[data-workshop-order-input="state_id"]');
                const trigger = stateSelect.querySelector('[data-select-trigger]');
                const valueLabel = stateSelect.querySelector('[data-select-value]');
                const optionsContainer = stateSelect.querySelector('[data-workshop-order-state-options]');
                if (hiddenInput) hiddenInput.value = '';
                if (valueLabel && trigger) valueLabel.textContent = trigger.dataset.selectPlaceholder ?? tx('Selecciona un estado');
                if (optionsContainer) optionsContainer.innerHTML = '';
            }
        } else {
            if (modalTitle) modalTitle.textContent = tx('Editar orden de trabajo');
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
            if (data) {
                populateForm(data);
            }
        }
    };
    const populateForm = async (data) => {
        if (!data || !form) return;
        setFieldValue('customer_id', data.customer_id ?? '');
        setFieldValue('equipment_id', data.equipment_id ?? '');
        setFieldValue('responsible_user_id', data.responsible_user_id ?? '');
        setFieldValue('category_id', data.category_id ?? '');
        setFieldValue('state_id', data.state_id ?? '');
        setFieldValue('priority', data.priority ?? 'Normal');
        setFieldValue('work_summary', data.work_summary ?? '');
        setFieldValue('work_description', data.work_description ?? '');
        setFieldValue('general_condition', data.general_condition ?? '');
        setFieldValue('diagnosis', data.diagnosis ? '1' : '0');
        setFieldValue('warranty', data.warranty ? '1' : '0');
        setFieldValue('equipment_password', data.equipment_password ?? '');
        setFieldValue('budget_currency', data.budget_currency ?? 'USD');
        setFieldValue('budget_amount', data.budget_amount ?? '');
        setFieldValue('advance_currency', data.advance_currency ?? 'USD');
        setFieldValue('advance_amount', data.advance_amount ?? '');
        if (data.promised_at) {
            const promisedAt = new Date(data.promised_at);
            const localDateTime = promisedAt.toISOString().slice(0, 16);
            setFieldValue('promised_at', localDateTime);
        } else {
            setFieldValue('promised_at', '');
        }
        const customerSearch = form?.querySelector('[data-workshop-order-customer-search]');
        const equipmentSearch = form?.querySelector('[data-workshop-order-equipment-search]');
        const responsibleSearch = form?.querySelector('[data-workshop-order-responsible-search]');
        if (customerSearch instanceof HTMLInputElement && data.customer_name) {
            customerSearch.value = data.customer_name;
            customerSearch.readOnly = true;
        }
        if (equipmentSearch instanceof HTMLInputElement && data.equipment_label) {
            equipmentSearch.value = data.equipment_label;
            equipmentSearch.readOnly = true;
        }
        if (responsibleSearch instanceof HTMLInputElement && data.responsible_name) {
            responsibleSearch.value = data.responsible_name;
            responsibleSearch.readOnly = true;
        }
        // Esperar a que las opciones estén cargadas antes de establecer valores
        await loadOptions();
        setTimeout(() => {
            initManualSelects();
            if (data.category_id) {
                const categoryName = data.category_name || '';
                setCustomSelectValue('category_id', data.category_id, categoryName);
                loadStates(data.category_id, data.state_id).then(() => {
                    if (data.state_id) {
                        const stateName = data.state_name || '';
                        setCustomSelectValue('state_id', data.state_id, stateName);
                    }
                });
            }
            if (data.priority) {
                const priorityLabel = data.priorities?.find((p) => p.value === data.priority)?.label || data.priority;
                setCustomSelectValue('priority', data.priority, priorityLabel);
            }
            if (data.diagnosis !== undefined) {
                setCustomSelectValue('diagnosis', data.diagnosis ? '1' : '0', data.diagnosis ? tx('Sí') : tx('No'));
            }
            if (data.warranty !== undefined) {
                setCustomSelectValue('warranty', data.warranty ? '1' : '0', data.warranty ? tx('Sí') : tx('No'));
            }
        }, 200);
        if (Array.isArray(data.accessories)) populateAccessories(data.accessories);
    };
    const populateAccessories = (accessories) => {
        const container = form?.querySelector('[data-workshop-order-accessories-selected]');
        if (!container || !Array.isArray(accessories)) return;
        container.innerHTML = '';
        selectedAccessories.clear();
        accessories.forEach((accessory) => {
            if (!accessory?.id || !accessory?.name) return;
            selectedAccessories.add(accessory.id);
            const badge = document.createElement('span');
            badge.className = 'inline-flex items-center gap-2 rounded-full bg-primary-soft/30 px-3 py-1.5 text-xs font-semibold text-primary dark:bg-primary/15 dark:text-primary-100';
            badge.dataset.accessoryId = accessory.id;
            badge.innerHTML = `
                <span>${accessory.name || ''}</span>
                <button type="button" class="hover:text-primary-strong" data-accessory-remove="${accessory.id}" aria-label="${tx('Remover accesorio')}">
                    <i class="fa-solid fa-xmark text-[10px]"></i>
                </button>
            `;
            const removeBtn = badge.querySelector(`[data-accessory-remove="${accessory.id}"]`);
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    selectedAccessories.delete(accessory.id);
                    badge.remove();
                });
            }
            container.appendChild(badge);
        });
    };
    const initManualSelects = () => {
        if (!form) return;
        const manualSelects = form.querySelectorAll('[data-select][data-select-manual="true"]');
        manualSelects.forEach((select) => {
            const trigger = select.querySelector('[data-select-trigger]');
            const dropdown = select.querySelector('[data-select-dropdown]');
            const icon = select.querySelector('[data-select-icon]');
            if (!trigger || !dropdown) return;

            const closeSelect = () => {
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
                select.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                icon?.classList.remove('rotate-180');
            };

            const openSelect = () => {
                // Cerrar todos los demás selects manuales
                manualSelects.forEach((otherSelect) => {
                    if (otherSelect !== select && otherSelect.dataset.open === 'true') {
                        const otherDropdown = otherSelect.querySelector('[data-select-dropdown]');
                        const otherTrigger = otherSelect.querySelector('[data-select-trigger]');
                        const otherIcon = otherSelect.querySelector('[data-select-icon]');
                        if (otherDropdown) {
                            otherDropdown.hidden = true;
                            otherDropdown.dataset.open = 'false';
                            otherSelect.dataset.open = 'false';
                            if (otherTrigger) otherTrigger.setAttribute('aria-expanded', 'false');
                            if (otherIcon) otherIcon.classList.remove('rotate-180');
                        }
                    }
                });

                dropdown.hidden = false;
                dropdown.dataset.open = 'true';
                select.dataset.open = 'true';
                trigger.setAttribute('aria-expanded', 'true');
                icon?.classList.add('rotate-180');
                requestAnimationFrame(() => {
                    dropdown.style.minWidth = `${trigger.getBoundingClientRect().width}px`;
                });
            };

            // Si el trigger ya tiene un listener, removerlo primero
            const newTrigger = trigger.cloneNode(true);
            trigger.parentNode.replaceChild(newTrigger, trigger);

            newTrigger.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                const isOpen = select.dataset.open === 'true';
                if (isOpen) {
                    closeSelect();
                } else {
                    openSelect();
                }
            });

            // Manejar clicks en las opciones
            dropdown.addEventListener('click', (event) => {
                const option = event.target.closest('[data-select-option]');
                if (!option) return;
                event.preventDefault();
                event.stopPropagation();
                const value = option.dataset.value ?? '';
                const label = option.dataset.label ?? option.textContent.trim();
                const hiddenInput = select.querySelector('input[type="hidden"]');
                const valueLabel = select.querySelector('[data-select-value]');
                if (hiddenInput) hiddenInput.value = value;
                if (valueLabel) valueLabel.textContent = label || select.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || '';
                
                // Marcar como seleccionado
                dropdown.querySelectorAll('[data-select-option]').forEach((opt) => {
                    opt.dataset.selected = opt.dataset.value === value ? 'true' : 'false';
                });

                closeSelect();
                if (hiddenInput) {
                    hiddenInput.dispatchEvent(new CustomEvent('change', { bubbles: true, detail: { value, label } }));
                    
                    // Si es el select de categoría, cargar los estados dependientes
                    if (hiddenInput.name === 'category_id' || hiddenInput.getAttribute('data-workshop-order-input') === 'category_id') {
                        const categoryId = value;
                        if (categoryId) {
                            // Limpiar el select de estado
                            const stateSelect = form?.querySelector('[data-select-name="state_id"]');
                            if (stateSelect) {
                                const stateHiddenInput = stateSelect.querySelector('[data-workshop-order-input="state_id"]');
                                const stateValueLabel = stateSelect.querySelector('[data-select-value]');
                                const stateTrigger = stateSelect.querySelector('[data-select-trigger]');
                                const stateOptionsContainer = stateSelect.querySelector('[data-workshop-order-state-options]');
                                if (stateHiddenInput) stateHiddenInput.value = '';
                                if (stateValueLabel && stateTrigger) {
                                    stateValueLabel.textContent = stateTrigger.dataset.selectPlaceholder ?? tx('Selecciona un estado');
                                }
                                if (stateOptionsContainer) stateOptionsContainer.innerHTML = '';
                            }
                            // Cargar los estados de la categoría seleccionada
                            loadStates(categoryId);
                        } else {
                            // Si no hay categoría, limpiar estados
                            const stateSelect = form?.querySelector('[data-select-name="state_id"]');
                            if (stateSelect) {
                                const stateOptionsContainer = stateSelect.querySelector('[data-workshop-order-state-options]');
                                if (stateOptionsContainer) stateOptionsContainer.innerHTML = '';
                            }
                        }
                    }
                }
            });

            // Cerrar al presionar Escape
            select.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeSelect();
                    newTrigger.focus({ preventScroll: true });
                }
            });
        });

    };
    const loadOptions = async () => {
        if (!optionsUrl) return;
        try {
            const response = await fetch(optionsUrl, { headers: { Accept: 'application/json' } });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data) {
                populateSelectOptions(json.data);
                // Inicializar selects manuales después de poblar las opciones
                setTimeout(() => initManualSelects(), 100);
            }
        } catch (error) {
            console.error('[WorkshopOrders] options load error', error);
        }
    };
    const setCustomSelectValue = (selectName, value, label) => {
        if (!form) return;
        const selectContainer = form.querySelector(`[data-select-name="${selectName}"]`);
        if (!selectContainer) return;
        const hiddenInput = selectContainer.querySelector(`[data-workshop-order-input="${selectName}"]`);
        const valueLabel = selectContainer.querySelector('[data-select-value]');
        const options = selectContainer.querySelectorAll('[data-select-option]');
        if (hiddenInput) hiddenInput.value = value || '';
        if (valueLabel) valueLabel.textContent = label || selectContainer.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || '';
        options.forEach((option) => {
            option.dataset.selected = option.dataset.value === value ? 'true' : 'false';
        });
    };
    const populateSelectOptions = (data) => {
        if (!data || !form) return;
        const prioritySelect = form.querySelector('[data-select-name="priority"]');
        if (prioritySelect && data.priorities) {
            const optionsContainer = prioritySelect.querySelector('[data-workshop-order-priority-options]');
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                data.priorities.forEach((opt) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-800 transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    button.setAttribute('data-select-option', '');
                    button.setAttribute('data-value', opt.value);
                    button.setAttribute('data-label', opt.label);
                    button.setAttribute('role', 'option');
                    button.setAttribute('data-selected', 'false');
                    button.innerHTML = `<span class="truncate">${opt.label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    optionsContainer.appendChild(button);
                });
            }
        }
        const diagnosisSelect = form.querySelector('[data-select-name="diagnosis"]');
        if (diagnosisSelect) {
            const optionsContainer = diagnosisSelect.querySelector('[data-workshop-order-diagnosis-options]');
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                [
                    { value: '0', label: tx('No') },
                    { value: '1', label: tx('Sí') },
                ].forEach((opt) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-800 transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    button.setAttribute('data-select-option', '');
                    button.setAttribute('data-value', opt.value);
                    button.setAttribute('data-label', opt.label);
                    button.setAttribute('role', 'option');
                    button.setAttribute('data-selected', 'false');
                    button.innerHTML = `<span class="truncate">${opt.label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    optionsContainer.appendChild(button);
                });
            }
        }
        const warrantySelect = form.querySelector('[data-select-name="warranty"]');
        if (warrantySelect) {
            const optionsContainer = warrantySelect.querySelector('[data-workshop-order-warranty-options]');
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                [
                    { value: '0', label: tx('No') },
                    { value: '1', label: tx('Sí') },
                ].forEach((opt) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-800 transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    button.setAttribute('data-select-option', '');
                    button.setAttribute('data-value', opt.value);
                    button.setAttribute('data-label', opt.label);
                    button.setAttribute('role', 'option');
                    button.setAttribute('data-selected', 'false');
                    button.innerHTML = `<span class="truncate">${opt.label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    optionsContainer.appendChild(button);
                });
            }
        }
        const loadCategories = async () => {
            if (!categoriesUrl) return;
            try {
                const response = await fetch(categoriesUrl, { headers: { Accept: 'application/json' } });
                const json = await response.json().catch(() => null);
                if (response.ok && json?.data?.items) {
                    const categorySelect = form?.querySelector('[data-select-name="category_id"]');
                    if (categorySelect) {
                        const optionsContainer = categorySelect.querySelector('[data-workshop-order-category-options]');
                        if (optionsContainer) {
                            optionsContainer.innerHTML = '';
                            json.data.items.forEach((cat) => {
                                const button = document.createElement('button');
                                button.type = 'button';
                                button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-800 transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                                button.setAttribute('data-select-option', '');
                                button.setAttribute('data-value', cat.id);
                                button.setAttribute('data-label', cat.name);
                                button.setAttribute('role', 'option');
                                button.setAttribute('data-selected', 'false');
                                button.innerHTML = `<span class="truncate">${cat.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                                optionsContainer.appendChild(button);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrders] categories load error', error);
            }
        };
        loadCategories();
    };
    const loadStates = async (categoryId, selectedStateId = null) => {
        if (!statesUrl || !categoryId) return;
        const stateSelect = form?.querySelector('[data-select-name="state_id"]');
        if (!stateSelect) return;
        try {
            const url = new URL(statesUrl, window.location.origin);
            url.searchParams.set('category_id', categoryId);
            const response = await fetch(url.toString(), { headers: { Accept: 'application/json' } });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data?.items) {
                const optionsContainer = stateSelect.querySelector('[data-workshop-order-state-options]');
                if (optionsContainer) {
                    optionsContainer.innerHTML = '';
                    json.data.items.forEach((state) => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-800 transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                        button.setAttribute('data-select-option', '');
                        button.setAttribute('data-value', state.id);
                        button.setAttribute('data-label', state.name);
                        button.setAttribute('role', 'option');
                        button.setAttribute('data-selected', selectedStateId && state.id === selectedStateId ? 'true' : 'false');
                        button.innerHTML = `<span class="truncate">${state.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                        optionsContainer.appendChild(button);
                    });
                    if (selectedStateId) {
                        setCustomSelectValue('state_id', selectedStateId, json.data.items.find((s) => s.id === selectedStateId)?.name || '');
                    }
                }
            }
        } catch (error) {
            console.error('[WorkshopOrders] states load error', error);
        }
    };
    const searchItems = async (type, query, url) => {
        if (!url || !query || query.length < 2) return [];
        try {
            const searchUrl = new URL(url, window.location.origin);
            searchUrl.searchParams.set('search', query);
            searchUrl.searchParams.set('per_page', '10');
            const response = await fetch(searchUrl.toString(), { headers: { Accept: 'application/json' } });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data?.items) return json.data.items;
            return [];
        } catch (error) {
            console.error(`[WorkshopOrders] ${type} search error`, error);
            return [];
        }
    };
    const renderSearchResults = (container, items, type, onSelect) => {
        if (!container) return;
        container.innerHTML = '';
        if (!items || items.length === 0) {
            const empty = document.createElement('p');
            empty.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400';
            empty.textContent = tx('No se encontraron resultados');
            container.appendChild(empty);
            container.hidden = false;
            container.dataset.open = 'true';
            return;
        }
        const list = document.createElement('div');
        list.className = 'max-h-60 overflow-y-auto py-2';
        items.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'flex w-full items-center justify-between px-4 py-2.5 text-left text-sm text-gray-700 transition hover:bg-primary-soft/20 dark:text-white dark:hover:bg-primary/20';
            const displayText = item.name || item.label || item.display_name || '';
            const subText = item.document_number || item.identifier || item.email || '';
            button.innerHTML = `
                <div class="flex-1">
                    <div class="font-medium">${displayText}</div>
                    ${subText ? `<div class="text-xs text-gray-500 dark:text-gray-400">${subText}</div>` : ''}
                </div>
            `;
            button.addEventListener('click', () => {
                if (onSelect) onSelect(item);
                container.hidden = true;
                container.dataset.open = 'false';
            });
            list.appendChild(button);
        });
        container.appendChild(list);
        container.hidden = false;
        container.dataset.open = 'true';
    };
    let customerSearchTimeout;
    const customerSearchInput = form?.querySelector('[data-workshop-order-customer-search]');
    const customerResults = form?.querySelector('[data-workshop-order-customer-results]');
    const customerCreateBtn = form?.querySelector('[data-workshop-order-customer-create]');
    if (customerSearchInput instanceof HTMLInputElement) {
        customerSearchInput.addEventListener('input', () => {
            clearTimeout(customerSearchTimeout);
            const query = customerSearchInput.value.trim();
            if (query.length < 2) {
                if (customerResults) {
                    customerResults.hidden = true;
                    customerResults.dataset.open = 'false';
                }
                return;
            }
            customerSearchTimeout = setTimeout(async () => {
                const items = await searchItems('customer', query, customersUrl);
                renderSearchResults(customerResults, items, 'customer', (item) => {
                    setFieldValue('customer_id', item.id);
                    const customerSearch = form?.querySelector('[data-workshop-order-customer-search]');
                    if (customerSearch instanceof HTMLInputElement) {
                        customerSearch.value = item.name || item.display_name || '';
                        customerSearch.readOnly = true;
                    }
                });
            }, 300);
        });
        customerSearchInput.addEventListener('focus', () => {
            if (customerSearchInput.value.trim().length >= 2 && !customerSearchInput.readOnly) {
                customerSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
    if (customerCreateBtn) {
        customerCreateBtn.addEventListener('click', () => {
            if (customerCreateUrl) window.open(customerCreateUrl, '_blank');
        });
    }
    let equipmentSearchTimeout;
    const equipmentSearchInput = form?.querySelector('[data-workshop-order-equipment-search]');
    const equipmentResults = form?.querySelector('[data-workshop-order-equipment-results]');
    const equipmentCreateBtn = form?.querySelector('[data-workshop-order-equipment-create]');
    if (equipmentSearchInput instanceof HTMLInputElement) {
        equipmentSearchInput.addEventListener('input', () => {
            clearTimeout(equipmentSearchTimeout);
            const query = equipmentSearchInput.value.trim();
            if (query.length < 2) {
                if (equipmentResults) {
                    equipmentResults.hidden = true;
                    equipmentResults.dataset.open = 'false';
                }
                return;
            }
            equipmentSearchTimeout = setTimeout(async () => {
                const items = await searchItems('equipment', query, equipmentsUrl);
                renderSearchResults(equipmentResults, items, 'equipment', (item) => {
                    setFieldValue('equipment_id', item.id);
                    const equipmentSearch = form?.querySelector('[data-workshop-order-equipment-search]');
                    if (equipmentSearch instanceof HTMLInputElement) {
                        equipmentSearch.value = item.label || item.identifier || '';
                        equipmentSearch.readOnly = true;
                    }
                });
            }, 300);
        });
        equipmentSearchInput.addEventListener('focus', () => {
            if (equipmentSearchInput.value.trim().length >= 2 && !equipmentSearchInput.readOnly) {
                equipmentSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
    if (equipmentCreateBtn) {
        equipmentCreateBtn.addEventListener('click', () => {
            if (equipmentCreateUrl) window.open(equipmentCreateUrl, '_blank');
        });
    }
    let responsibleSearchTimeout;
    const responsibleSearchInput = form?.querySelector('[data-workshop-order-responsible-search]');
    const responsibleResults = form?.querySelector('[data-workshop-order-responsible-results]');
    const responsibleCreateBtn = form?.querySelector('[data-workshop-order-responsible-create]');
    if (responsibleSearchInput instanceof HTMLInputElement) {
        responsibleSearchInput.addEventListener('input', () => {
            clearTimeout(responsibleSearchTimeout);
            const query = responsibleSearchInput.value.trim();
            if (query.length < 2) {
                if (responsibleResults) {
                    responsibleResults.hidden = true;
                    responsibleResults.dataset.open = 'false';
                }
                return;
            }
            responsibleSearchTimeout = setTimeout(async () => {
                const items = await searchItems('responsible', query, responsiblesUrl);
                renderSearchResults(responsibleResults, items, 'responsible', (item) => {
                    setFieldValue('responsible_user_id', item.id);
                    const responsibleSearch = form?.querySelector('[data-workshop-order-responsible-search]');
                    if (responsibleSearch instanceof HTMLInputElement) {
                        responsibleSearch.value = item.name || item.display_name || '';
                        responsibleSearch.readOnly = true;
                    }
                });
            }, 300);
        });
        responsibleSearchInput.addEventListener('focus', () => {
            if (responsibleSearchInput.value.trim().length >= 2 && !responsibleSearchInput.readOnly) {
                responsibleSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
    if (responsibleCreateBtn) {
        responsibleCreateBtn.addEventListener('click', () => {
            if (responsibleCreateUrl) window.open(responsibleCreateUrl, '_blank');
        });
    }
    let accessoriesSearchTimeout;
    const accessoriesSearchInput = form?.querySelector('[data-workshop-order-accessories-search]');
    const accessoriesResults = form?.querySelector('[data-workshop-order-accessories-results]');
    const accessoriesSelected = form?.querySelector('[data-workshop-order-accessories-selected]');
    const addAccessory = (accessory) => {
        if (!accessory?.id || selectedAccessories.has(accessory.id)) return;
        selectedAccessories.add(accessory.id);
        if (!accessoriesSelected) return;
        const badge = document.createElement('span');
        badge.className = 'inline-flex items-center gap-2 rounded-full bg-primary-soft/30 px-3 py-1.5 text-xs font-semibold text-primary dark:bg-primary/15 dark:text-primary-100';
        badge.dataset.accessoryId = accessory.id;
        badge.innerHTML = `
            <span>${accessory.name || ''}</span>
            <button type="button" class="hover:text-primary-strong" data-accessory-remove="${accessory.id}" aria-label="${tx('Remover accesorio')}">
                <i class="fa-solid fa-xmark text-[10px]"></i>
            </button>
        `;
        const removeBtn = badge.querySelector(`[data-accessory-remove="${accessory.id}"]`);
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                selectedAccessories.delete(accessory.id);
                badge.remove();
            });
        }
        accessoriesSelected.appendChild(badge);
    };
    if (accessoriesSearchInput instanceof HTMLInputElement) {
        accessoriesSearchInput.addEventListener('input', () => {
            clearTimeout(accessoriesSearchTimeout);
            const query = accessoriesSearchInput.value.trim();
            if (query.length < 2) {
                if (accessoriesResults) {
                    accessoriesResults.hidden = true;
                    accessoriesResults.dataset.open = 'false';
                }
                return;
            }
            accessoriesSearchTimeout = setTimeout(async () => {
                const items = await searchItems('accessories', query, accessoriesUrl);
                renderSearchResults(accessoriesResults, items, 'accessories', (item) => {
                    addAccessory(item);
                    accessoriesSearchInput.value = '';
                    if (accessoriesResults) {
                        accessoriesResults.hidden = true;
                        accessoriesResults.dataset.open = 'false';
                    }
                });
            }, 300);
        });
        accessoriesSearchInput.addEventListener('focus', () => {
            if (accessoriesSearchInput.value.trim().length >= 2) {
                accessoriesSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
    const accessoryForm = modals.accessoryCreate?.querySelector('[data-workshop-order-accessory-form]');
    const accessoryFormInput = accessoryForm?.querySelector('[data-workshop-order-accessory-input="name"]');
    const accessorySubmitBtn = accessoryForm?.querySelector('[data-workshop-order-accessory-submit]');
    const accessorySubmitLabel = accessorySubmitBtn?.querySelector('[data-workshop-order-accessory-submit-label]');
    const clearAccessoryForm = () => {
        if (accessoryForm) accessoryForm.reset();
        if (accessoryFormInput) accessoryFormInput.value = '';
        accessoryForm?.querySelectorAll('[data-workshop-order-accessory-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
    };
    const setAccessorySubmitLoading = (isLoading) => {
        if (!accessorySubmitBtn || !accessorySubmitLabel) return;
        accessorySubmitBtn.disabled = isLoading;
        if (isLoading) {
            accessorySubmitLabel.textContent = tx('Procesando...');
        } else {
            accessorySubmitLabel.textContent = tx('Guardar');
        }
    };
    if (accessoryForm) {
        accessoryForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!accessoryFormInput || !accessoryFormInput.value.trim()) return;
            setAccessorySubmitLoading(true);
            try {
                const response = await fetch(accessoriesCreateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify({ name: accessoryFormInput.value.trim() }),
                });
                const json = await response.json().catch(() => null);
                if (response.ok && json?.data?.item) {
                    addAccessory(json.data.item);
                    showAlert({ title: tx('Éxito'), text: json?.message ?? tx('Accesorio creado correctamente.'), icon: 'success' });
                    closeModal(modals.accessoryCreate);
                    clearAccessoryForm();
                } else {
                    if (response.status === 422 && json?.errors) {
                        accessoryForm.querySelectorAll('[data-workshop-order-accessory-error]').forEach((errorEl) => {
                            const field = errorEl.getAttribute('data-workshop-order-accessory-error');
                            const message = json.errors[field] ? (Array.isArray(json.errors[field]) ? json.errors[field][0] : json.errors[field]) : '';
                            errorEl.textContent = message;
                        });
                    } else {
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible crear el accesorio.'), icon: 'error' });
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrders] accessory create error', error);
                showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al crear el accesorio.'), icon: 'error' });
            } finally {
                setAccessorySubmitLoading(false);
            }
        });
    }
    const accessoriesCreateBtn = form?.querySelector('[data-workshop-order-accessories-create-button]');
    if (accessoriesCreateBtn) {
        accessoriesCreateBtn.addEventListener('click', () => {
            clearAccessoryForm();
            openModal(modals.accessoryCreate);
            if (accessoryFormInput) setTimeout(() => accessoryFormInput.focus(), 100);
        });
    }
    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) return;
        const mode = form.dataset.mode ?? 'create';
        const orderId = form.dataset.workshopOrderId ?? '';
        const accessories = Array.from(selectedAccessories);
        const payload = {
            category_id: getFieldValue('category_id'),
            state_id: getFieldValue('state_id') || null,
            customer_id: getFieldValue('customer_id'),
            equipment_id: getFieldValue('equipment_id'),
            responsible_user_id: getFieldValue('responsible_user_id'),
            priority: getFieldValue('priority'),
            work_summary: getFieldValue('work_summary'),
            work_description: getFieldValue('work_description') || null,
            general_condition: getFieldValue('general_condition') || null,
            diagnosis: getFieldValue('diagnosis') === '1',
            warranty: getFieldValue('warranty') === '1',
            equipment_password: getFieldValue('equipment_password') || null,
            promised_at: getFieldValue('promised_at') || null,
            budget_currency: getFieldValue('budget_currency') || null,
            budget_amount: getFieldValue('budget_amount') || null,
            advance_currency: getFieldValue('advance_currency') || null,
            advance_amount: getFieldValue('advance_amount') || null,
            status: getFieldValue('status') || 'A',
            accessories: accessories,
        };
        clearFormErrors();
        const validationErrors = {};
        if (!payload.customer_id) validationErrors.customer_id = tx('Debes seleccionar un cliente.');
        if (!payload.equipment_id) validationErrors.equipment_id = tx('Debes seleccionar un equipo.');
        if (!payload.responsible_user_id) validationErrors.responsible_user_id = tx('Debes seleccionar un responsable.');
        if (!payload.category_id) validationErrors.category_id = tx('Debes seleccionar una categoría.');
        if (!payload.work_summary) validationErrors.work_summary = tx('Debes indicar el trabajo a realizar.');
        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }
        setSubmitLoading(true);
        const url = mode === 'create' ? storeUrl : `${baseUrl}/${orderId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';
        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });
            const json = await response.json().catch(() => null);
            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopOrders] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };
    document.addEventListener('click', (event) => {
        if (!event.target) return;
        if (!form?.contains(event.target) && !customerResults?.contains(event.target) && !equipmentResults?.contains(event.target) && !responsibleResults?.contains(event.target) && !accessoriesResults?.contains(event.target)) {
            if (customerResults) {
                customerResults.hidden = true;
                customerResults.dataset.open = 'false';
            }
            if (equipmentResults) {
                equipmentResults.hidden = true;
                equipmentResults.dataset.open = 'false';
            }
            if (responsibleResults) {
                responsibleResults.hidden = true;
                responsibleResults.dataset.open = 'false';
            }
            if (accessoriesResults) {
                accessoriesResults.hidden = true;
                accessoriesResults.dataset.open = 'false';
            }
        }
    });
    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }
    root.addEventListener('click', (event) => {
        if (!(event.target instanceof Element)) return;
        const actionEl = event.target.closest('[data-workshop-order-action], [data-action], [data-row-action]');
        if (!actionEl) return;
        const payloadSource = actionEl.dataset.rowPayload ? actionEl : actionEl.closest('[data-row-payload]');
        let data = null;
        const payloadValue = payloadSource?.dataset?.rowPayload ?? actionEl.dataset.rowPayload ?? null;
        if (payloadValue) {
            try {
                data = decodePayload(payloadValue);
            } catch (error) {
                console.error('[WorkshopOrders] payload decode error', error, { payloadValue });
            }
        }
        const dataset = actionEl.dataset ?? {};
        let rowAction = dataset.workshopOrderAction ?? dataset.action ?? dataset.rowAction ?? null;
        if (rowAction === 'create') {
            // Redirigir a la página de crear orden
            window.location.href = `${baseUrl}/create`;
            return;
        }
        if (!rowAction) return;
        // Get row ID from button attributes if data is not available
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        
        // If no data from payload, create from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
            };
        }

        if (rowAction === 'view') {
            if (!data?.id) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            // Redirigir a la página de ver orden
            window.location.href = `${baseUrl}/${data.id}`;
            return;
        }
        if (rowAction === 'edit') {
            if (!data?.id) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            // Redirigir a la página de editar orden
            window.location.href = `${baseUrl}/${data.id}/edit`;
            return;
        }
        if (rowAction === 'delete') {
            const deleteId = data?.id ?? rowId ?? '';
            if (!deleteId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            // If we only have ID, fetch full data from server to get order summary
            if (!data || Object.keys(data).length <= 1) {
                fetch(`${baseUrl}/${deleteId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            data = json.data.item;
                            openDeleteModal(data, deleteId);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopOrders] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                openDeleteModal(data, deleteId);
            }
            return;
        }
    });
    
    const openDeleteModal = (data, deleteId) => {
        if (!modals.delete || !deleteId) return;
        modals.delete.dataset.workshopOrderId = deleteId;
        if (deleteName) {
            const summary = data.order_number 
                ? `${data.order_number}${data.customer_name ? ' - ' + data.customer_name : ''}`
                : data.customer_name 
                    ? data.customer_name 
                    : deleteId;
            deleteName.textContent = summary;
        }
        openModal(modals.delete);
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) return;
        const orderId = modals.delete.dataset.workshopOrderId;
        if (!orderId) {
            closeModal(modals.delete);
            return;
        }
        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');
        try {
            const response = await fetch(`${baseUrl}/${orderId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });
            const json = await response.json().catch(() => null);
            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopOrders] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }
    
    // Manejo de vista (tabla/kanban)
    let currentView = 'table';
    let currentCategoryId = null;
    let currentStateId = null;
    const tableView = root.querySelector('[data-orders-view="table"]');
    const kanbanView = root.querySelector('[data-orders-view="kanban"]');
    const kanbanContainer = kanbanView?.querySelector('[data-orders-kanban-container]');
    const viewToggles = root.querySelectorAll('[data-view-toggle]');
    const cardsContainer = root.querySelector('[data-orders-cards-container]');
    const filtersContainer = root.querySelector('[data-orders-filters]');
    const stateFilterContainer = root.querySelector('[data-filter-state-container]');
    const categoriesDataAttr = filtersContainer?.dataset?.categoriesData;
    let categoriesData = [];
    
    if (categoriesDataAttr) {
        try {
            categoriesData = JSON.parse(categoriesDataAttr);
        } catch (e) {
            console.error('[WorkshopOrders] Error parsing categories data', e);
        }
    }
    
    // Obtener todos los estados únicos de todas las categorías
    const getAllStates = () => {
        const allStates = new Map();
        categoriesData.forEach(category => {
            if (category.states && Array.isArray(category.states)) {
                category.states.forEach(state => {
                    if (!allStates.has(state.id)) {
                        allStates.set(state.id, { ...state, category_id: category.id });
                    }
                });
            }
        });
        return Array.from(allStates.values());
    };
    
    // Obtener estados filtrados por categoría
    const getStatesForCategory = (categoryId) => {
        if (!categoryId) return getAllStates();
        const category = categoriesData.find(cat => cat.id === categoryId);
        if (!category || !category.states) return [];
        return category.states.map(state => ({ ...state, category_id: categoryId }));
    };
    
    const switchView = (viewType) => {
        currentView = viewType;
        
        // Actualizar botones de toggle
        viewToggles.forEach(toggle => {
            const isActive = toggle.dataset.viewToggle === viewType;
            toggle.dataset.active = isActive ? 'true' : 'false';
        });
        
        // Mostrar/ocultar vistas
        if (tableView) {
            tableView.classList.toggle('hidden', viewType !== 'table');
        }
        if (kanbanView) {
            kanbanView.classList.toggle('hidden', viewType !== 'kanban');
        }
        
        // Mostrar/ocultar cards de totales (solo en tabla)
        if (cardsContainer) {
            cardsContainer.classList.toggle('hidden', viewType !== 'table');
        }
        
        // Mostrar/ocultar select de estado (solo en tabla)
        if (stateFilterContainer) {
            stateFilterContainer.classList.toggle('hidden', viewType !== 'table');
        }
        
        // Si cambió a kanban, resetear el estado y cargar el kanban
        if (viewType === 'kanban') {
            currentStateId = null;
            resetStateSelect();
            loadKanbanView();
        } else {
            // Si cambió a tabla, refrescar con los filtros actuales
            refreshTableWithFilters();
        }
    };
    
    // Cargar vista kanban
    const loadKanbanView = async () => {
        if (!kanbanContainer) return;
        
        // En kanban, solo usar categoría, no estado
        // Determinar qué estados mostrar
        let statesToShow = [];
        if (currentCategoryId) {
            // Si hay una categoría seleccionada, mostrar solo sus estados
            statesToShow = getStatesForCategory(currentCategoryId);
        } else {
            // Si no hay categoría seleccionada, mostrar todos los estados
            statesToShow = getAllStates();
        }
        
        // Mostrar loading
        const columnsContainer = kanbanContainer.querySelector('[data-orders-kanban-columns]');
        if (columnsContainer) {
            columnsContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-[400px] w-full">
                    <div class="text-center">
                        <i class="fa-solid fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${tx('Cargando tablero...')}</p>
                    </div>
                </div>
            `;
        }
        
        try {
            // Construir filtros para la API (solo categoría en kanban)
            const filters = {};
            if (currentCategoryId) {
                filters.category_id = currentCategoryId;
            }
            
            // Cargar órdenes
            const params = new URLSearchParams({
                per_page: '1000', // Cargar todas las órdenes para el kanban
            });
            if (filters.category_id) {
                params.append('category_id', filters.category_id);
            }
            if (filters.state_id) {
                params.append('state_id', filters.state_id);
            }
            
            const dataUrl = root.dataset.workshopOrdersBaseUrl ? 
                `${root.dataset.workshopOrdersBaseUrl}/data?${params.toString()}` : 
                `${baseUrl || root.dataset.workshopOrdersBaseUrl || ''}/data?${params.toString()}`;
            
            if (!dataUrl || dataUrl === '/data') {
                console.error('[WorkshopOrders] No se pudo determinar la URL base para cargar las órdenes');
                throw new Error('URL base no disponible');
            }
            
            const response = await fetch(dataUrl, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            
            const json = await response.json();
            
            if (json?.status !== 'success' || !json?.data?.items) {
                throw new Error('Failed to load orders');
            }
            
            const orders = json.data.items || [];
            
            // Crear columnas del kanban
            const columnsContainer = kanbanContainer.querySelector('[data-orders-kanban-columns]');
            if (!columnsContainer) return;
            
            columnsContainer.innerHTML = '';
            
            if (statesToShow.length === 0) {
                columnsContainer.innerHTML = `
                    <div class="flex items-center justify-center min-h-[400px] w-full">
                        <div class="text-center">
                            <i class="fa-solid fa-inbox text-4xl text-gray-400 mb-4"></i>
                            <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">${tx('No hay estados disponibles')}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${tx('Agrega estados a las categorías para ver el tablero kanban')}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Crear una columna por cada estado
            statesToShow.forEach((state) => {
                // Filtrar órdenes por estado
                const stateOrders = orders.filter(order => order.state_id === state.id);
                
                // Crear columna
                const column = document.createElement('div');
                column.className = 'flex-shrink-0 w-80';
                column.dataset.kanbanColumn = state.id;
                column.dataset.stateId = state.id;
                column.dataset.dropZone = 'true';
                
                // Prioridad colors
                const priorityColors = {
                    'Urgente': 'border-rose-500 bg-rose-50 text-rose-700 dark:bg-rose-900/20 dark:text-rose-300 dark:border-rose-400',
                    'Alta': 'border-amber-500 bg-amber-50 text-amber-700 dark:bg-amber-900/20 dark:text-amber-300 dark:border-amber-400',
                    'Normal': 'border-blue-500 bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-400',
                    'Baja': 'border-gray-500 bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600',
                };
                
                const priorityColor = priorityColors[stateOrders.find(o => o.priority)?.priority] || priorityColors['Normal'];
                
                column.innerHTML = `
                    <div class="rounded-xl border border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-slate-800/50">
                        <div class="sticky top-0 z-10 rounded-t-xl border-b border-gray-200 bg-white px-4 py-3 dark:border-gray-700 dark:bg-slate-900">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-bold text-gray-900 dark:text-white">${state.name || 'Sin estado'}</h3>
                                    <span class="inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-primary px-2 text-xs font-semibold text-white" data-state-count>
                                        ${stateOrders.length}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="max-h-[calc(100vh-300px)] space-y-3 overflow-y-auto p-4 rounded-b-xl" data-kanban-column-orders="${state.id}" style="min-height: 100px;">
                            ${stateOrders.length === 0 ? `
                                <div class="rounded-lg border-2 border-dashed border-gray-300 p-8 text-center dark:border-gray-600">
                                    <i class="fa-solid fa-inbox text-2xl text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${tx('Sin órdenes')}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                const ordersContainer = column.querySelector(`[data-kanban-column-orders="${state.id}"]`);
                
                // Agregar tarjetas de órdenes
                if (stateOrders.length > 0 && ordersContainer) {
                    stateOrders.forEach((order) => {
                        const card = createKanbanCard(order, priorityColors, state.id);
                        ordersContainer.appendChild(card);
                    });
                }
                
                // Agregar event listeners para drag and drop en la columna
                setupColumnDropZone(column, state.id);
                
                columnsContainer.appendChild(column);
            });
            
            // Inicializar drag and drop
            initKanbanDragAndDrop();
            
        } catch (error) {
            console.error('[WorkshopOrders] Error loading kanban view', error);
            const columnsContainer = kanbanContainer.querySelector('[data-orders-kanban-columns]');
            if (columnsContainer) {
                columnsContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-[400px] w-full">
                    <div class="text-center">
                        <i class="fa-solid fa-triangle-exclamation text-4xl text-rose-400 mb-4"></i>
                        <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">${tx('Error al cargar el tablero')}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${tx('Intenta recargar la página')}</p>
                    </div>
                </div>
                `;
            }
        }
    };
    
    // Crear tarjeta de orden para kanban
    const createKanbanCard = (order, priorityColors, currentStateId) => {
        const card = document.createElement('div');
        card.className = 'group cursor-move rounded-xl border border-gray-200 bg-white p-4 shadow-sm transition-all hover:shadow-md hover:border-primary dark:border-gray-700 dark:bg-slate-900';
        card.dataset.orderId = order.id;
        card.dataset.currentStateId = currentStateId;
        card.draggable = true;
        
        const priorityColor = priorityColors[order.priority] || priorityColors['Normal'];
        const priorityBadge = order.priority ? 
            `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold ${priorityColor}">${order.priority}</span>` : '';
        
        const orderNumber = order.order_number || '-';
        const customerName = order.customer_name || tx('Sin cliente');
        const equipmentLabel = order.equipment_label || tx('Sin equipo');
        const promisedAt = order.promised_at_formatted || '';
        
        // Construir URLs para las acciones
        const viewUrl = `${baseUrl}/${order.id}`;
        const editUrl = `${baseUrl}/${order.id}/edit`;
        
        card.innerHTML = `
            <div class="space-y-3">
                <div class="flex items-start justify-between gap-2">
                    <div class="flex-1">
                        <h4 class="text-sm font-bold text-gray-900 dark:text-white">${orderNumber}</h4>
                        <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">${customerName}</p>
                    </div>
                    ${priorityBadge}
                </div>
                <div class="space-y-1.5">
                    <div class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400">
                        <i class="fa-solid fa-desktop text-[10px]"></i>
                        <span class="truncate">${equipmentLabel}</span>
                    </div>
                    ${promisedAt ? `
                        <div class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400">
                            <i class="fa-solid fa-calendar-days text-[10px]"></i>
                            <span>${promisedAt}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="flex items-center justify-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-800">
                    <a
                        href="${viewUrl}"
                        class="inline-flex h-7 w-7 items-center justify-center rounded-lg border border-gray-300 text-gray-600 transition hover:border-primary hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary/30 dark:border-gray-700 dark:text-gray-300 dark:hover:border-primary"
                        title="${tx('Ver')}"
                        onclick="event.stopPropagation();"
                    >
                        <i class="fa-regular fa-eye text-xs"></i>
                    </a>
                    <a
                        href="${editUrl}"
                        class="inline-flex h-7 w-7 items-center justify-center rounded-lg border border-gray-300 text-gray-600 transition hover:border-primary hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary/30 dark:border-gray-700 dark:text-gray-300 dark:hover:border-primary"
                        title="${tx('Editar')}"
                        onclick="event.stopPropagation();"
                    >
                        <i class="fa-regular fa-pen-to-square text-xs"></i>
                    </a>
                </div>
            </div>
        `;
        
        return card;
    };
    
    // Configurar zona de drop para una columna
    const setupColumnDropZone = (column, stateId) => {
        const ordersContainer = column.querySelector(`[data-kanban-column-orders="${stateId}"]`);
        if (!ordersContainer) return;
        
        let dragCounter = 0;
        
        ordersContainer.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            ordersContainer.classList.add('bg-primary-soft/10', 'border-primary', 'border-2', 'border-dashed');
        });
        
        ordersContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        ordersContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                ordersContainer.classList.remove('bg-primary-soft/10', 'border-primary', 'border-2', 'border-dashed');
            }
        });
        
        ordersContainer.addEventListener('drop', async (e) => {
            e.preventDefault();
            dragCounter = 0;
            ordersContainer.classList.remove('bg-primary-soft/10', 'border-primary', 'border-2', 'border-dashed');
            
            const orderId = e.dataTransfer.getData('text/plain');
            if (!orderId) return;
            
            const card = document.querySelector(`[data-order-id="${orderId}"]`);
            if (!card) return;
            
            const oldStateId = card.dataset.currentStateId;
            const newStateId = stateId;
            
            if (oldStateId === newStateId) return;
            
            // Actualizar estado de la orden
            await updateOrderState(orderId, newStateId, card, oldStateId, newStateId);
        });
    };
    
    // Inicializar drag and drop en el kanban
    const initKanbanDragAndDrop = () => {
        const cards = kanbanContainer?.querySelectorAll('[data-order-id]');
        if (!cards) return;
        
        cards.forEach(card => {
            card.addEventListener('dragstart', (e) => {
                const orderId = card.dataset.orderId;
                e.dataTransfer.setData('text/plain', orderId);
                e.dataTransfer.effectAllowed = 'move';
                card.classList.add('opacity-50', 'cursor-grabbing');
            });
            
            card.addEventListener('dragend', (e) => {
                card.classList.remove('opacity-50', 'cursor-grabbing');
            });
        });
    };
    
    // Actualizar estado de una orden
    const updateOrderState = async (orderId, newStateId, cardElement, oldStateId, newStateIdParam) => {
        if (!orderId || !newStateIdParam) return;
        
        try {
            // Mostrar loading en la tarjeta
            const originalContent = cardElement.innerHTML;
            cardElement.innerHTML = `
                <div class="flex items-center justify-center py-4">
                    <i class="fa-solid fa-spinner fa-spin text-primary"></i>
                </div>
            `;
            
            const response = await fetch(`${baseUrl}/${orderId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({
                    state_id: newStateIdParam,
                }),
            });
            
            const json = await response.json();
            
            if (json?.status === 'success') {
                // Mover la tarjeta a la nueva columna
                const newColumn = kanbanContainer?.querySelector(`[data-state-id="${newStateIdParam}"]`);
                const newOrdersContainer = newColumn?.querySelector(`[data-kanban-column-orders="${newStateIdParam}"]`);
                
                if (newOrdersContainer) {
                    // Remover de la columna anterior
                    cardElement.remove();
                    
                    // Agregar a la nueva columna
                    const order = json?.data?.item;
                    if (order) {
                        const priorityColors = {
                            'Urgente': 'border-rose-500 bg-rose-50 text-rose-700 dark:bg-rose-900/20 dark:text-rose-300 dark:border-rose-400',
                            'Alta': 'border-amber-500 bg-amber-50 text-amber-700 dark:bg-amber-900/20 dark:text-amber-300 dark:border-amber-400',
                            'Normal': 'border-blue-500 bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-400',
                            'Baja': 'border-gray-500 bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600',
                        };
                        const newCard = createKanbanCard(order, priorityColors, newStateIdParam);
                        newOrdersContainer.appendChild(newCard);
                        
                        // Actualizar contador de la columna anterior
                        const oldColumn = kanbanContainer?.querySelector(`[data-state-id="${oldStateId}"]`);
                        const oldCount = oldColumn?.querySelector('[data-state-count]');
                        if (oldCount) {
                            const oldOrders = oldColumn?.querySelectorAll('[data-order-id]');
                            oldCount.textContent = oldOrders?.length || 0;
                        }
                        
                        // Actualizar contador de la nueva columna
                        const newCount = newColumn?.querySelector('[data-state-count]');
                        if (newCount) {
                            const newOrders = newColumn?.querySelectorAll('[data-order-id]');
                            newCount.textContent = newOrders?.length || 0;
                        }
                        
                        // Reinicializar drag and drop para la nueva tarjeta
                        initKanbanDragAndDrop();
                    }
                }
                
                showAlert({ 
                    title: tx('Estado actualizado'), 
                    text: json?.message || tx('El estado de la orden se actualizó correctamente.'), 
                    icon: 'success' 
                });
            } else {
                // Restaurar contenido original
                cardElement.innerHTML = originalContent;
                showAlert({ 
                    title: tx('Error'), 
                    text: json?.message || tx('No se pudo actualizar el estado de la orden.'), 
                    icon: 'error' 
                });
            }
        } catch (error) {
            console.error('[WorkshopOrders] Error updating order state', error);
            showAlert({ 
                title: tx('Error'), 
                text: tx('Ocurrió un problema al actualizar el estado.'), 
                icon: 'error' 
            });
        }
    };
    
    // Inicializar select manual
    const initManualSelect = (select) => {
        const trigger = select.querySelector('[data-select-trigger]');
        const dropdown = select.querySelector('[data-select-dropdown]');
        const icon = select.querySelector('[data-select-icon]');
        if (!trigger || !dropdown) return;
        
        const closeSelect = () => {
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
            select.dataset.open = 'false';
            trigger.setAttribute('aria-expanded', 'false');
            icon?.classList.remove('rotate-180');
        };
        
        const openSelect = () => {
            dropdown.hidden = false;
            dropdown.dataset.open = 'true';
            select.dataset.open = 'true';
            trigger.setAttribute('aria-expanded', 'true');
            icon?.classList.add('rotate-180');
            requestAnimationFrame(() => {
                dropdown.style.minWidth = `${trigger.getBoundingClientRect().width}px`;
            });
        };
        
        trigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (trigger.disabled) return;
            if (dropdown.hidden) {
                openSelect();
            } else {
                closeSelect();
            }
        });
        
        // Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!select.contains(e.target)) {
                closeSelect();
            }
        });
        
        // Cerrar con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !dropdown.hidden) {
                closeSelect();
            }
        });
    };
    
    // Cargar opciones del select de categoría
    const loadCategoryOptions = () => {
        if (!filtersContainer) return;
        const categorySelect = filtersContainer.querySelector('[data-select-name="filter_category"]');
        const optionsContainer = filtersContainer.querySelector('[data-filter-category-options]');
        if (!categorySelect || !optionsContainer) return;
        
        // Opción "Todas"
        const allOption = document.createElement('button');
        allOption.type = 'button';
        allOption.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
        allOption.dataset.selectOption = '';
        allOption.dataset.value = '';
        allOption.dataset.label = tx('Todas');
        allOption.dataset.selected = 'true';
        allOption.innerHTML = `
            <span>${tx('Todas')}</span>
            <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
        `;
        allOption.addEventListener('click', () => {
            setCategoryValue('');
        });
        optionsContainer.appendChild(allOption);
        
        // Opciones de categorías
        categoriesData.forEach(category => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            option.dataset.selectOption = '';
            option.dataset.value = category.id;
            option.dataset.label = category.name;
            option.dataset.selected = 'false';
            option.innerHTML = `
                <span>${category.name}</span>
                <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
            `;
            option.addEventListener('click', () => {
                setCategoryValue(category.id);
            });
            optionsContainer.appendChild(option);
        });
    };
    
    // Establecer valor de categoría
    const setCategoryValue = (categoryId) => {
        const categorySelect = filtersContainer?.querySelector('[data-select-name="filter_category"]');
        const hiddenInput = categorySelect?.querySelector('[data-filter-category-input]');
        const valueSpan = categorySelect?.querySelector('[data-select-value]');
        const dropdown = categorySelect?.querySelector('[data-select-dropdown]');
        const trigger = categorySelect?.querySelector('[data-select-trigger]');
        
        currentCategoryId = categoryId || null;
        
        if (hiddenInput) hiddenInput.value = categoryId || '';
        if (valueSpan) {
            const label = categoryId ? categoriesData.find(c => c.id === categoryId)?.name || tx('Todas') : tx('Todas');
            valueSpan.textContent = label;
        }
        if (dropdown) {
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
        }
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
        
        // Actualizar selección visual
        const optionsContainer = categorySelect?.querySelector('[data-filter-category-options]');
        if (optionsContainer) {
            optionsContainer.querySelectorAll('[data-select-option]').forEach(opt => {
                opt.dataset.selected = opt.dataset.value === categoryId ? 'true' : 'false';
            });
        }
        
        // Actualizar select de estados
        loadStateOptions();
        
        // Aplicar filtros
        refreshTableWithFilters();
    };
    
    // Cargar opciones del select de estado
    const loadStateOptions = () => {
        if (!filtersContainer) return;
        const stateSelect = filtersContainer.querySelector('[data-select-name="filter_state"]');
        const optionsContainer = filtersContainer.querySelector('[data-filter-state-options]');
        const trigger = stateSelect?.querySelector('[data-select-trigger]');
        if (!stateSelect || !optionsContainer) return;
        
        // Limpiar opciones actuales
        optionsContainer.innerHTML = '';
        
        // Obtener estados según la categoría seleccionada
        let statesToShow = [];
        if (currentCategoryId) {
            statesToShow = getStatesForCategory(currentCategoryId);
        } else {
            statesToShow = getAllStates();
        }
        
        // Habilitar/deshabilitar select
        if (trigger) {
            trigger.disabled = statesToShow.length === 0;
        }
        
        if (statesToShow.length === 0) {
            const emptyOption = document.createElement('div');
            emptyOption.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400';
            emptyOption.textContent = tx('No hay estados disponibles');
            optionsContainer.appendChild(emptyOption);
            return;
        }
        
        // Opción "Todos"
        const allOption = document.createElement('button');
        allOption.type = 'button';
        allOption.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
        allOption.dataset.selectOption = '';
        allOption.dataset.value = '';
        allOption.dataset.label = tx('Todos');
        allOption.dataset.selected = 'true';
        allOption.innerHTML = `
            <span>${tx('Todos')}</span>
            <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
        `;
        allOption.addEventListener('click', () => {
            setStateValue('');
        });
        optionsContainer.appendChild(allOption);
        
        // Opciones de estados
        statesToShow.forEach(state => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
            option.dataset.selectOption = '';
            option.dataset.value = state.id;
            option.dataset.label = state.name;
            option.dataset.selected = 'false';
            option.innerHTML = `
                <span>${state.name}</span>
                <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
            `;
            option.addEventListener('click', () => {
                setStateValue(state.id);
            });
            optionsContainer.appendChild(option);
        });
    };
    
    // Establecer valor de estado
    const setStateValue = (stateId) => {
        const stateSelect = filtersContainer?.querySelector('[data-select-name="filter_state"]');
        const hiddenInput = stateSelect?.querySelector('[data-filter-state-input]');
        const valueSpan = stateSelect?.querySelector('[data-select-value]');
        const dropdown = stateSelect?.querySelector('[data-select-dropdown]');
        const trigger = stateSelect?.querySelector('[data-select-trigger]');
        
        currentStateId = stateId || null;
        
        if (hiddenInput) hiddenInput.value = stateId || '';
        if (valueSpan) {
            if (!stateId) {
                valueSpan.textContent = tx('Todos');
            } else {
                const allStates = getAllStates();
                const state = allStates.find(s => s.id === stateId);
                valueSpan.textContent = state?.name || tx('Todos');
            }
        }
        if (dropdown) {
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
        }
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
        
        // Actualizar selección visual
        const optionsContainer = stateSelect?.querySelector('[data-filter-state-options]');
        if (optionsContainer) {
            optionsContainer.querySelectorAll('[data-select-option]').forEach(opt => {
                opt.dataset.selected = opt.dataset.value === stateId ? 'true' : 'false';
            });
        }
        
        // Aplicar filtros
        refreshTableWithFilters();
    };
    
    // Resetear select de estado
    const resetStateSelect = () => {
        const stateSelect = filtersContainer?.querySelector('[data-select-name="filter_state"]');
        const hiddenInput = stateSelect?.querySelector('[data-filter-state-input]');
        const valueSpan = stateSelect?.querySelector('[data-select-value]');
        
        if (hiddenInput) hiddenInput.value = '';
        if (valueSpan) valueSpan.textContent = tx('Todos');
        
        const optionsContainer = stateSelect?.querySelector('[data-filter-state-options]');
        if (optionsContainer) {
            optionsContainer.querySelectorAll('[data-select-option]').forEach(opt => {
                opt.dataset.selected = opt.dataset.value === '' ? 'true' : 'false';
            });
        }
    };
    
    // Aplicar filtros
    const refreshTableWithFilters = () => {
        const filters = {};
        if (currentCategoryId) {
            filters.category_id = currentCategoryId;
        }
        if (currentStateId && currentView === 'table') {
            // Solo aplicar filtro de estado en vista tabla
            filters.state_id = currentStateId;
        }
        currentFilters = filters;
        
        if (currentView === 'table') {
            refreshTable(filters);
        } else if (currentView === 'kanban') {
            loadKanbanView();
        }
    };
    
    // Inicializar toggles de vista
    viewToggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
            const viewType = toggle.dataset.viewToggle;
            if (viewType) {
                switchView(viewType);
            }
        });
    });
    
    // Inicializar selects de filtros
    if (filtersContainer && categoriesData.length > 0) {
        // Inicializar selects manuales
        const categorySelect = filtersContainer.querySelector('[data-select-name="filter_category"]');
        const stateSelect = filtersContainer.querySelector('[data-select-name="filter_state"]');
        
        if (categorySelect) {
            initManualSelect(categorySelect);
        }
        if (stateSelect) {
            initManualSelect(stateSelect);
        }
        
        // Cargar opciones
        loadCategoryOptions();
        loadStateOptions();
    }

    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            const orderId = target.dataset.id ?? '';
            if (!orderId || target.disabled) return;
            const previousChecked = !target.checked;
            const newStatus = target.checked ? 'A' : 'I';
            target.disabled = true;
            fetch(`${baseUrl}/${orderId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            })
                .then((response) => response.json().catch(() => null))
                .then((json) => {
                    if (json?.status === 'success') {
                        showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
                        refreshTable();
                    } else {
                        target.checked = previousChecked;
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopOrders] Status toggle error', error);
                    target.checked = previousChecked;
                    showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
                })
                .finally(() => {
                    target.disabled = false;
                });
        }
    });
};

const initWorkshopAdvancesModule = () => {
    const root = document.querySelector('[data-workshop-advances-root]');
    if (!root) return;
    const tableId = root.dataset.workshopAdvancesTableId ?? '';
    const baseUrl = root.dataset.workshopAdvancesBaseUrl ?? '';
    const storeUrl = root.dataset.workshopAdvancesStoreUrl ?? baseUrl;
    const optionsUrl = root.dataset.workshopAdvancesOptionsUrl ?? '';
    const ordersUrl = root.dataset.workshopAdvancesOrdersUrl ?? '';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const modals = {
        form: root.querySelector('[data-workshop-advance-modal="form"]'),
        view: root.querySelector('[data-workshop-advance-modal="view"]'),
        delete: root.querySelector('[data-workshop-advance-modal="delete"]'),
    };
    const form = modals.form?.querySelector('[data-workshop-advance-form]') ?? null;
    const submitButton = modals.form?.querySelector('[data-workshop-advance-submit]') ?? null;
    const submitLabel = submitButton?.querySelector('[data-workshop-advance-submit-label]') ?? null;
    const modalTitle = modals.form?.querySelector('[data-workshop-advance-modal-title]') ?? null;
    const deleteName = modals.delete?.querySelector('[data-workshop-advance-delete-amount]') ?? null;
    const deleteConfirmButton = modals.delete?.querySelector('[data-workshop-advance-delete-confirm]') ?? null;
    const bodyOverflowClass = 'overflow-hidden';
    const getEventTargetModal = (target) => target.closest('[data-workshop-advance-modal]');
    const openModal = (modal) => {
        if (!modal) return;
        modal.classList.remove('hidden');
        document.body.classList.add(bodyOverflowClass);
    };
    const closeModal = (modal) => {
        if (!modal) return;
        modal.classList.add('hidden');
        if (!root.querySelector('[data-workshop-advance-modal]:not(.hidden)')) {
            document.body.classList.remove(bodyOverflowClass);
        }
    };
    root.querySelectorAll('[data-workshop-advance-modal-close]').forEach((button) => {
        button.addEventListener('click', () => {
            const modal = getEventTargetModal(button);
            closeModal(modal);
        });
    });
    Object.values(modals).forEach((modal) => {
        if (!modal) return;
        modal.addEventListener('click', (event) => {
            if (event.target === modal) closeModal(modal);
        });
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeModal(modal);
        });
    });
    const clearFormErrors = () => {
        if (!form) return;
        form.querySelectorAll('[data-workshop-advance-error]').forEach((errorEl) => {
            errorEl.textContent = '';
        });
        form.querySelectorAll('[data-workshop-advance-input]').forEach((input) => {
            if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
                input.classList.remove('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };
    const applyFormErrors = (errors) => {
        if (!form || !errors) return;
        Object.entries(errors).forEach(([field, messages]) => {
            const message = Array.isArray(messages) ? messages[0] : messages;
            const errorEl = form.querySelector(`[data-workshop-advance-error="${field}"]`);
            if (errorEl) errorEl.textContent = message ?? '';
            const inputEl = form.querySelector(`[data-workshop-advance-input="${field}"]`);
            if (inputEl instanceof HTMLInputElement || inputEl instanceof HTMLTextAreaElement || inputEl instanceof HTMLSelectElement) {
                inputEl.classList.add('border-rose-500', 'focus:border-rose-500', 'focus:ring-rose-200');
            }
        });
    };
    const setSubmitLoading = (isLoading) => {
        if (!submitButton || !submitLabel) return;
        if (isLoading) {
            submitLabel.textContent = tx('Procesando...');
        } else if (submitButton.dataset.originalLabel) {
            submitLabel.textContent = submitButton.dataset.originalLabel;
        }
        submitButton.disabled = isLoading;
    };
    const getFieldValue = (field) => {
        if (!form) return '';
        // Check for custom select first (payment_method_id)
        if (field === 'payment_method_id') {
            const select = form.querySelector('[data-select-name="payment_method_id"]');
            if (select) {
                const hiddenInput = select.querySelector('[data-workshop-advance-input="payment_method_id"]');
                if (hiddenInput && hiddenInput.value) {
                    return hiddenInput.value.trim();
                }
            }
        }
        const input = form.querySelector(`[data-workshop-advance-input="${field}"]`);
        if (!input) return '';
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            return input.value.trim();
        }
        return '';
    };
    const setFieldValue = (field, value) => {
        if (!form) return;
        // Handle custom select for payment_method_id
        if (field === 'payment_method_id') {
            const select = form.querySelector('[data-select-name="payment_method_id"]');
            if (select) {
                const hiddenInput = select.querySelector('[data-workshop-advance-input="payment_method_id"]');
                if (hiddenInput) {
                    hiddenInput.value = value ?? '';
                    // Update display value if option exists
                    if (value) {
                        const optionsContainer = select.querySelector('[data-workshop-advance-payment-method-options]');
                        const valueSpan = select.querySelector('[data-select-value]');
                        if (optionsContainer && valueSpan) {
                            const option = optionsContainer.querySelector(`[data-value="${value}"]`);
                            if (option && option.textContent) {
                                valueSpan.textContent = option.textContent.trim();
                            }
                        }
                    } else {
                        const valueSpan = select.querySelector('[data-select-value]');
                        const trigger = select.querySelector('[data-select-trigger]');
                        if (valueSpan && trigger) {
                            valueSpan.textContent = trigger.getAttribute('data-select-placeholder') || tx('Selecciona un método de pago');
                        }
                    }
                }
            }
            return;
        }
        const input = form.querySelector(`[data-workshop-advance-input="${field}"]`);
        if (!input) return;
        if (input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement || input instanceof HTMLSelectElement) {
            input.value = value ?? '';
        }
    };
    const refreshTable = () => {
        if (!tableId) {
            window.dispatchEvent(new CustomEvent('datatable-refresh'));
            return;
        }
        window.dispatchEvent(new CustomEvent('datatable-refresh', { detail: { tableId } }));
    };
    const populateViewModal = (data) => {
        if (!modals.view || !data) return;
        modals.view.querySelectorAll('[data-workshop-advance-view-field]').forEach((element) => {
            const field = element.getAttribute('data-workshop-advance-view-field');
            if (!field) return;
            const value = data[field];
            element.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '-';
        });
    };
    const setMode = (mode, data = null) => {
        if (!form || !submitButton || !submitLabel) return;
        clearFormErrors();
        setSubmitLoading(false);
        form.dataset.mode = mode;
        form.dataset.workshopAdvanceId = data?.id ?? '';
        if (mode === 'create') {
            form.reset();
            setFieldValue('status', 'A');
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            setFieldValue('payment_date', localDateTime);
            if (modalTitle) modalTitle.textContent = tx('Nuevo abono');
            submitLabel.textContent = tx('Guardar');
            submitButton.dataset.originalLabel = tx('Guardar');
            resetSearchFields();
            resetSelects();
            loadOptions();
        } else {
            if (modalTitle) modalTitle.textContent = tx('Editar abono');
            submitLabel.textContent = tx('Actualizar');
            submitButton.dataset.originalLabel = tx('Actualizar');
            if (data) populateForm(data);
        }
    };
    const resetSelects = () => {
        // Reset custom select for payment_method_id
        const paymentMethodSelect = form?.querySelector('[data-select-name="payment_method_id"]');
        if (paymentMethodSelect) {
            const hiddenInput = paymentMethodSelect.querySelector('[data-workshop-advance-input="payment_method_id"]');
            const trigger = paymentMethodSelect.querySelector('[data-select-trigger]');
            const valueSpan = paymentMethodSelect.querySelector('[data-select-value]');
            if (hiddenInput) hiddenInput.value = '';
            if (trigger) {
                trigger.setAttribute('aria-expanded', 'false');
                // Reset initialization flag so it can be re-initialized
                trigger.dataset.initialized = 'false';
            }
            if (valueSpan) valueSpan.textContent = trigger?.getAttribute('data-select-placeholder') || tx('Selecciona un método de pago');
            const dropdown = paymentMethodSelect.querySelector('[data-select-dropdown]');
            if (dropdown) {
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
            }
            const icon = paymentMethodSelect.querySelector('[data-select-icon]');
            if (icon) icon.style.transform = '';
        }
    };
    const resetSearchFields = () => {
        const orderSearch = form?.querySelector('[data-workshop-advance-order-search]');
        if (orderSearch instanceof HTMLInputElement) {
            orderSearch.value = '';
            orderSearch.readOnly = false;
        }
        setFieldValue('order_id', '');
        closeSearchDropdowns();
    };
    const populateForm = async (data) => {
        if (!data || !form) return;
        setFieldValue('order_id', data.order_id ?? '');
        setFieldValue('amount', data.amount ?? '');
        if (data.payment_date) {
            const paymentDate = new Date(data.payment_date);
            const localDateTime = new Date(paymentDate.getTime() - paymentDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            setFieldValue('payment_date', localDateTime);
        } else {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            setFieldValue('payment_date', localDateTime);
        }
        setFieldValue('reference', data.reference ?? '');
        setFieldValue('notes', data.notes ?? '');
        setFieldValue('status', data.status ?? 'A');
        const orderSearch = form?.querySelector('[data-workshop-advance-order-search]');
        if (orderSearch instanceof HTMLInputElement && data.order_number) {
            orderSearch.value = data.order_number + (data.customer_name ? ' - ' + data.customer_name : '');
            orderSearch.readOnly = true;
        }
        await loadOptions();
        // Set payment_method_id using custom select
        if (data.payment_method_id) {
            setTimeout(() => {
                const paymentMethodSelect = form?.querySelector('[data-select-name="payment_method_id"]');
                if (paymentMethodSelect) {
                    const hiddenInput = paymentMethodSelect.querySelector('[data-workshop-advance-input="payment_method_id"]');
                    const valueSpan = paymentMethodSelect.querySelector('[data-select-value]');
                    const optionsContainer = paymentMethodSelect.querySelector('[data-workshop-advance-payment-method-options]');
                    if (hiddenInput) hiddenInput.value = data.payment_method_id;
                    // Find and set the display text
                    if (optionsContainer && valueSpan) {
                        const option = optionsContainer.querySelector(`[data-value="${data.payment_method_id}"]`);
                        if (option && option.textContent) {
                            valueSpan.textContent = option.textContent.trim();
                        }
                    }
                }
            }, 200);
        }
    };
    const loadOptions = async () => {
        if (!optionsUrl) return;
        try {
            const response = await fetch(optionsUrl, { headers: { Accept: 'application/json' } });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data) populateSelectOptions(json.data);
        } catch (error) {
            console.error('[WorkshopAdvances] options load error', error);
        }
    };
    let manualSelectInitialized = false;
    const initManualSelect = (select) => {
        if (!select) return;
        const trigger = select.querySelector('[data-select-trigger]');
        if (!trigger) return;
        
        // Check if already initialized
        if (trigger.dataset.initialized === 'true') return;
        trigger.dataset.initialized = 'true';
        
        const dropdown = select.querySelector('[data-select-dropdown]');
        const icon = select.querySelector('[data-select-icon]');
        
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dropdown?.dataset.open === 'true';
            if (dropdown) {
                dropdown.hidden = isOpen;
                dropdown.dataset.open = isOpen ? 'false' : 'true';
                trigger.setAttribute('aria-expanded', !isOpen);
                if (icon) icon.style.transform = isOpen ? '' : 'rotate(180deg)';
            }
        });
        
        // Close dropdown when clicking outside (only add once)
        if (!manualSelectInitialized) {
            manualSelectInitialized = true;
            document.addEventListener('click', (e) => {
                const manualSelects = form?.querySelectorAll('[data-select-manual="true"]');
                manualSelects?.forEach((manualSelect) => {
                    if (!manualSelect.contains(e.target)) {
                        const manualDropdown = manualSelect.querySelector('[data-select-dropdown]');
                        const manualTrigger = manualSelect.querySelector('[data-select-trigger]');
                        const manualIcon = manualSelect.querySelector('[data-select-icon]');
                        if (manualDropdown && manualDropdown.dataset.open === 'true') {
                            manualDropdown.hidden = true;
                            manualDropdown.dataset.open = 'false';
                            if (manualTrigger) manualTrigger.setAttribute('aria-expanded', 'false');
                            if (manualIcon) manualIcon.style.transform = '';
                        }
                    }
                });
            });
        }
    };
    
    const populateSelectOptions = (data) => {
        if (!data || !form) return;
        // Populate payment method custom select
        const paymentMethodOptionsContainer = form.querySelector('[data-workshop-advance-payment-method-options]');
        if (paymentMethodOptionsContainer && data.payment_methods) {
            paymentMethodOptionsContainer.innerHTML = '';
            if (data.payment_methods.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400';
                empty.textContent = tx('No hay métodos de pago disponibles');
                paymentMethodOptionsContainer.appendChild(empty);
            } else {
                data.payment_methods.forEach((method) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-primary-soft/20 dark:text-white dark:hover:bg-primary/20';
                    option.dataset.value = method.id;
                    option.setAttribute('role', 'option');
                    option.textContent = method.name || '';
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const select = form.querySelector('[data-select-name="payment_method_id"]');
                        const hiddenInput = select?.querySelector('[data-workshop-advance-input="payment_method_id"]');
                        const valueSpan = select?.querySelector('[data-select-value]');
                        const trigger = select?.querySelector('[data-select-trigger]');
                        const dropdown = select?.querySelector('[data-select-dropdown]');
                        if (hiddenInput) hiddenInput.value = method.id;
                        if (valueSpan) valueSpan.textContent = method.name || '';
                        if (trigger) trigger.setAttribute('aria-expanded', 'false');
                        if (dropdown) {
                            dropdown.hidden = true;
                            dropdown.dataset.open = 'false';
                        }
                        const icon = select?.querySelector('[data-select-icon]');
                        if (icon) icon.style.transform = '';
                    });
                    paymentMethodOptionsContainer.appendChild(option);
                });
            }
        }
        // Initialize manual selects after populating options
        setTimeout(() => {
            const manualSelects = form?.querySelectorAll('[data-select-manual="true"]');
            manualSelects?.forEach((select) => {
                initManualSelect(select);
            });
        }, 100);
    };
    const searchItems = async (type, query, url) => {
        if (!url || !query || query.length < 2) return [];
        try {
            const searchUrl = new URL(url, window.location.origin);
            searchUrl.searchParams.set('search', query);
            searchUrl.searchParams.set('per_page', '10');
            const response = await fetch(searchUrl.toString(), { headers: { Accept: 'application/json' } });
            const json = await response.json().catch(() => null);
            if (response.ok && json?.data?.items) return json.data.items;
            return [];
        } catch (error) {
            console.error(`[WorkshopAdvances] ${type} search error`, error);
            return [];
        }
    };
    const renderSearchResults = (container, items, type, onSelect) => {
        if (!container) return;
        container.innerHTML = '';
        if (!items || items.length === 0) {
            const empty = document.createElement('p');
            empty.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400';
            empty.textContent = tx('No se encontraron resultados');
            container.appendChild(empty);
            container.hidden = false;
            container.dataset.open = 'true';
            return;
        }
        const list = document.createElement('div');
        list.className = 'max-h-60 overflow-y-auto py-2';
        items.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'flex w-full items-center justify-between px-4 py-2.5 text-left text-sm text-gray-700 transition hover:bg-primary-soft/20 dark:text-white dark:hover:bg-primary/20';
            const displayText = item.order_number || item.label || '';
            const subText = item.customer_name || '';
            button.innerHTML = `
                <div class="flex-1">
                    <div class="font-medium">${displayText}</div>
                    ${subText ? `<div class="text-xs text-gray-500 dark:text-gray-400">${subText}</div>` : ''}
                </div>
            `;
            button.addEventListener('click', () => {
                if (onSelect) onSelect(item);
                container.hidden = true;
                container.dataset.open = 'false';
            });
            list.appendChild(button);
        });
        container.appendChild(list);
        container.hidden = false;
        container.dataset.open = 'true';
    };
    let orderSearchTimeout;
    const orderSearchInput = form?.querySelector('[data-workshop-advance-order-search]');
    const orderResults = form?.querySelector('[data-workshop-advance-order-results]');
    if (orderSearchInput instanceof HTMLInputElement) {
        orderSearchInput.addEventListener('input', () => {
            clearTimeout(orderSearchTimeout);
            const query = orderSearchInput.value.trim();
            if (query.length < 2) {
                if (orderResults) {
                    orderResults.hidden = true;
                    orderResults.dataset.open = 'false';
                }
                return;
            }
            orderSearchTimeout = setTimeout(async () => {
                const items = await searchItems('order', query, ordersUrl);
                renderSearchResults(orderResults, items, 'order', (item) => {
                    setFieldValue('order_id', item.id);
                    const orderSearch = form?.querySelector('[data-workshop-advance-order-search]');
                    if (orderSearch instanceof HTMLInputElement) {
                        orderSearch.value = item.order_number || item.label || '';
                        orderSearch.readOnly = true;
                    }
                });
            }, 300);
        });
        orderSearchInput.addEventListener('focus', () => {
            if (orderSearchInput.value.trim().length >= 2 && !orderSearchInput.readOnly) {
                orderSearchInput.dispatchEvent(new Event('input'));
            }
        });
    }
    const handleSubmit = async () => {
        if (!form || !submitButton || !submitLabel) return;
        const mode = form.dataset.mode ?? 'create';
        const advanceId = form.dataset.workshopAdvanceId ?? '';
        const payload = {
            order_id: getFieldValue('order_id'),
            currency: 'USD', // Siempre USD
            amount: getFieldValue('amount'),
            payment_date: getFieldValue('payment_date'),
            payment_method_id: getFieldValue('payment_method_id') || null,
            reference: getFieldValue('reference') || null,
            notes: getFieldValue('notes') || null,
            status: getFieldValue('status') || 'A',
        };
        clearFormErrors();
        const validationErrors = {};
        if (!payload.order_id) validationErrors.order_id = tx('Debes seleccionar una orden de trabajo.');
        if (!payload.amount) validationErrors.amount = tx('Debes ingresar el monto del abono.');
        if (!payload.payment_date) validationErrors.payment_date = tx('Debes ingresar la fecha de pago.');
        if (Object.keys(validationErrors).length > 0) {
            applyFormErrors(validationErrors);
            showAlert({ title: tx('Hay errores en el formulario'), text: tx('Revisa los campos resaltados.'), icon: 'error' });
            return;
        }
        setSubmitLoading(true);
        const url = mode === 'create' ? storeUrl : `${baseUrl}/${advanceId}`;
        const method = mode === 'create' ? 'POST' : 'PATCH';
        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });
            const json = await response.json().catch(() => null);
            if (!response.ok) {
                if (response.status === 422 && json?.errors) {
                    applyFormErrors(json.errors);
                    showAlert({ title: tx('Hay errores en el formulario'), text: json.message ?? tx('Revisa los campos resaltados.'), icon: 'error' });
                } else {
                    showAlert({ title: tx('Error'), text: json?.message ?? tx('No fue posible guardar la información.'), icon: 'error' });
                }
                return;
            }
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Acción realizada correctamente.'), icon: 'success' });
            closeModal(modals.form);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopAdvances] Submit error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al guardar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            setSubmitLoading(false);
        }
    };
    const closeSearchDropdowns = () => {
        if (orderResults) {
            orderResults.hidden = true;
            orderResults.dataset.open = 'false';
        }
    };
    document.addEventListener('click', (event) => {
        if (!event.target) return;
        if (!form?.contains(event.target) && !orderResults?.contains(event.target)) {
            closeSearchDropdowns();
        }
    });
    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleSubmit();
        });
    }
    root.addEventListener('click', (event) => {
        if (!(event.target instanceof Element)) return;
        
        let actionEl = event.target.closest('[data-workshop-advance-action], [data-action], [data-row-action]');
        if (!actionEl) return;
        
        // If we clicked on an icon or other child element inside a button, use the button as actionEl
        if (actionEl.tagName !== 'BUTTON' && actionEl.hasAttribute('data-action')) {
            const buttonParent = actionEl.closest('button[data-action], button[data-row-action]');
            if (buttonParent) {
                actionEl = buttonParent;
            }
        }
        
        const payloadSource = actionEl.dataset.rowPayload ? actionEl : actionEl.closest('[data-row-payload]');
        let data = null;
        const payloadValue = payloadSource?.dataset?.rowPayload ?? actionEl.dataset.rowPayload ?? null;
        if (payloadValue) {
            try {
                data = decodePayload(payloadValue);
            } catch (error) {
                console.error('[WorkshopAdvances] payload decode error', error, { payloadValue });
            }
        }
        const dataset = actionEl.dataset ?? {};
        let rowAction = dataset.workshopAdvanceAction ?? dataset.action ?? dataset.rowAction ?? null;
        if (rowAction === 'create') {
            setMode('create');
            openModal(modals.form);
            loadOptions();
            return;
        }
        if (!rowAction) return;
        // Get row ID and name from button attributes if data is not available
        const rowId = (actionEl.dataset.id || actionEl.dataset.rowId) ?? '';
        const rowName = (actionEl.dataset.name || actionEl.dataset.rowName) ?? '';
        
        // If no data from payload, create from button attributes
        if (!data && rowId) {
            data = {
                id: rowId,
                amount_formatted: rowName || null,
            };
        }

        if (rowAction === 'view') {
            // Always fetch full data from server to ensure we have all fields
            const advanceId = data?.id ?? rowId ?? '';
            if (!advanceId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            console.log('[WorkshopAdvances] Fetching advance', { advanceId, url: `${baseUrl}/${advanceId}`, data, rowId });
            fetch(`${baseUrl}/${advanceId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => {
                    console.log('[WorkshopAdvances] Response received', { status: response.status, ok: response.ok, url: response.url });
                    return response.json().then((json) => ({ response, json }));
                })
                .then(({ response, json }) => {
                    if (response.ok && json?.data?.item) {
                        populateViewModal(json.data.item);
                        openModal(modals.view);
                    } else {
                        console.error('[WorkshopAdvances] Error response', { response: { status: response.status, ok: response.ok }, json });
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopAdvances] Fetch error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                });
            return;
        }
        if (rowAction === 'edit') {
            // Always fetch full data from server to ensure we have all fields
            const advanceId = data?.id ?? rowId ?? '';
            if (!advanceId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            fetch(`${baseUrl}/${advanceId}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    if (json?.data?.item) {
                        setMode('edit', json.data.item);
                        openModal(modals.form);
                        loadOptions();
                    } else {
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopAdvances] Fetch error', error);
                    showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                });
            return;
        }
        if (rowAction === 'delete') {
            const deleteId = data?.id ?? rowId ?? '';
            if (!deleteId) {
                showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos seleccionados.'), icon: 'error' });
                return;
            }
            // If we only have ID, fetch full data from server to get advance summary
            if (!data || Object.keys(data).length <= 2) {
                fetch(`${baseUrl}/${deleteId}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then((response) => response.json())
                    .then((json) => {
                        if (json?.data?.item) {
                            data = json.data.item;
                            openDeleteModal(data, deleteId);
                        } else {
                            showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                        }
                    })
                    .catch((error) => {
                        console.error('[WorkshopAdvances] Fetch error', error);
                        showAlert({ title: tx('Error'), text: tx('No se pudieron obtener los datos del registro.'), icon: 'error' });
                    });
            } else {
                openDeleteModal(data, deleteId);
            }
            return;
        }
    });
    
    const openDeleteModal = (data, deleteId) => {
        if (!modals.delete || !deleteId) return;
        modals.delete.dataset.workshopAdvanceId = deleteId;
        if (deleteName) {
            const summary = data.amount_formatted 
                ? `${data.amount_formatted}${data.order_number ? ' - Orden: ' + data.order_number : ''}${data.customer_name ? ' - ' + data.customer_name : ''}`
                : data.order_number 
                    ? `Orden: ${data.order_number}${data.customer_name ? ' - ' + data.customer_name : ''}`
                    : deleteId;
            deleteName.textContent = summary;
        }
        openModal(modals.delete);
    };

    const handleDelete = async () => {
        if (!modals.delete || !deleteConfirmButton) return;
        const advanceId = modals.delete.dataset.workshopAdvanceId;
        if (!advanceId) {
            closeModal(modals.delete);
            return;
        }
        deleteConfirmButton.disabled = true;
        deleteConfirmButton.classList.add('cursor-not-allowed', 'opacity-70');
        try {
            const response = await fetch(`${baseUrl}/${advanceId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });
            const json = await response.json().catch(() => null);
            if (!response.ok) {
                showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo eliminar el registro.'), icon: 'error' });
                return;
            }
            showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('Registro eliminado correctamente.'), icon: 'success' });
            closeModal(modals.delete);
            refreshTable();
        } catch (error) {
            console.error('[WorkshopAdvances] Delete error', error);
            showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al eliminar. Inténtalo nuevamente.'), icon: 'error' });
        } finally {
            deleteConfirmButton.disabled = false;
            deleteConfirmButton.classList.remove('cursor-not-allowed', 'opacity-70');
        }
    };

    if (deleteConfirmButton) {
        deleteConfirmButton.addEventListener('click', handleDelete);
    }
    
    root.addEventListener('change', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement && target.matches('[data-status-toggle]')) {
            const advanceId = target.dataset.id ?? '';
            if (!advanceId || target.disabled) return;
            const previousChecked = !target.checked;
            const newStatus = target.checked ? 'A' : 'I';
            target.disabled = true;
            fetch(`${baseUrl}/${advanceId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ status: newStatus }),
            })
                .then((response) => response.json().catch(() => null))
                .then((json) => {
                    if (json?.status === 'success') {
                        showAlert({ title: tx('Datos actualizados'), text: json?.message ?? tx('El estado se modificó correctamente.'), icon: 'success' });
                        refreshTable();
                    } else {
                        target.checked = previousChecked;
                        showAlert({ title: tx('Error'), text: json?.message ?? tx('No se pudo actualizar el estado.'), icon: 'error' });
                    }
                })
                .catch((error) => {
                    console.error('[WorkshopAdvances] Status toggle error', error);
                    target.checked = previousChecked;
                    showAlert({ title: tx('Error'), text: tx('Ocurrió un problema al actualizar el estado.'), icon: 'error' });
                })
                .finally(() => {
                    target.disabled = false;
                });
        }
    });
};

// Helper function to get action from button (supports both data-action and data-row-action)
const getActionFromButton = (button) => {
    if (!button) return null;
    // Try data-action first (new format), then data-row-action (old format)
    return button.dataset.action || button.dataset.rowAction || null;
};

// Helper function to get row ID from button (supports multiple formats)
const getRowIdFromButton = (button) => {
    if (!button) return null;
    return button.dataset.id || button.dataset.rowId || null;
};

// Helper function to get row name from button (supports multiple formats)
const getRowNameFromButton = (button) => {
    if (!button) return null;
    return button.dataset.name || button.dataset.rowName || null;
};

// Global handler for barcode buttons in data tables
const initGlobalBarcodeHandler = () => {
    // Use capture phase to handle before any other listeners
    document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
            return;
        }
        
        // Find the closest button with data-action="barcode" or data-url for barcode
        const barcodeButton = target.closest('button[data-action="barcode"], button[data-row-action="barcode"]');
        if (!barcodeButton) {
            return;
        }
        
        const barcodeUrl = barcodeButton.dataset.url || barcodeButton.dataset.barcodeUrl || '';
        if (!barcodeUrl) {
            return;
        }
        
        // Prevent default behavior and stop propagation immediately
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        
        // Open in new tab only, never navigate current page
        const popup = window.open(barcodeUrl, '_blank', 'noopener,noreferrer');
        if (popup && !popup.closed) {
            popup.focus();
        } else {
            // If popup was blocked, show alert instead of navigating
            console.warn('[GlobalBarcodeHandler] Popup blocked for barcode URL:', barcodeUrl);
        }
        
        // Return false to prevent any further processing
        return false;
    }, true); // Capture phase - handles before bubbling phase listeners
};

// Global handler for data table action buttons (view, edit, delete)
// DISABLED: Module-specific handlers should handle their own actions
// This is kept for future reference but should not interfere with module handlers
const initGlobalDataTableActions = () => {
    // DISABLED - Modules handle their own actions
    // The issue was that this handler was interfering with module-specific handlers
    // and constructing incorrect URLs. All modules should handle their own actions.
    return;
};

const initApp = () => {
    initFlashAlerts();
    initPasswordToggles();
    initOtpForm();
    initThemeToggles();
    initDropdowns();
    initSidebarToggle();
    initSidebarAccordions();
    initDropzones();
    initCustomSelects();
    initGlobalBarcodeHandler();
    initGlobalDataTableActions();
    initUsersModule();
    initRolesModule();
    initPermissionsModule();
    initBranchesModule();
    initDocumentSequencesModule();
    initPaymentCardsModule();
    initBankAccountsModule();
    initIncomeTypesModule();
    initExpenseTypesModule();
    initIncomesModule();
    initExpensesModule();
    initReceivablesModule();
    initPayablesModule();
    initReceivableCategoriesModule();
    initPayableCategoriesModule();
    initProductLinesModule();
    initProductCategoriesModule();
    initCompanyProfile();
    initNotificationsDropdown();
    initNotificationPageList();
    initServiceCategoriesModule();
    initWorkshopCategoriesModule();
    initWorkshopBrandsModule();
    initWorkshopModelsModule();
    initWorkshopEquipmentsModule();
    initServicesModule();
    initWarehousesModule();
    initPriceListsModule();
    initProductsIndexModule();
    initProductsFormModule();
    initProductTransfersModule();
    initProvidersModule();
    initCustomerCategoriesModule();
    initCustomersModule();
    initWorkshopStatesModule();
    initWorkshopOrdersModule();
    initWorkshopAdvancesModule();
    initWorkshopOrderCreateForm();
    initWorkshopOrderEditForm();
    initPOSModule();
    initQuotationForm();
};

// Workshop Order Create Form Module
const initWorkshopOrderCreateForm = () => {
    const root = document.querySelector('[data-workshop-order-form-root]');
    if (!root) return;

    const form = root.querySelector('form[method="POST"]');
    if (!form) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const baseUrl = window.location.origin;
    const customersUrl = `${baseUrl}/workshop/work-orders/search/customers`;
    const equipmentsUrl = `${baseUrl}/workshop/work-orders/search/equipments`;
    const responsiblesUrl = `${baseUrl}/workshop/work-orders/search/responsibles`;
    const categoriesUrl = `${baseUrl}/workshop/categories/options`;
    const statesUrl = `${baseUrl}/workshop/states/options`;
    const accessoriesUrl = `${baseUrl}/workshop/accessories/options`;

    const selectedAccessories = new Set();

    const tx = (message) => {
        try {
            if (typeof window !== 'undefined' && typeof window.gettext === 'function') {
                return window.gettext(message);
            }
        } catch (error) {
            console.warn('[WorkshopOrderCreate] translate error', error, message);
        }
        return message;
    };

    // Search handlers
    let customerSearchTimeout = null;
    let equipmentSearchTimeout = null;
    let responsibleSearchTimeout = null;
    let accessorySearchTimeout = null;

    const loadCustomers = async (search = '') => {
        const optionsContainer = root.querySelector('[data-order-customer-options]');
        if (!optionsContainer) return;

        clearTimeout(customerSearchTimeout);
        customerSearchTimeout = setTimeout(async () => {
            try {
                const searchParam = search && search.length > 0 ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`${customersUrl}?limit=50${searchParam}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items) {
                    optionsContainer.innerHTML = '';
                    if (json.data.items.length === 0) {
                        optionsContainer.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No se encontraron clientes') + '</div>';
                    } else {
                        json.data.items.forEach((customer) => {
                            // Construir el nombre completo: primero intentar name/display_name, luego first_name + last_name, luego business_name
                            let customerName = customer.name || customer.display_name || '';
                            if (!customerName && customer.first_name) {
                                customerName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim();
                            }
                            if (!customerName && customer.business_name) {
                                customerName = customer.business_name;
                            }
                            if (!customerName) {
                                customerName = gettext('Sin nombre');
                            }
                            
                            const customerDoc = customer.document_number || '';
                            const displayLabel = customerDoc ? `${customerName} - ${customerDoc}` : customerName;
                            const displayValue = customerDoc ? `${customerName} - ${customerDoc}` : customerName;
                            
                            const optionEl = document.createElement('button');
                            optionEl.type = 'button';
                            optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                            optionEl.dataset.selectOption = '';
                            optionEl.dataset.value = customer.id;
                            optionEl.dataset.label = displayLabel;
                            optionEl.dataset.selected = 'false';
                            optionEl.innerHTML = `
                                <div class="flex-1">
                                    <p class="font-medium">${customerName}</p>
                                    ${customerDoc ? `<p class="text-xs text-gray-500 dark:text-gray-400">${customerDoc}</p>` : ''}
                                </div>
                                <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
                            `;
                            optionEl.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const select = root.querySelector('[data-select-name="customer_id"]');
                                if (select) {
                                    const input = select.querySelector('[data-select-input]');
                                    const valueSpan = select.querySelector('[data-select-value]');
                                    if (input) input.value = customer.id;
                                    if (valueSpan) valueSpan.textContent = displayValue;
                                    const dropdown = select.querySelector('[data-select-dropdown]');
                                    if (dropdown) {
                                        dropdown.hidden = true;
                                        dropdown.dataset.open = 'false';
                                    }
                                    const trigger = select.querySelector('[data-select-trigger]');
                                    if (trigger) trigger.setAttribute('aria-expanded', 'false');
                                    const icon = select.querySelector('[data-select-icon]');
                                    if (icon) icon.classList.remove('rotate-180');
                                    // Marcar como seleccionado
                                    optionsContainer.querySelectorAll('[data-select-option]').forEach(opt => {
                                        opt.dataset.selected = 'false';
                                    });
                                    optionEl.dataset.selected = 'true';
                                }
                            });
                            optionsContainer.appendChild(optionEl);
                        });
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrderCreate] Error loading customers', error);
            }
        }, 300);
    };

    const loadEquipments = async (search = '') => {
        const optionsContainer = root.querySelector('[data-order-equipment-options]');
        if (!optionsContainer) return;

        clearTimeout(equipmentSearchTimeout);
        equipmentSearchTimeout = setTimeout(async () => {
            try {
                const searchParam = search && search.length > 0 ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`${equipmentsUrl}?limit=50${searchParam}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items) {
                    optionsContainer.innerHTML = '';
                    if (json.data.items.length === 0) {
                        optionsContainer.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No se encontraron equipos') + '</div>';
                    } else {
                        json.data.items.forEach((equipment) => {
                            const optionEl = document.createElement('button');
                            optionEl.type = 'button';
                            optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                            optionEl.dataset.selectOption = '';
                            optionEl.dataset.value = equipment.id;
                            optionEl.dataset.label = equipment.label || '';
                            optionEl.dataset.selected = 'false';
                            optionEl.innerHTML = `<span class="truncate">${equipment.label || ''}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                            optionEl.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const select = root.querySelector('[data-select-name="equipment_id"]');
                                if (select) {
                                    const input = select.querySelector('[data-select-input]');
                                    const valueSpan = select.querySelector('[data-select-value]');
                                    if (input) input.value = equipment.id;
                                    if (valueSpan) valueSpan.textContent = equipment.label || '';
                                    const dropdown = select.querySelector('[data-select-dropdown]');
                                    if (dropdown) {
                                        dropdown.hidden = true;
                                        dropdown.dataset.open = 'false';
                                    }
                                    const trigger = select.querySelector('[data-select-trigger]');
                                    if (trigger) trigger.setAttribute('aria-expanded', 'false');
                                    const icon = select.querySelector('[data-select-icon]');
                                    if (icon) icon.classList.remove('rotate-180');
                                    // Marcar como seleccionado
                                    optionsContainer.querySelectorAll('[data-select-option]').forEach(opt => {
                                        opt.dataset.selected = 'false';
                                    });
                                    optionEl.dataset.selected = 'true';
                                }
                            });
                            optionsContainer.appendChild(optionEl);
                        });
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrderCreate] Error loading equipments', error);
            }
        }, 300);
    };

    const loadResponsibles = async (search = '') => {
        const optionsContainer = root.querySelector('[data-order-responsible-options]');
        if (!optionsContainer) return;

        clearTimeout(responsibleSearchTimeout);
        responsibleSearchTimeout = setTimeout(async () => {
            try {
                const searchParam = search && search.length > 0 ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`${responsiblesUrl}?limit=50${searchParam}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items) {
                    optionsContainer.innerHTML = '';
                    if (json.data.items.length === 0) {
                        optionsContainer.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No se encontraron usuarios') + '</div>';
                    } else {
                        json.data.items.forEach((user) => {
                            const userName = user.name || user.full_name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email || '';
                            const userDoc = user.document_number || '';
                            const displayLabel = userDoc ? `${userName} - ${userDoc}` : userName;
                            const displayValue = userDoc ? `${userName} - ${userDoc}` : userName;
                            
                            const optionEl = document.createElement('button');
                            optionEl.type = 'button';
                            optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                            optionEl.dataset.selectOption = '';
                            optionEl.dataset.value = user.id;
                            optionEl.dataset.label = displayLabel;
                            optionEl.dataset.selected = 'false';
                            optionEl.innerHTML = `
                                <div class="flex-1">
                                    <p class="font-medium">${userName}</p>
                                    ${userDoc ? `<p class="text-xs text-gray-500 dark:text-gray-400">${userDoc}</p>` : ''}
                                </div>
                                <i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>
                            `;
                            optionEl.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const select = root.querySelector('[data-select-name="responsible_user_id"]');
                                if (select) {
                                    const input = select.querySelector('[data-select-input]');
                                    const valueSpan = select.querySelector('[data-select-value]');
                                    if (input) input.value = user.id;
                                    if (valueSpan) valueSpan.textContent = displayValue;
                                    const dropdown = select.querySelector('[data-select-dropdown]');
                                    if (dropdown) {
                                        dropdown.hidden = true;
                                        dropdown.dataset.open = 'false';
                                    }
                                    const trigger = select.querySelector('[data-select-trigger]');
                                    if (trigger) trigger.setAttribute('aria-expanded', 'false');
                                    const icon = select.querySelector('[data-select-icon]');
                                    if (icon) icon.classList.remove('rotate-180');
                                    // Marcar como seleccionado
                                    optionsContainer.querySelectorAll('[data-select-option]').forEach(opt => {
                                        opt.dataset.selected = 'false';
                                    });
                                    optionEl.dataset.selected = 'true';
                                }
                            });
                            optionsContainer.appendChild(optionEl);
                        });
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrderCreate] Error loading responsibles', error);
            }
        }, 300);
    };

    const searchAccessories = async (search) => {
        if (!search || search.length < 2) {
            const results = root.querySelector('[data-order-accessories-results]');
            if (results) {
                results.innerHTML = '';
                results.hidden = true;
                results.dataset.open = 'false';
            }
            return;
        }

        clearTimeout(accessorySearchTimeout);
        accessorySearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`${accessoriesUrl}?search=${encodeURIComponent(search)}&limit=20`, {
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });
                const json = await response.json();
                const results = root.querySelector('[data-order-accessories-results]');
                const searchInput = root.querySelector('[data-order-accessories-search]');
                if (json?.status === 'success' && json?.data?.items && results) {
                    results.innerHTML = '';
                    if (json.data.items.length === 0) {
                        results.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No se encontraron accesorios') + '</div>';
                    } else {
                        json.data.items.forEach((accessory) => {
                            if (selectedAccessories.has(accessory.id)) return;
                            const itemEl = document.createElement('button');
                            itemEl.type = 'button';
                            itemEl.className = 'flex w-full items-center justify-between px-4 py-3 text-left text-sm text-gray-900 transition hover:bg-gray-50 dark:text-white dark:hover:bg-slate-800';
                            itemEl.innerHTML = `<p class="font-medium">${accessory.name || ''}</p>`;
                            itemEl.addEventListener('click', () => {
                                selectedAccessories.add(accessory.id);
                                const container = root.querySelector('[data-order-accessories-selected]');
                                if (container) {
                                    const badge = document.createElement('span');
                                    badge.className = 'inline-flex items-center gap-2 rounded-lg bg-primary/10 px-3 py-1.5 text-sm font-medium text-primary';
                                    badge.innerHTML = `
                                        ${accessory.name}
                                        <input type="hidden" name="accessories[]" value="${accessory.id}">
                                        <button type="button" class="ml-2 hover:text-primary-strong" data-accessory-remove="${accessory.id}">
                                            <i class="fa-solid fa-xmark text-xs"></i>
                                        </button>
                                    `;
                                    container.appendChild(badge);
                                    badge.querySelector(`[data-accessory-remove="${accessory.id}"]`)?.addEventListener('click', () => {
                                        selectedAccessories.delete(accessory.id);
                                        badge.remove();
                                    });
                                }
                                if (searchInput) searchInput.value = '';
                                results.hidden = true;
                                results.dataset.open = 'false';
                            });
                            results.appendChild(itemEl);
                        });
                    }
                    results.hidden = false;
                    results.dataset.open = 'true';
                }
            } catch (error) {
                console.error('[WorkshopOrderCreate] Error searching accessories', error);
            }
        }, 300);
    };

    // Load categories
    const loadCategories = async () => {
        try {
            const response = await fetch(categoriesUrl, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            
            if (!response.ok) {
                const text = await response.text();
                console.error('[WorkshopOrderCreate] Error loading categories - Response not OK', {
                    status: response.status,
                    statusText: response.statusText,
                    url: categoriesUrl,
                    body: text.substring(0, 200),
                });
                return;
            }
            
            const json = await response.json().catch((err) => {
                console.error('[WorkshopOrderCreate] Error parsing JSON', err);
                return null;
            });
            
            if (!json) return;
            
            const container = root.querySelector('[data-order-category-options]');
            const categorySelect = root.querySelector('[data-select-name="category_id"]');
            if (json?.status === 'success' && json?.data?.items && container) {
                container.innerHTML = '';
                json.data.items.forEach((category) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    option.dataset.selectOption = '';
                    option.dataset.value = category.id;
                    option.dataset.label = category.name;
                    option.innerHTML = `<span class="truncate">${category.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    container.appendChild(option);
                });
                if (categorySelect) initCustomSelect(categorySelect);
            }
        } catch (error) {
            console.error('[WorkshopOrderCreate] Error loading categories', error);
        }
    };

    // Load states based on category
    const loadStates = async (categoryId) => {
        if (!categoryId) return;
        try {
            const url = new URL(statesUrl, window.location.origin);
            url.searchParams.set('category_id', categoryId);
            
            const response = await fetch(url.toString(), {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            
            if (!response.ok) {
                const text = await response.text();
                console.error('[WorkshopOrderCreate] Error loading states - Response not OK', {
                    status: response.status,
                    statusText: response.statusText,
                    url: url.toString(),
                    body: text.substring(0, 200),
                });
                return;
            }
            
            const json = await response.json().catch((err) => {
                console.error('[WorkshopOrderCreate] Error parsing JSON', err);
                return null;
            });
            
            if (!json) return;
            
            const container = root.querySelector('[data-order-state-options]');
            const stateSelect = root.querySelector('[data-select-name="state_id"]');
            if (json?.status === 'success' && json?.data?.items && container) {
                container.innerHTML = '';
                const trigger = stateSelect?.querySelector('[data-select-trigger]');
                if (trigger) trigger.disabled = false;
                json.data.items.forEach((state) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    option.dataset.selectOption = '';
                    option.dataset.value = state.id;
                    option.dataset.label = state.name;
                    option.innerHTML = `<span class="truncate">${state.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    container.appendChild(option);
                });
                if (stateSelect) initCustomSelect(stateSelect);
            }
        } catch (error) {
            console.error('[WorkshopOrderCreate] Error loading states', error);
        }
    };

    // Load priority options
    const loadPriorityOptions = () => {
        const priorities = [
            { value: 'Baja', label: tx('Baja') },
            { value: 'Normal', label: tx('Normal') },
            { value: 'Alta', label: tx('Alta') },
            { value: 'Urgente', label: tx('Urgente') },
        ];
        const container = root.querySelector('[data-order-priority-options]');
        const prioritySelect = root.querySelector('[data-select-name="priority"]');
        if (container) {
            container.innerHTML = '';
            priorities.forEach((priority) => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                option.dataset.selectOption = '';
                option.dataset.value = priority.value;
                option.dataset.label = priority.label;
                option.innerHTML = `<span class="truncate">${priority.label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                container.appendChild(option);
            });
        }
        if (prioritySelect) initCustomSelect(prioritySelect);
    };

    // Load diagnosis options
    const loadDiagnosisOptions = () => {
        const options = [
            { value: '0', label: tx('No') },
            { value: '1', label: tx('Sí') },
        ];
        const container = root.querySelector('[data-order-diagnosis-options]');
        const diagnosisSelect = root.querySelector('[data-select-name="diagnosis"]');
        if (container) {
            container.innerHTML = '';
            options.forEach((opt) => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                option.dataset.selectOption = '';
                option.dataset.value = opt.value;
                option.dataset.label = opt.label;
                option.innerHTML = `<span class="truncate">${opt.label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                container.appendChild(option);
            });
        }
        if (diagnosisSelect) initCustomSelect(diagnosisSelect);
    };

    // Load warranty options
    const loadWarrantyOptions = () => {
        const options = [
            { value: '0', label: tx('No') },
            { value: '1', label: tx('Sí') },
        ];
        const container = root.querySelector('[data-order-warranty-options]');
        const warrantySelect = root.querySelector('[data-select-name="warranty"]');
        if (container) {
            container.innerHTML = '';
            options.forEach((opt) => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                option.dataset.selectOption = '';
                option.dataset.value = opt.value;
                option.dataset.label = opt.label;
                option.innerHTML = `<span class="truncate">${opt.label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                container.appendChild(option);
            });
        }
        if (warrantySelect) initCustomSelect(warrantySelect);
    };

    // Initialize custom select
    const initCustomSelect = (selectRoot) => {
        if (!selectRoot) return;
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const dropdown = selectRoot.querySelector('[data-select-dropdown]');
        const icon = selectRoot.querySelector('[data-select-icon]');
        const hiddenInput = selectRoot.querySelector('[data-select-input]');
        const options = selectRoot.querySelectorAll('[data-select-option]');
        if (!trigger || !dropdown || !hiddenInput) return;

        const closeSelect = () => {
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
            selectRoot.dataset.open = 'false';
            trigger.setAttribute('aria-expanded', 'false');
            icon?.classList.remove('rotate-180');
        };

        const openSelect = () => {
            dropdown.hidden = false;
            dropdown.dataset.open = 'true';
            selectRoot.dataset.open = 'true';
            trigger.setAttribute('aria-expanded', 'true');
            icon?.classList.add('rotate-180');
        };

        trigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isOpen = selectRoot.dataset.open === 'true';
            if (isOpen) {
                closeSelect();
            } else {
                openSelect();
            }
        });

        options.forEach((option) => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const value = option.dataset.value || '';
                const label = option.dataset.label || option.textContent.trim();
                hiddenInput.value = value;
                const valueLabel = selectRoot.querySelector('[data-select-value]');
                if (valueLabel) valueLabel.textContent = label;
                options.forEach((opt) => {
                    opt.dataset.selected = opt.dataset.value === value ? 'true' : 'false';
                });
                closeSelect();
                hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Si es el select de categoría, cargar estados
                if (hiddenInput.name === 'category_id') {
                    const stateSelect = root.querySelector('[data-select-name="state_id"]');
                    const stateInput = stateSelect?.querySelector('[data-select-input]');
                    const stateValueLabel = stateSelect?.querySelector('[data-select-value]');
                    const stateTrigger = stateSelect?.querySelector('[data-select-trigger]');
                    if (stateInput) stateInput.value = '';
                    if (stateValueLabel && stateTrigger) {
                        stateValueLabel.textContent = stateTrigger.dataset.selectPlaceholder || tx('Selecciona un estado');
                    }
                    loadStates(value);
                }
            });
        });

        document.addEventListener('click', (e) => {
            if (!selectRoot.contains(e.target)) {
                closeSelect();
            }
        });
    };

    // Initialize custom selects with search
    const customerSelect = root.querySelector('[data-select-name="customer_id"]');
    if (customerSelect) {
        const trigger = customerSelect.querySelector('[data-select-trigger]');
        const dropdown = customerSelect.querySelector('[data-select-dropdown]');
        const searchInput = customerSelect.querySelector('[data-order-customer-search]');
        
        if (trigger && dropdown) {
            const closeSelect = () => {
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
                customerSelect.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                const icon = customerSelect.querySelector('[data-select-icon]');
                if (icon) icon.classList.remove('rotate-180');
            };
            
            const openSelect = () => {
                dropdown.hidden = false;
                dropdown.dataset.open = 'true';
                customerSelect.dataset.open = 'true';
                trigger.setAttribute('aria-expanded', 'true');
                const icon = customerSelect.querySelector('[data-select-icon]');
                if (icon) icon.classList.add('rotate-180');
                loadCustomers(''); // Cargar todas las opciones al abrir
            };
            
            trigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopImmediatePropagation();
                const isOpen = dropdown.dataset.open === 'true';
                if (isOpen) {
                    closeSelect();
                } else {
                    openSelect();
                }
            }, true);
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    e.stopPropagation();
                    loadCustomers(e.target.value.trim());
                });
            }
            
            document.addEventListener('click', (e) => {
                if (!customerSelect.contains(e.target)) {
                    closeSelect();
                }
            });
        }
    }

    const equipmentSelect = root.querySelector('[data-select-name="equipment_id"]');
    if (equipmentSelect) {
        const trigger = equipmentSelect.querySelector('[data-select-trigger]');
        const dropdown = equipmentSelect.querySelector('[data-select-dropdown]');
        const searchInput = equipmentSelect.querySelector('[data-order-equipment-search]');
        
        if (trigger && dropdown) {
            const closeSelect = () => {
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
                equipmentSelect.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                const icon = equipmentSelect.querySelector('[data-select-icon]');
                if (icon) icon.classList.remove('rotate-180');
            };
            
            const openSelect = () => {
                dropdown.hidden = false;
                dropdown.dataset.open = 'true';
                equipmentSelect.dataset.open = 'true';
                trigger.setAttribute('aria-expanded', 'true');
                const icon = equipmentSelect.querySelector('[data-select-icon]');
                if (icon) icon.classList.add('rotate-180');
                loadEquipments(''); // Cargar todas las opciones al abrir
            };
            
            trigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopImmediatePropagation();
                const isOpen = dropdown.dataset.open === 'true';
                if (isOpen) {
                    closeSelect();
                } else {
                    openSelect();
                }
            }, true);
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    e.stopPropagation();
                    loadEquipments(e.target.value.trim());
                });
            }
            
            document.addEventListener('click', (e) => {
                if (!equipmentSelect.contains(e.target)) {
                    closeSelect();
                }
            });
        }
    }

    const responsibleSelect = root.querySelector('[data-select-name="responsible_user_id"]');
    if (responsibleSelect) {
        const trigger = responsibleSelect.querySelector('[data-select-trigger]');
        const dropdown = responsibleSelect.querySelector('[data-select-dropdown]');
        const searchInput = responsibleSelect.querySelector('[data-order-responsible-search]');
        
        if (trigger && dropdown) {
            const closeSelect = () => {
                dropdown.hidden = true;
                dropdown.dataset.open = 'false';
                responsibleSelect.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                const icon = responsibleSelect.querySelector('[data-select-icon]');
                if (icon) icon.classList.remove('rotate-180');
            };
            
            const openSelect = () => {
                dropdown.hidden = false;
                dropdown.dataset.open = 'true';
                responsibleSelect.dataset.open = 'true';
                trigger.setAttribute('aria-expanded', 'true');
                const icon = responsibleSelect.querySelector('[data-select-icon]');
                if (icon) icon.classList.add('rotate-180');
                loadResponsibles(''); // Cargar todas las opciones al abrir
            };
            
            trigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopImmediatePropagation();
                const isOpen = dropdown.dataset.open === 'true';
                if (isOpen) {
                    closeSelect();
                } else {
                    openSelect();
                }
            }, true);
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    e.stopPropagation();
                    loadResponsibles(e.target.value.trim());
                });
            }
            
            document.addEventListener('click', (e) => {
                if (!responsibleSelect.contains(e.target)) {
                    closeSelect();
                }
            });
        }
    }

    root.querySelector('[data-order-accessories-search]')?.addEventListener('input', (e) => {
        searchAccessories(e.target.value.trim());
    });

    // Initialize selects
    loadCategories();
    loadPriorityOptions();
    loadDiagnosisOptions();
    loadWarrantyOptions();
};

// Workshop Order Edit Form Module
const initWorkshopOrderEditForm = () => {
    const root = document.querySelector('[data-workshop-order-edit-root]');
    if (!root) {
        return;
    }
    const orderId = root.dataset.orderId;
    if (!orderId) {
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const baseUrl = window.location.origin;
    const categoriesUrl = `${baseUrl}/workshop/categories/options`;
    const statesUrl = `${baseUrl}/workshop/states/options`;

    // Notes elements - modales están fuera del root, buscar en document
    const notesList = root.querySelector('[data-order-notes-list]');
    const noteModal = document.querySelector('[data-order-note-modal]');
    const noteForm = noteModal?.querySelector('[data-order-note-form]');
    const noteModalTitle = noteModal?.querySelector('[data-order-note-modal-title]');
    const noteTextArea = noteForm?.querySelector('[data-order-note-text]');
    const noteIdInput = noteForm?.querySelector('[data-order-note-id]');
    console.log('[WorkshopOrderEdit] Notes elements', { notesList, noteModal, noteForm, noteModalTitle, noteTextArea, noteIdInput });

    // Items elements - modales están fuera del root, buscar en document
    const itemsList = root.querySelector('[data-order-items-list]');
    const itemModal = document.querySelector('[data-order-item-modal]');
    const itemForm = itemModal?.querySelector('[data-order-item-form]');
    const itemModalTitle = itemModal?.querySelector('[data-order-item-modal-title]');
    const itemProductSelect = itemForm?.querySelector('[data-order-item-product-select]');
    const itemProductSearch = itemForm?.querySelector('[data-order-item-product-search]');
    const itemProductOptions = itemForm?.querySelector('[data-order-item-product-options]');
    const itemProductIdInput = itemForm?.querySelector('[data-order-item-product-id]');
    const itemPriceListSelect = itemForm?.querySelector('[data-order-item-price-list-select]');
    const itemPriceListOptions = itemForm?.querySelector('[data-order-item-price-list-options]');
    const itemPriceListIdInput = itemForm?.querySelector('[data-order-item-price-list-id]');
    const itemQuantityInput = itemForm?.querySelector('[data-order-item-quantity]');
    const itemUnitPriceInput = itemForm?.querySelector('[data-order-item-unit-price]');
    const itemNotesInput = itemForm?.querySelector('[data-order-item-notes]');
    const itemIdInput = itemForm?.querySelector('[data-order-item-id]');
    console.log('[WorkshopOrderEdit] Items elements', { itemsList, itemModal, itemForm, itemModalTitle, itemProductSelect, itemPriceListSelect });

    // Services elements - modales están fuera del root, buscar en document
    const servicesList = root.querySelector('[data-order-services-list]');
    const serviceModal = document.querySelector('[data-order-service-modal]');
    const serviceForm = serviceModal?.querySelector('[data-order-service-form]');
    const serviceModalTitle = serviceModal?.querySelector('[data-order-service-modal-title]');
    const serviceCategorySelect = serviceForm?.querySelector('[data-order-service-category-select]');
    const serviceCategoryOptions = serviceForm?.querySelector('[data-order-service-category-options]');
    const serviceCategoryIdInput = serviceForm?.querySelector('[data-order-service-category-id]');
    const serviceServiceSelect = serviceForm?.querySelector('[data-order-service-service-select]');
    const serviceServiceSearch = serviceForm?.querySelector('[data-order-service-service-search]');
    const serviceServiceOptions = serviceForm?.querySelector('[data-order-service-service-options]');
    const serviceServiceIdInput = serviceForm?.querySelector('[data-order-service-service-id]');
    const serviceQuantityInput = serviceForm?.querySelector('[data-order-service-quantity]');
    const serviceUnitPriceInput = serviceForm?.querySelector('[data-order-service-unit-price]');
    const serviceNotesInput = serviceForm?.querySelector('[data-order-service-notes]');
    const serviceIdInput = serviceForm?.querySelector('[data-order-service-id]');
    console.log('[WorkshopOrderEdit] Services elements', { servicesList, serviceModal, serviceForm, serviceModalTitle, serviceCategorySelect, serviceServiceSelect });

    // Summary elements
    const itemsTotalEl = root.querySelector('[data-order-items-total]');
    const servicesTotalEl = root.querySelector('[data-order-services-total]');
    const totalCostEl = root.querySelector('[data-order-total-cost]');
    const totalPaidEl = root.querySelector('[data-order-total-paid]');
    const balanceEl = root.querySelector('[data-order-balance]');

    const tx = (message) => {
        try {
            if (typeof window !== 'undefined' && typeof window.gettext === 'function') {
                return window.gettext(message);
            }
        } catch (error) {
            console.warn('[WorkshopOrderEdit] translate error', error, message);
        }
        return message;
    };

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('es-ES', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(amount);
    };

    // Load categories
    const loadCategories = async () => {
        try {
            const response = await fetch(categoriesUrl, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            
            if (!response.ok) {
                const text = await response.text();
                console.error('[WorkshopOrderEdit] Error loading categories - Response not OK', {
                    status: response.status,
                    statusText: response.statusText,
                    url: categoriesUrl,
                    body: text.substring(0, 200),
                });
                return;
            }
            
            const json = await response.json().catch((err) => {
                console.error('[WorkshopOrderEdit] Error parsing JSON', err);
                return null;
            });
            
            if (!json) return;
            
            const container = root.querySelector('[data-order-category-options]');
            const categorySelect = root.querySelector('[data-select-name="category_id"]');
            const categoryInput = categorySelect?.querySelector('[data-select-input]');
            const currentCategoryId = categoryInput?.value || '';
            
            if (json?.status === 'success' && json?.data?.items && container) {
                container.innerHTML = '';
                json.data.items.forEach((category) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    option.dataset.selectOption = '';
                    option.dataset.value = category.id;
                    option.dataset.label = category.name;
                    option.dataset.selected = category.id === currentCategoryId ? 'true' : 'false';
                    option.innerHTML = `<span class="truncate">${category.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    container.appendChild(option);
                });
                if (categorySelect) initCustomSelect(categorySelect);
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading categories', error);
        }
    };

    // Load states based on category
    const loadStates = async (categoryId) => {
        if (!categoryId) return;
        try {
            const url = new URL(statesUrl, window.location.origin);
            url.searchParams.set('category_id', categoryId);
            
            const response = await fetch(url.toString(), {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            
            if (!response.ok) {
                const text = await response.text();
                console.error('[WorkshopOrderEdit] Error loading states - Response not OK', {
                    status: response.status,
                    statusText: response.statusText,
                    url: url.toString(),
                    body: text.substring(0, 200),
                });
                return;
            }
            
            const json = await response.json().catch((err) => {
                console.error('[WorkshopOrderEdit] Error parsing JSON', err);
                return null;
            });
            
            if (!json) return;
            
            const container = root.querySelector('[data-order-state-options]');
            const stateSelect = root.querySelector('[data-select-name="state_id"]');
            const stateInput = stateSelect?.querySelector('[data-select-input]');
            const currentStateId = stateInput?.value || '';
            
            if (json?.status === 'success' && json?.data?.items && container) {
                container.innerHTML = '';
                const trigger = stateSelect?.querySelector('[data-select-trigger]');
                if (trigger) trigger.disabled = false;
                json.data.items.forEach((state) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                    option.dataset.selectOption = '';
                    option.dataset.value = state.id;
                    option.dataset.label = state.name;
                    option.dataset.selected = state.id === currentStateId ? 'true' : 'false';
                    option.innerHTML = `<span class="truncate">${state.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                    container.appendChild(option);
                });
                if (stateSelect) initCustomSelect(stateSelect);
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading states', error);
        }
    };

    // Initialize custom select
    const initCustomSelect = (selectRoot) => {
        if (!selectRoot) return;
        const trigger = selectRoot.querySelector('[data-select-trigger]');
        const dropdown = selectRoot.querySelector('[data-select-dropdown]');
        const icon = selectRoot.querySelector('[data-select-icon]');
        const hiddenInput = selectRoot.querySelector('[data-select-input]');
        const options = selectRoot.querySelectorAll('[data-select-option]');
        if (!trigger || !dropdown || !hiddenInput) return;

        const closeSelect = () => {
            dropdown.hidden = true;
            dropdown.dataset.open = 'false';
            selectRoot.dataset.open = 'false';
            trigger.setAttribute('aria-expanded', 'false');
            icon?.classList.remove('rotate-180');
        };

        const openSelect = () => {
            dropdown.hidden = false;
            dropdown.dataset.open = 'true';
            selectRoot.dataset.open = 'true';
            trigger.setAttribute('aria-expanded', 'true');
            icon?.classList.add('rotate-180');
        };

        // Remove existing event listeners by cloning
        const newTrigger = trigger.cloneNode(true);
        trigger.parentNode?.replaceChild(newTrigger, trigger);
        const newOptions = dropdown.querySelectorAll('[data-select-option]');

        newTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isOpen = selectRoot.dataset.open === 'true';
            if (isOpen) {
                closeSelect();
            } else {
                openSelect();
            }
        });

        newOptions.forEach((option) => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const value = option.dataset.value || '';
                const label = option.dataset.label || option.textContent.trim();
                hiddenInput.value = value;
                const valueLabel = selectRoot.querySelector('[data-select-value]');
                if (valueLabel) valueLabel.textContent = label;
                newOptions.forEach((opt) => {
                    opt.dataset.selected = opt.dataset.value === value ? 'true' : 'false';
                });
                closeSelect();
                hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Si es el select de categoría, cargar estados
                if (hiddenInput.name === 'category_id') {
                    const stateSelect = root.querySelector('[data-select-name="state_id"]');
                    const stateInput = stateSelect?.querySelector('[data-select-input]');
                    const stateValueLabel = stateSelect?.querySelector('[data-select-value]');
                    const stateTrigger = stateSelect?.querySelector('[data-select-trigger]');
                    if (stateInput) stateInput.value = '';
                    if (stateValueLabel && stateTrigger) {
                        stateValueLabel.textContent = stateTrigger.dataset.selectPlaceholder || tx('Selecciona un estado');
                    }
                    loadStates(value);
                }
            });
        });

        document.addEventListener('click', (e) => {
            if (!selectRoot.contains(e.target)) {
                closeSelect();
            }
        });
    };

    const updateCostsSummary = async () => {
        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/json`, {
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });
            const json = await response.json();
            if (json?.status === 'success' && json?.data?.item) {
                const order = json.data.item;
                if (itemsTotalEl) {
                    const itemsTotal = order.items?.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0) || 0;
                    itemsTotalEl.textContent = formatCurrency(itemsTotal);
                }
                if (servicesTotalEl) {
                    const servicesTotal = order.services?.reduce((sum, service) => sum + parseFloat(service.subtotal || 0), 0) || 0;
                    servicesTotalEl.textContent = formatCurrency(servicesTotal);
                }
                if (totalCostEl) {
                    totalCostEl.textContent = formatCurrency(parseFloat(order.total_cost || 0));
                }
                if (totalPaidEl) {
                    totalPaidEl.textContent = formatCurrency(parseFloat(order.total_paid || 0));
                }
                if (balanceEl) {
                    const balance = parseFloat(order.balance || 0);
                    balanceEl.textContent = formatCurrency(Math.abs(balance));
                    if (balance < 0) {
                        balanceEl.classList.add('text-rose-600', 'dark:text-rose-400');
                        balanceEl.classList.remove('text-gray-900', 'dark:text-white');
                    } else {
                        balanceEl.classList.add('text-gray-900', 'dark:text-white');
                        balanceEl.classList.remove('text-rose-600', 'dark:text-rose-400');
                    }
                }
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error updating costs summary', error);
        }
    };

    // Notes Management
    const loadNotes = async () => {
        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/notes`, {
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });
            const json = await response.json();
            if (json?.status === 'success' && json?.data?.items && notesList) {
                notesList.innerHTML = '';
                json.data.items.forEach((note) => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-slate-800/50';
                    noteEl.dataset.orderNoteItem = '';
                    noteEl.dataset.noteId = note.id;
                    noteEl.innerHTML = `
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <p class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap">${note.note || ''}</p>
                                <div class="mt-2 flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center gap-1.5">
                                        <i class="fa-solid fa-user"></i>
                                        ${note.user?.name || ''}
                                    </span>
                                    <span class="flex items-center gap-1.5">
                                        <i class="fa-solid fa-clock"></i>
                                        ${note.created_at_formatted || ''}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    type="button"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 text-gray-600 transition hover:border-primary hover:text-primary dark:border-gray-700 dark:text-gray-300"
                                    data-order-note-edit
                                    data-note-id="${note.id}"
                                    data-note-text="${(note.note || '').replace(/"/g, '&quot;')}"
                                >
                                    <i class="fa-regular fa-pen-to-square text-xs"></i>
                                </button>
                                <button
                                    type="button"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-rose-300 text-rose-600 transition hover:border-rose-500 hover:bg-rose-50 dark:border-rose-700 dark:text-rose-400"
                                    data-order-note-delete
                                    data-note-id="${note.id}"
                                >
                                    <i class="fa-regular fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    notesList.appendChild(noteEl);
                });
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading notes', error);
        }
    };

    const openNoteModal = (noteId = null, noteText = '') => {
        console.log('[WorkshopOrderEdit] openNoteModal called', { noteId, noteText, noteModal, noteForm, noteModalTitle, noteTextArea, noteIdInput });
        if (!noteModal) {
            console.error('[WorkshopOrderEdit] noteModal not found');
            return;
        }
        if (!noteForm) {
            console.error('[WorkshopOrderEdit] noteForm not found');
            return;
        }
        if (noteIdInput) noteIdInput.value = noteId || '';
        if (noteTextArea) noteTextArea.value = noteText || '';
        if (noteModalTitle) {
            noteModalTitle.textContent = noteId ? tx('Editar nota') : tx('Agregar nota');
        }
        console.log('[WorkshopOrderEdit] Removing hidden class from noteModal', { before: noteModal.classList.contains('hidden') });
        noteModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        console.log('[WorkshopOrderEdit] Note modal opened', { after: noteModal.classList.contains('hidden') });
        if (noteTextArea) {
            setTimeout(() => noteTextArea.focus(), 100);
        }
    };

    const closeNoteModal = () => {
        if (!noteModal) return;
        noteModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (noteForm) noteForm.reset();
        if (noteIdInput) noteIdInput.value = '';
        if (noteTextArea) noteTextArea.value = '';
    };

    const saveNote = async (noteId = null) => {
        if (!noteForm || !noteTextArea) return;
        const noteText = noteTextArea.value.trim();
        if (!noteText) {
            alert(tx('La nota no puede estar vacía.'));
            return;
        }

        try {
            const url = noteId
                ? `${baseUrl}/workshop/work-orders/${orderId}/notes/${noteId}`
                : `${baseUrl}/workshop/work-orders/${orderId}/notes`;
            const method = noteId ? 'PATCH' : 'POST';

            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({ note: noteText }),
            });

            const json = await response.json();
            if (response.ok && json?.status === 'success') {
                closeNoteModal();
                loadNotes();
            } else {
                alert(json?.message || tx('Error al guardar la nota.'));
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error saving note', error);
            alert(tx('Error al guardar la nota.'));
        }
    };

    const deleteNote = async (noteId) => {
        if (!noteId || !confirm(tx('¿Estás seguro de eliminar esta nota?'))) return;

        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/notes/${noteId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json();
            if (response.ok && json?.status === 'success') {
                loadNotes();
            } else {
                alert(json?.message || tx('Error al eliminar la nota.'));
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error deleting note', error);
            alert(tx('Error al eliminar la nota.'));
        }
    };

    // Items Management
    let productSearchTimeout = null;
    let priceLists = [];

    // Load price lists
    const loadPriceLists = async () => {
        try {
            const response = await fetch(`${baseUrl}/configuration/price-lists/options`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json();
            if (json?.status === 'success' && json?.data?.items && itemPriceListOptions) {
                priceLists = json.data.items || [];
                itemPriceListOptions.innerHTML = '';
                if (priceLists.length === 0) {
                    itemPriceListOptions.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No hay listas de precios disponibles') + '</div>';
                } else {
                    priceLists.forEach((priceList) => {
                        const optionEl = document.createElement('button');
                        optionEl.type = 'button';
                        optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                        optionEl.dataset.selectOption = '';
                        optionEl.dataset.value = priceList.id;
                        optionEl.dataset.label = priceList.name;
                        optionEl.dataset.selected = 'false';
                        optionEl.innerHTML = `<span class="truncate">${priceList.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                        optionEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Cerrar dropdown primero para evitar interferencias
                            const dropdown = itemPriceListSelect?.querySelector('[data-select-dropdown]');
                            if (dropdown) {
                                dropdown.hidden = true;
                                dropdown.dataset.open = 'false';
                            }
                            const trigger = itemPriceListSelect?.querySelector('[data-select-trigger]');
                            if (trigger) trigger.setAttribute('aria-expanded', 'false');
                            const icon = itemPriceListSelect?.querySelector('[data-select-icon]');
                            if (icon) icon.style.transform = '';
                            
                            // Establecer el valor de la lista de precios
                            if (itemPriceListIdInput) {
                                itemPriceListIdInput.value = priceList.id;
                            }
                            
                            // Actualizar la UI del select
                            const valueLabel = itemPriceListSelect?.querySelector('[data-select-value]');
                            if (valueLabel) valueLabel.textContent = priceList.name;
                            
                            // Cargar el precio automáticamente si hay un producto seleccionado
                            const productId = itemProductIdInput?.value?.trim();
                            const priceListId = priceList.id;
                            if (productId && priceListId && itemUnitPriceInput) {
                                console.log('[WorkshopOrderEdit] Loading price for product', productId, 'and price list', priceListId);
                                // Pasar los valores directamente para evitar problemas de timing
                                loadProductPrice(productId, priceListId);
                            } else {
                                console.log('[WorkshopOrderEdit] Cannot load price - missing product or price list', { productId, priceListId, hasUnitPriceInput: !!itemUnitPriceInput });
                            }
                        });
                        itemPriceListOptions.appendChild(optionEl);
                    });
                }
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading price lists', error);
        }
    };

    // Load product price for selected product and price list
    const loadProductPrice = async (overrideProductId = null, overridePriceListId = null) => {
        const productId = overrideProductId || itemProductIdInput?.value?.trim();
        const priceListId = overridePriceListId || itemPriceListIdInput?.value?.trim();
        
        if (!productId || !priceListId || !itemUnitPriceInput) {
            console.warn('[WorkshopOrderEdit] Cannot load product price - missing required data', {
                productId,
                priceListId,
                hasUnitPriceInput: !!itemUnitPriceInput
            });
            return;
        }

        try {
            console.log('[WorkshopOrderEdit] Fetching price for product', productId, 'with price list', priceListId);
            const response = await fetch(`${baseUrl}/workshop/work-orders/items/products/${productId}/price?price_list_id=${encodeURIComponent(priceListId)}`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const json = await response.json();
            console.log('[WorkshopOrderEdit] Price response', json);
            
            if (json?.status === 'success' && json?.data?.price !== undefined) {
                const price = json.data.price || '0';
                itemUnitPriceInput.value = price;
                console.log('[WorkshopOrderEdit] Price loaded successfully', price);
                
                // Disparar evento input para notificar a otros listeners
                itemUnitPriceInput.dispatchEvent(new Event('input', { bubbles: true }));
            } else {
                console.warn('[WorkshopOrderEdit] Unexpected response format', json);
                // Si no hay precio, establecer en 0
                itemUnitPriceInput.value = '0';
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading product price', error);
            // En caso de error, mantener el valor actual o establecer en 0
            if (itemUnitPriceInput && !itemUnitPriceInput.value) {
                itemUnitPriceInput.value = '0';
            }
        }
    };

    const searchProducts = async (search = '') => {
        if (!itemProductOptions) return;

        clearTimeout(productSearchTimeout);
        productSearchTimeout = setTimeout(async () => {
            try {
                const searchParam = search && search.length > 0 ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`${baseUrl}/workshop/work-orders/items/search/products?limit=50${searchParam}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items) {
                    itemProductOptions.innerHTML = '';
                    if (json.data.items.length === 0) {
                        itemProductOptions.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No se encontraron productos') + '</div>';
                    } else {
                        json.data.items.forEach((product) => {
                            const optionEl = document.createElement('button');
                            optionEl.type = 'button';
                            optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                            optionEl.dataset.selectOption = '';
                            optionEl.dataset.value = product.id;
                            optionEl.dataset.label = product.name;
                            optionEl.dataset.selected = 'false';
                            const label = product.sku ? `${product.name} (${product.sku})` : product.name;
                            optionEl.innerHTML = `<span class="truncate">${label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                            optionEl.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (itemProductIdInput) itemProductIdInput.value = product.id;
                                const valueLabel = itemProductSelect?.querySelector('[data-select-value]');
                                if (valueLabel) valueLabel.textContent = product.name;
                                const dropdown = itemProductSelect?.querySelector('[data-select-dropdown]');
                                if (dropdown) {
                                    dropdown.hidden = true;
                                    dropdown.dataset.open = 'false';
                                }
                                const trigger = itemProductSelect?.querySelector('[data-select-trigger]');
                                if (trigger) trigger.setAttribute('aria-expanded', 'false');
                                const icon = itemProductSelect?.querySelector('[data-select-icon]');
                                if (icon) icon.style.transform = '';
                                
                                // Cargar el precio automáticamente si hay una lista de precios seleccionada
                                const productId = itemProductIdInput?.value?.trim();
                                const priceListId = itemPriceListIdInput?.value?.trim();
                                if (productId && priceListId && itemUnitPriceInput) {
                                    console.log('[WorkshopOrderEdit] Loading price for product', productId, 'and price list', priceListId);
                                    // Pasar los valores directamente para evitar problemas de timing
                                    loadProductPrice(productId, priceListId);
                                } else {
                                    console.log('[WorkshopOrderEdit] Cannot load price - missing product or price list', { productId, priceListId, hasUnitPriceInput: !!itemUnitPriceInput });
                                }
                            });
                            itemProductOptions.appendChild(optionEl);
                        });
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrderEdit] Error searching products', error);
            }
        }, search && search.length > 0 ? 300 : 0);
    };

    const loadItems = async () => {
        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/items`, {
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });
            const json = await response.json();
            if (json?.status === 'success' && json?.data?.items && itemsList) {
                itemsList.innerHTML = '';
                if (json.data.items.length === 0) {
                    itemsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500 dark:text-gray-400">
                                ${tx('No hay productos agregados')}
                            </td>
                        </tr>
                    `;
                } else {
                    json.data.items.forEach((item) => {
                        const itemEl = document.createElement('tr');
                        itemEl.dataset.orderItemRow = '';
                        itemEl.dataset.itemId = item.id;
                        itemEl.innerHTML = `
                            <td class="px-4 py-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">${item.product_name || 'N/A'}</p>
                                    ${item.product_sku ? `<p class="text-xs text-gray-500 dark:text-gray-400">${tx('SKU')}: ${item.product_sku}</p>` : ''}
                                    ${item.notes ? `<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">${item.notes}</p>` : ''}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${item.quantity || 0}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${formatCurrency(item.unit_price || 0)}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-semibold text-gray-900 dark:text-white">${formatCurrency(item.subtotal || 0)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button
                                        type="button"
                                        class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 text-gray-600 transition hover:border-primary hover:text-primary dark:border-gray-700 dark:text-gray-300"
                                        data-order-item-edit
                                        data-item-id="${item.id}"
                                        data-item-product-id="${item.product_id}"
                                        data-item-product-name="${(item.product_name || '').replace(/"/g, '&quot;')}"
                                        data-item-quantity="${item.quantity}"
                                        data-item-unit-price="${item.unit_price}"
                                        data-item-notes="${(item.notes || '').replace(/"/g, '&quot;')}"
                                    >
                                        <i class="fa-regular fa-pen-to-square text-xs"></i>
                                    </button>
                                    <button
                                        type="button"
                                        class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-rose-300 text-rose-600 transition hover:border-rose-500 hover:bg-rose-50 dark:border-rose-700 dark:text-rose-400"
                                        data-order-item-delete
                                        data-item-id="${item.id}"
                                    >
                                        <i class="fa-regular fa-trash-can text-xs"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        itemsList.appendChild(itemEl);
                    });
                }
                updateCostsSummary();
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading items', error);
        }
    };

    const openItemModal = (itemId = null, itemData = null) => {
        console.log('[WorkshopOrderEdit] openItemModal called', { itemId, itemData, itemModal, itemForm, itemModalTitle });
        if (!itemModal) {
            console.error('[WorkshopOrderEdit] itemModal not found');
            return;
        }
        if (!itemForm) {
            console.error('[WorkshopOrderEdit] itemForm not found');
            return;
        }
        if (itemIdInput) itemIdInput.value = itemId || '';
        if (itemModalTitle) {
            itemModalTitle.textContent = itemId ? tx('Editar producto') : tx('Agregar producto');
        }
        if (itemData) {
            if (itemProductIdInput) itemProductIdInput.value = itemData.product_id || '';
            const productValueLabel = itemProductSelect?.querySelector('[data-select-value]');
            if (productValueLabel && itemData.product_name) {
                productValueLabel.textContent = itemData.product_name;
            }
            if (itemQuantityInput) itemQuantityInput.value = itemData.quantity || '1';
            if (itemUnitPriceInput) itemUnitPriceInput.value = itemData.unit_price || '0';
            if (itemNotesInput) itemNotesInput.value = itemData.notes || '';
        } else {
            if (itemForm) itemForm.reset();
            if (itemQuantityInput) itemQuantityInput.value = '1';
            if (itemUnitPriceInput) itemUnitPriceInput.value = '0';
            const productValueLabel = itemProductSelect?.querySelector('[data-select-value]');
            if (productValueLabel) {
                productValueLabel.textContent = itemProductSelect?.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || tx('Selecciona un producto');
            }
            if (itemPriceListIdInput) itemPriceListIdInput.value = '';
            const priceListValueLabel = itemPriceListSelect?.querySelector('[data-select-value]');
            if (priceListValueLabel) {
                priceListValueLabel.textContent = itemPriceListSelect?.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || tx('Selecciona una lista de precios');
            }
        }
        console.log('[WorkshopOrderEdit] Removing hidden class from itemModal', { before: itemModal.classList.contains('hidden') });
        itemModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        console.log('[WorkshopOrderEdit] Item modal opened', { after: itemModal.classList.contains('hidden') });
    };

    const closeItemModal = () => {
        if (!itemModal) return;
        itemModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (itemForm) itemForm.reset();
        if (itemIdInput) itemIdInput.value = '';
        if (itemProductIdInput) itemProductIdInput.value = '';
        if (itemPriceListIdInput) itemPriceListIdInput.value = '';
        if (itemProductOptions) itemProductOptions.innerHTML = '';
        if (itemProductSearch) itemProductSearch.value = '';
        const productDropdown = itemProductSelect?.querySelector('[data-select-dropdown]');
        if (productDropdown) {
            productDropdown.hidden = true;
            productDropdown.dataset.open = 'false';
        }
        const productTrigger = itemProductSelect?.querySelector('[data-select-trigger]');
        if (productTrigger) productTrigger.setAttribute('aria-expanded', 'false');
        const productIcon = itemProductSelect?.querySelector('[data-select-icon]');
        if (productIcon) productIcon.style.transform = '';
        const productValueLabel = itemProductSelect?.querySelector('[data-select-value]');
        if (productValueLabel) {
            productValueLabel.textContent = productTrigger?.dataset.selectPlaceholder || tx('Selecciona un producto');
        }
        const priceListDropdown = itemPriceListSelect?.querySelector('[data-select-dropdown]');
        if (priceListDropdown) {
            priceListDropdown.hidden = true;
            priceListDropdown.dataset.open = 'false';
        }
        const priceListTrigger = itemPriceListSelect?.querySelector('[data-select-trigger]');
        if (priceListTrigger) priceListTrigger.setAttribute('aria-expanded', 'false');
        const priceListIcon = itemPriceListSelect?.querySelector('[data-select-icon]');
        if (priceListIcon) priceListIcon.style.transform = '';
        const priceListValueLabel = itemPriceListSelect?.querySelector('[data-select-value]');
        if (priceListValueLabel) {
            priceListValueLabel.textContent = priceListTrigger?.dataset.selectPlaceholder || tx('Selecciona una lista de precios');
        }
    };

    const saveItem = async (itemId = null) => {
        if (!itemForm) return;
        const productId = itemProductIdInput?.value?.trim();
        const quantity = parseInt(itemQuantityInput?.value || '0', 10);
        const unitPrice = parseFloat(itemUnitPriceInput?.value || '0');
        const notes = itemNotesInput?.value?.trim() || null;

        if (!productId) {
            alert(tx('Selecciona un producto.'));
            return;
        }
        if (quantity < 1) {
            alert(tx('La cantidad debe ser mayor a 0.'));
            return;
        }
        if (unitPrice < 0) {
            alert(tx('El precio unitario no puede ser negativo.'));
            return;
        }

        try {
            const url = itemId
                ? `${baseUrl}/workshop/work-orders/${orderId}/items/${itemId}`
                : `${baseUrl}/workshop/work-orders/${orderId}/items`;
            const method = itemId ? 'PATCH' : 'POST';

            const payload = {
                ...(itemId ? {} : { product_id: productId }),
                quantity,
                unit_price: unitPrice,
                ...(notes ? { notes } : {}),
            };

            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json();
            if (response.ok && json?.status === 'success') {
                closeItemModal();
                loadItems();
            } else {
                alert(json?.message || tx('Error al guardar el producto.'));
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error saving item', error);
            alert(tx('Error al guardar el producto.'));
        }
    };

    const deleteItem = async (itemId) => {
        if (!itemId || !confirm(tx('¿Estás seguro de eliminar este producto?'))) return;

        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/items/${itemId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json();
            if (response.ok && json?.status === 'success') {
                loadItems();
            } else {
                alert(json?.message || tx('Error al eliminar el producto.'));
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error deleting item', error);
            alert(tx('Error al eliminar el producto.'));
        }
    };

    // Services Management
    let serviceSearchTimeout = null;
    let serviceCategories = [];

    // Load service categories
    const loadServiceCategories = async () => {
        try {
            const response = await fetch(`${baseUrl}/configuration/service-categories/options`, {
                headers: {
                    Accept: 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const json = await response.json();
            if (json?.status === 'success' && json?.data?.items && serviceCategoryOptions) {
                serviceCategories = json.data.items || [];
                serviceCategoryOptions.innerHTML = '';
                if (serviceCategories.length === 0) {
                    serviceCategoryOptions.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No hay categorías de servicios disponibles') + '</div>';
                } else {
                    serviceCategories.forEach((category) => {
                        const optionEl = document.createElement('button');
                        optionEl.type = 'button';
                        optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                        optionEl.dataset.selectOption = '';
                        optionEl.dataset.value = category.id;
                        optionEl.dataset.label = category.name;
                        optionEl.dataset.selected = 'false';
                        optionEl.innerHTML = `<span class="truncate">${category.name}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                        optionEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Cerrar dropdown primero
                            const dropdown = serviceCategorySelect?.querySelector('[data-select-dropdown]');
                            if (dropdown) {
                                dropdown.hidden = true;
                                dropdown.dataset.open = 'false';
                            }
                            const trigger = serviceCategorySelect?.querySelector('[data-select-trigger]');
                            if (trigger) trigger.setAttribute('aria-expanded', 'false');
                            const icon = serviceCategorySelect?.querySelector('[data-select-icon]');
                            if (icon) icon.style.transform = '';
                            
                            // Establecer el valor de la categoría
                            if (serviceCategoryIdInput) {
                                serviceCategoryIdInput.value = category.id;
                            }
                            
                            // Actualizar la UI del select
                            const valueLabel = serviceCategorySelect?.querySelector('[data-select-value]');
                            if (valueLabel) valueLabel.textContent = category.name;
                            
                            // Limpiar y recargar servicios de la categoría seleccionada
                            if (serviceServiceIdInput) {
                                serviceServiceIdInput.value = '';
                                serviceServiceIdInput.disabled = false; // Habilitar el input de servicio
                            }
                            const serviceValueLabel = serviceServiceSelect?.querySelector('[data-select-value]');
                            if (serviceValueLabel) {
                                serviceValueLabel.textContent = serviceServiceSelect?.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || tx('Selecciona un servicio');
                            }
                            if (serviceServiceOptions) serviceServiceOptions.innerHTML = '';
                            if (serviceServiceSearch) {
                                serviceServiceSearch.value = '';
                                serviceServiceSearch.disabled = false; // Habilitar la búsqueda
                            }
                            if (serviceUnitPriceInput) serviceUnitPriceInput.value = '0';
                            
                            // Habilitar el select de servicios visualmente
                            const serviceTriggerEnable = serviceServiceSelect?.querySelector('[data-select-trigger]');
                            if (serviceTriggerEnable) {
                                serviceTriggerEnable.disabled = false;
                                serviceTriggerEnable.classList.remove('opacity-50', 'cursor-not-allowed');
                            }
                            
                            // Cargar servicios de la categoría seleccionada
                            searchServices('', category.id);
                        });
                        serviceCategoryOptions.appendChild(optionEl);
                    });
                }
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading service categories', error);
        }
    };

    const searchServices = async (search = '', categoryId = null) => {
        if (!serviceServiceOptions) return;

        // Obtener categoryId de parámetro o del input
        const selectedCategoryId = categoryId || serviceCategoryIdInput?.value?.trim();
        
        // Si no hay categoría seleccionada, mostrar mensaje
        if (!selectedCategoryId) {
            serviceServiceOptions.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('Primero selecciona una categoría') + '</div>';
            return;
        }

        clearTimeout(serviceSearchTimeout);
        serviceSearchTimeout = setTimeout(async () => {
            try {
                const searchParam = search && search.length > 0 ? `&search=${encodeURIComponent(search)}` : '';
                const categoryParam = `&category_id=${encodeURIComponent(selectedCategoryId)}`;
                const response = await fetch(`${baseUrl}/workshop/work-orders/services/search/services?limit=50${searchParam}${categoryParam}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                });
                const json = await response.json();
                console.log('[WorkshopOrderEdit] Services response', json);
                if (json?.status === 'success' && json?.data?.items) {
                    serviceServiceOptions.innerHTML = '';
                    if (json.data.items.length === 0) {
                        serviceServiceOptions.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('No se encontraron servicios en esta categoría') + '</div>';
                    } else {
                        json.data.items.forEach((service) => {
                            console.log('[WorkshopOrderEdit] Processing service', service, 'price:', service.price);
                            const optionEl = document.createElement('button');
                            optionEl.type = 'button';
                            optionEl.className = 'group flex w-full items-center justify-between px-4 py-2 text-left text-sm text-heading transition hover:bg-primary-soft/20 data-[selected=true]:bg-primary-soft/30 data-[selected=true]:text-primary dark:text-white';
                            optionEl.dataset.selectOption = '';
                            optionEl.dataset.value = service.id;
                            optionEl.dataset.label = service.name;
                            optionEl.dataset.selected = 'false';
                            const label = service.description ? `${service.name} - ${service.description.substring(0, 50)}${service.description.length > 50 ? '...' : ''}` : service.name;
                            optionEl.innerHTML = `<span class="truncate">${label}</span><i class="fa-solid fa-circle-check text-primary opacity-0 transition group-data-[selected=true]:opacity-100" data-select-check></i>`;
                            optionEl.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // Cerrar dropdown primero
                                const dropdown = serviceServiceSelect?.querySelector('[data-select-dropdown]');
                                if (dropdown) {
                                    dropdown.hidden = true;
                                    dropdown.dataset.open = 'false';
                                }
                                const trigger = serviceServiceSelect?.querySelector('[data-select-trigger]');
                                if (trigger) trigger.setAttribute('aria-expanded', 'false');
                                const icon = serviceServiceSelect?.querySelector('[data-select-icon]');
                                if (icon) icon.style.transform = '';
                                
                                // Establecer el valor del servicio
                                if (serviceServiceIdInput) {
                                    serviceServiceIdInput.value = service.id;
                                    serviceServiceIdInput.disabled = false;
                                }
                                const valueLabel = serviceServiceSelect?.querySelector('[data-select-value]');
                                if (valueLabel) valueLabel.textContent = service.name;
                                
                                // Mapear el precio del servicio
                                const price = service.price !== undefined && service.price !== null ? String(service.price) : '0';
                                console.log('[WorkshopOrderEdit] Service selected', { service, price, hasUnitPriceInput: !!serviceUnitPriceInput });
                                if (serviceUnitPriceInput) {
                                    serviceUnitPriceInput.value = price;
                                    // Disparar evento input para notificar a otros listeners
                                    serviceUnitPriceInput.dispatchEvent(new Event('input', { bubbles: true }));
                                    console.log('[WorkshopOrderEdit] Service price mapped to input', { price, inputValue: serviceUnitPriceInput.value });
                                } else {
                                    console.warn('[WorkshopOrderEdit] serviceUnitPriceInput not found');
                                }
                            });
                            serviceServiceOptions.appendChild(optionEl);
                        });
                    }
                }
            } catch (error) {
                console.error('[WorkshopOrderEdit] Error searching services', error);
                serviceServiceOptions.innerHTML = '<div class="px-4 py-3 text-sm text-rose-500 dark:text-rose-400">' + tx('Error al cargar los servicios') + '</div>';
            }
        }, search && search.length > 0 ? 300 : 0);
    };

    const loadServices = async () => {
        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/services`, {
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });
            const json = await response.json();
            if (json?.status === 'success' && json?.data?.items && servicesList) {
                servicesList.innerHTML = '';
                if (json.data.items.length === 0) {
                    servicesList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500 dark:text-gray-400">
                                ${tx('No hay servicios agregados')}
                            </td>
                        </tr>
                    `;
                } else {
                    json.data.items.forEach((service) => {
                        const serviceEl = document.createElement('tr');
                        serviceEl.dataset.orderServiceRow = '';
                        serviceEl.dataset.serviceId = service.id;
                        serviceEl.innerHTML = `
                            <td class="px-4 py-3">
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">${service.service_name || 'N/A'}</p>
                                    ${service.notes ? `<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">${service.notes}</p>` : ''}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${service.quantity || 0}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${formatCurrency(service.unit_price || 0)}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-semibold text-gray-900 dark:text-white">${formatCurrency(service.subtotal || 0)}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button
                                        type="button"
                                        class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 text-gray-600 transition hover:border-primary hover:text-primary dark:border-gray-700 dark:text-gray-300"
                                        data-order-service-edit
                                        data-service-id="${service.id}"
                                        data-service-service-id="${service.service_id}"
                                        data-service-service-name="${(service.service_name || '').replace(/"/g, '&quot;')}"
                                        data-service-quantity="${service.quantity}"
                                        data-service-unit-price="${service.unit_price}"
                                        data-service-notes="${(service.notes || '').replace(/"/g, '&quot;')}"
                                    >
                                        <i class="fa-regular fa-pen-to-square text-xs"></i>
                                    </button>
                                    <button
                                        type="button"
                                        class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-rose-300 text-rose-600 transition hover:border-rose-500 hover:bg-rose-50 dark:border-rose-700 dark:text-rose-400"
                                        data-order-service-delete
                                        data-service-id="${service.id}"
                                    >
                                        <i class="fa-regular fa-trash-can text-xs"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        servicesList.appendChild(serviceEl);
                    });
                }
                updateCostsSummary();
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error loading services', error);
        }
    };

    const openServiceModal = (serviceId = null, serviceData = null) => {
        console.log('[WorkshopOrderEdit] openServiceModal called', { serviceId, serviceData, serviceModal, serviceForm, serviceModalTitle });
        if (!serviceModal) {
            console.error('[WorkshopOrderEdit] serviceModal not found');
            return;
        }
        if (!serviceForm) {
            console.error('[WorkshopOrderEdit] serviceForm not found');
            return;
        }
        if (serviceIdInput) serviceIdInput.value = serviceId || '';
        if (serviceModalTitle) {
            serviceModalTitle.textContent = serviceId ? tx('Editar servicio') : tx('Agregar servicio');
        }
        
        // Reset category select
        if (serviceCategoryIdInput) {
            serviceCategoryIdInput.value = '';
        }
        const categoryValueLabel = serviceCategorySelect?.querySelector('[data-select-value]');
        if (categoryValueLabel) {
            categoryValueLabel.textContent = serviceCategorySelect?.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || tx('Selecciona una categoría');
        }
        const categoryDropdown = serviceCategorySelect?.querySelector('[data-select-dropdown]');
        if (categoryDropdown) {
            categoryDropdown.hidden = true;
            categoryDropdown.dataset.open = 'false';
        }
        const categoryTrigger = serviceCategorySelect?.querySelector('[data-select-trigger]');
        if (categoryTrigger) categoryTrigger.setAttribute('aria-expanded', 'false');
        const categoryIcon = serviceCategorySelect?.querySelector('[data-select-icon]');
        if (categoryIcon) categoryIcon.style.transform = '';
        
        // Deshabilitar el select de servicios hasta que se seleccione una categoría
        if (serviceServiceIdInput) {
            serviceServiceIdInput.disabled = true;
        }
        if (serviceServiceSearch) {
            serviceServiceSearch.disabled = true;
        }
        const serviceTriggerEl = serviceServiceSelect?.querySelector('[data-select-trigger]');
        if (serviceTriggerEl) {
            serviceTriggerEl.disabled = true;
            serviceTriggerEl.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        if (serviceData) {
            if (serviceServiceIdInput) serviceServiceIdInput.value = serviceData.service_id || '';
            const serviceValueLabel = serviceServiceSelect?.querySelector('[data-select-value]');
            if (serviceValueLabel && serviceData.service_name) {
                serviceValueLabel.textContent = serviceData.service_name;
            }
            if (serviceQuantityInput) serviceQuantityInput.value = serviceData.quantity || '1';
            if (serviceUnitPriceInput) serviceUnitPriceInput.value = serviceData.unit_price || '0';
            if (serviceNotesInput) serviceNotesInput.value = serviceData.notes || '';
        } else {
            if (serviceForm) serviceForm.reset();
            if (serviceQuantityInput) serviceQuantityInput.value = '1';
            if (serviceUnitPriceInput) serviceUnitPriceInput.value = '0';
            const serviceValueLabel = serviceServiceSelect?.querySelector('[data-select-value]');
            if (serviceValueLabel) {
                serviceValueLabel.textContent = serviceServiceSelect?.querySelector('[data-select-trigger]')?.dataset.selectPlaceholder || tx('Selecciona un servicio');
            }
        }
        
        // Clear service select
        if (serviceServiceIdInput) serviceServiceIdInput.value = '';
        if (serviceServiceOptions) serviceServiceOptions.innerHTML = '';
        if (serviceServiceSearch) serviceServiceSearch.value = '';
        const serviceDropdown = serviceServiceSelect?.querySelector('[data-select-dropdown]');
        if (serviceDropdown) {
            serviceDropdown.hidden = true;
            serviceDropdown.dataset.open = 'false';
        }
        if (serviceTriggerEl) {
            serviceTriggerEl.setAttribute('aria-expanded', 'false');
        }
        const serviceIcon = serviceServiceSelect?.querySelector('[data-select-icon]');
        if (serviceIcon) serviceIcon.style.transform = '';
        
        console.log('[WorkshopOrderEdit] Removing hidden class from serviceModal', { before: serviceModal.classList.contains('hidden') });
        serviceModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        console.log('[WorkshopOrderEdit] Service modal opened', { after: serviceModal.classList.contains('hidden') });
    };

    const closeServiceModal = () => {
        if (!serviceModal) return;
        serviceModal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (serviceForm) serviceForm.reset();
        if (serviceIdInput) serviceIdInput.value = '';
        if (serviceCategoryIdInput) serviceCategoryIdInput.value = '';
        if (serviceServiceIdInput) serviceServiceIdInput.value = '';
        if (serviceServiceOptions) serviceServiceOptions.innerHTML = '';
        if (serviceServiceSearch) serviceServiceSearch.value = '';
        
        // Reset category select
        const categoryDropdown = serviceCategorySelect?.querySelector('[data-select-dropdown]');
        if (categoryDropdown) {
            categoryDropdown.hidden = true;
            categoryDropdown.dataset.open = 'false';
        }
        const categoryTrigger = serviceCategorySelect?.querySelector('[data-select-trigger]');
        if (categoryTrigger) {
            categoryTrigger.setAttribute('aria-expanded', 'false');
            categoryTrigger.disabled = false;
            categoryTrigger.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        const categoryIcon = serviceCategorySelect?.querySelector('[data-select-icon]');
        if (categoryIcon) categoryIcon.style.transform = '';
        const categoryValueLabel = serviceCategorySelect?.querySelector('[data-select-value]');
        if (categoryValueLabel) {
            categoryValueLabel.textContent = categoryTrigger?.dataset.selectPlaceholder || tx('Selecciona una categoría');
        }
        
        // Reset service select (deshabilitar hasta que se seleccione categoría)
        if (serviceServiceIdInput) {
            serviceServiceIdInput.disabled = true;
        }
        if (serviceServiceSearch) {
            serviceServiceSearch.disabled = true;
        }
        const serviceDropdown = serviceServiceSelect?.querySelector('[data-select-dropdown]');
        if (serviceDropdown) {
            serviceDropdown.hidden = true;
            serviceDropdown.dataset.open = 'false';
        }
        const serviceTriggerReset = serviceServiceSelect?.querySelector('[data-select-trigger]');
        if (serviceTriggerReset) {
            serviceTriggerReset.setAttribute('aria-expanded', 'false');
            serviceTriggerReset.disabled = true;
            serviceTriggerReset.classList.add('opacity-50', 'cursor-not-allowed');
        }
        const serviceIcon = serviceServiceSelect?.querySelector('[data-select-icon]');
        if (serviceIcon) serviceIcon.style.transform = '';
        const serviceValueLabel = serviceServiceSelect?.querySelector('[data-select-value]');
        if (serviceValueLabel && serviceTriggerReset) {
            serviceValueLabel.textContent = serviceTriggerReset.dataset.selectPlaceholder || tx('Selecciona un servicio');
        }
    };

    const saveService = async (serviceId = null) => {
        if (!serviceForm) return;
        const serviceServiceId = serviceServiceIdInput?.value?.trim();
        const quantity = parseInt(serviceQuantityInput?.value || '0', 10);
        const unitPrice = parseFloat(serviceUnitPriceInput?.value || '0');
        const notes = serviceNotesInput?.value?.trim() || null;

        if (!serviceServiceId) {
            alert(tx('Selecciona un servicio.'));
            return;
        }
        if (quantity < 1) {
            alert(tx('La cantidad debe ser mayor a 0.'));
            return;
        }
        if (unitPrice < 0) {
            alert(tx('El precio unitario no puede ser negativo.'));
            return;
        }

        try {
            const url = serviceId
                ? `${baseUrl}/workshop/work-orders/${orderId}/services/${serviceId}`
                : `${baseUrl}/workshop/work-orders/${orderId}/services`;
            const method = serviceId ? 'PATCH' : 'POST';

            const payload = {
                ...(serviceId ? {} : { service_id: serviceServiceId }),
                quantity,
                unit_price: unitPrice,
                ...(notes ? { notes } : {}),
            };

            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            const json = await response.json();
            if (response.ok && json?.status === 'success') {
                closeServiceModal();
                loadServices();
            } else {
                alert(json?.message || tx('Error al guardar el servicio.'));
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error saving service', error);
            alert(tx('Error al guardar el servicio.'));
        }
    };

    const deleteService = async (serviceId) => {
        if (!serviceId || !confirm(tx('¿Estás seguro de eliminar este servicio?'))) return;

        try {
            const response = await fetch(`${baseUrl}/workshop/work-orders/${orderId}/services/${serviceId}`, {
                method: 'DELETE',
                headers: {
                    Accept: 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
            });

            const json = await response.json();
            if (response.ok && json?.status === 'success') {
                loadServices();
            } else {
                alert(json?.message || tx('Error al eliminar el servicio.'));
            }
        } catch (error) {
            console.error('[WorkshopOrderEdit] Error deleting service', error);
            alert(tx('Error al eliminar el servicio.'));
        }
    };

    // Event Listeners
    // Notes
    const noteAddButton = root.querySelector('[data-order-note-add]');
    if (noteAddButton) {
        noteAddButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('[WorkshopOrderEdit] Note add button clicked', { noteModal, noteForm });
            openNoteModal();
        });
    } else {
        console.warn('[WorkshopOrderEdit] Note add button not found');
    }

    root.addEventListener('click', (e) => {
        const target = e.target.closest('[data-order-note-edit]');
        if (target) {
            const noteId = target.dataset.noteId;
            const noteText = target.dataset.noteText || '';
            openNoteModal(noteId, noteText);
            return;
        }

        const deleteBtn = e.target.closest('[data-order-note-delete]');
        if (deleteBtn) {
            const noteId = deleteBtn.dataset.noteId;
            deleteNote(noteId);
            return;
        }
    });

    noteForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const noteId = noteIdInput?.value || null;
        saveNote(noteId);
    });

    noteModal?.querySelectorAll('[data-order-note-modal-close]').forEach((btn) => {
        btn.addEventListener('click', closeNoteModal);
    });

    // Items
    const itemAddButton = root.querySelector('[data-order-item-add]');
    if (itemAddButton) {
        itemAddButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('[WorkshopOrderEdit] Item add button clicked', { itemModal, itemForm });
            openItemModal();
        });
    } else {
        console.warn('[WorkshopOrderEdit] Item add button not found');
    }

    root.addEventListener('click', (e) => {
        const target = e.target.closest('[data-order-item-edit]');
        if (target) {
            const itemId = target.dataset.itemId;
            const itemData = {
                product_id: target.dataset.itemProductId,
                product_name: target.dataset.itemProductName,
                quantity: target.dataset.itemQuantity,
                unit_price: target.dataset.itemUnitPrice,
                notes: target.dataset.itemNotes,
            };
            openItemModal(itemId, itemData);
            return;
        }

        const deleteBtn = e.target.closest('[data-order-item-delete]');
        if (deleteBtn) {
            const itemId = deleteBtn.dataset.itemId;
            deleteItem(itemId);
            return;
        }
    });

    // Initialize product select with search
    if (itemProductSelect && itemProductSearch) {
        const productSelectTrigger = itemProductSelect.querySelector('[data-select-trigger]');
        const productSelectDropdown = itemProductSelect.querySelector('[data-select-dropdown]');
        const productSelectIcon = itemProductSelect.querySelector('[data-select-icon]');

        productSelectTrigger?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isOpen = productSelectDropdown?.dataset.open === 'true';
            if (productSelectDropdown) {
                productSelectDropdown.hidden = isOpen;
                productSelectDropdown.dataset.open = isOpen ? 'false' : 'true';
                productSelectTrigger.setAttribute('aria-expanded', !isOpen);
                if (productSelectIcon) productSelectIcon.style.transform = isOpen ? '' : 'rotate(180deg)';
                if (!isOpen && itemProductOptions) {
                    // Load all products when opening
                    searchProducts('');
                }
            }
        });

        itemProductSearch.addEventListener('input', (e) => {
            e.stopPropagation();
            const search = e.target.value.trim();
            searchProducts(search);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (itemProductSelect && !itemProductSelect.contains(e.target)) {
                if (productSelectDropdown && productSelectDropdown.dataset.open === 'true') {
                    productSelectDropdown.hidden = true;
                    productSelectDropdown.dataset.open = 'false';
                    productSelectTrigger?.setAttribute('aria-expanded', 'false');
                    if (productSelectIcon) productSelectIcon.style.transform = '';
                }
            }
        });
    }

    // Initialize price list select
    if (itemPriceListSelect) {
        const priceListSelectTrigger = itemPriceListSelect.querySelector('[data-select-trigger]');
        const priceListSelectDropdown = itemPriceListSelect.querySelector('[data-select-dropdown]');
        const priceListSelectIcon = itemPriceListSelect.querySelector('[data-select-icon]');

        // Remove any existing listeners by checking initialization flag
        if (priceListSelectTrigger && !priceListSelectTrigger.dataset.initialized) {
            priceListSelectTrigger.dataset.initialized = 'true';
            
            priceListSelectTrigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isOpen = priceListSelectDropdown?.dataset.open === 'true';
                if (priceListSelectDropdown) {
                    priceListSelectDropdown.hidden = isOpen;
                    priceListSelectDropdown.dataset.open = isOpen ? 'false' : 'true';
                    priceListSelectTrigger.setAttribute('aria-expanded', !isOpen);
                    if (priceListSelectIcon) priceListSelectIcon.style.transform = isOpen ? '' : 'rotate(180deg)';
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (itemPriceListSelect && !itemPriceListSelect.contains(e.target)) {
                if (priceListSelectDropdown && priceListSelectDropdown.dataset.open === 'true') {
                    priceListSelectDropdown.hidden = true;
                    priceListSelectDropdown.dataset.open = 'false';
                    priceListSelectTrigger?.setAttribute('aria-expanded', 'false');
                    if (priceListSelectIcon) priceListSelectIcon.style.transform = '';
                }
            }
        });
    }

    // Load price lists on initialization
    loadPriceLists();

    itemForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const itemId = itemIdInput?.value || null;
        saveItem(itemId);
    });

    itemModal?.querySelectorAll('[data-order-item-modal-close]').forEach((btn) => {
        btn.addEventListener('click', closeItemModal);
    });


    // Services
    const serviceAddButton = root.querySelector('[data-order-service-add]');
    if (serviceAddButton) {
        serviceAddButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('[WorkshopOrderEdit] Service add button clicked', { serviceModal, serviceForm });
            openServiceModal();
        });
    } else {
        console.warn('[WorkshopOrderEdit] Service add button not found');
    }

    root.addEventListener('click', (e) => {
        const target = e.target.closest('[data-order-service-edit]');
        if (target) {
            const serviceId = target.dataset.serviceId;
            const serviceData = {
                service_id: target.dataset.serviceServiceId,
                service_name: target.dataset.serviceServiceName,
                quantity: target.dataset.serviceQuantity,
                unit_price: target.dataset.serviceUnitPrice,
                notes: target.dataset.serviceNotes,
            };
            openServiceModal(serviceId, serviceData);
            return;
        }

        const deleteBtn = e.target.closest('[data-order-service-delete]');
        if (deleteBtn) {
            const serviceId = deleteBtn.dataset.serviceId;
            deleteService(serviceId);
            return;
        }
    });

    // Initialize service category select
    if (serviceCategorySelect) {
        const categorySelectTrigger = serviceCategorySelect.querySelector('[data-select-trigger]');
        const categorySelectDropdown = serviceCategorySelect.querySelector('[data-select-dropdown]');
        const categorySelectIcon = serviceCategorySelect.querySelector('[data-select-icon]');

        // Remove any existing listeners by checking initialization flag
        if (categorySelectTrigger && !categorySelectTrigger.dataset.initialized) {
            categorySelectTrigger.dataset.initialized = 'true';
            
            categorySelectTrigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation(); // Prevenir otros listeners
                
                const isOpen = categorySelectDropdown?.dataset.open === 'true';
                if (categorySelectDropdown) {
                    if (isOpen) {
                        // Cerrar
                        categorySelectDropdown.hidden = true;
                        categorySelectDropdown.dataset.open = 'false';
                        categorySelectTrigger.setAttribute('aria-expanded', 'false');
                        if (categorySelectIcon) categorySelectIcon.style.transform = '';
                    } else {
                        // Abrir
                        categorySelectDropdown.hidden = false;
                        categorySelectDropdown.dataset.open = 'true';
                        categorySelectTrigger.setAttribute('aria-expanded', 'true');
                        if (categorySelectIcon) categorySelectIcon.style.transform = 'rotate(180deg)';
                        if (serviceCategoryOptions) {
                            // Load categories when opening
                            loadServiceCategories();
                        }
                    }
                }
            }, true); // Usar capture phase para capturar antes que otros listeners
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (serviceCategorySelect && !serviceCategorySelect.contains(e.target)) {
                if (categorySelectDropdown && categorySelectDropdown.dataset.open === 'true') {
                    categorySelectDropdown.hidden = true;
                    categorySelectDropdown.dataset.open = 'false';
                    categorySelectTrigger?.setAttribute('aria-expanded', 'false');
                    if (categorySelectIcon) categorySelectIcon.style.transform = '';
                }
            }
        });
    }

    // Initialize service select with search
    if (serviceServiceSelect && serviceServiceSearch) {
        const serviceSelectTrigger = serviceServiceSelect.querySelector('[data-select-trigger]');
        const serviceSelectDropdown = serviceServiceSelect.querySelector('[data-select-dropdown]');
        const serviceSelectIcon = serviceServiceSelect.querySelector('[data-select-icon]');

        // Remove any existing listeners by checking initialization flag
        if (serviceSelectTrigger && !serviceSelectTrigger.dataset.initialized) {
            serviceSelectTrigger.dataset.initialized = 'true';
            
            serviceSelectTrigger.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation(); // Prevenir otros listeners
                
                // Verificar que haya una categoría seleccionada antes de abrir
                const categoryId = serviceCategoryIdInput?.value?.trim();
                if (!categoryId) {
                    // Si no hay categoría, cerrar el dropdown y mostrar alerta
                    if (serviceSelectDropdown) {
                        serviceSelectDropdown.hidden = true;
                        serviceSelectDropdown.dataset.open = 'false';
                    }
                    serviceSelectTrigger.setAttribute('aria-expanded', 'false');
                    if (serviceSelectIcon) serviceSelectIcon.style.transform = '';
                    alert(tx('Primero debes seleccionar una categoría'));
                    return;
                }
                
                const isOpen = serviceSelectDropdown?.dataset.open === 'true';
                if (serviceSelectDropdown) {
                    if (isOpen) {
                        // Cerrar
                        serviceSelectDropdown.hidden = true;
                        serviceSelectDropdown.dataset.open = 'false';
                        serviceSelectTrigger.setAttribute('aria-expanded', 'false');
                        if (serviceSelectIcon) serviceSelectIcon.style.transform = '';
                    } else {
                        // Abrir
                        serviceSelectDropdown.hidden = false;
                        serviceSelectDropdown.dataset.open = 'true';
                        serviceSelectTrigger.setAttribute('aria-expanded', 'true');
                        if (serviceSelectIcon) serviceSelectIcon.style.transform = 'rotate(180deg)';
                        if (serviceServiceOptions) {
                            // Cargar servicios de la categoría seleccionada
                            searchServices('', categoryId);
                        }
                    }
                }
            }, true); // Usar capture phase para capturar antes que otros listeners
        }

        serviceServiceSearch.addEventListener('input', (e) => {
            e.stopPropagation();
            const search = e.target.value.trim();
            const categoryId = serviceCategoryIdInput?.value?.trim();
            if (!categoryId) {
                // Si no hay categoría, limpiar opciones
                if (serviceServiceOptions) {
                    serviceServiceOptions.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">' + tx('Primero selecciona una categoría') + '</div>';
                }
                return;
            }
            searchServices(search, categoryId);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (serviceServiceSelect && !serviceServiceSelect.contains(e.target)) {
                if (serviceSelectDropdown && serviceSelectDropdown.dataset.open === 'true') {
                    serviceSelectDropdown.hidden = true;
                    serviceSelectDropdown.dataset.open = 'false';
                    serviceSelectTrigger?.setAttribute('aria-expanded', 'false');
                    if (serviceSelectIcon) serviceSelectIcon.style.transform = '';
                }
            }
        });
    }

    serviceForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const serviceId = serviceIdInput?.value || null;
        saveService(serviceId);
    });

    serviceModal?.querySelectorAll('[data-order-service-modal-close]').forEach((btn) => {
        btn.addEventListener('click', closeServiceModal);
    });


    // Load initial data
    loadCategories().then(() => {
        const categoryInput = root.querySelector('[data-select-name="category_id"] [data-select-input]');
        const currentCategoryId = categoryInput?.value || '';
        if (currentCategoryId) {
            loadStates(currentCategoryId);
        }
    });
    loadNotes();
    loadItems();
    loadServices();
    updateCostsSummary();
};

// POS Module
const initPOSModule = () => {
    const root = document.querySelector('[data-pos-root]');
    if (!root) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? '';
    const baseUrl = window.location.origin;

    // URLs
    const customersUrl = `${baseUrl}/pos/search/customers`;
    const productsUrl = `${baseUrl}/pos/search/products`;
    const servicesUrl = `${baseUrl}/pos/search/services`;
    const usersUrl = `${baseUrl}/pos/search/users`;
    const workOrdersUrl = `${baseUrl}/pos/search/work-orders`;
    const storeUrl = `${baseUrl}/pos`;

    // Estado
    let currentTab = 'products';
    let cartItems = [];
    let selectedCustomer = null;
    let selectedSalesperson = null;
    let selectedWorkOrder = null;

    // Elements
    const salespersonTrigger = root.querySelector('[data-pos-salesperson-trigger]');
    const salespersonDisplay = root.querySelector('[data-pos-salesperson-display]');
    const salespersonSearch = root.querySelector('[data-pos-salesperson-search]');
    const salespersonId = root.querySelector('[data-pos-salesperson-id]');
    const salespersonDropdown = root.querySelector('[data-pos-salesperson-dropdown]');
    const salespersonResults = root.querySelector('[data-pos-salesperson-results]');
    const salespersonSelected = root.querySelector('[data-pos-salesperson-selected]');
    const salespersonName = root.querySelector('[data-pos-salesperson-name]');
    const salespersonClear = root.querySelector('[data-pos-salesperson-clear]');

    const customerTrigger = root.querySelector('[data-pos-customer-trigger]');
    const customerDisplay = root.querySelector('[data-pos-customer-display]');
    const customerSearch = root.querySelector('[data-pos-customer-search]');
    const customerId = root.querySelector('[data-pos-customer-id]');
    const customerDropdown = root.querySelector('[data-pos-customer-dropdown]');
    const customerResults = root.querySelector('[data-pos-customer-results]');
    const customerSelected = root.querySelector('[data-pos-customer-selected]');
    const customerName = root.querySelector('[data-pos-customer-name]');
    const customerClear = root.querySelector('[data-pos-customer-clear]');

    const workOrderTrigger = root.querySelector('[data-pos-work-order-trigger]');
    const workOrderDisplay = root.querySelector('[data-pos-work-order-display]');
    const workOrderSearch = root.querySelector('[data-pos-work-order-search]');
    const workOrderId = root.querySelector('[data-pos-work-order-id]');
    const workOrderDropdown = root.querySelector('[data-pos-work-order-dropdown]');
    const workOrderResults = root.querySelector('[data-pos-work-order-results]');
    const workOrderSelected = root.querySelector('[data-pos-work-order-selected]');
    const workOrderNumber = root.querySelector('[data-pos-work-order-number]');
    const workOrderCustomer = root.querySelector('[data-pos-work-order-customer]');
    const workOrderClear = root.querySelector('[data-pos-work-order-clear]');

    const itemSearch = root.querySelector('[data-pos-item-search]');
    const productsGrid = root.querySelector('[data-pos-products-grid]');
    const cartItemsContainer = root.querySelector('[data-pos-cart-items]');
    const completeSaleBtn = root.querySelector('[data-pos-complete-sale]');
    const clearCartBtn = root.querySelector('[data-pos-clear-cart]');
    
    // Payment modal elements
    const paymentModal = root.querySelector('[data-pos-payment-modal]');
    const paymentCloseBtn = root.querySelectorAll('[data-pos-payment-close]');
    const paymentSubtotalEl = root.querySelector('[data-pos-payment-subtotal]');
    const paymentTaxEl = root.querySelector('[data-pos-payment-tax]');
    const paymentTotalEl = root.querySelector('[data-pos-payment-total]');
    const paymentMethodSelect = root.querySelector('[data-pos-payment-method]');
    const paymentNotesTextarea = root.querySelector('[data-pos-payment-notes]');
    const paymentConfirmBtn = root.querySelector('[data-pos-payment-confirm]');

    const tabButtons = root.querySelectorAll('[data-pos-tab]');
    const subtotalEl = root.querySelector('[data-pos-subtotal]');
    const taxEl = root.querySelector('[data-pos-tax]');
    const totalEl = root.querySelector('[data-pos-total]');
    const itemsCountEl = root.querySelector('[data-pos-items-count]');
    const productsCountEl = root.querySelector('[data-pos-products-count]');
    const servicesCountEl = root.querySelector('[data-pos-services-count]');

    // Helpers
    const tx = (message) => {
        try {
            if (typeof window !== 'undefined' && typeof window.gettext === 'function') {
                return window.gettext(message);
            }
        } catch (error) {
            console.warn('[POS] translate error', error, message);
        }
        return message;
    };

    const formatCurrency = (amount) => {
        return `USD ${Number(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
    };

    // Variable para almacenar el abono de la orden de trabajo
    let workOrderAdvance = 0;

    const calculateTotals = () => {
        const subtotal = cartItems.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
        const tax = subtotal * 0.15; // IVA 15%
        const total = subtotal + tax;
        const remaining = Math.max(0, total - workOrderAdvance); // Restante después de abono

        if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
        if (taxEl) taxEl.textContent = formatCurrency(tax);
        if (totalEl) totalEl.textContent = formatCurrency(total);
        
        // Update payment modal totals
        if (paymentSubtotalEl) paymentSubtotalEl.textContent = formatCurrency(subtotal);
        if (paymentTaxEl) paymentTaxEl.textContent = formatCurrency(tax);
        if (paymentTotalEl) paymentTotalEl.textContent = formatCurrency(total);
        
        // Mostrar abono si existe
        const advanceEl = root.querySelector('[data-pos-advance]');
        const advanceAmountEl = root.querySelector('[data-pos-advance-amount]');
        const remainingEl = root.querySelector('[data-pos-remaining]');
        const remainingAmountEl = root.querySelector('[data-pos-remaining-amount]');
        
        if (workOrderAdvance > 0) {
            if (advanceEl) advanceEl.style.display = 'flex';
            if (advanceAmountEl) advanceAmountEl.textContent = formatCurrency(workOrderAdvance);
            if (remainingEl) remainingEl.style.display = 'flex';
            if (remainingAmountEl) remainingAmountEl.textContent = formatCurrency(remaining);
        } else {
            if (advanceEl) advanceEl.style.display = 'none';
            if (remainingEl) remainingEl.style.display = 'none';
        }

        // Counts
        const productsCount = cartItems.filter(item => item.item_type === 'product').reduce((sum, item) => sum + item.quantity, 0);
        const servicesCount = cartItems.filter(item => item.item_type === 'service').reduce((sum, item) => sum + item.quantity, 0);

        if (itemsCountEl) itemsCountEl.textContent = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        if (productsCountEl) productsCountEl.textContent = productsCount;
        if (servicesCountEl) servicesCountEl.textContent = servicesCount;

        // Enable/disable complete sale button
        if (completeSaleBtn) {
            completeSaleBtn.disabled = !selectedCustomer || cartItems.length === 0;
        }
    };

    const renderCartItems = () => {
        if (!cartItemsContainer) return;

        if (cartItems.length === 0) {
            cartItemsContainer.innerHTML = `
                <div class="rounded-lg border-2 border-dashed border-gray-300 p-8 text-center dark:border-gray-700">
                    <i class="fa-solid fa-shopping-cart mb-3 text-4xl text-gray-400"></i>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${tx('Carrito vacío')}</p>
                </div>
            `;
            return;
        }

        cartItemsContainer.innerHTML = cartItems.map((item, index) => `
            <div class="rounded-lg border border-gray-200 bg-gray-50 p-3 shadow-sm dark:border-gray-800 dark:bg-slate-900/50" data-cart-item="${index}">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">${item.name}</h3>
                        ${item.sku ? `<p class="mt-1 text-xs text-gray-600 dark:text-gray-400">${item.sku}</p>` : ''}
                        <div class="mt-2 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button
                                    type="button"
                                    data-cart-item-decrease="${index}"
                                    class="flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 active:scale-95 dark:border-gray-700 dark:bg-slate-900 dark:text-gray-300 touch-manipulation"
                                >
                                    <i class="fa-solid fa-minus text-xs"></i>
                                </button>
                                <input
                                    type="number"
                                    data-cart-item-quantity="${index}"
                                    value="${item.quantity}"
                                    min="1"
                                    class="w-16 rounded-lg border border-gray-300 bg-white px-2 py-1 text-center text-sm font-semibold text-gray-900 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                                >
                                <button
                                    type="button"
                                    data-cart-item-increase="${index}"
                                    class="flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 active:scale-95 dark:border-gray-700 dark:bg-slate-900 dark:text-gray-300 touch-manipulation"
                                >
                                    <i class="fa-solid fa-plus text-xs"></i>
                                </button>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-medium text-gray-600 dark:text-gray-400">${formatCurrency(item.unit_price)}</p>
                                <p class="text-base font-bold text-primary">${formatCurrency(item.quantity * item.unit_price)}</p>
                            </div>
                        </div>
                    </div>
                    <button
                        type="button"
                        data-cart-item-remove="${index}"
                        class="flex h-8 w-8 items-center justify-center rounded-lg text-rose-500 transition hover:bg-rose-50 active:scale-95 dark:hover:bg-rose-900/20 touch-manipulation"
                    >
                        <i class="fa-solid fa-trash text-sm"></i>
                    </button>
                </div>
            </div>
        `).join('');
    };

    // Helper: Close all dropdowns
    const closeAllDropdowns = () => {
        if (salespersonDropdown) salespersonDropdown.classList.add('hidden');
        if (customerDropdown) customerDropdown.classList.add('hidden');
        if (workOrderDropdown) workOrderDropdown.classList.add('hidden');
    };

    // Helper: Toggle dropdown
    const toggleDropdown = (dropdown, searchInput, loadFunction) => {
        if (!dropdown) {
            console.warn('[POS] Dropdown not found', dropdown);
            return;
        }
        const isHidden = dropdown.classList.contains('hidden');
        
        if (isHidden) {
            // Close all other dropdowns first
            closeAllDropdowns();
            
            // Then open this one immediately (synchronously)
            dropdown.classList.remove('hidden');
            
            // Clear and focus search input
            if (searchInput) {
                searchInput.value = '';
                // Use requestAnimationFrame to ensure dropdown is visible before focusing
                requestAnimationFrame(() => {
                    searchInput.focus();
                });
            }
            
            // Load initial data
            if (loadFunction) {
                loadFunction('');
            }
        } else {
            // If already open, close it
            dropdown.classList.add('hidden');
        }
    };
    
    // Estado de métodos de pago
    let paymentMethods = [];
    const paymentMethodsContainer = root.querySelector('[data-pos-payment-methods]');
    const addPaymentMethodBtn = root.querySelector('[data-pos-add-payment-method]');
    const paymentTotalPaidEl = root.querySelector('[data-pos-payment-total-paid]');
    const documentTypeCheckbox = root.querySelector('[data-pos-document-type]');
    const paymentAdvanceEl = root.querySelector('[data-pos-payment-advance]');
    const paymentAdvanceAmountEl = root.querySelector('[data-pos-payment-advance-amount]');
    const paymentRemainingEl = root.querySelector('[data-pos-payment-remaining]');
    const paymentRemainingAmountEl = root.querySelector('[data-pos-payment-remaining-amount]');

    // Métodos de pago estáticos
    const staticPaymentMethods = [
        { id: 'EFECTIVO', name: 'EFECTIVO' },
        { id: 'TRANSFERENCIA', name: 'TRANSFERENCIA' },
        { id: 'TARJETA', name: 'TARJETA' },
    ];

    // Helper: Render payment methods
    const renderPaymentMethods = () => {
        if (!paymentMethodsContainer) return;
        
        if (paymentMethods.length === 0) {
            paymentMethodsContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">' + tx('No hay métodos de pago agregados') + '</p>';
        } else {
            paymentMethodsContainer.innerHTML = paymentMethods.map((method, index) => `
                <div class="space-y-3 rounded-lg border border-gray-200 bg-white p-3 dark:border-gray-700 dark:bg-slate-800" data-payment-method-item="${index}">
                    <div class="flex items-center gap-3">
                        <div class="relative flex-1" data-select data-select-name="payment_method_${index}" data-select-manual="true">
                            <input type="hidden" data-payment-method-type="${index}" data-select-input value="${method.type || ''}">
                            <button
                                type="button"
                                class="flex w-full items-center justify-between rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/15 dark:border-surface dark:bg-slate-900 dark:text-white"
                                data-select-trigger
                                data-select-placeholder="${tx('Seleccionar método...')}"
                            >
                                <span data-select-value class="truncate">${method.type ? staticPaymentMethods.find(pm => pm.id === method.type)?.name || method.type : tx('Seleccionar método...')}</span>
                                <i class="fa-solid fa-chevron-down text-xs text-secondary transition" data-select-icon></i>
                            </button>
                            <div
                                class="invisible absolute left-0 right-0 z-50 mt-2 w-full origin-top scale-95 transform rounded-lg border border-gray-200 bg-white shadow-xl opacity-0 transition will-change-transform data-[open='true']:visible data-[open='true']:scale-100 data-[open='true']:opacity-100 dark:border-gray-700 dark:bg-slate-900"
                                data-select-dropdown
                                hidden
                            >
                                <div class="max-h-60 overflow-y-auto py-2">
                                    ${staticPaymentMethods.map(pm => `
                                        <button
                                            type="button"
                                            class="w-full px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-slate-800"
                                            data-value="${pm.id}"
                                            data-select-option
                                        >
                                            ${pm.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <input
                            type="number"
                            data-payment-method-amount="${index}"
                            step="0.01"
                            min="0"
                            placeholder="0.00"
                            value="${method.amount || ''}"
                            class="w-32 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                        >
                        <button
                            type="button"
                            data-payment-method-remove="${index}"
                            class="flex h-9 w-9 items-center justify-center rounded-lg text-rose-500 transition hover:bg-rose-50 active:scale-95 dark:hover:bg-rose-900/20"
                        >
                            <i class="fa-solid fa-times text-sm"></i>
                        </button>
                    </div>
                    <div class="payment-method-reference" data-payment-method-reference="${index}" style="display: ${(method.type === 'TRANSFERENCIA' || method.type === 'TARJETA') ? 'block' : 'none'};">
                        <label class="mb-1 block text-xs font-semibold text-gray-600 dark:text-gray-400">
                            ${tx('Número de referencia')} <span class="text-rose-500">*</span>
                        </label>
                        <input
                            type="text"
                            data-payment-method-reference-input="${index}"
                            placeholder="${tx('Ingrese el número de referencia')}"
                            value="${method.reference || ''}"
                            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                        >
                    </div>
                </div>
            `).join('');
            
            // Agregar event listeners
            paymentMethods.forEach((_, index) => {
                const paymentItem = paymentMethodsContainer.querySelector(`[data-payment-method-item="${index}"]`);
                const typeSelect = paymentItem?.querySelector(`[data-select-name="payment_method_${index}"]`);
                const typeInput = paymentItem?.querySelector(`[data-payment-method-type="${index}"]`);
                const amountInput = paymentItem?.querySelector(`[data-payment-method-amount="${index}"]`);
                const referenceInput = paymentItem?.querySelector(`[data-payment-method-reference-input="${index}"]`);
                const referenceContainer = paymentItem?.querySelector(`[data-payment-method-reference="${index}"]`);
                const removeBtn = paymentItem?.querySelector(`[data-payment-method-remove="${index}"]`);
                
                // Initialize custom select
                if (typeSelect) {
                    const trigger = typeSelect.querySelector('[data-select-trigger]');
                    const dropdown = typeSelect.querySelector('[data-select-dropdown]');
                    const valueSpan = typeSelect.querySelector('[data-select-value]');
                    const options = typeSelect.querySelectorAll('[data-select-option]');
                    
                    if (trigger && dropdown) {
                        const closeSelect = () => {
                            dropdown.hidden = true;
                            dropdown.dataset.open = 'false';
                            typeSelect.dataset.open = 'false';
                            trigger.setAttribute('aria-expanded', 'false');
                            const icon = typeSelect.querySelector('[data-select-icon]');
                            if (icon) icon.classList.remove('rotate-180');
                        };
                        
                        const openSelect = () => {
                            dropdown.hidden = false;
                            dropdown.dataset.open = 'true';
                            typeSelect.dataset.open = 'true';
                            trigger.setAttribute('aria-expanded', 'true');
                            const icon = typeSelect.querySelector('[data-select-icon]');
                            if (icon) icon.classList.add('rotate-180');
                        };
                        
                        trigger.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const isOpen = dropdown.dataset.open === 'true';
                            if (isOpen) {
                                closeSelect();
                            } else {
                                openSelect();
                            }
                        });
                        
                        options.forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const value = option.dataset.value;
                                if (typeInput) typeInput.value = value;
                                if (valueSpan) {
                                    valueSpan.textContent = option.textContent.trim();
                                }
                                paymentMethods[index].type = value;
                                
                                // Show/hide reference field
                                if (referenceContainer) {
                                    if (value === 'TRANSFERENCIA' || value === 'TARJETA') {
                                        referenceContainer.style.display = 'block';
                                    } else {
                                        referenceContainer.style.display = 'none';
                                        if (referenceInput) referenceInput.value = '';
                                        paymentMethods[index].reference = '';
                                    }
                                }
                                
                                closeSelect();
                                updatePaymentTotals();
                            });
                        });
                        
                        document.addEventListener('click', (e) => {
                            if (!typeSelect.contains(e.target)) {
                                closeSelect();
                            }
                        });
                    }
                }
                
                if (amountInput) {
                    amountInput.addEventListener('input', (e) => {
                        paymentMethods[index].amount = parseFloat(e.target.value) || 0;
                        updatePaymentTotals();
                    });
                }
                
                if (referenceInput) {
                    referenceInput.addEventListener('input', (e) => {
                        paymentMethods[index].reference = e.target.value.trim();
                    });
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        paymentMethods.splice(index, 1);
                        renderPaymentMethods();
                        updatePaymentTotals();
                    });
                }
            });
        }
    };

    // Helper: Update payment totals
    const updatePaymentTotals = () => {
        const subtotal = cartItems.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
        const tax = subtotal * 0.15;
        const total = subtotal + tax;
        const remaining = Math.max(0, total - workOrderAdvance);
        
        const totalPaid = paymentMethods.reduce((sum, method) => sum + (parseFloat(method.amount) || 0), 0);
        
        if (paymentTotalPaidEl) paymentTotalPaidEl.textContent = formatCurrency(totalPaid);
        
        // Mostrar abono en modal si existe
        if (workOrderAdvance > 0) {
            if (paymentAdvanceEl) paymentAdvanceEl.style.display = 'flex';
            if (paymentAdvanceAmountEl) paymentAdvanceAmountEl.textContent = formatCurrency(workOrderAdvance);
            if (paymentRemainingEl) paymentRemainingEl.style.display = 'flex';
            if (paymentRemainingAmountEl) paymentRemainingAmountEl.textContent = formatCurrency(remaining - totalPaid);
        } else {
            if (paymentAdvanceEl) paymentAdvanceEl.style.display = 'none';
            if (paymentRemainingEl) paymentRemainingEl.style.display = 'none';
        }
    };

    // Helper: Add payment method
    const addPaymentMethod = () => {
        paymentMethods.push({ type: '', amount: 0, reference: '' });
        renderPaymentMethods();
    };

    // Helper: Open payment modal
    const openPaymentModal = () => {
        if (paymentModal) {
            // Reset payment methods
            paymentMethods = [];
            renderPaymentMethods();
            
            // Update totals
            calculateTotals();
            updatePaymentTotals();
            
            // Show/hide advance in modal
            if (workOrderAdvance > 0) {
                if (paymentAdvanceEl) paymentAdvanceEl.style.display = 'flex';
                if (paymentAdvanceAmountEl) paymentAdvanceAmountEl.textContent = formatCurrency(workOrderAdvance);
                if (paymentRemainingEl) paymentRemainingEl.style.display = 'flex';
            } else {
                if (paymentAdvanceEl) paymentAdvanceEl.style.display = 'none';
                if (paymentRemainingEl) paymentRemainingEl.style.display = 'none';
            }
            
            paymentModal.classList.remove('hidden');
            paymentModal.classList.add('flex');
            if (addPaymentMethodBtn) addPaymentMethodBtn.focus();
        }
    };
    
    // Helper: Close payment modal
    const closePaymentModal = () => {
        if (paymentModal) {
            paymentModal.classList.add('hidden');
            paymentModal.classList.remove('flex');
            if (paymentNotesTextarea) paymentNotesTextarea.value = '';
            paymentMethods = [];
            renderPaymentMethods();
            if (documentTypeCheckbox) documentTypeCheckbox.checked = false;
        }
    };

    // Search functions
    let searchTimeouts = {};

    const loadSalespersons = async (search = '') => {
        clearTimeout(searchTimeouts.salesperson);
        searchTimeouts.salesperson = setTimeout(async () => {
            try {
                const query = search ? `?search=${encodeURIComponent(search)}&limit=50` : '?limit=50';
                const response = await fetch(`${usersUrl}${query}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items && salespersonResults) {
                    salespersonResults.innerHTML = '';
                    if (json.data.items.length === 0) {
                        salespersonResults.innerHTML = `<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${tx('No se encontraron vendedores')}</div>`;
                    } else {
                        json.data.items.forEach((user) => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'flex w-full items-center justify-between px-4 py-3 text-left text-sm text-gray-900 transition hover:bg-primary/10 active:bg-primary/20 dark:text-white dark:hover:bg-slate-800 touch-manipulation';
                            const userDisplayName = user.name || user.full_name || user.email || '';
                            item.innerHTML = `
                                <div>
                                    <p class="font-medium">${userDisplayName}</p>
                                    ${user.email ? `<p class="text-xs text-gray-500 dark:text-gray-400">${user.email}</p>` : ''}
                                </div>
                            `;
                            item.addEventListener('click', () => {
                                selectedSalesperson = user;
                                const userDisplayName = user.name || user.full_name || user.email || '';
                                if (salespersonId) salespersonId.value = user.id;
                                if (salespersonDisplay) salespersonDisplay.textContent = userDisplayName;
                                if (salespersonName) salespersonName.textContent = userDisplayName;
                                if (salespersonSelected) salespersonSelected.style.display = 'flex';
                                if (salespersonTrigger) salespersonTrigger.style.display = 'none';
                                if (salespersonSearch) salespersonSearch.value = '';
                                if (salespersonDropdown) salespersonDropdown.classList.add('hidden');
                            });
                            salespersonResults.appendChild(item);
                        });
                    }
                }
            } catch (error) {
                console.error('[POS] Error loading salespersons', error);
            }
        }, 300);
    };

    const loadCustomers = async (search = '') => {
        clearTimeout(searchTimeouts.customer);
        searchTimeouts.customer = setTimeout(async () => {
            try {
                const query = search ? `?search=${encodeURIComponent(search)}&limit=50` : '?limit=50';
                const response = await fetch(`${customersUrl}${query}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items && customerResults) {
                    customerResults.innerHTML = '';
                    if (json.data.items.length === 0) {
                        customerResults.innerHTML = `<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${tx('No se encontraron clientes')}</div>`;
                    } else {
                        json.data.items.forEach((customer) => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'flex w-full items-center justify-between px-4 py-3 text-left text-sm text-gray-900 transition hover:bg-primary/10 active:bg-primary/20 dark:text-white dark:hover:bg-slate-800 touch-manipulation';
                            const customerDisplayName = customer.name || customer.display_name || '';
                            item.innerHTML = `
                                <div>
                                    <p class="font-medium">${customerDisplayName}</p>
                                    ${customer.document_number ? `<p class="text-xs text-gray-500 dark:text-gray-400">${customer.document_number}</p>` : ''}
                                </div>
                            `;
                            item.addEventListener('click', () => {
                                selectedCustomer = customer;
                                const customerDisplayName = customer.name || customer.display_name || '';
                                if (customerId) customerId.value = customer.id;
                                if (customerDisplay) customerDisplay.textContent = customerDisplayName;
                                if (customerName) customerName.textContent = customerDisplayName;
                                if (customerSelected) customerSelected.style.display = 'flex';
                                if (customerTrigger) customerTrigger.style.display = 'none';
                                if (customerSearch) customerSearch.value = '';
                                if (customerDropdown) customerDropdown.classList.add('hidden');
                                
                                // Cargar órdenes del cliente seleccionado
                                if (customer.id) {
                                    loadWorkOrders('', customer.id);
                                }
                                
                                calculateTotals();
                            });
                            customerResults.appendChild(item);
                        });
                    }
                }
            } catch (error) {
                console.error('[POS] Error loading customers', error);
            }
        }, 300);
    };

    const loadWorkOrders = async (search = '', customerIdFilter = null) => {
        clearTimeout(searchTimeouts.workOrder);
        searchTimeouts.workOrder = setTimeout(async () => {
            try {
                let query = search ? `?search=${encodeURIComponent(search)}` : '?';
                if (customerIdFilter) {
                    query += query.includes('?') && query !== '?' ? '&' : '';
                    query += `customer_id=${encodeURIComponent(customerIdFilter)}`;
                }
                query += query.includes('?') && query !== '?' ? '&' : '';
                query += 'limit=50';
                
                const response = await fetch(`${workOrdersUrl}${query}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items && workOrderResults) {
                    workOrderResults.innerHTML = '';
                    if (json.data.items.length === 0) {
                        workOrderResults.innerHTML = `<div class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${tx('No se encontraron órdenes')}</div>`;
                    } else {
                        json.data.items.forEach((order) => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'flex w-full items-center justify-between px-4 py-3 text-left text-sm text-gray-900 transition hover:bg-primary/10 active:bg-primary/20 dark:text-white dark:hover:bg-slate-800 touch-manipulation';
                            item.innerHTML = `
                                <div>
                                    <p class="font-medium">${order.order_number}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${order.customer_name} - ${formatCurrency(order.total_cost)}</p>
                                </div>
                            `;
                            item.addEventListener('click', () => {
                                selectedWorkOrder = order;
                                if (workOrderId) workOrderId.value = order.id;
                                if (workOrderDisplay) workOrderDisplay.textContent = order.order_number;
                                if (workOrderNumber) workOrderNumber.textContent = order.order_number;
                                if (workOrderCustomer) workOrderCustomer.textContent = order.customer_name;
                                if (workOrderSelected) workOrderSelected.style.display = 'block';
                                if (workOrderTrigger) workOrderTrigger.style.display = 'none';
                                if (workOrderSearch) workOrderSearch.value = '';
                                if (workOrderDropdown) workOrderDropdown.classList.add('hidden');

                                // Cargar cliente de la orden si no está seleccionado
                                if (order.customer_id && (!selectedCustomer || selectedCustomer.id !== order.customer_id)) {
                                    // Buscar y seleccionar el cliente de la orden
                                    fetch(`${customersUrl}?search=&limit=100`, {
                                        headers: {
                                            Accept: 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest',
                                        },
                                    })
                                        .then((response) => response.json())
                                        .then((json) => {
                                            if (json?.status === 'success' && json?.data?.items) {
                                                const orderCustomer = json.data.items.find(c => c.id === order.customer_id);
                                                if (orderCustomer) {
                                                    selectedCustomer = orderCustomer;
                                                    const customerDisplayName = orderCustomer.name || orderCustomer.display_name || '';
                                                    if (customerId) customerId.value = orderCustomer.id;
                                                    if (customerDisplay) customerDisplay.textContent = customerDisplayName;
                                                    if (customerName) customerName.textContent = customerDisplayName;
                                                    if (customerSelected) customerSelected.style.display = 'flex';
                                                    if (customerTrigger) customerTrigger.style.display = 'none';
                                                }
                                            }
                                        })
                                        .catch((error) => {
                                            console.error('[POS] Error loading customer from order', error);
                                        });
                                }

                                // Cargar abono de la orden
                                workOrderAdvance = parseFloat(order.total_advances || 0);

                                // Cargar items de la orden al carrito
                                cartItems = [];
                                if (order.items && order.items.length > 0) {
                                    order.items.forEach((item) => {
                                        cartItems.push({
                                            item_id: item.item_id,
                                            item_type: item.item_type,
                                            name: item.name || 'Producto',
                                            sku: item.sku || '',
                                            quantity: item.quantity,
                                            unit_price: item.unit_price,
                                        });
                                    });
                                }
                                if (order.services && order.services.length > 0) {
                                    order.services.forEach((service) => {
                                        cartItems.push({
                                            item_id: service.item_id,
                                            item_type: service.item_type,
                                            name: service.name || 'Servicio',
                                            sku: service.sku || '',
                                            quantity: service.quantity,
                                            unit_price: service.unit_price,
                                        });
                                    });
                                }

                                renderCartItems();
                                calculateTotals();
                            });
                            workOrderResults.appendChild(item);
                        });
                    }
                }
            } catch (error) {
                console.error('[POS] Error loading work orders', error);
            }
        }, 300);
    };

    const loadItems = async (search = '') => {
        clearTimeout(searchTimeouts.item);
        searchTimeouts.item = setTimeout(async () => {
            try {
                const url = currentTab === 'products' ? productsUrl : servicesUrl;
                const query = search ? `?search=${encodeURIComponent(search)}&limit=100` : '?limit=100';
                const response = await fetch(`${url}${query}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items && productsGrid) {
                    if (json.data.items.length === 0) {
                        productsGrid.innerHTML = `
                            <div class="col-span-full rounded-xl border-2 border-dashed border-gray-300 p-12 text-center dark:border-gray-700">
                                <i class="fa-solid fa-box-open mb-4 text-5xl text-gray-400"></i>
                                <p class="text-gray-500 dark:text-gray-400">${tx('No se encontraron resultados')}</p>
                            </div>
                        `;
                    } else {
                        productsGrid.innerHTML = json.data.items.map((item) => {
                            const existingCartItem = cartItems.find(cartItem => 
                                cartItem.item_id === item.id && cartItem.item_type === (currentTab === 'products' ? 'product' : 'service')
                            );
                            const isInCart = existingCartItem !== undefined;
                            
                            return `
                                <div
                                    class="group relative cursor-pointer rounded-lg border-2 border-gray-200 bg-white p-4 text-center transition-all hover:border-primary hover:shadow-lg active:scale-95 dark:border-gray-700 dark:bg-slate-800 touch-manipulation ${isInCart ? 'border-primary bg-primary/5' : ''}"
                                    data-pos-product-item="${item.id}"
                                    data-pos-product-type="${currentTab === 'products' ? 'product' : 'service'}"
                                >
                                    ${item.image_url ? `
                                        <img
                                            src="${item.image_url}"
                                            alt="${item.name}"
                                            class="mx-auto mb-3 h-20 w-20 rounded-lg object-cover"
                                            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'80\\' height=\\'80\\'%3E%3Crect fill=\\'%23f0f0f0\\' width=\\'80\\' height=\\'80\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\' font-family=\\'sans-serif\\' font-size=\\'12\\'%3E${tx('Sin imagen')}%3C/text%3E%3C/svg%3E'"
                                        >
                                    ` : `
                                        <div class="mx-auto mb-3 flex h-20 w-20 items-center justify-center rounded-lg bg-gray-100 dark:bg-slate-700">
                                            <i class="fa-solid ${currentTab === 'products' ? 'fa-box' : 'fa-wrench'} text-3xl text-gray-400"></i>
                                        </div>
                                    `}
                                    <h3 class="mb-2 text-sm font-semibold text-gray-900 line-clamp-2 dark:text-white">
                                        ${item.name}
                                    </h3>
                                    ${item.sku ? `<p class="mb-2 text-xs text-gray-500 dark:text-gray-400">${item.sku}</p>` : ''}
                                    <p class="text-lg font-bold text-primary">
                                        ${formatCurrency(item.price)}
                                    </p>
                                    ${item.stock !== undefined ? `
                                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                            ${tx('Stock')}: ${item.stock}
                                        </p>
                                    ` : ''}
                                    ${isInCart ? `
                                        <div class="absolute top-2 right-2 rounded-full bg-primary px-2 py-1 text-xs font-bold text-white">
                                            ${existingCartItem.quantity}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                        
                        // Add click listeners to product items
                        productsGrid.querySelectorAll('[data-pos-product-item]').forEach((productEl) => {
                            productEl.addEventListener('click', () => {
                                const itemId = productEl.dataset.posProductItem;
                                const itemType = productEl.dataset.posProductType;
                                const item = json.data.items.find(i => i.id === itemId);
                                
                                if (!item) return;
                                
                                // Add to cart
                                const existingIndex = cartItems.findIndex(cartItem => 
                                    cartItem.item_id === item.id && cartItem.item_type === itemType
                                );

                                if (existingIndex >= 0) {
                                    cartItems[existingIndex].quantity += 1;
                                } else {
                                    cartItems.push({
                                        item_id: item.id,
                                        item_type: itemType,
                                        name: item.name,
                                        sku: item.sku || '',
                                        quantity: 1,
                                        unit_price: item.price,
                                    });
                                }

                                renderCartItems();
                                calculateTotals();
                                
                                // Refresh grid to show updated cart badge
                                loadItems(itemSearch?.value || '');
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('[POS] Error loading items', error);
                if (productsGrid) {
                    productsGrid.innerHTML = `
                        <div class="col-span-full rounded-xl border-2 border-dashed border-red-300 p-12 text-center dark:border-red-700">
                            <i class="fa-solid fa-exclamation-triangle mb-4 text-5xl text-red-400"></i>
                            <p class="text-red-500 dark:text-red-400">${tx('Error al cargar productos')}</p>
                        </div>
                    `;
                }
            }
        }, 300);
    };

    // Event listeners - Triggers
    if (salespersonTrigger && salespersonDropdown) {
        salespersonTrigger.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default button behavior
            e.stopPropagation(); // Stop propagation to root listener
            toggleDropdown(salespersonDropdown, salespersonSearch, loadSalespersons);
        });
    } else {
        console.warn('[POS] Salesperson trigger or dropdown not found', { salespersonTrigger, salespersonDropdown });
    }

    if (customerTrigger && customerDropdown) {
        customerTrigger.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default button behavior
            e.stopPropagation(); // Stop propagation to root listener
            toggleDropdown(customerDropdown, customerSearch, loadCustomers);
        });
    } else {
        console.warn('[POS] Customer trigger or dropdown not found', { customerTrigger, customerDropdown });
    }

    if (workOrderTrigger && workOrderDropdown) {
        workOrderTrigger.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default button behavior
            e.stopPropagation(); // Stop propagation to root listener
            toggleDropdown(workOrderDropdown, workOrderSearch, loadWorkOrders);
        });
    } else {
        console.warn('[POS] Work order trigger or dropdown not found', { workOrderTrigger, workOrderDropdown });
    }

    // Event listeners - Search inputs inside dropdowns
    if (salespersonSearch) {
        salespersonSearch.addEventListener('input', (e) => {
            loadSalespersons(e.target.value);
        });
    }

    if (customerSearch) {
        customerSearch.addEventListener('input', (e) => {
            loadCustomers(e.target.value);
        });
    }

    if (workOrderSearch) {
        workOrderSearch.addEventListener('input', (e) => {
            loadWorkOrders(e.target.value);
        });
    }

    // Product/service search - direct search without dropdown
    if (itemSearch) {
        itemSearch.addEventListener('input', (e) => {
            loadItems(e.target.value);
        });
        // Load initial products
        loadItems('');
    }

    // Tab switching
    tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.posTab;
            currentTab = tab;

            tabButtons.forEach((b) => {
                if (b.dataset.posTab === tab) {
                    b.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-slate-700', 'dark:text-gray-300', 'dark:hover:bg-slate-600');
                    b.classList.add('bg-primary', 'text-white', 'hover:bg-primary-strong');
                } else {
                    b.classList.remove('bg-primary', 'text-white', 'hover:bg-primary-strong');
                    b.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-slate-700', 'dark:text-gray-300', 'dark:hover:bg-slate-600');
                }
            });

            if (itemSearch) {
                itemSearch.placeholder = tab === 'products' ? tx('Buscar productos por nombre o SKU...') : tx('Buscar servicios por nombre...');
                itemSearch.value = '';
            }
            
            // Update title
            const productsTitle = root.querySelector('[data-pos-products-title]');
            if (productsTitle) {
                productsTitle.textContent = tab === 'products' ? tx('Productos Disponibles') : tx('Servicios Disponibles');
            }
            
            // Load items for the selected tab
            loadItems('');
        });
    });

    // Cart item controls
    cartItemsContainer?.addEventListener('click', (e) => {
        const decreaseBtn = e.target.closest('[data-cart-item-decrease]');
        if (decreaseBtn) {
            const index = parseInt(decreaseBtn.dataset.cartItemDecrease);
            if (cartItems[index].quantity > 1) {
                cartItems[index].quantity -= 1;
                renderCartItems();
                calculateTotals();
            }
            return;
        }

        const increaseBtn = e.target.closest('[data-cart-item-increase]');
        if (increaseBtn) {
            const index = parseInt(increaseBtn.dataset.cartItemIncrease);
            cartItems[index].quantity += 1;
            renderCartItems();
            calculateTotals();
            return;
        }

        const removeBtn = e.target.closest('[data-cart-item-remove]');
        if (removeBtn) {
            const index = parseInt(removeBtn.dataset.cartItemRemove);
            cartItems.splice(index, 1);
            renderCartItems();
            calculateTotals();
            return;
        }
    });

    // Quantity input changes
    cartItemsContainer?.addEventListener('change', (e) => {
        const quantityInput = e.target.closest('[data-cart-item-quantity]');
        if (quantityInput) {
            const index = parseInt(quantityInput.dataset.cartItemQuantity);
            const quantity = parseInt(quantityInput.value) || 1;
            cartItems[index].quantity = Math.max(1, quantity);
            renderCartItems();
            calculateTotals();
        }
    });

    // Clear buttons
    if (salespersonClear) {
        salespersonClear.addEventListener('click', () => {
            selectedSalesperson = null;
            if (salespersonId) salespersonId.value = '';
            if (salespersonSelected) salespersonSelected.style.display = 'none';
            if (salespersonTrigger) salespersonTrigger.style.display = 'flex';
            if (salespersonDisplay) salespersonDisplay.textContent = tx('Seleccionar vendedor...');
        });
    }

    if (customerClear) {
        customerClear.addEventListener('click', () => {
            selectedCustomer = null;
            if (customerId) customerId.value = '';
            if (customerSelected) customerSelected.style.display = 'none';
            if (customerTrigger) customerTrigger.style.display = 'flex';
            if (customerDisplay) customerDisplay.textContent = tx('Seleccionar cliente...');
            calculateTotals();
        });
    }

    if (workOrderClear) {
        workOrderClear.addEventListener('click', () => {
            selectedWorkOrder = null;
            workOrderAdvance = 0;
            if (workOrderId) workOrderId.value = '';
            if (workOrderSelected) workOrderSelected.style.display = 'none';
            if (workOrderTrigger) workOrderTrigger.style.display = 'flex';
            if (workOrderDisplay) workOrderDisplay.textContent = tx('Seleccionar orden de trabajo...');
            calculateTotals();
        });
    }

    // Complete sale - open payment modal
    if (completeSaleBtn) {
        completeSaleBtn.addEventListener('click', () => {
            if (!selectedCustomer || cartItems.length === 0) return;
            openPaymentModal();
        });
    }
    
    // Clear cart
    if (clearCartBtn) {
        clearCartBtn.addEventListener('click', () => {
            if (cartItems.length === 0) return;
            getThemedSwal().then((Swal) => {
                Swal.fire({
                    title: tx('¿Limpiar el carrito?'),
                    text: tx('Esta acción eliminará todos los items del carrito.'),
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: tx('Sí, limpiar'),
                    cancelButtonText: tx('Cancelar'),
                }).then((result) => {
                    if (result.isConfirmed) {
                        cartItems = [];
                        workOrderAdvance = 0;
                        renderCartItems();
                        calculateTotals();
                        loadItems(itemSearch?.value || '');
                    }
                });
            });
        });
    }
    
    // Payment modal - close buttons
    paymentCloseBtn.forEach((btn) => {
        btn.addEventListener('click', () => {
            closePaymentModal();
        });
    });
    
    // Payment modal - close on outside click
    if (paymentModal) {
        paymentModal.addEventListener('click', (e) => {
            if (e.target === paymentModal) {
                closePaymentModal();
            }
        });
    }
    
    // Payment modal - close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && paymentModal && !paymentModal.classList.contains('hidden')) {
            closePaymentModal();
        }
    });
    
    // Event listener para agregar método de pago
    if (addPaymentMethodBtn) {
        addPaymentMethodBtn.addEventListener('click', () => {
            addPaymentMethod();
        });
    }
    
    // Payment modal - confirm sale
    if (paymentConfirmBtn) {
        paymentConfirmBtn.addEventListener('click', async () => {
            if (!selectedCustomer || cartItems.length === 0) {
                showAlert({ 
                    title: tx('Error'), 
                    text: tx('Debes seleccionar un cliente y agregar items al carrito.'), 
                    icon: 'error' 
                });
                return;
            }
            
            // Validar que haya al menos un método de pago con tipo y monto
            const validPaymentMethods = paymentMethods.filter(pm => pm.type && parseFloat(pm.amount) > 0);
            if (validPaymentMethods.length === 0) {
                showAlert({ 
                    title: tx('Error'), 
                    text: tx('Debes agregar al menos un método de pago con tipo y monto.'), 
                    icon: 'error' 
                });
                return;
            }
            
            // Validar que los métodos TRANSFERENCIA y TARJETA tengan referencia
            for (const method of validPaymentMethods) {
                if ((method.type === 'TRANSFERENCIA' || method.type === 'TARJETA') && !method.reference?.trim()) {
                    showAlert({ 
                        title: tx('Error'), 
                        text: tx('El número de referencia es requerido para ') + method.type + '.', 
                        icon: 'error' 
                    });
                    return;
                }
            }
            
            // Calcular totales
            const subtotal = cartItems.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
            const tax = subtotal * 0.15;
            const total = subtotal + tax;
            const remaining = Math.max(0, total - workOrderAdvance);
            const totalPaid = validPaymentMethods.reduce((sum, method) => sum + (parseFloat(method.amount) || 0), 0);
            
            // Validar que el total pagado no exceda el restante
            if (totalPaid > remaining) {
                showAlert({ 
                    title: tx('Error'), 
                    text: tx('El total pagado no puede exceder el restante a pagar.'), 
                    icon: 'error' 
                });
                return;
            }
            
            paymentConfirmBtn.disabled = true;
            const originalText = paymentConfirmBtn.innerHTML;
            paymentConfirmBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>${tx('Procesando...')}`;

            try {
                // Determinar tipo de documento
                const documentType = documentTypeCheckbox && documentTypeCheckbox.checked ? 'NOTA DE VENTA' : 'FACTURA';
                
                const response = await fetch(storeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                    },
                    body: JSON.stringify({
                        customer_id: selectedCustomer.id,
                        salesperson_id: selectedSalesperson?.id || null,
                        work_order_id: selectedWorkOrder?.id || null,
                        document_type: documentType,
                        work_order_advance: workOrderAdvance,
                        payment_methods: validPaymentMethods.map(pm => ({
                            type: pm.type,
                            amount: parseFloat(pm.amount),
                            reference: pm.reference || null,
                        })),
                        notes: paymentNotesTextarea?.value || '',
                        items: cartItems.map(item => ({
                            item_id: item.item_id,
                            item_type: item.item_type,
                            quantity: item.quantity,
                            unit_price: item.unit_price,
                        })),
                    }),
                });

                const json = await response.json();

                if (json?.status === 'success') {
                    const documentNumber = json.data.invoice?.invoice_number || json.data.sales_note?.document_number || '';
                    const documentName = documentType === 'NOTA DE VENTA' ? tx('Nota de Venta') : tx('Factura');
                    const isPaid = json.data.invoice?.workflow_status === 'paid' || json.data.sales_note?.workflow_status === 'paid';
                    
                    showAlert({ 
                        title: tx('Éxito'), 
                        text: `${tx('Venta procesada correctamente.')}\n\n${documentName}: ${documentNumber}\n${isPaid ? tx('Estado: Pagado') : tx('Estado: Pendiente de pago')}`, 
                        icon: 'success' 
                    });
                    
                    // Reset POS
                    cartItems = [];
                    selectedCustomer = null;
                    selectedSalesperson = null;
                    selectedWorkOrder = null;
                    workOrderAdvance = 0;
                    if (customerId) customerId.value = '';
                    if (salespersonId) salespersonId.value = '';
                    if (workOrderId) workOrderId.value = '';
                    if (customerSelected) customerSelected.style.display = 'none';
                    if (salespersonSelected) salespersonSelected.style.display = 'none';
                    if (workOrderSelected) workOrderSelected.style.display = 'none';
                    if (customerTrigger) customerTrigger.style.display = 'flex';
                    if (salespersonTrigger) salespersonTrigger.style.display = 'flex';
                    if (workOrderTrigger) workOrderTrigger.style.display = 'flex';
                    if (customerDisplay) customerDisplay.textContent = tx('Seleccionar cliente...');
                    if (salespersonDisplay) salespersonDisplay.textContent = tx('Seleccionar vendedor...');
                    if (workOrderDisplay) workOrderDisplay.textContent = tx('Buscar orden de trabajo...');
                    renderCartItems();
                    calculateTotals();
                    loadItems(itemSearch?.value || '');
                    closePaymentModal();
                } else {
                    showAlert({ 
                        title: tx('Error'), 
                        text: json?.message || tx('Error al procesar la venta.'), 
                        icon: 'error' 
                    });
                }
            } catch (error) {
                console.error('[POS] Error completing sale', error);
                showAlert({ 
                    title: tx('Error'), 
                    text: tx('Error al procesar la venta. Inténtalo nuevamente.'), 
                    icon: 'error' 
                });
            } finally {
                paymentConfirmBtn.disabled = false;
                paymentConfirmBtn.innerHTML = originalText;
            }
        });
    }

    // Close dropdowns on outside click (delegated to root)
    // Triggers use stopPropagation, so this won't fire for trigger clicks
    root.addEventListener('click', (e) => {
        // Check if click is inside any dropdown (search inputs, results, etc.)
        const clickedInsideDropdown = 
            (salespersonDropdown && !salespersonDropdown.classList.contains('hidden') && salespersonDropdown.contains(e.target)) ||
            (customerDropdown && !customerDropdown.classList.contains('hidden') && customerDropdown.contains(e.target)) ||
            (workOrderDropdown && !workOrderDropdown.classList.contains('hidden') && workOrderDropdown.contains(e.target));

        if (clickedInsideDropdown) {
            // Don't close if clicking inside an open dropdown
            return;
        }

        // Close all dropdowns if clicking outside
        // Note: This won't fire for trigger clicks because triggers use stopPropagation
        closeAllDropdowns();
    }, false); // Use bubbling phase (default)

    // Close dropdowns on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeAllDropdowns();
        }
    });

    // Initial render
    renderCartItems();
    calculateTotals();
};

const initQuotationForm = () => {
    const root = document.querySelector('[data-quotation-form-root]');
    if (!root) return;

    const baseUrl = window.location.origin;
    const quotationId = root.dataset.quotationId || null;

    // URLs
    const customersUrl = `${baseUrl}/sales/quotations/search/customers`;
    const productsUrl = `${baseUrl}/sales/quotations/search/products`;
    const servicesUrl = `${baseUrl}/sales/quotations/search/services`;

    // Estado
    let currentTab = 'products';
    let cartItems = [];
    let selectedCustomer = null;

    // Elements
    const customerContainer = root.querySelector('[data-quotation-customer]');
    const customerSearch = root.querySelector('[data-quotation-customer-search]');
    const customerId = root.querySelector('[data-quotation-customer-id]');
    const customerResults = root.querySelector('[data-quotation-customer-results]');
    const customerOptions = root.querySelector('[data-quotation-customer-options]');

    const itemSearch = root.querySelector('[data-quotation-item-search]');
    const itemsGrid = root.querySelector('[data-quotation-items-grid]');
    const cartItemsContainer = root.querySelector('[data-quotation-cart-items]');
    const totalEl = root.querySelector('[data-quotation-total]');
    const form = root.querySelector('form');
    const tabButtons = root.querySelectorAll('[data-quotation-tab]');

    // Helpers
    const tx = (message) => {
        try {
            if (typeof window !== 'undefined' && typeof window.gettext === 'function') {
                return window.gettext(message);
            }
        } catch (error) {
            console.warn('[Quotation] translate error', error, message);
        }
        return message;
    };

    const formatCurrency = (amount) => {
        return `USD ${Number(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
    };

    const calculateTotal = () => {
        const subtotal = cartItems.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
        const tax = subtotal * 0.15; // IVA 15%
        const total = subtotal + tax;

        if (totalEl) totalEl.textContent = formatCurrency(total);
    };

    const renderCartItems = () => {
        if (!cartItemsContainer) return;

        if (cartItems.length === 0) {
            cartItemsContainer.innerHTML = `
                <div class="rounded-lg border-2 border-dashed border-gray-300 p-8 text-center dark:border-gray-700">
                    <i class="fa-solid fa-shopping-cart mb-3 text-4xl text-gray-400"></i>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${tx('No hay items agregados')}</p>
                </div>
            `;
            return;
        }

        cartItemsContainer.innerHTML = cartItems.map((item, index) => `
            <div class="rounded-lg border border-gray-200 bg-gray-50 p-3 shadow-sm dark:border-gray-800 dark:bg-slate-900/50" data-cart-item="${index}">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">${item.name}</h3>
                        ${item.sku ? `<p class="mt-1 text-xs text-gray-600 dark:text-gray-400">${item.sku}</p>` : ''}
                        <div class="mt-2 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button
                                    type="button"
                                    data-cart-item-decrease="${index}"
                                    class="flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 active:scale-95 dark:border-gray-700 dark:bg-slate-900 dark:text-gray-300"
                                >
                                    <i class="fa-solid fa-minus text-xs"></i>
                                </button>
                                <input
                                    type="number"
                                    data-cart-item-quantity="${index}"
                                    value="${item.quantity}"
                                    min="1"
                                    class="w-16 rounded-lg border border-gray-300 bg-white px-2 py-1 text-center text-sm font-semibold text-gray-900 outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/20 dark:border-gray-700 dark:bg-slate-900 dark:text-white"
                                >
                                <button
                                    type="button"
                                    data-cart-item-increase="${index}"
                                    class="flex h-8 w-8 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 active:scale-95 dark:border-gray-700 dark:bg-slate-900 dark:text-gray-300"
                                >
                                    <i class="fa-solid fa-plus text-xs"></i>
                                </button>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-medium text-gray-600 dark:text-gray-400">${formatCurrency(item.unit_price)}</p>
                                <p class="text-base font-bold text-primary">${formatCurrency(item.quantity * item.unit_price)}</p>
                            </div>
                        </div>
                    </div>
                    <button
                        type="button"
                        data-cart-item-remove="${index}"
                        class="flex h-8 w-8 items-center justify-center rounded-lg text-rose-500 transition hover:bg-rose-50 active:scale-95 dark:hover:bg-rose-900/20"
                    >
                        <i class="fa-solid fa-trash text-sm"></i>
                    </button>
                </div>
            </div>
        `).join('');
    };

    // Search functions
    let searchTimeouts = {};

    const loadCustomers = async (search = '') => {
        clearTimeout(searchTimeouts.customer);
        searchTimeouts.customer = setTimeout(async () => {
            try {
                const query = search ? `?search=${encodeURIComponent(search)}&limit=100` : '?limit=100';
                const response = await fetch(`${customersUrl}${query}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                const json = await response.json();
                const optionsContainer = customerOptions || customerResults;
                if (json?.status === 'success' && json?.data?.items && optionsContainer) {
                    // Limpiar opciones anteriores
                    if (customerOptions) {
                        customerOptions.innerHTML = '';
                    } else {
                        optionsContainer.innerHTML = '';
                    }
                    
                    if (json.data.items.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'px-4 py-3 text-sm text-center text-gray-500 dark:text-gray-400';
                        emptyMessage.textContent = tx('No se encontraron clientes');
                        if (customerOptions) {
                            customerOptions.appendChild(emptyMessage);
                        } else {
                            optionsContainer.appendChild(emptyMessage);
                        }
                    } else {
                        json.data.items.forEach((customer) => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'flex w-full items-center justify-between gap-3 px-4 py-3 text-left text-sm text-gray-900 transition hover:bg-primary/10 active:bg-primary/20 dark:text-white dark:hover:bg-slate-800 border-b border-gray-100 dark:border-gray-800 last:border-b-0';
                            item.innerHTML = `
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-gray-900 dark:text-white truncate">${customer.name || customer.display_name || ''}</p>
                                    ${customer.document_number ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${customer.document_number}</p>` : ''}
                                    ${customer.email ? `<p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5 truncate">${customer.email}</p>` : ''}
                                </div>
                                <i class="fa-solid fa-chevron-right text-xs text-gray-400 flex-shrink-0"></i>
                            `;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                selectedCustomer = customer;
                                if (customerId) customerId.value = customer.id;
                                if (customerSearch) customerSearch.value = customer.name || customer.display_name || '';
                                if (customerResults) {
                                    customerResults.hidden = true;
                                    customerResults.dataset.open = 'false';
                                }
                            });
                            if (customerOptions) {
                                customerOptions.appendChild(item);
                            } else {
                                optionsContainer.appendChild(item);
                            }
                        });
                    }
                    if (customerResults && customerResults.hidden) {
                        customerResults.hidden = false;
                        customerResults.dataset.open = 'true';
                    }
                }
            } catch (error) {
                console.error('[Quotation] Error loading customers', error);
                const optionsContainer = customerOptions || customerResults;
                if (optionsContainer) {
                    if (customerOptions) {
                        customerOptions.innerHTML = `<div class="px-4 py-3 text-sm text-center text-rose-500">${tx('Error al cargar clientes')}</div>`;
                    } else {
                        optionsContainer.innerHTML = `<div class="px-4 py-3 text-sm text-center text-rose-500">${tx('Error al cargar clientes')}</div>`;
                    }
                }
            }
        }, 300);
    };

    const loadItems = async (search = '') => {
        clearTimeout(searchTimeouts.item);
        searchTimeouts.item = setTimeout(async () => {
            try {
                const url = currentTab === 'products' ? productsUrl : servicesUrl;
                const query = search ? `?search=${encodeURIComponent(search)}&limit=100` : '?limit=100';
                const response = await fetch(`${url}${query}`, {
                    headers: {
                        Accept: 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                const json = await response.json();
                if (json?.status === 'success' && json?.data?.items && itemsGrid) {
                    if (json.data.items.length === 0) {
                        itemsGrid.innerHTML = `
                            <div class="col-span-full rounded-xl border-2 border-dashed border-gray-300 p-12 text-center dark:border-gray-700">
                                <i class="fa-solid fa-box-open mb-4 text-5xl text-gray-400"></i>
                                <p class="text-gray-500 dark:text-gray-400">${tx('No se encontraron resultados')}</p>
                            </div>
                        `;
                    } else {
                        itemsGrid.innerHTML = json.data.items.map((item) => {
                            const existingCartItem = cartItems.find(cartItem => 
                                cartItem.item_id === item.id && cartItem.item_type === (currentTab === 'products' ? 'product' : 'service')
                            );
                            const isInCart = existingCartItem !== undefined;
                            
                            return `
                                <div
                                    class="group relative cursor-pointer rounded-lg border-2 border-gray-200 bg-white p-4 text-center transition-all hover:border-primary hover:shadow-lg active:scale-95 dark:border-gray-700 dark:bg-slate-800 ${isInCart ? 'border-primary bg-primary/5' : ''}"
                                    data-quotation-item="${item.id}"
                                    data-quotation-item-type="${currentTab === 'products' ? 'product' : 'service'}"
                                >
                                    <div class="mx-auto mb-3 flex h-20 w-20 items-center justify-center rounded-lg bg-gray-100 dark:bg-slate-700">
                                        <i class="fa-solid ${currentTab === 'products' ? 'fa-box' : 'fa-wrench'} text-3xl text-gray-400"></i>
                                    </div>
                                    <h3 class="mb-2 text-sm font-semibold text-gray-900 line-clamp-2 dark:text-white">
                                        ${item.name}
                                    </h3>
                                    ${item.sku ? `<p class="mb-2 text-xs text-gray-500 dark:text-gray-400">${item.sku}</p>` : ''}
                                    <p class="text-lg font-bold text-primary">
                                        ${formatCurrency(item.price)}
                                    </p>
                                    ${isInCart ? `
                                        <div class="absolute top-2 right-2 rounded-full bg-primary px-2 py-1 text-xs font-bold text-white">
                                            ${existingCartItem.quantity}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                        
                        // Add click listeners to items
                        itemsGrid.querySelectorAll('[data-quotation-item]').forEach((itemEl) => {
                            itemEl.addEventListener('click', () => {
                                const itemId = itemEl.dataset.quotationItem;
                                const itemType = itemEl.dataset.quotationItemType;
                                const item = json.data.items.find(i => i.id === itemId);
                                
                                if (!item) return;
                                
                                // Add to cart
                                const existingIndex = cartItems.findIndex(cartItem => 
                                    cartItem.item_id === item.id && cartItem.item_type === itemType
                                );

                                if (existingIndex >= 0) {
                                    cartItems[existingIndex].quantity += 1;
                                } else {
                                    cartItems.push({
                                        item_id: item.id,
                                        item_type: itemType,
                                        name: item.name,
                                        sku: item.sku || '',
                                        quantity: 1,
                                        unit_price: item.price,
                                    });
                                }

                                renderCartItems();
                                calculateTotal();
                                
                                // Refresh grid to show updated cart badge
                                loadItems(itemSearch?.value || '');
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('[Quotation] Error loading items', error);
                if (itemsGrid) {
                    itemsGrid.innerHTML = `
                        <div class="col-span-full rounded-xl border-2 border-dashed border-red-300 p-12 text-center dark:border-red-700">
                            <i class="fa-solid fa-exclamation-triangle mb-4 text-5xl text-red-400"></i>
                            <p class="text-red-500 dark:text-red-400">${tx('Error al cargar items')}</p>
                        </div>
                    `;
                }
            }
        }, 300);
    };

    // Customer search
    if (customerSearch) {
        customerSearch.addEventListener('focus', () => {
            if (customerResults) {
                customerResults.hidden = false;
                customerResults.dataset.open = 'true';
                loadCustomers('');
            }
        });

        customerSearch.addEventListener('input', (e) => {
            loadCustomers(e.target.value);
        });

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (customerContainer && !customerContainer.contains(e.target)) {
                if (customerResults) {
                    customerResults.hidden = true;
                    customerResults.dataset.open = 'false';
                }
            }
        });
    }

    // Item search
    if (itemSearch) {
        itemSearch.addEventListener('input', (e) => {
            loadItems(e.target.value);
        });
        // Load initial products
        loadItems('');
    }

    // Tab switching
    tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.quotationTab;
            currentTab = tab;

            tabButtons.forEach((b) => {
                if (b.dataset.quotationTab === tab) {
                    b.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-slate-700', 'dark:text-gray-300', 'dark:hover:bg-slate-600');
                    b.classList.add('bg-primary', 'text-white', 'hover:bg-primary-strong');
                } else {
                    b.classList.remove('bg-primary', 'text-white', 'hover:bg-primary-strong');
                    b.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-slate-700', 'dark:text-gray-300', 'dark:hover:bg-slate-600');
                }
            });

            if (itemSearch) {
                itemSearch.placeholder = tab === 'products' ? tx('Buscar productos por nombre o SKU...') : tx('Buscar servicios por nombre...');
                itemSearch.value = '';
            }
            
            // Load items for the selected tab
            loadItems('');
        });
    });

    // Cart item controls
    cartItemsContainer?.addEventListener('click', (e) => {
        const decreaseBtn = e.target.closest('[data-cart-item-decrease]');
        if (decreaseBtn) {
            const index = parseInt(decreaseBtn.dataset.cartItemDecrease);
            if (cartItems[index].quantity > 1) {
                cartItems[index].quantity -= 1;
                renderCartItems();
                calculateTotal();
            }
            return;
        }

        const increaseBtn = e.target.closest('[data-cart-item-increase]');
        if (increaseBtn) {
            const index = parseInt(increaseBtn.dataset.cartItemIncrease);
            cartItems[index].quantity += 1;
            renderCartItems();
            calculateTotal();
            return;
        }

        const removeBtn = e.target.closest('[data-cart-item-remove]');
        if (removeBtn) {
            const index = parseInt(removeBtn.dataset.cartItemRemove);
            cartItems.splice(index, 1);
            renderCartItems();
            calculateTotal();
            loadItems(itemSearch?.value || '');
            return;
        }
    });

    // Quantity input changes
    cartItemsContainer?.addEventListener('change', (e) => {
        const quantityInput = e.target.closest('[data-cart-item-quantity]');
        if (quantityInput) {
            const index = parseInt(quantityInput.dataset.cartItemQuantity);
            const quantity = parseInt(quantityInput.value) || 1;
            cartItems[index].quantity = Math.max(1, quantity);
            renderCartItems();
            calculateTotal();
        }
    });

    // Form submission
    if (form) {
        form.addEventListener('submit', (e) => {
            // Validar que se haya seleccionado un cliente
            if (!selectedCustomer && !customerId?.value) {
                e.preventDefault();
                showAlert({ 
                    title: tx('Error'), 
                    text: tx('Debes seleccionar un cliente para continuar.'), 
                    icon: 'error' 
                });
                if (customerSearch) {
                    customerSearch.focus();
                }
                return;
            }

            // Validar que haya al menos un item en la cotización
            if (cartItems.length === 0) {
                e.preventDefault();
                showAlert({ 
                    title: tx('Error'), 
                    text: tx('Debes agregar al menos un item (producto o servicio) a la cotización para continuar.'), 
                    icon: 'error' 
                });
                if (itemSearch) {
                    itemSearch.focus();
                }
                return;
            }

            // Add hidden inputs for items
            cartItems.forEach((item, index) => {
                const itemIdInput = document.createElement('input');
                itemIdInput.type = 'hidden';
                itemIdInput.name = `items[${index}][item_id]`;
                itemIdInput.value = item.item_id;
                form.appendChild(itemIdInput);

                const itemTypeInput = document.createElement('input');
                itemTypeInput.type = 'hidden';
                itemTypeInput.name = `items[${index}][item_type]`;
                itemTypeInput.value = item.item_type;
                form.appendChild(itemTypeInput);

                const quantityInput = document.createElement('input');
                quantityInput.type = 'hidden';
                quantityInput.name = `items[${index}][quantity]`;
                quantityInput.value = item.quantity;
                form.appendChild(quantityInput);

                const unitPriceInput = document.createElement('input');
                unitPriceInput.type = 'hidden';
                unitPriceInput.name = `items[${index}][unit_price]`;
                unitPriceInput.value = item.unit_price;
                form.appendChild(unitPriceInput);
            });
        });
    }

    // Load existing quotation data if editing
    if (quotationId) {
        // Listen for custom event to load existing items
        window.addEventListener('quotation:loadItems', (e) => {
            if (e.detail && Array.isArray(e.detail)) {
                cartItems = e.detail;
                renderCartItems();
                calculateTotal();
                loadItems(itemSearch?.value || '');
            }
        });
    }

    // Initial render
    renderCartItems();
    calculateTotal();
};

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp, { once: true });
} else {
    initApp();
}